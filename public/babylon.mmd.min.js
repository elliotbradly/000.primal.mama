!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@babylonjs/core/Buffers/buffer"),require("@babylonjs/core/Engines/constants"),require("@babylonjs/core/Materials/clipPlaneMaterialHelper"),require("@babylonjs/core/Materials/drawWrapper"),require("@babylonjs/core/Materials/effectFallbacks"),require("@babylonjs/core/Materials/materialHelper.functions"),require("@babylonjs/core/Materials/shaderLanguage"),require("@babylonjs/core/Maths/math.vector"),require("@babylonjs/core/scene"),require("@babylonjs/core/sceneComponent"),require("@babylonjs/core/Misc/observable"),require("@babylonjs/core/Animations/animation"),require("@babylonjs/core/Animations/animationGroup"),require("@babylonjs/core/Animations/animationKey"),require("@babylonjs/core/Maths/math.color"),require("@babylonjs/core/Misc/typeStore"),require("@babylonjs/core/Maths/math.axis"),require("@babylonjs/core/Materials/materialDefines"),require("@babylonjs/core/Materials/materialPluginBase"),require("@babylonjs/core/Misc/decorators"),require("@babylonjs/core/Materials/material"),require("@babylonjs/core/Materials/standardMaterial"),require("@babylonjs/core/Misc/decorators.serialization"),require("@babylonjs/core/Meshes/mesh"),require("@babylonjs/core/Cameras/camera"),require("@babylonjs/core/node"),require("@babylonjs/core/Loading/sceneLoader"),require("@babylonjs/core/Materials/Textures/Loaders/textureLoaderManager"),require("@babylonjs/core/Misc/fileTools"),require("@babylonjs/core/Misc/logger"),require("@babylonjs/core/Materials/multiMaterial"),require("@babylonjs/core/Meshes/geometry"),require("@babylonjs/core/Meshes/mesh.vertexData"),require("@babylonjs/core/Meshes/subMesh"),require("@babylonjs/core/Misc/tools"),require("@babylonjs/core/Morph/morphTarget"),require("@babylonjs/core/Morph/morphTargetManager"),require("@babylonjs/core/assetContainer"),require("@babylonjs/core/Bones/bone"),require("@babylonjs/core/Bones/skeleton"),require("@babylonjs/core/Culling/boundingInfo"),require("@babylonjs/core/Materials/Textures/texture"),require("@babylonjs/core/Misc/timingTools"),require("@babylonjs/core/Materials/shaderMaterial"),require("@babylonjs/core/Materials/Textures/renderTargetTexture"),require("@babylonjs/core/Physics/v1/physicsJoint"),require("@babylonjs/core/Physics/v1/Plugins/ammoJSPlugin"),require("@babylonjs/core/Physics/joinedPhysicsEngineComponent"),require("@babylonjs/core/Physics/v1/physicsEngineComponent"),require("@babylonjs/core/Meshes/abstractMesh"),require("@babylonjs/core/Physics/v1/physicsImpostor"),require("@babylonjs/core/Physics/v2/physicsEngineComponent"),require("@babylonjs/core/Meshes/transformNode"),require("@babylonjs/core/Physics/v2/IPhysicsEnginePlugin"),require("@babylonjs/core/Physics/v2/physicsBody"),require("@babylonjs/core/Physics/v2/physicsConstraint"),require("@babylonjs/core/Physics/v2/physicsShape"),require("@babylonjs/core/Engines/abstractEngine"),require("@babylonjs/core/Shaders/ShadersInclude/bonesDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/bakedVertexAnimationDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/morphTargetsVertexGlobalDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/morphTargetsVertexDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/clipPlaneVertexDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/instancesDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/logDepthDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/morphTargetsVertexGlobal"),require("@babylonjs/core/Shaders/ShadersInclude/morphTargetsVertex"),require("@babylonjs/core/Shaders/ShadersInclude/instancesVertex"),require("@babylonjs/core/Shaders/ShadersInclude/bonesVertex"),require("@babylonjs/core/Shaders/ShadersInclude/bakedVertexAnimation"),require("@babylonjs/core/Shaders/ShadersInclude/clipPlaneVertex"),require("@babylonjs/core/Shaders/ShadersInclude/logDepthVertex"),require("@babylonjs/core/Engines/shaderStore"),require("@babylonjs/core/Shaders/ShadersInclude/clipPlaneFragmentDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/clipPlaneFragment"),require("@babylonjs/core/Shaders/ShadersInclude/logDepthFragment"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/bonesDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/bakedVertexAnimationDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/morphTargetsVertexGlobalDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/morphTargetsVertexDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/clipPlaneVertexDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/instancesDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/logDepthDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/morphTargetsVertexGlobal"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/morphTargetsVertex"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/instancesVertex"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/bonesVertex"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/bakedVertexAnimation"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/clipPlaneVertex"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/logDepthVertex"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/clipPlaneFragmentDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/clipPlaneFragment"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/logDepthFragment")):"function"==typeof define&&define.amd?define("babylon-mmd",["@babylonjs/core/Buffers/buffer","@babylonjs/core/Engines/constants","@babylonjs/core/Materials/clipPlaneMaterialHelper","@babylonjs/core/Materials/drawWrapper","@babylonjs/core/Materials/effectFallbacks","@babylonjs/core/Materials/materialHelper.functions","@babylonjs/core/Materials/shaderLanguage","@babylonjs/core/Maths/math.vector","@babylonjs/core/scene","@babylonjs/core/sceneComponent","@babylonjs/core/Misc/observable","@babylonjs/core/Animations/animation","@babylonjs/core/Animations/animationGroup","@babylonjs/core/Animations/animationKey","@babylonjs/core/Maths/math.color","@babylonjs/core/Misc/typeStore","@babylonjs/core/Maths/math.axis","@babylonjs/core/Materials/materialDefines","@babylonjs/core/Materials/materialPluginBase","@babylonjs/core/Misc/decorators","@babylonjs/core/Materials/material","@babylonjs/core/Materials/standardMaterial","@babylonjs/core/Misc/decorators.serialization","@babylonjs/core/Meshes/mesh","@babylonjs/core/Cameras/camera","@babylonjs/core/node","@babylonjs/core/Loading/sceneLoader","@babylonjs/core/Materials/Textures/Loaders/textureLoaderManager","@babylonjs/core/Misc/fileTools","@babylonjs/core/Misc/logger","@babylonjs/core/Materials/multiMaterial","@babylonjs/core/Meshes/geometry","@babylonjs/core/Meshes/mesh.vertexData","@babylonjs/core/Meshes/subMesh","@babylonjs/core/Misc/tools","@babylonjs/core/Morph/morphTarget","@babylonjs/core/Morph/morphTargetManager","@babylonjs/core/assetContainer","@babylonjs/core/Bones/bone","@babylonjs/core/Bones/skeleton","@babylonjs/core/Culling/boundingInfo","@babylonjs/core/Materials/Textures/texture","@babylonjs/core/Misc/timingTools","@babylonjs/core/Materials/shaderMaterial","@babylonjs/core/Materials/Textures/renderTargetTexture","@babylonjs/core/Physics/v1/physicsJoint","@babylonjs/core/Physics/v1/Plugins/ammoJSPlugin","@babylonjs/core/Physics/joinedPhysicsEngineComponent","@babylonjs/core/Physics/v1/physicsEngineComponent","@babylonjs/core/Meshes/abstractMesh","@babylonjs/core/Physics/v1/physicsImpostor","@babylonjs/core/Physics/v2/physicsEngineComponent","@babylonjs/core/Meshes/transformNode","@babylonjs/core/Physics/v2/IPhysicsEnginePlugin","@babylonjs/core/Physics/v2/physicsBody","@babylonjs/core/Physics/v2/physicsConstraint","@babylonjs/core/Physics/v2/physicsShape","@babylonjs/core/Engines/abstractEngine","@babylonjs/core/Shaders/ShadersInclude/bonesDeclaration","@babylonjs/core/Shaders/ShadersInclude/bakedVertexAnimationDeclaration","@babylonjs/core/Shaders/ShadersInclude/morphTargetsVertexGlobalDeclaration","@babylonjs/core/Shaders/ShadersInclude/morphTargetsVertexDeclaration","@babylonjs/core/Shaders/ShadersInclude/clipPlaneVertexDeclaration","@babylonjs/core/Shaders/ShadersInclude/instancesDeclaration","@babylonjs/core/Shaders/ShadersInclude/logDepthDeclaration","@babylonjs/core/Shaders/ShadersInclude/morphTargetsVertexGlobal","@babylonjs/core/Shaders/ShadersInclude/morphTargetsVertex","@babylonjs/core/Shaders/ShadersInclude/instancesVertex","@babylonjs/core/Shaders/ShadersInclude/bonesVertex","@babylonjs/core/Shaders/ShadersInclude/bakedVertexAnimation","@babylonjs/core/Shaders/ShadersInclude/clipPlaneVertex","@babylonjs/core/Shaders/ShadersInclude/logDepthVertex","@babylonjs/core/Engines/shaderStore","@babylonjs/core/Shaders/ShadersInclude/clipPlaneFragmentDeclaration","@babylonjs/core/Shaders/ShadersInclude/clipPlaneFragment","@babylonjs/core/Shaders/ShadersInclude/logDepthFragment","@babylonjs/core/ShadersWGSL/ShadersInclude/bonesDeclaration","@babylonjs/core/ShadersWGSL/ShadersInclude/bakedVertexAnimationDeclaration","@babylonjs/core/ShadersWGSL/ShadersInclude/morphTargetsVertexGlobalDeclaration","@babylonjs/core/ShadersWGSL/ShadersInclude/morphTargetsVertexDeclaration","@babylonjs/core/ShadersWGSL/ShadersInclude/clipPlaneVertexDeclaration","@babylonjs/core/ShadersWGSL/ShadersInclude/instancesDeclaration","@babylonjs/core/ShadersWGSL/ShadersInclude/logDepthDeclaration","@babylonjs/core/ShadersWGSL/ShadersInclude/morphTargetsVertexGlobal","@babylonjs/core/ShadersWGSL/ShadersInclude/morphTargetsVertex","@babylonjs/core/ShadersWGSL/ShadersInclude/instancesVertex","@babylonjs/core/ShadersWGSL/ShadersInclude/bonesVertex","@babylonjs/core/ShadersWGSL/ShadersInclude/bakedVertexAnimation","@babylonjs/core/ShadersWGSL/ShadersInclude/clipPlaneVertex","@babylonjs/core/ShadersWGSL/ShadersInclude/logDepthVertex","@babylonjs/core/ShadersWGSL/ShadersInclude/clipPlaneFragmentDeclaration","@babylonjs/core/ShadersWGSL/ShadersInclude/clipPlaneFragment","@babylonjs/core/ShadersWGSL/ShadersInclude/logDepthFragment"],t):"object"==typeof exports?exports["babylon-mmd"]=t(require("@babylonjs/core/Buffers/buffer"),require("@babylonjs/core/Engines/constants"),require("@babylonjs/core/Materials/clipPlaneMaterialHelper"),require("@babylonjs/core/Materials/drawWrapper"),require("@babylonjs/core/Materials/effectFallbacks"),require("@babylonjs/core/Materials/materialHelper.functions"),require("@babylonjs/core/Materials/shaderLanguage"),require("@babylonjs/core/Maths/math.vector"),require("@babylonjs/core/scene"),require("@babylonjs/core/sceneComponent"),require("@babylonjs/core/Misc/observable"),require("@babylonjs/core/Animations/animation"),require("@babylonjs/core/Animations/animationGroup"),require("@babylonjs/core/Animations/animationKey"),require("@babylonjs/core/Maths/math.color"),require("@babylonjs/core/Misc/typeStore"),require("@babylonjs/core/Maths/math.axis"),require("@babylonjs/core/Materials/materialDefines"),require("@babylonjs/core/Materials/materialPluginBase"),require("@babylonjs/core/Misc/decorators"),require("@babylonjs/core/Materials/material"),require("@babylonjs/core/Materials/standardMaterial"),require("@babylonjs/core/Misc/decorators.serialization"),require("@babylonjs/core/Meshes/mesh"),require("@babylonjs/core/Cameras/camera"),require("@babylonjs/core/node"),require("@babylonjs/core/Loading/sceneLoader"),require("@babylonjs/core/Materials/Textures/Loaders/textureLoaderManager"),require("@babylonjs/core/Misc/fileTools"),require("@babylonjs/core/Misc/logger"),require("@babylonjs/core/Materials/multiMaterial"),require("@babylonjs/core/Meshes/geometry"),require("@babylonjs/core/Meshes/mesh.vertexData"),require("@babylonjs/core/Meshes/subMesh"),require("@babylonjs/core/Misc/tools"),require("@babylonjs/core/Morph/morphTarget"),require("@babylonjs/core/Morph/morphTargetManager"),require("@babylonjs/core/assetContainer"),require("@babylonjs/core/Bones/bone"),require("@babylonjs/core/Bones/skeleton"),require("@babylonjs/core/Culling/boundingInfo"),require("@babylonjs/core/Materials/Textures/texture"),require("@babylonjs/core/Misc/timingTools"),require("@babylonjs/core/Materials/shaderMaterial"),require("@babylonjs/core/Materials/Textures/renderTargetTexture"),require("@babylonjs/core/Physics/v1/physicsJoint"),require("@babylonjs/core/Physics/v1/Plugins/ammoJSPlugin"),require("@babylonjs/core/Physics/joinedPhysicsEngineComponent"),require("@babylonjs/core/Physics/v1/physicsEngineComponent"),require("@babylonjs/core/Meshes/abstractMesh"),require("@babylonjs/core/Physics/v1/physicsImpostor"),require("@babylonjs/core/Physics/v2/physicsEngineComponent"),require("@babylonjs/core/Meshes/transformNode"),require("@babylonjs/core/Physics/v2/IPhysicsEnginePlugin"),require("@babylonjs/core/Physics/v2/physicsBody"),require("@babylonjs/core/Physics/v2/physicsConstraint"),require("@babylonjs/core/Physics/v2/physicsShape"),require("@babylonjs/core/Engines/abstractEngine"),require("@babylonjs/core/Shaders/ShadersInclude/bonesDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/bakedVertexAnimationDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/morphTargetsVertexGlobalDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/morphTargetsVertexDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/clipPlaneVertexDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/instancesDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/logDepthDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/morphTargetsVertexGlobal"),require("@babylonjs/core/Shaders/ShadersInclude/morphTargetsVertex"),require("@babylonjs/core/Shaders/ShadersInclude/instancesVertex"),require("@babylonjs/core/Shaders/ShadersInclude/bonesVertex"),require("@babylonjs/core/Shaders/ShadersInclude/bakedVertexAnimation"),require("@babylonjs/core/Shaders/ShadersInclude/clipPlaneVertex"),require("@babylonjs/core/Shaders/ShadersInclude/logDepthVertex"),require("@babylonjs/core/Engines/shaderStore"),require("@babylonjs/core/Shaders/ShadersInclude/clipPlaneFragmentDeclaration"),require("@babylonjs/core/Shaders/ShadersInclude/clipPlaneFragment"),require("@babylonjs/core/Shaders/ShadersInclude/logDepthFragment"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/bonesDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/bakedVertexAnimationDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/morphTargetsVertexGlobalDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/morphTargetsVertexDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/clipPlaneVertexDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/instancesDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/logDepthDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/morphTargetsVertexGlobal"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/morphTargetsVertex"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/instancesVertex"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/bonesVertex"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/bakedVertexAnimation"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/clipPlaneVertex"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/logDepthVertex"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/clipPlaneFragmentDeclaration"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/clipPlaneFragment"),require("@babylonjs/core/ShadersWGSL/ShadersInclude/logDepthFragment")):e.BABYLONMMD=t(e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON,e.BABYLON)}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,((e,t,n,i,r,o,a,s,l,h,d,c,u,m,p,_,g,f,b,y,w,A,M,T,x,v,I,B,P,S,R,E,C,O,k,F,N,D,L,U,V,W,z,j,q,K,G,Y,Q,H,$,X,J,Z,ee,te,ne,ie,re,oe,ae,se,le,he,de,ce,ue,me,pe,_e,ge,fe,be,ye,we,Ae,Me,Te,xe,ve,Ie,Be,Pe,Se,Re,Ee,Ce,Oe,ke,Fe,Ne,De,Le)=>(()=>{"use strict";var Ue={10:e=>{e.exports=ye},71:(e,t,n)=>{n.r(t),n.d(t,{textureAlphaCheckerVertexShader:()=>o});const i="textureAlphaCheckerVertexShader",r="\nprecision highp float;attribute vec2 uv;varying vec2 vUv;void main() {vUv=uv;gl_Position=vec4(mod(uv,1.0)*2.0-1.0,0.0,1.0);}\n";n(4234).ShaderStore.ShadersStore[i]=r;const o={name:i,shader:r}},78:e=>{e.exports=se},169:e=>{e.exports=y},182:e=>{e.exports=Pe},211:e=>{e.exports=oe},224:(e,t,n)=>{n.d(t,{PmdLoader:()=>s});var i=n(6532),r=n(1433),o=n(7569),a=n(4784);class s extends a.F{constructor(e,t){super(o.Q.name,o.Q.extensions,e,t)}createPlugin(e){return new s(e.mmdmodel,this)}async _parseFileAsync(e){return await r.D.ParseAsync(e,this).catch((e=>Promise.reject(e)))}}(0,i.registerSceneLoaderPlugin)(new s)},360:e=>{e.exports=ue},426:(e,t,n)=>{n.d(t,{ZL:()=>m,rw:()=>i});var i,r=n(3843),o=n(9430),a=n(9190),s=n(5501),l=n(169),h=n(2792),d=n(3036),c=function(e,t,n,i){var r,o=arguments.length,a=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(a=(o<3?r(a):o>3?r(t,n,a):r(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a};class u extends o.MaterialDefines{SPHERE_TEXTURE=!1;SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1;SPHERE_TEXTURE_BLEND_MODE_ADD=!1;TOON_TEXTURE=!1;IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1;APPLY_AMBIENT_COLOR_TO_DIFFUSE=!1;CLAMP_ALPHA=!1;TEXTURE_COLOR=!1;SPHERE_TEXTURE_COLOR=!1;TOON_TEXTURE_COLOR=!1;SDEF=!1}!function(e){e[e.Multiply=1]="Multiply",e[e.Add=2]="Add",e[e.SubTexture=3]="SubTexture"}(i||(i={}));class m extends a.MaterialPluginBase{_sphereTexture=null;_sphereTextureBlendMode=i.Add;_toonTexture=null;_ignoreDiffuseWhenToonTextureIsNull=!1;textureMultiplicativeColor=new s.Color4(1,1,1,1);textureAdditiveColor=new s.Color4(0,0,0,0);sphereTextureMultiplicativeColor=new s.Color4(1,1,1,1);sphereTextureAdditiveColor=new s.Color4(0,0,0,0);toonTextureMultiplicativeColor=new s.Color4(1,1,1,1);toonTextureAdditiveColor=new s.Color4(0,0,0,0);_applyAmbientColorToDiffuse=!0;_clampAlpha=!0;_useTextureColor=!1;_useSphereTextureColor=!1;_useToonTextureColor=!1;_isEnabled=!1;get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this.markAllDefinesAsDirty(),this._enable(e))}get sphereTexture(){return this._sphereTexture}set sphereTexture(e){this._sphereTexture!==e&&(this._sphereTexture=e,this._markAllSubMeshesAsTexturesDirty())}get sphereTextureBlendMode(){return this._sphereTextureBlendMode}set sphereTextureBlendMode(e){this._sphereTextureBlendMode!==e&&(this._sphereTextureBlendMode=e,this.markAllDefinesAsDirty())}get toonTexture(){return this._toonTexture}set toonTexture(e){this._toonTexture!==e&&(this._toonTexture=e,this._markAllSubMeshesAsTexturesDirty())}get ignoreDiffuseWhenToonTextureIsNull(){return this._ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._ignoreDiffuseWhenToonTextureIsNull!==e&&(this._ignoreDiffuseWhenToonTextureIsNull=e,this.markAllDefinesAsDirty())}get applyAmbientColorToDiffuse(){return this._applyAmbientColorToDiffuse}set applyAmbientColorToDiffuse(e){this._applyAmbientColorToDiffuse!==e&&(this._applyAmbientColorToDiffuse=e,this.markAllDefinesAsDirty())}get clampAlpha(){return this._clampAlpha}set clampAlpha(e){this._clampAlpha!==e&&(this._clampAlpha=e,this.markAllDefinesAsDirty())}get useTextureColor(){return this._useTextureColor}set useTextureColor(e){this._useTextureColor!==e&&(this._useTextureColor=e,this.markAllDefinesAsDirty())}get useSphereTextureColor(){return this._useSphereTextureColor}set useSphereTextureColor(e){this._useSphereTextureColor!==e&&(this._useSphereTextureColor=e,this.markAllDefinesAsDirty())}get useToonTextureColor(){return this._useToonTextureColor}set useToonTextureColor(e){this._useToonTextureColor!==e&&(this._useToonTextureColor=e,this.markAllDefinesAsDirty())}_internalMarkAllSubMeshesAsTexturesDirty;_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(e){return!0}constructor(e,t=!0,n=!1,i=!1){super(e,"MmdMaterial",100,new u,t,n,i),this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[r.Constants.MATERIAL_TextureDirtyFlag]}isReadyForSubMesh(e,t){return!this._isEnabled||!(e._areTexturesDirty&&t.texturesEnabled&&this._sphereTexture&&!this._sphereTexture.isReadyOrNotBlocking())}bindForSubMesh(e,t,n,i){if(!this._isEnabled)return;const r=i.materialDefines,o=this._material.isFrozen;e.useUbo&&o&&e.isSync||(r.DIFFUSE&&r.TEXTURE_COLOR&&(e.updateDirectColor4("textureMultiplicativeColor",this.textureMultiplicativeColor),e.updateDirectColor4("textureAdditiveColor",this.textureAdditiveColor)),r.NORMAL&&r.SPHERE_TEXTURE&&r.SPHERE_TEXTURE_COLOR&&(e.updateDirectColor4("sphereTextureMultiplicativeColor",this.sphereTextureMultiplicativeColor),e.updateDirectColor4("sphereTextureAdditiveColor",this.sphereTextureAdditiveColor)),r.TOON_TEXTURE&&r.TOON_TEXTURE_COLOR&&(e.updateDirectColor4("toonTextureMultiplicativeColor",this.toonTextureMultiplicativeColor),e.updateDirectColor4("toonTextureAdditiveColor",this.toonTextureAdditiveColor)),r.SPHERE_TEXTURE&&null!==i.effect&&this._material.bindView(i.effect)),t.texturesEnabled&&(r.NORMAL&&this._sphereTexture&&e.setTexture("sphereSampler",this._sphereTexture),this._toonTexture&&e.setTexture("toonSampler",this._toonTexture))}dispose(e){e&&(this._sphereTexture?.dispose(),this._toonTexture?.dispose())}prepareDefines(e,t,n){if(this._isEnabled){const r=t.texturesEnabled;e.SPHERE_TEXTURE=null!==this._sphereTexture&&r,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=this._sphereTextureBlendMode===i.Multiply,e.SPHERE_TEXTURE_BLEND_MODE_ADD=this._sphereTextureBlendMode===i.Add,e.TOON_TEXTURE=null!==this._toonTexture&&r,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=this._ignoreDiffuseWhenToonTextureIsNull,e.APPLY_AMBIENT_COLOR_TO_DIFFUSE=this._applyAmbientColorToDiffuse,e.CLAMP_ALPHA=this._clampAlpha,e.TEXTURE_COLOR=this._useTextureColor,e.SPHERE_TEXTURE_COLOR=this._useSphereTextureColor,e.TOON_TEXTURE_COLOR=this._useToonTextureColor,e.SDEF=n.useBones&&n.computeBonesUsingShaders&&!!n.skeleton&&n.isVerticesDataPresent(d.V.MatricesSdefCKind)}else e.SPHERE_TEXTURE=!1,e.SPHERE_TEXTURE_BLEND_MODE_MULTIPLY=!1,e.SPHERE_TEXTURE_BLEND_MODE_ADD=!1,e.TOON_TEXTURE=!1,e.IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED=!1,e.APPLY_AMBIENT_COLOR_TO_DIFFUSE=!1,e.CLAMP_ALPHA=!1,e.TEXTURE_COLOR=!1,e.SPHERE_TEXTURE_COLOR=!1,e.TOON_TEXTURE_COLOR=!1,e.SDEF=!1}hasTexture(e){return this._sphereTexture===e||this._toonTexture===e}getActiveTextures(e){this._sphereTexture&&e.push(this._sphereTexture),this._toonTexture&&e.push(this._toonTexture)}getAnimatables(e){this._sphereTexture&&this._sphereTexture.animations&&0<this._sphereTexture.animations.length&&e.push(this._sphereTexture),this._toonTexture&&this._toonTexture.animations&&0<this._toonTexture.animations.length&&e.push(this._toonTexture)}getSamplers(e){e.push("sphereSampler","toonSampler")}getAttributes(e,t,n){this._isEnabled&&n.useBones&&n.computeBonesUsingShaders&&n.skeleton&&n.isVerticesDataPresent(d.V.MatricesSdefCKind)&&(e.push(d.V.MatricesSdefCKind),e.push(d.V.MatricesSdefRW0Kind),e.push(d.V.MatricesSdefRW1Kind))}getUniforms(e){return{ubo:[{name:"textureMultiplicativeColor",size:4,type:"vec4"},{name:"textureAdditiveColor",size:4,type:"vec4"},{name:"sphereTextureMultiplicativeColor",size:4,type:"vec4"},{name:"sphereTextureAdditiveColor",size:4,type:"vec4"},{name:"toonTextureMultiplicativeColor",size:4,type:"vec4"},{name:"toonTextureAdditiveColor",size:4,type:"vec4"}]}}getClassName(){return"MmdPluginMaterial"}}c([(0,l.serializeAsTexture)("sphereTexture")],m.prototype,"_sphereTexture",void 0),c([(0,l.serialize)("sphereTextureBlendMode")],m.prototype,"_sphereTextureBlendMode",void 0),c([(0,l.serializeAsTexture)("toonTexture")],m.prototype,"_toonTexture",void 0),c([(0,l.serialize)("ignoreDiffuseWhenToonTextureIsNull")],m.prototype,"_ignoreDiffuseWhenToonTextureIsNull",void 0),c([(0,l.serialize)("applyAmbientColorToDiffuse")],m.prototype,"_applyAmbientColorToDiffuse",void 0),c([(0,l.serialize)("clampAlpha")],m.prototype,"_clampAlpha",void 0),(0,h.RegisterClass)("BABYLON.MmdPluginMaterial",m)},577:(e,t,n)=>{n.d(t,{L:()=>i,c:()=>p});var i,r=n(3843),o=n(1860),a=n(9150),s=n(5501),l=n(7396),h=n(5092),d=n(2620),c=n(6910),u=n(5567),m=n(1494);!function(e){e[e.DepthWriteAlphaBlendingWithEvaluation=0]="DepthWriteAlphaBlendingWithEvaluation",e[e.DepthWriteAlphaBlending=1]="DepthWriteAlphaBlending",e[e.AlphaEvaluation=2]="AlphaEvaluation"}(i||(i={}));class p{renderMethod=i.DepthWriteAlphaBlendingWithEvaluation;forceDisableAlphaEvaluation=!1;alphaThreshold=195;alphaBlendThreshold=100;alphaEvaluationResolution=512;deleteTextureBufferAfterLoad=!0;_textureLoader=new h.J;nextStartingAlphaIndex=65536;alphaIndexIncrementsPerModel=1024;_setMeshesAlphaIndex(e){let t=this.nextStartingAlphaIndex;for(let n=0;n<e.length;++n)e[n].alphaIndex=t,t+=1;this.nextStartingAlphaIndex+=this.alphaIndexIncrementsPerModel}buildMaterials(e,t,n,r,o,a,s,l,h,c,p,_,g,f,b){this.renderMethod!==i.DepthWriteAlphaBlendingWithEvaluation&&this.renderMethod!==i.DepthWriteAlphaBlending||this._setMeshesAlphaIndex(h);const y=c.blockMaterialDirtyMechanism;c._forceBlockMaterialDirtyMechanism(!0);let w=null;const A=()=>null!==w?w:this.forceDisableAlphaEvaluation?null:w=new m.n(c,this.alphaEvaluationResolution),M=new u.g(s,o,a),T=[],x={lengthComputable:!0,loaded:0,total:3*t.length},v=()=>{x.loaded+=1,f?.(x)},I=[];for(let i=0;i<t.length;++i){const a=t[i];c._blockEntityCollection=!!p;const s=new d.t(a.name,c);s._parentContainer=p,c._blockEntityCollection=!1,p?.materials.push(s);{const t=[],h=this.loadGeneralScalarProperties(s,a,l[i]);void 0!==h&&t.push(h);const d=this.loadDiffuseTexture(e,s,a,r,n[a.textureIndex]??null,c,p,o,M,g,v),u=()=>this.setAlphaBlendMode(s,a,l[i],g,A);if(void 0!==d){const e=d.then(u);t.push(e)}else{const e=u();void 0!==e&&t.push(e)}const m=this.loadSphereTexture(e,s,a,r,n[a.sphereTextureIndex]??null,c,p,o,M,g,v);void 0!==m&&t.push(m);const _=this.loadToonTexture(e,s,a,r,n[a.toonTextureIndex]??null,c,p,o,M,g,v);void 0!==_&&t.push(_);const f=this.loadOutlineRenderingProperties(s,a,g);void 0!==f&&t.push(f),T.push(...t),Promise.all(t).then((()=>{this.afterBuildSingleMaterial(s,i,a,r,n,c,o)}))}I.push(s)}this._textureLoader.loadModelTexturesEnd(e);const B=this._textureLoader.onModelTextureLoadedObservable.get(e);return void 0!==B?B.addOnce((()=>{Promise.all(T).then((()=>{w?.dispose(),c._forceBlockMaterialDirtyMechanism(y),null!==_&&this._buildTextureNameMap(t,I,r,n,_),b?.()}))})):Promise.all(T).then((()=>{w?.dispose(),c._forceBlockMaterialDirtyMechanism(y),null!==_&&this._buildTextureNameMap(t,I,r,n,_),b?.()})),I}_buildTextureNameMap(e,t,n,i,r){for(let o=0;o<e.length;++o){const a=e[o],s=t[o],l=n[i[a.textureIndex]?.imagePathIndex];if(void 0!==l){const e=s.diffuseTexture;null!==e&&r.set(e,l)}const h=n[i[a.sphereTextureIndex]?.imagePathIndex];if(void 0!==h){const e=s.sphereTexture;null!==e&&r.set(e,h)}const d=n[i[a.toonTextureIndex]?.imagePathIndex];if(void 0!==d){const e=s.toonTexture;null!==e&&r.set(e,d)}}}_getForcedExtension(e){if(".bmp"===e.substring(e.length-4).toLowerCase()&&null!==(0,a._GetCompatibleTextureLoader)(".dxbmp"))return".dxbmp"}loadGeneralScalarProperties=(e,t,n)=>{const i=t.diffuse;e.diffuseColor=new s.Color3(i[0],i[1],i[2]);const r=t.specular;e.specularColor=new s.Color3(r[0],r[1],r[2]);const o=t.ambient;e.ambientColor=new s.Color3(o[0],o[1],o[2]);const a=t.diffuse[3];if(e.alpha=a,0===a)for(let e=0;e<n.length;++e){const t=n[e];void 0!==t.isVisible&&(t.isVisible=!1)}e.specularPower=t.shininess};loadDiffuseTexture=async(e,t,n,i,o,a,s,l,h,d,u)=>{t.backFaceCulling=!(n.flag&c.B.Material.Flag.IsDoubleSided);const m=i[o?.imagePathIndex??-1];if(void 0!==m){const n=h.createFullPath(m);let i;const c=h.resolve(n);i=void 0!==c?await this._textureLoader.loadTextureFromBufferAsync(e,n,c instanceof File?c:c.data,a,s,{...o,deleteBuffer:this.deleteTextureBufferAfterLoad,format:r.Constants.TEXTUREFORMAT_RGBA,mimeType:c instanceof File?c.type:c.mimeType,forcedExtension:this._getForcedExtension(m)}):await this._textureLoader.loadTextureAsync(e,l,m,a,s,{...o,deleteBuffer:this.deleteTextureBufferAfterLoad,format:r.Constants.TEXTUREFORMAT_RGBA,forcedExtension:this._getForcedExtension(m)});const p=i;null!==p?t.diffuseTexture=p:d.error(`Failed to load diffuse texture: ${n}`),u?.()}else u?.()};async _evaluateDiffuseTextureTransparencyMode(e,t,n,r,a){let s=Number.MIN_SAFE_INTEGER;if(this.renderMethod===i.DepthWriteAlphaBlendingWithEvaluation){let i=t>>4&3;if(3^i||(i=-1),-1===i){s=o.Material.MATERIAL_OPAQUE;const t=a();if(null!==t)for(let i=0;i<n.length;++i){const r=n[i];if(!await t.hasFragmentsOnlyOpaqueOnGeometry(e,r?.mesh??r,void 0!==r?.subMeshIndex?r.subMeshIndex:null)){s=o.Material.MATERIAL_ALPHABLEND;break}}}else s=0===i?o.Material.MATERIAL_OPAQUE:o.Material.MATERIAL_ALPHABLEND}else if(this.renderMethod===i.AlphaEvaluation){let i=15&t;if(15^i||(i=-1),-1!==i)s=i;else{const t=a();if(null!==t)for(let i=0;i<n.length;++i){const r=n[i],o=await t.hasTranslucentFragmentsOnGeometry(e,r?.mesh??r,void 0!==r?.subMeshIndex?r.subMeshIndex:null,this.alphaThreshold,this.alphaBlendThreshold);s<o&&(s=o)}}}else r.warn(`Unknown shading method for evaluating transparency mode: ${this.renderMethod}`);return s!==Number.MIN_SAFE_INTEGER?s:null}setAlphaBlendMode=async(e,t,n,r,a)=>{if(this.renderMethod===i.DepthWriteAlphaBlending)return e.diffuseTexture&&(e.diffuseTexture.hasAlpha=!0,e.useAlphaFromDiffuseTexture=!0),e.transparencyMode=o.Material.MATERIAL_ALPHABLEND,void(e.forceDepthWrite=!0);if(this.renderMethod===i.DepthWriteAlphaBlendingWithEvaluation&&e.alpha<1)return e.diffuseTexture&&(e.diffuseTexture.hasAlpha=!0,e.useAlphaFromDiffuseTexture=!0),e.transparencyMode=o.Material.MATERIAL_ALPHABLEND,void(e.forceDepthWrite=!0);const s=e.diffuseTexture,l=t.evaluatedTransparency??-1;if(null!==s){const t=await this._evaluateDiffuseTextureTransparencyMode(s,l,n,r,a);if(null!==t){const n=t!==o.Material.MATERIAL_OPAQUE;n&&(s.hasAlpha=!0),e.useAlphaFromDiffuseTexture=n,e.transparencyMode=t,this.renderMethod===i.DepthWriteAlphaBlendingWithEvaluation&&(e.forceDepthWrite=n)}}else if(this.renderMethod===i.DepthWriteAlphaBlendingWithEvaluation){let t=l>>4&3;3^t||(t=0),e.transparencyMode=0===t?o.Material.MATERIAL_OPAQUE:o.Material.MATERIAL_ALPHABLEND}else{let t=15&l;15^t||(t=0),e.transparencyMode=o.Material.MATERIAL_OPAQUE}};loadSphereTexture=async(e,t,n,i,o,a,s,l,h,d,u)=>{if(n.sphereTextureMode!==c.B.Material.SphereTextureMode.Off){const m=i[o?.imagePathIndex??-1];if(void 0!==m){const i=a.getEngine().isWebGPU||n.sphereTextureMode===c.B.Material.SphereTextureMode.Multiply?r.Constants.TEXTUREFORMAT_RGBA:r.Constants.TEXTUREFORMAT_RGB,p=h.createFullPath(m);let _;const g=h.resolve(p);_=void 0!==g?await this._textureLoader.loadTextureFromBufferAsync(e,p,g instanceof File?g:g.data,a,s,{...o,deleteBuffer:this.deleteTextureBufferAfterLoad,format:i,mimeType:g instanceof File?g.type:g.mimeType,forcedExtension:this._getForcedExtension(m)}):await this._textureLoader.loadTextureAsync(e,l,m,a,s,{...o,deleteBuffer:this.deleteTextureBufferAfterLoad,format:i,forcedExtension:this._getForcedExtension(m)}),null!==_?(t.sphereTexture=_,t.sphereTextureBlendMode=n.sphereTextureMode):d.error(`Failed to load sphere texture: ${p}`),u?.()}else u?.()}else u?.()};loadToonTexture=async(e,t,n,i,o,a,s,l,h,d,c)=>{let u;if(u=n.isSharedToonTexture?n.toonTextureIndex:i[o?.imagePathIndex??-1],void 0!==u){const n=h.createFullPath(u.toString());let i;const m="string"==typeof u?h.resolve(n):void 0;i=void 0!==m?await this._textureLoader.loadTextureFromBufferAsync(e,n,m instanceof File?m:m.data,a,s,{...o,deleteBuffer:this.deleteTextureBufferAfterLoad,format:a.getEngine().isWebGPU?r.Constants.TEXTUREFORMAT_RGBA:r.Constants.TEXTUREFORMAT_RGB,mimeType:m instanceof File?m.type:m.mimeType}):await this._textureLoader.loadTextureAsync(e,l,u,a,s,{...o,deleteBuffer:this.deleteTextureBufferAfterLoad,format:a.getEngine().isWebGPU?r.Constants.TEXTUREFORMAT_RGBA:r.Constants.TEXTUREFORMAT_RGB}),null!==i?t.toonTexture=i:d.error(`Failed to load toon texture: ${n}`),c?.()}else c?.()};loadOutlineRenderingProperties=(e,t,n)=>{if(t.flag&c.B.Material.Flag.EnabledToonEdge){void 0===l.Scene.prototype.getMmdOutlineRenderer&&n.warn('MMD Outline Renderer is not available. Please import "babylon-mmd/esm/Loader/mmdOutlineRenderer".'),e.renderOutline=!0,e.outlineWidth=t.edgeSize;const i=t.edgeColor;e.outlineColor=new s.Color3(i[0],i[1],i[2]),e.outlineAlpha=i[3]}};afterBuildSingleMaterial=()=>{}}},735:e=>{e.exports=M},858:(e,t,n)=>{e.exports=n.p+"d41e11c2889c1bc8cc62.wasm"},1068:e=>{e.exports=x},1072:(e,t,n)=>{e.exports=n.p+"f2d2edb75376b0f5c81a.wasm"},1122:e=>{e.exports=Oe},1259:e=>{e.exports=u},1306:(e,t,n)=>{n.r(t),n.d(t,{textureAlphaCheckerPixelShader:()=>o});const i="textureAlphaCheckerPixelShader",r="\nvar textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUv: vec2f;@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=vec4f(\nvec3f(1.0)-vec3f(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.vUv).a),\n1.0\n);}\n";n(4234).ShaderStore.ShadersStoreWGSL[i]=r;const o={name:i,shader:r}},1308:e=>{e.exports=i},1409:e=>{e.exports=de},1433:(e,t,n)=>{n.d(t,{D:()=>s});var i,r=n(1599),o=n(5297);!function(e){let t;!function(e){let t;!function(e){e[e.Rotate=0]="Rotate",e[e.RotateMove=1]="RotateMove",e[e.Ik=2]="Ik",e[e.Unknown=3]="Unknown",e[e.IkLink=4]="IkLink",e[e.RotateEffect=5]="RotateEffect",e[e.IkTo=6]="IkTo",e[e.Invisible=7]="Invisible",e[e.Twist=8]="Twist",e[e.RotateRatio=9]="RotateRatio"}(t=e.Type||(e.Type={}))}(t=e.Bone||(e.Bone={}))}(i||(i={}));var a=n(6910);class s{constructor(){}static async ParseAsync(e,t=new r.C){const n=new o.u(e);n.initializeTextDecoder("shift-jis");const i=this._ParseHeader(n),a=await this._ParseVerticesAsync(n),s=this._ParseIndices(n),l=this._ParseMaterials(n),h=this._ParseBones(n),d=this._ParseIks(n),c=this._ParseMorphs(n),[u,m]=this._ParseDisplayFrames(n,c);if(0===n.bytesAvailable){const e=[];return{header:i,vertices:a,indices:s,textures:e,materials:this._ConvertMaterials(l,e),bones:this._ConvertBones(h,d,a,u),morphs:c,displayFrames:u,rigidBodies:[],joints:[],softBodies:[]}}0!==n.getUint8()&&this._ParseEnglishNames(n,i,h,c,u,m);const p=this._ParseToonTextures(n),_=this._ConvertMaterials(l,p);if(0===n.bytesAvailable)return{header:i,vertices:a,indices:s,textures:p,materials:_,bones:this._ConvertBones(h,d,a,u),morphs:c,displayFrames:u,rigidBodies:[],joints:[],softBodies:[]};const g=this._ParseRigidBodies(n),f=this._ConvertBones(h,d,a,u,g);this._NormalizeRigidBodyPositions(g,f);const b=this._ParseJoints(n);return n.bytesAvailable>0&&t.warn(`There are ${n.bytesAvailable} bytes left after parsing`),{header:i,vertices:a,indices:s,textures:p,materials:_,bones:f,morphs:c,displayFrames:u,rigidBodies:g,joints:b,softBodies:[]}}static _ParseHeader(e){if(e.bytesAvailable<7)throw new Error("is not pmd file");const t=e.getSignatureString(3);if("Pmd"!==t)throw new Error("is not pmd file");const n=e.getFloat32(),i=e.getDecoderString(20,!0),r=e.getDecoderString(256,!0);return{signature:t,version:n,encoding:a.B.Header.Encoding.ShiftJis,additionalVec4Count:0,vertexIndexSize:2,textureIndexSize:4,materialIndexSize:4,boneIndexSize:2,morphIndexSize:2,rigidBodyIndexSize:4,modelName:i,englishModelName:"",comment:r,englishComment:""}}static async _ParseVerticesAsync(e){const t=e.getUint32(),n=[];let i=performance.now();for(let r=0;r<t;++r){const t=e.getFloat32Tuple(3),o=e.getFloat32Tuple(3),s=e.getFloat32Tuple(2),l=a.B.Vertex.BoneWeightType.Bdef2,h={boneIndices:[e.getUint16(),e.getUint16()],boneWeights:e.getUint8()/100},d=0!==e.getUint8();n.push({position:t,normal:o,uv:s,additionalVec4:[],weightType:l,boneWeight:h,edgeScale:d?1:0}),r%1e4==0&&100<performance.now()-i&&(await new Promise((e=>setTimeout(e,0))),i=performance.now())}return n}static _ParseIndices(e){const t=e.getUint32(),n=new Uint16Array(t);return e.getUint16Array(n),n}static _ParseMaterials(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getFloat32Tuple(4),i=e.getFloat32(),r=e.getFloat32Tuple(3),o=e.getFloat32Tuple(3),s=e.getInt8(),l=e.getUint8(),h=e.getUint32(),d=e.getDecoderString(20,!0);let c=0;0!==l&&(c|=a.B.Material.Flag.EnabledToonEdge|a.B.Material.Flag.EnabledGroundShadow),.98!==t[3]&&(c|=a.B.Material.Flag.EnabledDrawShadow|a.B.Material.Flag.EnabledReceiveShadow),t[3]<1&&(c|=a.B.Material.Flag.IsDoubleSided);let u=a.B.Material.SphereTextureMode.Off,m="",p="";{const e=d.split("*");for(let t=0;t<e.length;++t){const n=e[t];let i=a.B.Material.SphereTextureMode.Off;if(""!==n){const e=n.lastIndexOf("."),t=-1!==e?n.substring(e).toLowerCase():"";".sph"===t?i=a.B.Material.SphereTextureMode.Multiply:".spa"===t&&(i=a.B.Material.SphereTextureMode.Add)}i!==a.B.Material.SphereTextureMode.Off?(u=i,p=n):m=n}}const _={name:d,englishName:"",diffuse:t,specular:r,shininess:i,ambient:o,flag:c,edgeColor:[0,0,0,1],edgeSize:1,textureIndex:m,sphereTextureIndex:p,sphereTextureMode:u,isSharedToonTexture:!1,toonTextureIndex:s,comment:"",indexCount:h};n.push(_)}return n}static _ParseBones(e){const t=e.getUint16(),n=[];for(let i=0;i<t;++i){const t={name:e.getDecoderString(20,!0),englishName:"",parentBoneIndex:e.getInt16(),tailIndex:e.getInt16(),type:e.getUint8(),ikIndex:e.getInt16(),position:e.getFloat32Tuple(3)};n.push(t)}return n}static _ParseIks(e){const t=e.getUint16(),n=[];for(let i=0;i<t;++i){const t=e.getUint16(),i=e.getUint16(),r=e.getUint8(),o=e.getUint16(),a=e.getFloat32(),s=[];for(let t=0;t<r;++t)s.push(e.getUint16());const l={boneIndex:t,targetIndex:i,iteration:o,rotationConstraint:a,links:s};n.push(l)}return n}static _ParseMorphs(e){const t=e.getUint16();if(0===t)return[];const n=[];for(let i=0;i<t;++i){const t=e.getDecoderString(20,!0),i=e.getUint32();let r={name:t,englishName:"",category:e.getUint8(),type:a.B.Morph.Type.VertexMorph};const o=new Int32Array(i),s=new Float32Array(3*i);for(let t=0;t<i;++t)o[t]=e.getUint32(),s[3*t+0]=e.getFloat32(),s[3*t+1]=e.getFloat32(),s[3*t+2]=e.getFloat32();r={...r,indices:o,positions:s},n.push(r)}const i=n.shift().indices;for(let e=0;e<n.length;++e){const t=n[e].indices;for(let e=0;e<t.length;++e){const n=t[e];0<=n&&n<i.length?t[e]=i[n]:t[e]=0}}return n}static _ParseDisplayFrames(e,t){const n=[],i=e.getUint8();for(let r=0;r<i;++r){const i={type:a.B.DisplayFrame.FrameData.FrameType.Morph,index:e.getUint16()},r={name:t[i.index]?.name??"",englishName:"",isSpecialFrame:!0,frames:[i]};n.push(r)}const r=n.length,o=e.getUint8();for(let t=0;t<o;++t){const t={name:e.getDecoderString(50,!0),englishName:"",isSpecialFrame:!1,frames:void 0};n.push(t)}const s=e.getUint32();for(let t=0;t<s;++t){const t=e.getUint16(),i=n[r+e.getUint8()-1];if(void 0!==i){const e={type:a.B.DisplayFrame.FrameData.FrameType.Bone,index:t};void 0===i.frames?i.frames=[e]:i.frames.push(e)}}for(let e=r;e<n.length;++e){const t=n[e];void 0===t.frames&&(t.frames=[])}return[n,r]}static _ParseEnglishNames(e,t,n,i,r,o){t.englishModelName=e.getDecoderString(20,!0),t.englishComment=e.getDecoderString(256,!0);for(let t=0;t<n.length;++t)n[t].englishName=e.getDecoderString(20,!0);for(let t=0;t<i.length;++t)i[t].englishName=e.getDecoderString(20,!0);for(let t=o;t<r.length;++t)r[t].englishName=e.getDecoderString(50,!0)}static _ParseToonTextures(e){const t=[];for(let n=0;n<10;++n)t.push(e.getDecoderString(100,!0));return t}static _PathNormalize(e){const t=(e=e.replace(/\\/g,"/")).split("/"),n=[];for(let e=0;e<t.length;++e){const i=t[e];"."!==i&&(".."===i?n.pop():n.push(i))}return n.join("/").toLowerCase()}static _ConvertMaterials(e,t){const n=new Array(t.length);for(let e=0;e<t.length;++e)n[e]=this._PathNormalize(t[e]);for(let i=0;i<e.length;++i){const r=e[i];if(0<=r.toonTextureIndex&&r.toonTextureIndex<t.length){const e=n[r.toonTextureIndex];if(/toon(10|0[0-9])\.bmp/.test(e)){r.isSharedToonTexture=!0;let t=e.substring(e.length-6,e.length-4);"n"===t[0]&&(t=t[1]),r.toonTextureIndex=parseInt(t,10)-1}}}const i=new Map;for(let e=0;e<t.length;++e)i.set(this._PathNormalize(t[e]),e);for(let n=0;n<e.length;++n){const r=e[n];if(""!==r.textureIndex){const e=this._PathNormalize(r.textureIndex);let n=i.get(e);void 0===n&&(n=i.size,i.set(e,n),t.push(r.textureIndex)),r.textureIndex=n}else r.textureIndex=-1;if(""!==r.sphereTextureIndex){const e=this._PathNormalize(r.sphereTextureIndex);let n=i.get(e);void 0===n&&(n=i.size,i.set(e,n),t.push(r.sphereTextureIndex)),r.sphereTextureIndex=n}else r.sphereTextureIndex=-1}return e}static _IkAngleLimitTable=new Map(Object.entries({左ひざ:[-180,-.5,0,0,0,0],右ひざ:[-180,-.5,0,0,0,0]}));static _ConvertBones(e,t,n,r,o){const s=new Map;for(let n=0;n<t.length;++n){const i=t[n].boneIndex;0<=i&&i<e.length&&!s.has(i)&&s.set(i,n)}const l=[];for(let t=0;t<e.length;++t){const n=e[t],r={name:n.name,englishName:n.englishName,position:n.position,parentBoneIndex:n.parentBoneIndex,transformOrder:0,flag:a.B.Bone.Flag.UseBoneIndexAsTailPosition,tailPosition:n.tailIndex<=0?-1:n.tailIndex,appendTransform:void 0,axisLimit:void 0,localVector:void 0,externalParentTransform:void 0,ik:void 0};let o=s.has(t);switch(r.flag|=a.B.Bone.Flag.IsRotatable|a.B.Bone.Flag.IsVisible|a.B.Bone.Flag.IsControllable,r.flag&=~a.B.Bone.Flag.IsMovable&~a.B.Bone.Flag.IsIkEnabled&~a.B.Bone.Flag.HasAppendRotate&~a.B.Bone.Flag.HasAxisLimit,n.type){case i.Bone.Type.RotateMove:r.flag|=a.B.Bone.Flag.IsMovable;break;case i.Bone.Type.Ik:o=!0;break;case i.Bone.Type.RotateEffect:r.flag|=a.B.Bone.Flag.HasAppendRotate,r.flag&=~a.B.Bone.Flag.UseBoneIndexAsTailPosition&~a.B.Bone.Flag.IsVisible,r.appendTransform={parentIndex:n.tailIndex,ratio:.01*n.ikIndex}}o&&(r.flag|=a.B.Bone.Flag.IsMovable|a.B.Bone.Flag.IsIkEnabled,r.transformOrder=1),l.push(r)}let h=Math.min(l.length,e.length);for(let t=0;t<h;++t){const n=e[t],r=l[t];if(n.type===i.Bone.Type.Twist){let t=e[n.tailIndex];void 0===t&&(t=e[0]);const i=t.position,o=n.position;r.axisLimit=[i[0]-o[0],i[1]-o[1],i[2]-o[2]];const s=r.axisLimit,l=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);s[0]/=l,s[1]/=l,s[2]/=l,r.flag&=~a.B.Bone.Flag.UseBoneIndexAsTailPosition}}const d=[];for(let n=0;n<h;++n){const i=l[n];if(!(i.flag&a.B.Bone.Flag.IsIkEnabled))continue;let r=0;for(let o=0;o<t.length;++o){const s=t[o];if(s.boneIndex!==n)continue;let h;0===r?(h=i,r+=1):(h={name:i.name+"+",englishName:i.englishName,position:[...i.position],parentBoneIndex:n,transformOrder:i.transformOrder,flag:i.flag&~a.B.Bone.Flag.IsVisible&~a.B.Bone.Flag.UseBoneIndexAsTailPosition,tailPosition:[0,0,0],appendTransform:void 0!==i.appendTransform?{...i.appendTransform}:void 0,axisLimit:void 0!==i.axisLimit?[...i.axisLimit]:void 0,localVector:void 0!==i.localVector?{x:[...i.localVector.x],z:[...i.localVector.z]}:void 0,externalParentTransform:i.externalParentTransform,ik:void 0},d.push(h),r+=1),void 0===h.ik&&(h.ik={target:0,iteration:0,rotationConstraint:0,links:[]});{const t=h.ik;t.target=s.targetIndex,t.iteration=s.iteration,t.rotationConstraint=4*s.rotationConstraint;const n=s.links;for(let i=0;i<n.length;++i){const r=n[i];if(0<=r&&r<l.length){const n={target:r,limitation:void 0};if(0<=r&&r<e.length){const t=e[r].name,i=this._IkAngleLimitTable.get(t);void 0!==i&&(n.limitation={minimumAngle:[i[0],i[2],i[4]],maximumAngle:[i[1],i[3],i[5]]})}t.links.push(n)}}}}}l.push(...d),h=Math.min(l.length,e.length);const c=[];for(let e=0;e<h;++e)if(l[e].flag&a.B.Bone.Flag.IsIkEnabled)for(let n=0;n<t.length;++n)if(t[n].boneIndex===e){c.push([e,n]);break}let u=!0;for(let e=0;e<c.length-1;++e)if(c[e][1]>c[e+1][1]){u=!1;break}if(!u){c.sort(((e,t)=>e[1]-t[1]));const e=new Array(c.length);for(let t=1;t<c.length;++t){let n=!0;(c[t-1][0]>c[t][0]||void 0!==e[t-1])&&(n=!1),n||(e[t]=l[c[t-1][0]])}const t=new Map;for(let n=0;n<e.length;++n){const i=e[n];void 0===i||t.has(i)||t.set(i,n)}const i=new Array(c.length);for(let e=0;e<c.length;++e)i[e]=l[c[e][0]];const s=l.slice();for(let n=0;0<t.size;++n){for(let n=1;n<c.length;++n)if(void 0!==e[n]&&void 0!==i[n]&&!t.has(i[n])){const r=i[n],o=l.indexOf(r);l.splice(o,1);const a=l.indexOf(e[n])+1;l.splice(a,0,r),t.delete(r)}if(c.length<n)break}const h=new Map;for(let e=0;e<l.length;++e){const t=l[e];h.set(t,e)}for(let e=0;e<n.length;++e){const t=n[e].boneWeight;if("number"==typeof t.boneIndices)t.boneIndices=h.get(s[t.boneIndices]);else{const e=t.boneIndices;for(let t=0;t<e.length;++t)e[t]=h.get(s[e[t]])}}for(let e=0;e<l.length;++e){const t=l[e];if(t.parentBoneIndex=h.get(s[t.parentBoneIndex]),"number"==typeof t.tailPosition&&(t.tailPosition=h.get(s[t.tailPosition])),t.appendTransform&&(t.appendTransform.parentIndex=h.get(s[t.appendTransform.parentIndex])),t.ik){t.ik.target=h.get(s[t.ik.target]);const e=t.ik.links;for(let t=0;t<e.length;++t)e[t].target=h.get(s[e[t].target])}}for(let e=0;e<r.length;++e){const t=r[e].frames;if(void 0!==t)for(let e=0;e<t.length;++e){const n=t[e];n.type===a.B.DisplayFrame.FrameData.FrameType.Bone&&(n.index=h.get(s[n.index]))}}if(void 0!==o)for(let e=0;e<o.length;++e){const t=o[e];t.boneIndex=h.get(s[t.boneIndex])}}let m=!1;for(let e=0;e<l.length;++e){let t=l[e];for(let n=0;n<l.length;++n){const i=l[n].parentBoneIndex;if(i===e){m=!0;break}if(t=l[i],void 0===t)break}if(m)break}if(m)for(let e=0;e<l.length;++e){let e=!1;for(let t=0;t<l.length;++t){const n=l[t];let i=n,r=n.transformOrder;for(;;){const t=l[i.parentBoneIndex];if(void 0===t)break;r<t.transformOrder&&(r=t.transformOrder,e=!0),i=t}n.transformOrder=r}if(!e)break}for(let e=0;e<l.length;++e){const t=l[e];t.flag&a.B.Bone.Flag.UseBoneIndexAsTailPosition?"number"!=typeof t.tailPosition&&(t.tailPosition=-1):"number"==typeof t.tailPosition&&(t.tailPosition=[0,0,0])}return l}static _ParseRigidBodies(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t={name:e.getDecoderString(20,!0),englishName:"",boneIndex:e.getInt16(),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};n.push(t)}return n}static _NormalizeRigidBodyPositions(e,t){for(let n=0;n<e.length;++n){const i=e[n],r=t[i.boneIndex<0?0:i.boneIndex].position,o=i.shapePosition;o[0]+=r[0],o[1]+=r[1],o[2]+=r[2]}}static _ParseJoints(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getDecoderString(20,!0),i=e.getInt32(),r=e.getInt32(),o=e.getFloat32Tuple(3),s=e.getFloat32Tuple(3),l=e.getFloat32Tuple(3),h=e.getFloat32Tuple(3),d=e.getFloat32Tuple(3),c=e.getFloat32Tuple(3),u=e.getFloat32Tuple(3),m=e.getFloat32Tuple(3),p={name:t,englishName:"",type:a.B.Joint.Type.Spring6dof,rigidbodyIndexA:i,rigidbodyIndexB:r,position:o,rotation:s,positionMin:l,positionMax:h,rotationMin:d,rotationMax:c,springPosition:u,springRotation:m};n.push(p)}return n}}},1494:(e,t,n)=>{n.d(t,{S:()=>i,n:()=>d});var i,r=n(3843),o=n(1860),a=n(9866),s=n(6837),l=n(5918),h=n(5501);!function(e){e[e.Opaque=o.Material.MATERIAL_OPAQUE]="Opaque",e[e.AlphaTest=o.Material.MATERIAL_ALPHATEST]="AlphaTest",e[e.AlphaBlend=o.Material.MATERIAL_ALPHABLEND]="AlphaBlend"}(i||(i={}));class d{_scene;_renderTargetTexture;_resultPixelsBuffer;constructor(e,t=512){this._scene=e;const n=e.getEngine(),i=this._renderTargetTexture=new l.RenderTargetTexture("texture_alpha_checker",t,e,{generateDepthBuffer:!1,generateStencilBuffer:!1,generateMipMaps:!1,type:r.Constants.TEXTURETYPE_UNSIGNED_BYTE,format:n.isWebGPU||n.version>1?r.Constants.TEXTUREFORMAT_RED:r.Constants.TEXTUREFORMAT_RGBA,doNotChangeAspectRatio:!0});i.noPrePassRenderer=!0,i.anisotropicFilteringLevel=1,i.renderParticles=!1,i.optimizeUVAllocation=!0,i.ignoreCameraViewport=!0,i.clearColor=new h.Color4(0,0,0,1),this._resultPixelsBuffer=new Uint8Array(t*t*4)}async _renderTexture(e,t,n){const i=d._GetShader(this._scene);i.setTexture("textureSampler",e);let r=null;null!==n&&(r=t.subMeshes,t.subMeshes=[t.subMeshes[n]]);const o=this._renderTargetTexture;o.renderList=[t],o.setMaterialForRendering(t,i);const a=t._nodeDataStorage._isEnabled,s=t._nodeDataStorage._isParentEnabled;for(;t._nodeDataStorage._isEnabled=!0,t._nodeDataStorage._isParentEnabled=!0,!o.isReadyForRendering()||!i.isReady();)if(t._nodeDataStorage._isEnabled=a,t._nodeDataStorage._isParentEnabled=s,await new Promise((e=>{setTimeout(e,0)})),null===o._texture)return new Uint8Array(0);o.render(!1,!1),t._nodeDataStorage._isParentEnabled=s,t._nodeDataStorage._isEnabled=a;const l=i.getEffect();t.geometry._releaseVertexArrayObject(l);const h=t.subMeshes;for(let e=0,t=h.length;e<t;++e)h[e]._removeDrawWrapper(o.renderPassId,!0);null!==r&&(t.subMeshes=r);const c=this._resultPixelsBuffer;return await o.readPixels(void 0,void 0,c),c}_blockRendering=!1;_taskQueue=[];async hasTranslucentFragmentsOnGeometry(e,t,n,r,o){if(!e.isReady())throw new Error("Texture is not ready");this._blockRendering&&await new Promise((e=>{this._taskQueue.push(e)})),this._blockRendering=!0;const a=await this._renderTexture(e,t,n);let s=0,l=0,h=0;for(let e=0;e<a.length;e+=4){const t=a[e];s=Math.max(s,t),0<t&&t<255&&(l+=t,h+=1)}0!==h&&(l/=h),this._blockRendering=!1;const d=this._taskQueue.shift();return void 0!==d&&d(),s<r?i.Opaque:l+o<s?i.AlphaTest:i.AlphaBlend}async hasFragmentsOnlyOpaqueOnGeometry(e,t,n){if(!e.isReady())throw new Error("Texture is not ready");this._blockRendering&&await new Promise((e=>{this._taskQueue.push(e)})),this._blockRendering=!0;const i=await this._renderTexture(e,t,n);for(let e=0;e<i.length;e+=4)if(0!==i[e]){this._blockRendering=!1;const e=this._taskQueue.shift();return void 0!==e&&e(),!1}this._blockRendering=!1;const r=this._taskQueue.shift();return void 0!==r&&r(),!0}dispose(){this._renderTargetTexture.dispose()}static _GetShader(e){if(!e._textureAlphaCheckerShader){const t=e.getEngine().isWebGPU?a.ShaderLanguage.WGSL:a.ShaderLanguage.GLSL,i=new s.ShaderMaterial("textureAlphaChecker",e,{vertex:"textureAlphaChecker",fragment:"textureAlphaChecker"},{needAlphaBlending:!1,needAlphaTesting:!1,attributes:["uv"],uniforms:[],samplers:["textureSampler"],shaderLanguage:t,extraInitializationsAsync:async()=>{t===a.ShaderLanguage.WGSL?await Promise.all([Promise.resolve().then(n.bind(n,1306)),Promise.resolve().then(n.bind(n,6876))]):await Promise.all([Promise.resolve().then(n.bind(n,9457)),Promise.resolve().then(n.bind(n,71))])}});i.backFaceCulling=!1,i.alphaMode=r.Constants.ALPHA_DISABLE,e.onDisposeObservable.add((()=>{e._textureAlphaCheckerShader?.dispose(),e._textureAlphaCheckerShader=null})),e._textureAlphaCheckerShader=i}return e._textureAlphaCheckerShader}static DisposeShader(e){e._textureAlphaCheckerShader?.dispose(),e._textureAlphaCheckerShader=null}}},1599:(e,t,n)=>{n.d(t,{C:()=>i});class i{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}},1755:e=>{e.exports=N},1822:e=>{e.exports=ge},1860:e=>{e.exports=w},1870:(e,t,n)=>{n.r(t),n.d(t,{mmdOutlineVertexShader:()=>o}),n(6462),n(8628),n(8296),n(2665),n(9535),n(6713),n(182),n(8474),n(3027),n(4585),n(4282),n(1122),n(9721),n(6018);const i="mmdOutlineVertexShader",r="\nattribute position: vec3f;attribute normal: vec3f;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\nuniform offset: f32;\n#include<instancesDeclaration>\nuniform viewport: vec2f;uniform view: mat3x3f;uniform viewProjection: mat4x4f;\n#ifdef WORLDPOS_REQUIRED\nuniform inverseViewProjection: mat4x4f;\n#endif\n#ifdef ALPHATEST\nvarying vUV: vec2f;uniform diffuseMatrix: mat4x4f; \n#ifdef UV1\nattribute uv: vec2f;\n#endif\n#ifdef UV2\nattribute uv2: vec2f;\n#endif\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\n@vertex\nfn main(input: VertexInputs)->FragmentInputs {var positionUpdated: vec3f=vertexInputs.position;var normalUpdated: vec3f=vertexInputs.normal;\n#ifdef UV1\nvar uvUpdated: vec2f=vertexInputs.uv;\n#endif\n#ifdef UV2\nvar uv2Updated: vec2f=vertexInputs.uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvar viewNormal: vec3f=uniforms.view*(mat3x3(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz)*normalUpdated);var projectedPosition: vec4f=uniforms.viewProjection*finalWorld*vec4f(positionUpdated,1.0);var screenNormal: vec2f=normalize(viewNormal.xy);projectedPosition=vec4f(\nprojectedPosition.xy+(screenNormal/(uniforms.viewport*0.25/*0.5 */)*uniforms.offset*projectedPosition.w),\nprojectedPosition.z,\nprojectedPosition.w\n);vertexOutputs.position=projectedPosition;\n#ifdef WORLDPOS_REQUIRED\nvar worldPos: vec4f=uniforms.inverseViewProjection*projectedPosition;\n#endif\n#ifdef ALPHATEST\n#ifdef UV1\nvertexOutputs.vUV=(uniforms.diffuseMatrix*vec4f(uvUpdated,1.0,0.0)).xy;\n#endif\n#ifdef UV2\nvertexOutputs.vUV=(uniforms.diffuseMatrix*vec4f(uv2Updated,1.0,0.0)).xy;\n#endif\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}\n";n(4234).ShaderStore.ShadersStoreWGSL[i]=r;const o={name:i,shader:r}},1949:e=>{e.exports=pe},2074:e=>{e.exports=ie},2273:e=>{e.exports=G},2478:e=>{e.exports=me},2524:(e,t,n)=>{e.exports=n.p+"49ba28737896155b6903.wasm"},2620:(e,t,n)=>{n.d(t,{t:()=>m});var i=n(1860),r=n(9866),o=n(4229),a=n(5501),s=n(169),l=n(735),h=n(2792),d=n(426),c=function(e,t,n,i){var r,o=arguments.length,a=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(a=(o<3?r(a):o>3?r(t,n,a):r(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a};class u{isMock=!0;sphereTexture=null;sphereTextureBlendMode=d.rw.Add;toonTexture=null;ignoreDiffuseWhenToonTextureIsNull=!1;applyAmbientColorToDiffuse=!0;clampAlpha=!0;textureMultiplicativeColor=new a.Color4(1,1,1,1);textureAdditiveColor=new a.Color4(0,0,0,0);sphereTextureMultiplicativeColor=new a.Color4(1,1,1,1);sphereTextureAdditiveColor=new a.Color4(0,0,0,0);toonTextureMultiplicativeColor=new a.Color4(1,1,1,1);toonTextureAdditiveColor=new a.Color4(0,0,0,0);useTextureColor=!1;useSphereTextureColor=!1;useToonTextureColor=!1}class m extends o.StandardMaterial{_pluginMaterial;_renderOutline=!1;outlineWidth=.01;outlineColor=new a.Color3(0,0,0);outlineAlpha=1;_disposed=!1;constructor(e,t,n=!1){super(e,t,n),this.specularColor=new a.Color3(0,0,0),(this._pluginMaterial=new u).ignoreDiffuseWhenToonTextureIsNull=!0,this._initPluginShaderSourceAsync(this._shaderLanguage)}async _initPluginShaderSourceAsync(e){const t=e===r.ShaderLanguage.GLSL?(await Promise.resolve().then(n.bind(n,3313))).MmdPluginMaterial:(await Promise.resolve().then(n.bind(n,5718))).MmdPluginMaterial;if(this._disposed)return;const i=this._pluginMaterial,o=this._pluginMaterial=new t(this);o.isEnabled=!0,o.sphereTexture=i.sphereTexture,o.sphereTextureBlendMode=i.sphereTextureBlendMode,o.toonTexture=i.toonTexture,o.ignoreDiffuseWhenToonTextureIsNull=i.ignoreDiffuseWhenToonTextureIsNull,o.applyAmbientColorToDiffuse=i.applyAmbientColorToDiffuse,o.clampAlpha=i.clampAlpha,o.textureMultiplicativeColor=i.textureMultiplicativeColor,o.textureAdditiveColor=i.textureAdditiveColor,o.sphereTextureMultiplicativeColor=i.sphereTextureMultiplicativeColor,o.sphereTextureAdditiveColor=i.sphereTextureAdditiveColor,o.toonTextureMultiplicativeColor=i.toonTextureMultiplicativeColor,o.toonTextureAdditiveColor=i.toonTextureAdditiveColor,o.useTextureColor=i.useTextureColor,o.useSphereTextureColor=i.useSphereTextureColor,o.useToonTextureColor=i.useToonTextureColor}dispose(e,t){super.dispose(e,t),this._disposed=!0}isReadyForSubMesh(e,t,n){return!this._pluginMaterial.isMock&&super.isReadyForSubMesh(e,t,n)}get sphereTexture(){return this._pluginMaterial.sphereTexture}set sphereTexture(e){this._pluginMaterial.sphereTexture=e}get sphereTextureBlendMode(){return this._pluginMaterial.sphereTextureBlendMode}set sphereTextureBlendMode(e){this._pluginMaterial.sphereTextureBlendMode=e}get toonTexture(){return this._pluginMaterial.toonTexture}set toonTexture(e){this._pluginMaterial.toonTexture=e}get ignoreDiffuseWhenToonTextureIsNull(){return this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull}set ignoreDiffuseWhenToonTextureIsNull(e){this._pluginMaterial.ignoreDiffuseWhenToonTextureIsNull=e}get applyAmbientColorToDiffuse(){return this._pluginMaterial.applyAmbientColorToDiffuse}set applyAmbientColorToDiffuse(e){this._pluginMaterial.applyAmbientColorToDiffuse=e}get clampAlpha(){return this._pluginMaterial.clampAlpha}set clampAlpha(e){this._pluginMaterial.clampAlpha=e}get textureMultiplicativeColor(){return this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureMultiplicativeColor}set textureMultiplicativeColor(e){this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureMultiplicativeColor=e}get textureAdditiveColor(){return this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureAdditiveColor}set textureAdditiveColor(e){this._pluginMaterial.useTextureColor=!0,this._pluginMaterial.textureAdditiveColor=e}get sphereTextureMultiplicativeColor(){return this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureMultiplicativeColor}set sphereTextureMultiplicativeColor(e){this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureMultiplicativeColor=e}get sphereTextureAdditiveColor(){return this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureAdditiveColor}set sphereTextureAdditiveColor(e){this._pluginMaterial.useSphereTextureColor=!0,this._pluginMaterial.sphereTextureAdditiveColor=e}get toonTextureMultiplicativeColor(){return this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureMultiplicativeColor}set toonTextureMultiplicativeColor(e){this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureMultiplicativeColor=e}get toonTextureAdditiveColor(){return this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureAdditiveColor}set toonTextureAdditiveColor(e){this._pluginMaterial.useToonTextureColor=!0,this._pluginMaterial.toonTextureAdditiveColor=e}get renderOutline(){return this._renderOutline}set renderOutline(e){e&&this.getScene().getMmdOutlineRenderer?.(),this._renderOutline=e}needAlphaBlending(){return!this._disableAlphaBlending&&(super.needAlphaBlending()||null!==this._pluginMaterial.sphereTexture&&this._pluginMaterial.sphereTextureBlendMode===d.rw.Multiply)}clone(e,t=!0,n=""){const i=l.SerializationHelper.Clone((()=>new m(e,this.getScene())),this,{cloneTexturesOnlyOnce:t});return i.name=e,i.id=e,this.stencil.copyTo(i.stencil),this._clonePlugins(i,n),i}static Parse(e,t,n){const r=l.SerializationHelper.Parse((()=>new m(e.name,t)),e,t,n);return e.stencil&&r.stencil.parse(e.stencil,t,n),i.Material._ParsePlugins(e,r,t,n),r}}c([(0,s.serialize)("renderOutline")],m.prototype,"_renderOutline",void 0),c([(0,s.serialize)()],m.prototype,"outlineWidth",void 0),c([(0,s.serializeAsColor3)()],m.prototype,"outlineColor",void 0),c([(0,s.serialize)()],m.prototype,"outlineAlpha",void 0),(0,h.RegisterClass)("BABYLON.MmdStandardMaterial",m)},2665:e=>{e.exports=ve},2792:e=>{e.exports=_},2828:e=>{e.exports=we},2929:e=>{e.exports=h},3027:e=>{e.exports=Re},3036:(e,t,n)=>{n.d(t,{V:()=>i});class i{static AdditionalUV1Kind="additionalUv1";static AdditionalUV2Kind="additionalUv2";static AdditionalUV3Kind="additionalUv3";static AdditionalUV4Kind="additionalUv4";static MatricesSdefCKind="matricesSdefC";static MatricesSdefRW0Kind="matricesSdefRW0";static MatricesSdefRW1Kind="matricesSdefRW1";static MatricesSdefR0Kind="matricesSdefR0";static MatricesSdefR1Kind="matricesSdefR1";static EdgeScaleKind="edgeScale"}},3272:e=>{e.exports=n},3301:e=>{e.exports=te},3313:(e,t,n)=>{n.r(t),n.d(t,{MmdPluginMaterial:()=>l});var i=n(9866),r=n(426);function o(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var a=n(9339),s=n(5041);class l extends r.ZL{isCompatible(e){return e===i.ShaderLanguage.GLSL}getCustomCode(e){if("vertex"===e){const e={};return e.CUSTOM_VERTEX_DEFINITIONS=a.B,e[`!${o("finalWorld=finalWorld*influence;")}`]=`\n${s.Z}\nfinalWorld=(finalWorld*influence);\n`,e}if("fragment"===e){const e={CUSTOM_FRAGMENT_DEFINITIONS:"\n#if defined(SPHERE_TEXTURE) && defined(NORMAL)\nuniform sampler2D sphereSampler;\n#endif\n#ifdef TOON_TEXTURE\nuniform sampler2D toonSampler;\n#endif\n"};e[`!${o("#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#endif")}`]="\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)\nuniform mat4 view;\n#elif defined(NORMAL) && defined(SPHERE_TEXTURE)\nuniform mat4 view;\n#endif\n",e.CUSTOM_FRAGMENT_MAIN_BEGIN="\n#ifdef TOON_TEXTURE\nvec3 toonNdl;\n#endif\n",e[`!${o("vec3 diffuseColor=vDiffuseColor.rgb;")}`]="\n#ifdef APPLY_AMBIENT_COLOR_TO_DIFFUSE\nvec3 diffuseColor=clamp(vDiffuseColor.rgb+vAmbientColor,0.0,1.0);\n#else\nvec3 diffuseColor=(vDiffuseColor.rgb);\n#endif\n",e[`!${o("float alpha=vDiffuseColor.a;")}`]="\n#ifdef CLAMP_ALPHA\nfloat alpha=clamp(vDiffuseColor.a,0.0,1.0);\n#else\nfloat alpha=vDiffuseColor.a;\n#endif\n",e[`!${o("baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);")}`]="\n#if defined(DIFFUSE) && defined(TEXTURE_COLOR)\nbaseColor=texture2D(diffuseSampler,(vDiffuseUV+uvOffset));baseColor.rgb=mix(\nvec3(1.0),\nbaseColor.rgb*textureMultiplicativeColor.rgb,\ntextureMultiplicativeColor.a\n);baseColor.rgb=clamp(\nbaseColor.rgb+(baseColor.rgb-vec3(1.0))*textureAdditiveColor.a,\n0.0,\n1.0\n)+textureAdditiveColor.rgb;\n#else\nbaseColor=texture2D(diffuseSampler,(vDiffuseUV+uvOffset));\n#endif\n",e[`!${o("struct lightingInfo\n{")}`]="\nstruct lightingInfo {\n#ifdef TOON_TEXTURE\n#ifndef NDOTL\nfloat ndl;\n#endif\nfloat isToon;\n#endif\n",e[`!${o("result.diffuse=ndl*diffuseColor*attenuation;")}`]="\n#ifdef TOON_TEXTURE\nresult.diffuse=diffuseColor*attenuation;result.ndl=ndl;result.isToon=1.0;\n#elif defined(IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED) \nresult.diffuse=diffuseColor*attenuation;\n#else\nresult.diffuse=(ndl*diffuseColor*attenuation);\n#endif\n",e[`!${o("diffuseBase+=info.diffuse*shadow;")}`]="\n#ifdef TOON_TEXTURE\ntoonNdl=vec3(clamp(info.ndl*shadow,0.02,0.98));toonNdl.r=texture2D(toonSampler,vec2(0.5,toonNdl.r)).r;toonNdl.g=texture2D(toonSampler,vec2(0.5,toonNdl.g)).g;toonNdl.b=texture2D(toonSampler,vec2(0.5,toonNdl.b)).b;\n#ifdef TOON_TEXTURE_COLOR\ntoonNdl=mix(\nvec3(1.0),\ntoonNdl*toonTextureMultiplicativeColor.rgb,\ntoonTextureMultiplicativeColor.a\n);toonNdl=clamp(\ntoonNdl+(toonNdl-vec3(1.0))*toonTextureAdditiveColor.a,\n0.0,\n1.0\n)+toonTextureAdditiveColor.rgb;\n#endif\ndiffuseBase+=mix(info.diffuse*shadow,toonNdl*info.diffuse,info.isToon);\n#elif defined(IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED)\ndiffuseBase+=info.diffuse;\n#else\ndiffuseBase+=(info.diffuse*shadow);\n#endif\n";const t="\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n";return e[`!${o(t)}`]=`\n#ifdef APPLY_AMBIENT_COLOR_TO_DIFFUSE\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#else\n${t.replace("diffuseBase","(diffuseBase)")}#endif\n`,e.CUSTOM_FRAGMENT_BEFORE_FOG="\n#if defined(NORMAL) && defined(SPHERE_TEXTURE)\nvec3 viewSpaceNormal=normalize(mat3(view)*vNormalW);vec2 sphereUV=viewSpaceNormal.xy*0.5+0.5;vec4 sphereReflectionColor=texture2D(sphereSampler,sphereUV);\n#ifdef SPHERE_TEXTURE_COLOR\nsphereReflectionColor.rgb=mix(\nvec3(1.0),\nsphereReflectionColor.rgb*sphereTextureMultiplicativeColor.rgb,\nsphereTextureMultiplicativeColor.a\n);sphereReflectionColor.rgb=clamp(\nsphereReflectionColor.rgb+(sphereReflectionColor.rgb-vec3(1.0))*sphereTextureAdditiveColor.a,\n0.0,\n1.0\n)+sphereTextureAdditiveColor.rgb;\n#endif\nsphereReflectionColor.rgb*=diffuseBase;\n#ifdef SPHERE_TEXTURE_BLEND_MODE_MULTIPLY\ncolor*=sphereReflectionColor;\n#elif defined(SPHERE_TEXTURE_BLEND_MODE_ADD)\ncolor=vec4(color.rgb+sphereReflectionColor.rgb,color.a);\n#endif\n#endif\n",e}return null}getUniforms(e){return{...super.getUniforms(e),fragment:"\n#if defined(DIFFUSE) && defined(TEXTURE_COLOR)\nuniform vec4 textureMultiplicativeColor;uniform vec4 textureAdditiveColor;\n#endif\n#if defined(SPHERE_TEXTURE) && defined(SPHERE_TEXTURE_COLOR)\nuniform vec4 sphereTextureMultiplicativeColor;uniform vec4 sphereTextureAdditiveColor;\n#endif\n#if defined(TOON_TEXTURE) && defined(TOON_TEXTURE_COLOR)\nuniform vec4 toonTextureMultiplicativeColor;uniform vec4 toonTextureAdditiveColor;\n#endif\n"}}}},3357:(e,t,n)=>{n.r(t),n.d(t,{mmdOutlinePixelShader:()=>o}),n(10),n(1409),n(2828),n(3635);const i="mmdOutlinePixelShader",r="\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nuniform vec4 color;\n#ifdef ALPHATEST\nvarying vec2 vUV;uniform sampler2D diffuseSampler;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#include<logDepthFragment>\ngl_FragColor=color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";n(4234).ShaderStore.ShadersStore[i]=r;const o={name:i,shader:r}},3376:t=>{t.exports=e},3442:(e,t,n)=>{n.d(t,{$:()=>u});var i=n(9125),r=n(6320),o=n(6429),a=n(8619),s=n(6377),l=n(3929),h=n(4751),d=n(577);class c{lengthComputable;total;_onProgress;_unprocessedTasks;_processingTasks;_endedTaskNames;_endedTasksTotal;constructor(e,t,n){this.lengthComputable=e;let i=0;for(let e=0;e<t.length;++e)i+=t[e].cost;this.total=i,this._onProgress=n;const r=this._unprocessedTasks=new Map;for(let e=0;e<t.length;++e){if(r.has(t[e].name))throw new Error(`Duplicated task name: ${t[e].name}`);r.set(t[e].name,t[e])}this._processingTasks=new Map,this._endedTaskNames=new Set,this._endedTasksTotal=0}_getTaskState(e){let t=this._processingTasks.get(e);if(void 0===t){const n=this._unprocessedTasks.get(e);if(void 0===n){if(this._endedTaskNames.has(e))return null;throw new Error(`Task not found: ${e}`)}t={name:n.name,cost:n.cost,progress:0},this._processingTasks.set(e,t),this._unprocessedTasks.delete(e)}return t}processTask(e,t){const n=this._getTaskState(e);null!==n&&(n.progress+=t,n.progress>=n.cost&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=n.cost))}setTaskProgress(e,t){const n=this._getTaskState(e);return null!==n&&(n.progress=t,n.progress>=n.cost&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=n.cost),!0)}setTaskProgressRatio(e,t,n){const i=this._getTaskState(e);return null!==i&&(i.progress=n?Math.floor(i.cost*t):i.cost*t,i.progress>=i.cost&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=i.cost),!0)}endTask(e){const t=this._getTaskState(e);null!==t&&(this._processingTasks.delete(e),this._endedTaskNames.add(e),this._endedTasksTotal+=t.cost)}invokeProgressEvent(){null!==this._onProgress&&this._onProgress({lengthComputable:this.lengthComputable,loaded:this.loaded,total:this.total})}get loaded(){let e=this._endedTasksTotal;for(const[t,n]of this._processingTasks)e+=n.progress;return e}}class u{name;extensions;materialBuilder;useSdef;buildSkeleton;buildMorph;boundingBoxMargin;preserveSerializationData;_loggingEnabled;log;warn;error;static _SharedStandardMaterialBuilder=new d.c;constructor(e,t,n={},i){this.name=e,this.extensions=t,i=i??{materialBuilder:u._SharedStandardMaterialBuilder,useSdef:!0,buildSkeleton:!0,buildMorph:!0,boundingBoxMargin:10,preserveSerializationData:!1,loggingEnabled:!1},this.materialBuilder=n.materialBuilder??i.materialBuilder,this.useSdef=n.useSdef??i.useSdef,this.buildSkeleton=n.buildSkeleton??i.buildSkeleton,this.buildMorph=n.buildMorph??i.buildMorph,this.boundingBoxMargin=n.boundingBoxMargin??i.boundingBoxMargin,this.preserveSerializationData=n.preserveSerializationData??i.preserveSerializationData,this._loggingEnabled=n.loggingEnabled??i.loggingEnabled,this._loggingEnabled?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}importMeshAsync(e,t,n,i,r,o){return this._loadAsyncInternal(t,null,n,i,r)}loadAsync(e,t,n,i,r){return this._loadAsyncInternal(e,null,t,n,i).then((()=>{}))}loadAssetContainerAsync(e,t,n,r,o){const a=new i.AssetContainer(e);return this._loadAsyncInternal(e,a,t,n,r).then((()=>a))}async _loadAsyncInternal(e,t,n,i,r){const o=await this._parseFileAsync(n.arrayBuffer),a=new c(!0,this._getProgressTaskCosts(n,o),r??null);a.endTask("Parse"),a.invokeProgressEvent(),e._blockEntityCollection=!!t;const s=new l.Mesh(o.header.modelName,e);s._parentContainer=t,e._blockEntityCollection=!1,s.setEnabled(!1);const h=await this._buildGeometryAsync(n,o,s,e,t,a),d=n.preserveSerializationData?new Map:null,{materials:u,multiMaterials:m,textureLoadPromise:p}=await this._buildMaterialAsync(n,o,s,h.meshes,d,e,t,i,a),_=[];let g=null;n.buildSkeleton?g=await this._buildSkeletonAsync(n,o,h.meshes,e,t,_,a):a.endTask("Build Skeleton");const f=[];let b=null;if(n.buildMorph&&(b=await this._buildMorphAsync(n,o,h,e,t,f,a)),0!==n.boundingBoxMargin&&this._applyBoundingBoxMargin(h.meshes,n.boundingBoxMargin),s.metadata={isMmdModel:!0,header:{modelName:o.header.modelName,englishModelName:o.header.englishModelName,comment:o.header.comment,englishComment:o.header.englishComment},bones:_,morphs:f,rigidBodies:o.rigidBodies,joints:o.joints,meshes:h.meshes,materials:u,skeleton:g},n.preserveSerializationData){const e=[],t=o.materials;for(let n=0;n<t.length;++n){const i=t[n];e.push({englishName:i.englishName,comment:i.comment})}s.metadata={...s.metadata,containsSerializationData:!0,textureNameMap:d,materialsMetadata:e,displayFrames:o.displayFrames}}return a.invokeProgressEvent(),await p,a.endTask("Texture Load"),a.invokeProgressEvent(),s.setEnabled(!0),null!==t&&(t.rootNodes.push(s),t.meshes.push(s,...h.meshes),t.geometries.push(...h.geometries),t.materials.push(...u),t.multiMaterials.push(...m),null!==g&&t.skeletons.push(g),null!==b&&t.morphTargetManagers.push(...b)),{meshes:[s,...h.meshes],particleSystems:[],skeletons:null!==g?[g]:[],animationGroups:[],transformNodes:[],geometries:h.geometries,lights:[],spriteManagers:[]}}_getProgressTaskCosts(e,t){return[{name:"Parse",cost:Math.floor(e.arrayBuffer.byteLength/100)},{name:"Build Material",cost:100*t.materials.length},{name:"Build Skeleton",cost:e.buildSkeleton?100*t.bones.length:0},{name:"Texture Load",cost:3e4*t.textures.length}]}async _buildSkeletonAsync(e,t,n,i,a,l,h){const d=e.preserveSerializationData;i._blockEntityCollection=!!a;const c=new o.Skeleton(t.header.modelName,t.header.modelName+"_skeleton",i);c._parentContainer=a,i._blockEntityCollection=!1;{const e=t.bones,n=[],i=[];for(let t=0;t<e.length;++t){const o=e[t];let a=!1;if(0<=o.parentBoneIndex&&o.parentBoneIndex<e.length){let n=o.parentBoneIndex;for(let i=0;i<e.length&&-1!==n;++i){if(n===t){a=!0,this.warn(`Bone loop detected. Ignore Parenting. Bone index: ${t}`);break}n=e[n].parentBoneIndex}t<=o.parentBoneIndex&&this.warn(`Parent bone index is greater equal than child bone index. Bone index: ${t} Parent bone index: ${o.parentBoneIndex}`)}else-1!==o.parentBoneIndex&&this.error(`Parent bone index is out of range. Bone index: ${t} Parent bone index: ${o.parentBoneIndex}`);const h=o.position,u=new s.Vector3(h[0],h[1],h[2]);if(0<=o.parentBoneIndex&&o.parentBoneIndex<e.length&&!a){const t=e[o.parentBoneIndex];u.x-=t.position[0],u.y-=t.position[1],u.z-=t.position[2]}const m=s.Matrix.Identity().setTranslation(u),p=new r.Bone(o.name,c,void 0,m,void 0,void 0,t);n.push(p),i.push(a);const _={name:o.name,englishName:o.englishName,parentBoneIndex:o.parentBoneIndex,transformOrder:o.transformOrder,flag:o.flag,appendTransform:o.appendTransform,axisLimit:o.axisLimit,ik:o.ik,...d?{tailPosition:o.tailPosition,localVector:o.localVector,externalParentTransform:o.externalParentTransform}:void 0};l.push(_)}for(let t=0;t<n.length;++t){const r=e[t],o=n[t];0<=r.parentBoneIndex&&r.parentBoneIndex<n.length&&!i[t]&&o.setParent(n[r.parentBoneIndex],!1)}for(let e=0;e<n.length;++e){const t=n[e];null===t.getParent()&&t._updateAbsoluteBindMatrices()}}h.endTask("Build Skeleton"),h.invokeProgressEvent();for(let e=0;e<n.length;++e)n[e].skeleton=c;return c}_applyBoundingBoxMargin(e,t){for(let n=0;n<e.length;++n){const i=e[n];if(void 0===i.subMeshes)continue;const r=i.subMeshes;for(let e=0;e<r.length;++e){const n=r[e],i=n.getBoundingInfo();n.setBoundingInfo(new a.BoundingInfo((new s.Vector3).setAll(-t).addInPlace(i.minimum),(new s.Vector3).setAll(t).addInPlace(i.maximum)))}const o=i.getBoundingInfo();i.setBoundingInfo(new a.BoundingInfo((new s.Vector3).setAll(-t).addInPlace(o.minimum),(new s.Vector3).setAll(t).addInPlace(o.maximum))),i._updateBoundingInfo()}}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){h.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){h.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){h.Logger.Error(e)}_errorDisabled(){}}},3466:e=>{e.exports=ee},3635:e=>{e.exports=Ae},3789:(e,t,n)=>{n.d(t,{I:()=>i});const i={name:"pmx",extensions:{".pmx":{isBinary:!0}}}},3807:e=>{e.exports=O},3843:e=>{e.exports=t},3898:e=>{e.exports=E},3929:e=>{e.exports=T},4044:e=>{e.exports=J},4122:(e,t,n)=>{n.d(t,{Z:()=>i});const i="\n#ifndef SDEFVERTEX\n#define SDEFVERTEX\n#if !defined(BAKED_VERTEX_ANIMATION_TEXTURE) && defined(SDEF)\n#if NUM_BONE_INFLUENCERS>0\n{let weight0: f32=vertexInputs.matricesWeights[0];let weight1: f32=vertexInputs.matricesWeights[1];\n#ifdef BONETEXTURE\nlet transformMatrix0: mat4x4f=readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[0]);let transformMatrix1: mat4x4f=readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[1]);\n#else\nlet transformMatrix0: mat4x4f=uniforms.mBones[int(vertexInputs.matricesIndices[0])];let transformMatrix1: mat4x4f=uniforms.mBones[int(vertexInputs.matricesIndices[1])];\n#endif\nlet slerpedRotationMatrix: mat3x3f=quaternionToRotationMatrix(slerp(\nrotationMatrixToQuaternion(mat3x3f(transformMatrix0[0].xyz,transformMatrix0[1].xyz,transformMatrix0[2].xyz)),\nrotationMatrixToQuaternion(mat3x3f(transformMatrix1[0].xyz,transformMatrix1[1].xyz,transformMatrix1[2].xyz)),\nweight1\n));var sdefInflunce: mat4x4f=mat4x4f(\nvec4f(1.0,0.0,0.0,0.0),\nvec4f(0.0,1.0,0.0,0.0),\nvec4f(0.0,0.0,1.0,0.0),\nvec4f(-vertexInputs.matricesSdefC,1.0)\n);let rotationMatrix: mat4x4f=mat4x4f(\nvec4f(slerpedRotationMatrix[0],0.0),\nvec4f(slerpedRotationMatrix[1],0.0),\nvec4f(slerpedRotationMatrix[2],0.0),\nvec4f(0.0,0.0,0.0,1.0)\n);sdefInflunce=rotationMatrix*sdefInflunce;let positionOffset: vec3f =\n(transformMatrix0*vec4f(vertexInputs.matricesSdefRW0,1)).xyz*weight0 +\n(transformMatrix1*vec4f(vertexInputs.matricesSdefRW1,1)).xyz*weight1;sdefInflunce[3]+=vec4f(positionOffset,0.0);let useLinearDeform: f32=step(0.0,-abs(vertexInputs.matricesSdefRW0.x));influence=mat4x4f(\nmix(sdefInflunce[0],influence[0],useLinearDeform),\nmix(sdefInflunce[1],influence[1],useLinearDeform),\nmix(sdefInflunce[2],influence[2],useLinearDeform),\nmix(sdefInflunce[3],influence[3],useLinearDeform)\n);}\n#endif\n#endif\n#endif\n"},4184:e=>{e.exports=Le},4229:e=>{e.exports=A},4232:e=>{e.exports=P},4234:e=>{e.exports=be},4268:e=>{e.exports=c},4282:e=>{e.exports=Ce},4398:e=>{e.exports=$},4439:e=>{e.exports=H},4570:e=>{e.exports=v},4585:e=>{e.exports=Ee},4619:e=>{e.exports=g},4751:e=>{e.exports=S},4756:(e,t,n)=>{n.d(t,{PmxLoader:()=>s});var i=n(6532),r=n(9722),o=n(4784),a=n(3789);class s extends o.F{constructor(e,t){super(a.I.name,a.I.extensions,e,t)}createPlugin(e){return new s(e.mmdmodel,this)}async _parseFileAsync(e){return await r.X.ParseAsync(e,this).catch((e=>Promise.reject(e)))}}(0,i.registerSceneLoaderPlugin)(new s)},4784:(e,t,n)=>{n.d(t,{F:()=>_});var i=n(3376),r=n(3898),o=n(3929),a=n(6867),s=n(7466),l=n(8698),h=n(1755),d=n(3036),c=n(3442),u=n(5932),m=n(6910),p=n(9481);class _ extends c.${referenceFiles;constructor(e,t,n={},i){super(e,t,n,i),this.referenceFiles=n.referenceFiles??i?.referenceFiles??[]}loadFile(e,t,n,i,r,o,a){const s=this.materialBuilder,l=this.useSdef,h=this.buildSkeleton,d=this.buildMorph,c=this.boundingBoxMargin,m=this.referenceFiles,p=this.preserveSerializationData;return e._loadFile(t,((e,n)=>{const r={arrayBuffer:e,pmFileId:t instanceof File?u.R.GetId(t).toString():t,materialBuilder:s,useSdef:l,buildSkeleton:h,buildMorph:d,boundingBoxMargin:c,referenceFiles:m,preserveSerializationData:p};i(r,n)}),r,!0,o,a)}_getProgressTaskCosts(e,t){const n=super._getProgressTaskCosts(e,t);if(n.push({name:"Build Geometry",cost:t.indices.length}),e.buildMorph){let e=0;const i=t.morphs;for(let t=0;t<i.length;++t){const n=i[t];n.type!==m.B.Morph.Type.VertexMorph&&n.type!==m.B.Morph.Type.UvMorph&&n.type!==m.B.Morph.Type.AdditionalUvMorph1&&n.type!==m.B.Morph.Type.AdditionalUvMorph2&&n.type!==m.B.Morph.Type.AdditionalUvMorph3&&n.type!==m.B.Morph.Type.AdditionalUvMorph4||(e+=n.indices.length)}n.push({name:"Build Morph",cost:e})}return n}async _buildGeometryAsync(e,t,n,i,l,h){const c=[],u=[];let _;const g=[];{_=t.indices instanceof Uint8Array||t.indices instanceof Uint16Array?new Uint16Array(t.indices.length):new Uint32Array(t.indices.length);{const e=t.indices;for(let t=0;t<_.length;t+=3)_[t+0]=e[t+0],_[t+1]=e[t+2],_[t+2]=e[t+1]}const f=t.materials;let b=0;for(let y=0;y<f.length;++y){const w=f[y],A=new Uint8Array(t.vertices.length);let M=0;{const e=w.indexCount;for(let t=0;t<e;++t){const e=_[b+t];0===A[e]&&(A[e]=1,M+=1)}A.fill(0)}const T=new a.VertexData,x=[];if(e.preserveSerializationData)for(let e=0;e<t.header.additionalVec4Count;++e)x.push(new Float32Array(4*M));let v=null,I=null,B=null,P=null,S=null;e.buildSkeleton&&e.useSdef&&(v=new Float32Array(3*M),I=new Float32Array(3*M),B=new Float32Array(3*M),P=new Float32Array(3*M),S=new Float32Array(3*M));let R=!1,E=null;e.preserveSerializationData&&(E=new Float32Array(M));const C=new t.indices.constructor(t.vertices.length);{const n=new Float32Array(3*M),i=new Float32Array(3*M),r=new Float32Array(2*M),o=new _.constructor(w.indexCount);let a=null,l=null;e.buildSkeleton&&(a=new Float32Array(4*M),l=new Float32Array(4*M));let d=performance.now(),c=0,u=0;const p=w.indexCount;for(let g=0;g<p;++g){const p=_[b+g];if(0===A[p]){A[p]=1;const s=t.vertices[p];n[3*c+0]=s.position[0],n[3*c+1]=s.position[1],n[3*c+2]=s.position[2],i[3*c+0]=s.normal[0],i[3*c+1]=s.normal[1],i[3*c+2]=s.normal[2],r[2*c+0]=s.uv[0],r[2*c+1]=1-s.uv[1];const h=s.additionalVec4;for(let e=0;e<x.length;++e)x[e][4*c+0]=h[e][0],x[e][4*c+1]=h[e][1],x[e][4*c+2]=h[e][2],x[e][4*c+3]=h[e][3];if(e.buildSkeleton)switch(s.weightType){case m.B.Vertex.BoneWeightType.Bdef1:{const e=s.boneWeight;a[4*c+0]=e.boneIndices,a[4*c+1]=0,a[4*c+2]=0,a[4*c+3]=0,l[4*c+0]=1,l[4*c+1]=0,l[4*c+2]=0,l[4*c+3]=0}break;case m.B.Vertex.BoneWeightType.Bdef2:{const e=s.boneWeight;a[4*c+0]=e.boneIndices[0],a[4*c+1]=e.boneIndices[1],a[4*c+2]=0,a[4*c+3]=0,l[4*c+0]=e.boneWeights,l[4*c+1]=1-e.boneWeights,l[4*c+2]=0,l[4*c+3]=0}break;case m.B.Vertex.BoneWeightType.Bdef4:case m.B.Vertex.BoneWeightType.Qdef:{const e=s.boneWeight;a[4*c+0]=e.boneIndices[0],a[4*c+1]=e.boneIndices[1],a[4*c+2]=e.boneIndices[2],a[4*c+3]=e.boneIndices[3],l[4*c+0]=e.boneWeights[0],l[4*c+1]=e.boneWeights[1],l[4*c+2]=e.boneWeights[2],l[4*c+3]=e.boneWeights[3]}break;case m.B.Vertex.BoneWeightType.Sdef:{const t=s.boneWeight;a[4*c+0]=t.boneIndices[0],a[4*c+1]=t.boneIndices[1],a[4*c+2]=0,a[4*c+3]=0;const n=t.boneWeights,i=n.boneWeight0,r=1-i;if(l[4*c+0]=i,l[4*c+1]=r,l[4*c+2]=0,l[4*c+3]=0,e.useSdef){const e=n.c[0],t=n.c[1],o=n.c[2];let a=n.r0[0],s=n.r0[1],l=n.r0[2],h=n.r1[0],d=n.r1[1],u=n.r1[2];I[3*c+0]=a,I[3*c+1]=s,I[3*c+2]=l,B[3*c+0]=h,B[3*c+1]=d,B[3*c+2]=u;const m=a*i+h*r,p=s*i+d*r,_=l*i+u*r;a=e+a-m,s=t+s-p,l=o+l-_,h=e+h-m,d=t+d-p,u=o+u-_;const g=.5*(e+a),f=.5*(t+s),b=.5*(o+l),y=.5*(e+h),w=.5*(t+d),A=.5*(o+u);v[3*c+0]=e,v[3*c+1]=t,v[3*c+2]=o,P[3*c+0]=g,P[3*c+1]=f,P[3*c+2]=b,S[3*c+0]=y,S[3*c+1]=w,S[3*c+2]=A,R=!0}}}e.preserveSerializationData&&(E[c]=s.edgeScale),o[u]=c,C[p]=c,u+=1,c+=1}else o[u]=C[p],u+=1;(b+g)%1e4==0&&100<performance.now()-d&&(h.setTaskProgress("Build Geometry",b+g),h.invokeProgressEvent(),await s.Tools.DelayAsync(0),d=performance.now())}T.positions=n,T.normals=i,T.uvs=r,T.indices=o,T.matricesIndices=a,T.matricesWeights=l}i._blockEntityCollection=!!l;const O=new(e.useSdef&&R?p.k:o.Mesh)(w.name,i);O._parentContainer=l,i._blockEntityCollection=!1,O.setParent(n),c.push(O),i._blockEntityCollection=!!l;const k=new r.Geometry(t.header.modelName,i,T,!1);k._parentContainer=l,i._blockEntityCollection=!1,e.preserveSerializationData&&(1<=x.length&&k.setVerticesData(d.V.AdditionalUV1Kind,x[0],!1,4),2<=x.length&&k.setVerticesData(d.V.AdditionalUV2Kind,x[1],!1,4),3<=x.length&&k.setVerticesData(d.V.AdditionalUV3Kind,x[2],!1,4),4<=x.length&&k.setVerticesData(d.V.AdditionalUV4Kind,x[3],!1,4)),e.useSdef&&R&&(k.setVerticesData(d.V.MatricesSdefCKind,v,!1,3),k.setVerticesData(d.V.MatricesSdefR0Kind,I,!1,3),k.setVerticesData(d.V.MatricesSdefR1Kind,B,!1,3),k.setVerticesData(d.V.MatricesSdefRW0Kind,P,!1,3),k.setVerticesData(d.V.MatricesSdefRW1Kind,S,!1,3)),e.preserveSerializationData&&k.setVerticesData(d.V.EdgeScaleKind,E,!1,1),k.applyToMesh(O),u.push(k),g.push({map:C,isReferencedVertex:A}),b+=w.indexCount}}return h.endTask("Build Geometry"),h.invokeProgressEvent(),{meshes:c,geometries:u,indices:_,indexToSubmehIndexMaps:g}}async _buildMaterialAsync(e,t,n,i,r,o,a,s,l){let h;const d=new Array(t.textures.length);for(let e=0;e<d.length;++e)d[e]={noMipmap:!1,invertY:!0,samplingMode:void 0,imagePathIndex:e};const c=[];for(let e=0;e<i.length;++e)c.push([i[e]]);const u=new Promise((u=>{h=e.materialBuilder.buildMaterials(n.uniqueId,t.materials,d,t.textures,s,"file:"+e.pmFileId+"_",e.referenceFiles,c,i,o,a,r,this,(e=>{e.lengthComputable&&(l.setTaskProgressRatio("Texture Load",e.loaded/e.total,!0),l.invokeProgressEvent())}),(()=>u()))})),m=Array.isArray(h)?h:await h;for(let e=0;e<m.length;++e)i[e].material=m[e];return l.endTask("Build Material"),l.invokeProgressEvent(),{materials:m,multiMaterials:[],textureLoadPromise:u}}async _buildMorphAsync(e,t,n,r,o,a,d){const c=e.preserveSerializationData,u=new Int32Array(t.vertices.length).fill(-1),p=new Map,_=n.indices;{const e=t.materials;let n=0;for(let t=0;t<e.length;++t){const i=e[t].indexCount;for(let e=0;e<i;++e){const i=_[n+e];if(-1===u[i])u[i]=t;else if(-2===u[i]){const e=p.get(i);e.includes(t)||e.push(t)}else u[i]!==t&&(p.set(i,[u[i],t]),u[i]=-2)}n+=i}}const g=n.indexToSubmehIndexMaps,f=t.morphs,b=n.geometries,y=new Array(b.length);for(let e=0;e<y.length;++e)y[e]=[];let w=0,A=performance.now();for(let e=0;e<f.length;++e){const t=f[e],n=[],o=[];switch(t.type){case m.B.Morph.Type.GroupMorph:case m.B.Morph.Type.BoneMorph:case m.B.Morph.Type.MaterialMorph:a.push(t);break;case m.B.Morph.Type.VertexMorph:case m.B.Morph.Type.UvMorph:case m.B.Morph.Type.AdditionalUvMorph1:case m.B.Morph.Type.AdditionalUvMorph2:case m.B.Morph.Type.AdditionalUvMorph3:case m.B.Morph.Type.AdditionalUvMorph4:a.push({name:t.name,englishName:t.englishName,category:t.category,type:t.type,morphTargets:n,...c?{elements:o}:void 0});break;default:this.warn(`Unsupported morph type: ${t.type}`)}if(t.type!==m.B.Morph.Type.VertexMorph&&t.type!==m.B.Morph.Type.UvMorph&&t.type!==m.B.Morph.Type.AdditionalUvMorph1&&t.type!==m.B.Morph.Type.AdditionalUvMorph2&&t.type!==m.B.Morph.Type.AdditionalUvMorph3&&t.type!==m.B.Morph.Type.AdditionalUvMorph4)continue;const h=[];{const e=t.indices;for(let t=0;t<e.length;++t){const n=e[t],i=u[n];if(-1!==i)if(-2===i){const e=p.get(n);for(let t=0;t<e.length;++t){const n=e[t];h.includes(n)||h.push(n)}}else h.includes(i)||h.push(i)}if(t.type!==m.B.Morph.Type.AdditionalUvMorph1&&t.type!==m.B.Morph.Type.AdditionalUvMorph2&&t.type!==m.B.Morph.Type.AdditionalUvMorph3&&t.type!==m.B.Morph.Type.AdditionalUvMorph4)for(let e=0;e<h.length;++e){const i=new l.MorphTarget(t.name,0,r);n.push(i),y[h[e]].push(i)}}if(t.type===m.B.Morph.Type.VertexMorph)for(let e=0;e<h.length;++e){const r=h[e],a=b[r],s=new Float32Array(a.getVerticesData(i.VertexBuffer.PositionKind)),l=t.indices,d=t.positions,u=g[r].map,m=g[r].isReferencedVertex;if(c){let e=0;for(let t=0;t<l.length;++t){if(0===m[l[t]])continue;const n=u[l[t]];s[3*n+0]+=d[3*t+0],s[3*n+1]+=d[3*t+1],s[3*n+2]+=d[3*t+2],e+=1}const t=new Int32Array(e),n=new Float32Array(3*e);for(let e=0,i=0;e<l.length;++e){if(0===m[l[e]])continue;const r=u[l[e]];t[i]=r,n[3*i+0]=d[3*e+0],n[3*i+1]=d[3*e+1],n[3*i+2]=d[3*e+2],i+=1}o.push({meshIndex:r,indices:t,offsets:n})}else for(let e=0;e<l.length;++e){if(0===m[l[e]])continue;const t=u[l[e]];s[3*t+0]+=d[3*e+0],s[3*t+1]+=d[3*e+1],s[3*t+2]+=d[3*e+2]}n[e].setPositions(s)}else if(t.type===m.B.Morph.Type.UvMorph)for(let e=0;e<h.length;++e){const r=h[e],a=b[r],s=new Float32Array(a.getVerticesData(i.VertexBuffer.UVKind)),l=t.indices,d=t.offsets,u=g[r].map,m=g[r].isReferencedVertex;if(c){let e=0;for(let t=0;t<l.length;++t){if(0===m[l[t]])continue;const n=u[l[t]];s[2*n+0]+=d[4*t+0],s[2*n+1]-=d[4*t+1],e+=1}const t=new Int32Array(e),n=new Float32Array(4*e);for(let e=0,i=0;e<l.length;++e){if(0===m[l[e]])continue;const r=u[l[e]];t[i]=r,n[4*i+0]=d[4*e+0],n[4*i+1]=-d[4*e+1],n[4*i+2]=d[4*e+2],n[4*i+3]=d[4*e+3],i+=1}o.push({meshIndex:r,indices:t,offsets:n})}else for(let e=0;e<l.length;++e){if(0===m[l[e]])continue;const t=u[l[e]];s[2*t+0]+=d[4*e+0],s[2*t+1]-=d[4*e+1]}n[e].setUVs(s)}else if(c)for(let e=0;e<h.length;++e){const n=h[e],i=g[n].map,r=g[n].isReferencedVertex,a=t.indices,s=t.offsets;let l=0;for(let e=0;e<a.length;++e)0!==r[a[e]]&&(l+=1);const d=new Int32Array(l),c=new Float32Array(4*l);for(let e=0,t=0;e<a.length;++e){if(0===r[a[e]])continue;const n=i[a[e]];d[t]=n,c[4*t+0]=s[4*e+0],c[4*t+1]=s[4*e+1],c[4*t+2]=s[4*e+2],c[4*t+3]=s[4*e+3],t+=1}o.push({meshIndex:n,indices:d,offsets:c})}w+=t.indices.length,100<performance.now()-A&&(d.setTaskProgress("Build Morph",w),d.invokeProgressEvent(),await s.Tools.DelayAsync(0),A=performance.now())}d.endTask("Build Morph");const M=[],T=n.meshes;for(let e=0;e<y.length;++e){const t=y[e];if(0===t.length)continue;r._blockEntityCollection=!!o;const n=new h.MorphTargetManager(r);n._parentContainer=o,r._blockEntityCollection=!1,n.enablePositionMorphing=!1,n.enableNormalMorphing=!1,n.enableTangentMorphing=!1,n.enableUVMorphing=!1,n.enableUV2Morphing=!1,n.areUpdatesFrozen=!0;for(let e=0;e<t.length;++e){const i=t[e];n.addTarget(i),i.hasPositions&&(n.enablePositionMorphing=!0),i.hasUVs&&(n.enableUVMorphing=!0)}if(n.enablePositionMorphing){const n=b[e].getVerticesData(i.VertexBuffer.PositionKind);for(let e=0;e<t.length;++e){const i=t[e];i.hasPositions||i.setPositions(n)}}if(n.enableUVMorphing){const n=b[e].getVerticesData(i.VertexBuffer.UVKind);for(let e=0;e<t.length;++e){const i=t[e];i.hasUVs||i.setUVs(n)}}n.areUpdatesFrozen=!1,M.push(n),T[e].morphTargetManager=n}return M}}},4870:(e,t,n)=>{n.d(t,{BpmxLoader:()=>A});var i=n(3376),r=n(6532),o=n(5527),a=n(3898),s=n(3929),l=n(6867),h=n(3807),d=n(7466),c=n(8698),u=n(1755),m=n(3036),p=n(3442),_=n(5932),g=n(6910),f=n(9481),b=n(6343),y=n(7556),w=n(5272);class A extends p.${constructor(e,t){super(b.S.name,b.S.extensions,e,t)}loadFile(e,t,n,i,r,o,a){const s=this.materialBuilder,l=this.useSdef,h=this.buildSkeleton,d=this.buildMorph,c=this.boundingBoxMargin,u=this.preserveSerializationData;return e._loadFile(t,((e,n)=>{const r={arrayBuffer:e,pmFileId:t instanceof File?_.R.GetId(t).toString():t,materialBuilder:s,useSdef:l,buildSkeleton:h,buildMorph:d,boundingBoxMargin:c,preserveSerializationData:u};i(r,n)}),r,!0,o,a)}createPlugin(e){return new A(e.mmdmodel,this)}async _parseFileAsync(e){return await w.N.ParseAsync(e,this).catch((e=>Promise.reject(e)))}_getProgressTaskCosts(e,t){const n=super._getProgressTaskCosts(e,t);let i=0;for(let e=0;e<t.geometries.length;++e)i+=t.geometries[e].positions.length;if(n.push({name:"Build Geometry",cost:i}),e.buildMorph){let e=0;const i=t.morphs;for(let t=0;t<i.length;++t){const n=i[t];if(n.type!==g.B.Morph.Type.VertexMorph&&n.type!==g.B.Morph.Type.UvMorph)continue;const r=n.elements;for(let t=0;t<r.length;++t)e+=r[t].indices.length}n.push({name:"Build Morph",cost:e})}return n}async _buildGeometryAsync(e,t,n,i,r,o){const h=[],c=[];let u=performance.now(),p=0;const _=t.geometries;for(let g=0;g<_.length;++g){const b=_[g],y=b.skinning,w=new l.VertexData;w.positions=b.positions,w.normals=b.normals,w.uvs=b.uvs,void 0!==b.indices&&(w.indices=b.indices),e.buildSkeleton&&void 0!==y&&(w.matricesIndices=y.matricesIndices,w.matricesWeights=y.matricesWeights);let A=null,M=null,T=null,x=null,v=null;if(e.buildSkeleton&&e.useSdef&&void 0!==y?.sdef){const e=b.positions.length/3,t=y.matricesWeights;A=y.sdef.c,M=y.sdef.r0,T=y.sdef.r1,x=new Float32Array(M.length),v=new Float32Array(T.length);for(let n=0;n<e;++n){const e=t[4*n+0],i=t[4*n+1],r=A[3*n+0],o=A[3*n+1],a=A[3*n+2];let s=M[3*n+0],l=M[3*n+1],h=M[3*n+2],d=T[3*n+0],c=T[3*n+1],u=T[3*n+2];const m=s*e+d*i,p=l*e+c*i,_=h*e+u*i;s=r+s-m,l=o+l-p,h=a+h-_,d=r+d-m,c=o+c-p,u=a+u-_;const g=.5*(r+s),f=.5*(o+l),b=.5*(a+h),y=.5*(r+d),w=.5*(o+c),I=.5*(a+u);x[3*n+0]=g,x[3*n+1]=f,x[3*n+2]=b,v[3*n+0]=y,v[3*n+1]=w,v[3*n+2]=I}}i._blockEntityCollection=!!r;const I=new(null!==A?f.k:s.Mesh)(b.name,i);I._parentContainer=r,i._blockEntityCollection=!1,void 0===b.indices&&(I.isUnIndexed=!0),I.setParent(n),h.push(I),i._blockEntityCollection=!!r;const B=new a.Geometry(t.header.modelName,i,w,!1);if(B._parentContainer=r,i._blockEntityCollection=!1,e.preserveSerializationData&&void 0!==b.additionalUvs){const e=[m.V.AdditionalUV1Kind,m.V.AdditionalUV2Kind,m.V.AdditionalUV3Kind,m.V.AdditionalUV4Kind];for(let t=0;t<b.additionalUvs.length;++t)B.setVerticesData(e[t],b.additionalUvs[t],!1,4)}null!==A&&(B.setVerticesData(m.V.MatricesSdefCKind,A,!1,3),B.setVerticesData(m.V.MatricesSdefR0Kind,M,!1,3),B.setVerticesData(m.V.MatricesSdefR1Kind,T,!1,3),B.setVerticesData(m.V.MatricesSdefRW0Kind,x,!1,3),B.setVerticesData(m.V.MatricesSdefRW1Kind,v,!1,3)),e.preserveSerializationData&&void 0!==b.edgeScale&&B.setVerticesData(m.V.EdgeScaleKind,b.edgeScale,!1,1),B.applyToMesh(I),c.push(B),p+=b.positions.length,p%1e4==0&&100<performance.now()-u&&(o.setTaskProgress("Build Geometry",p),o.invokeProgressEvent(),await d.Tools.DelayAsync(0),u=performance.now())}return o.endTask("Build Geometry"),o.invokeProgressEvent(),{meshes:h,geometries:c}}async _buildMaterialAsync(e,t,n,i,r,a,s,l,d){let c;const u=new Array(t.images.length);for(let e=0;e<t.images.length;++e)u[e]=t.images[e].relativePath;const m=new Array(t.textures.length);for(let e=0;e<t.textures.length;++e){const n=t.textures[e];m[e]={noMipmap:!!(n.flag&y.h.Texture.Flag.NoMipmap),invertY:!!(n.flag&y.h.Texture.Flag.InvertY),samplingMode:n.samplingMode,imagePathIndex:n.imageIndex}}const p=new Array(t.materials.length);for(let e=0;e<p.length;++e)p[e]=[];const _=t.geometries;for(let e=0;e<i.length;++e){const t=_[e].materialIndex;if(-1!==t)if("object"==typeof t){const n=t;for(let t=0;t<n.length;++t)p[n[t].materialIndex].push({mesh:i[e],subMeshIndex:t})}else p[t].push(i[e])}const g=new Promise((o=>{c=e.materialBuilder.buildMaterials(n.uniqueId,t.materials,m,u,l,"file:"+e.pmFileId+"_",t.images,p,i,a,s,r,this,(e=>{e.lengthComputable&&(d.setTaskProgressRatio("Texture Load",e.loaded/e.total,!0),d.invokeProgressEvent())}),(()=>o()))})),f=Array.isArray(c)?c:await c,b=[];for(let e=0;e<i.length;++e){const t=i[e],n=_[e].materialIndex;if(-1!==n)if("object"==typeof n){const e=n;if(t.subMeshes.length=0,0===e.length)t.material=null;else if(1===e.length){const n=e[0];new h.SubMesh(0,n.verticesStart,n.verticesCount,n.indexStart,n.indexCount,t),t.material=f[e[0].materialIndex]}else{a._blockEntityCollection=!!s;const n=new o.MultiMaterial(t.name,a);n._parentContainer=s,a._blockEntityCollection=!1;const i=n.subMaterials;b.push(n);for(let n=0;n<e.length;++n){const r=e[n];new h.SubMesh(n,r.verticesStart,r.verticesCount,r.indexStart,r.indexCount,t),i.push(f[r.materialIndex])}t.material=n}}else{const e=f[n];t.material=e}}return d.endTask("Build Material"),d.invokeProgressEvent(),{materials:f,multiMaterials:b,textureLoadPromise:g}}_buildSkeletonAsync(e,t,n,i,r,o,a){return 0===t.bones.length?(a.endTask("Build Skeleton"),Promise.resolve(null)):super._buildSkeletonAsync(e,t,n,i,r,o,a)}async _buildMorphAsync(e,t,n,r,o,a,s){const l=e.preserveSerializationData,h=t.morphs,m=new Array(t.geometries.length);for(let e=0;e<m.length;++e)m[e]=[];let p=0,_=performance.now();for(let e=0;e<h.length;++e){const n=h[e],i=[];switch(n.type){case g.B.Morph.Type.GroupMorph:case g.B.Morph.Type.BoneMorph:case g.B.Morph.Type.MaterialMorph:a.push(n);break;case g.B.Morph.Type.VertexMorph:case g.B.Morph.Type.UvMorph:case g.B.Morph.Type.AdditionalUvMorph1:case g.B.Morph.Type.AdditionalUvMorph2:case g.B.Morph.Type.AdditionalUvMorph3:case g.B.Morph.Type.AdditionalUvMorph4:a.push({name:n.name,englishName:n.englishName,category:n.category,type:n.type,morphTargets:i,...l?{elements:n.elements}:void 0})}if(n.type===g.B.Morph.Type.VertexMorph||n.type===g.B.Morph.Type.UvMorph||n.type===g.B.Morph.Type.AdditionalUvMorph1||n.type===g.B.Morph.Type.AdditionalUvMorph2||n.type===g.B.Morph.Type.AdditionalUvMorph3||n.type===g.B.Morph.Type.AdditionalUvMorph4){if(n.type!==g.B.Morph.Type.AdditionalUvMorph1&&n.type!==g.B.Morph.Type.AdditionalUvMorph2&&n.type!==g.B.Morph.Type.AdditionalUvMorph3&&n.type!==g.B.Morph.Type.AdditionalUvMorph4){const e=n.elements;for(let t=0;t<e.length;++t){const o=new c.MorphTarget(n.name,0,r);i.push(o),m[e[t].meshIndex].push(o),p+=e[t].indices.length}const o=t.geometries;if(n.type===g.B.Morph.Type.VertexMorph)for(let t=0;t<e.length;++t){const n=e[t],r=o[n.meshIndex],a=new Float32Array(r.positions.length);a.set(r.positions);const s=n.indices,l=n.offsets;for(let e=0;e<s.length;++e){const t=s[e];a[3*t+0]+=l[3*e+0],a[3*t+1]+=l[3*e+1],a[3*t+2]+=l[3*e+2]}i[t].setPositions(a)}else for(let t=0;t<e.length;++t){const n=e[t],r=o[n.meshIndex],a=new Float32Array(r.uvs.length);a.set(r.uvs);const s=n.indices,l=n.offsets;for(let e=0;e<s.length;++e){const t=s[e];a[2*t+0]+=l[4*e+0],a[2*t+1]+=l[4*e+1]}i[t].setUVs(a)}}100<performance.now()-_&&(s.setTaskProgress("Build Morph",p),s.invokeProgressEvent(),await d.Tools.DelayAsync(0),_=performance.now())}}s.endTask("Build Morph");const f=[],b=n.meshes;for(let e=0;e<m.length;++e){const t=m[e];if(0===t.length)continue;r._blockEntityCollection=!!o;const a=new u.MorphTargetManager(r);a._parentContainer=o,r._blockEntityCollection=!1,a.enablePositionMorphing=!1,a.enableNormalMorphing=!1,a.enableTangentMorphing=!1,a.enableUVMorphing=!1,a.enableUV2Morphing=!1,a.areUpdatesFrozen=!0;for(let e=0;e<t.length;++e){const n=t[e];a.addTarget(n),n.hasPositions&&(a.enablePositionMorphing=!0),n.hasUVs&&(a.enableUVMorphing=!0)}if(a.enablePositionMorphing){const r=n.geometries[e].getVerticesData(i.VertexBuffer.PositionKind);for(let e=0;e<t.length;++e){const n=t[e];n.hasPositions||n.setPositions(r)}}if(a.enableUVMorphing){const r=n.geometries[e].getVerticesData(i.VertexBuffer.UVKind);for(let e=0;e<t.length;++e){const n=t[e];n.hasUVs||n.setUVs(r)}}a.areUpdatesFrozen=!1,f.push(a),b[e].morphTargetManager=a}return f}}(0,r.registerSceneLoaderPlugin)(new A)},5031:e=>{e.exports=Y},5041:(e,t,n)=>{n.d(t,{Z:()=>i});const i="\n#ifndef SDEFVERTEX\n#define SDEFVERTEX\n#if !defined(BAKED_VERTEX_ANIMATION_TEXTURE) && defined(SDEF)\n#if NUM_BONE_INFLUENCERS>0\n{float weight0=matricesWeights[0];float weight1=matricesWeights[1];\n#ifdef BONETEXTURE\nmat4 transformMatrix0=readMatrixFromRawSampler(boneSampler,matricesIndices[0]);mat4 transformMatrix1=readMatrixFromRawSampler(boneSampler,matricesIndices[1]);\n#else\nmat4 transformMatrix0=mBones[int(matricesIndices[0])];mat4 transformMatrix1=mBones[int(matricesIndices[1])];\n#endif\nmat3 slerpedRotationMatrix=quaternionToRotationMatrix(slerp(\nrotationMatrixToQuaternion(mat3(transformMatrix0)),\nrotationMatrixToQuaternion(mat3(transformMatrix1)),\nweight1\n));mat4 sdefInflunce=mat4(\nvec4(1.0,0.0,0.0,0.0),\nvec4(0.0,1.0,0.0,0.0),\nvec4(0.0,0.0,1.0,0.0),\nvec4(-matricesSdefC,1.0)\n);mat4 rotationMatrix=mat4(\nvec4(slerpedRotationMatrix[0],0.0),\nvec4(slerpedRotationMatrix[1],0.0),\nvec4(slerpedRotationMatrix[2],0.0),\nvec4(0.0,0.0,0.0,1.0)\n);sdefInflunce=rotationMatrix*sdefInflunce;vec3 positionOffset =\nvec3(transformMatrix0*vec4(matricesSdefRW0,1))*weight0 +\nvec3(transformMatrix1*vec4(matricesSdefRW1,1))*weight1;sdefInflunce[3]+=vec4(positionOffset,0.0);float useLinearDeform=step(0.0,-abs(matricesSdefRW0.x));influence=mat4(\nmix(sdefInflunce[0],influence[0],useLinearDeform),\nmix(sdefInflunce[1],influence[1],useLinearDeform),\nmix(sdefInflunce[2],influence[2],useLinearDeform),\nmix(sdefInflunce[3],influence[3],useLinearDeform)\n);}\n#endif\n#endif\n#endif\n"},5043:(e,t,n)=>{n.r(t),n.d(t,{mmdOutlineVertexShader:()=>o}),n(7325),n(211),n(8767),n(78),n(7348),n(5378),n(1409),n(6841),n(360),n(2478),n(1949),n(6089),n(1822),n(8257);const i="mmdOutlineVertexShader",r="\nattribute vec3 position;attribute vec3 normal;\n#include<bonesDeclaration>\n#include<bakedVertexAnimationDeclaration>\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#include<clipPlaneVertexDeclaration>\nuniform float offset;\n#include<instancesDeclaration>\nuniform vec2 viewport;uniform mat3 view;uniform mat4 viewProjection;\n#ifdef WORLDPOS_REQUIRED\nuniform mat4 inverseViewProjection;\n#endif\n#ifdef ALPHATEST\nvarying vec2 vUV;uniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void)\n{vec3 positionUpdated=position;vec3 normalUpdated=normal;\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#ifdef UV2\nvec2 uv2Updated=uv2;\n#endif\n#include<morphTargetsVertexGlobal>\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#include<instancesVertex>\n#include<bonesVertex>\n#include<bakedVertexAnimation>\nvec3 viewNormal=view*(mat3(finalWorld)*normalUpdated);vec4 projectedPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vec2 screenNormal=normalize(vec2(viewNormal));projectedPosition.xy+=screenNormal/(viewport*0.25/*0.5 */)*offset*projectedPosition.w;gl_Position=projectedPosition;\n#ifdef WORLDPOS_REQUIRED\nvec4 worldPos=inverseViewProjection*projectedPosition;\n#endif\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));\n#endif\n#endif\n#include<clipPlaneVertex>\n#include<logDepthVertex>\n}\n";n(4234).ShaderStore.ShadersStore[i]=r;const o={name:i,shader:r}},5092:(e,t,n)=>{n.d(t,{J:()=>u});var i=n(3843),r=n(5197),o=n(7508),a=n(7116),s=n(9897),l=n(6641);class h{uniqueId;leftLoadCount;isRequesting;errorTextureDatas;constructor(e){this.uniqueId=e,this.leftLoadCount=0,this.isRequesting=!0,this.errorTextureDatas=[]}}class d{observable;hasLoadError;constructor(){this.observable=new o.Observable,this.hasLoadError=!1}}class c{cacheKey;_scene;_assetContainer;_textureName;_options;_onLoad;_onError;_forcedExtension;_texture;constructor(e,t,n,i,r,o,a,s,l,h){this.cacheKey=e,this._scene=t,this._assetContainer=n,this._textureName=r,this._options=a,this._onLoad=s,this._onError=l,this._forcedExtension=h,this._texture=null,o||t._loadFile(i,(e=>{this._createTexture(t,n,r,e,a,s,((e,t)=>{l?.(e,t)}),h)}),void 0,!0,!0,((e,t)=>{l?.(e?e.status+" "+e.statusText:"",t)}))}loadFromArrayBuffer(e){this._createTexture(this._scene,this._assetContainer,this._textureName,e,this._options,this._onLoad,((e,t)=>{this._onError?.(e,t)}),this._forcedExtension)}_onDisposeCallback=null;registerOnDisposeCallback(e){this._onDisposeCallback=e,this._texture.onDisposeObservable.addOnce(e)}unregisterOnDisposeCallback(){const e=this._onDisposeCallback;return null===e?null:(this._onDisposeCallback=null,this._texture.onDisposeObservable.removeCallback(e),e)}_createTexture(e,t,n,i,o,s,l,h){e._blockEntityCollection=!!t;const d={noMipmap:o.noMipmap,invertY:o.invertY,samplingMode:o.samplingMode,onLoad:()=>{null===this._texture?null!==s&&a.TimingTools.SetImmediate(s):s?.()},onError:l,buffer:i,deleteBuffer:o.deleteBuffer,format:o.format,mimeType:o.mimeType,forcedExtension:h},c=this._texture=new r.Texture("data:"+n,e,d);c._parentContainer=t,e._blockEntityCollection=!1,t?.textures.push(c),c.name=n}get texture(){return this._texture}}class u{onModelTextureLoadedObservable=new Map;textureCache=new Map;_textureLoadInfoMap=new Map;_loadingModels=new Map;_errorTexturesReferenceCount=new Map;_incrementLeftLoadCount(e){let t=this._loadingModels.get(e);void 0===t&&(t=new h(e),this._loadingModels.set(e,t)),t.leftLoadCount+=1;let n=this.onModelTextureLoadedObservable.get(e);return void 0===n&&(n=new o.Observable,this.onModelTextureLoadedObservable.set(e,n)),t}_decrementLeftLoadCount(e){if(e.leftLoadCount-=1,!e.isRequesting&&0===e.leftLoadCount){this._removeErrorTexturesReferenceCount(e.uniqueId),this._loadingModels.delete(e.uniqueId);const t=this.onModelTextureLoadedObservable.get(e.uniqueId);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e.uniqueId)}}loadModelTexturesEnd(e){const t=this._loadingModels.get(e);if(void 0!==t&&(t.isRequesting=!1,0===t.leftLoadCount)){this._removeErrorTexturesReferenceCount(e),this._loadingModels.delete(e);const t=this.onModelTextureLoadedObservable.get(e);t?.notifyObservers(),t?.clear(),this.onModelTextureLoadedObservable.delete(e)}}_addErrorTextureReferenceCount(e,t){this._loadingModels.get(e).errorTextureDatas.push(t),this._errorTexturesReferenceCount.set(t,(this._errorTexturesReferenceCount.get(t)??0)+1)}_removeErrorTexturesReferenceCount(e){const t=this._loadingModels.get(e);for(let e=0;e<t.errorTextureDatas.length;++e){const n=t.errorTextureDatas[e],i=this._errorTexturesReferenceCount.get(n)-1;0===i?null!==n.texture?n.texture.dispose():(this._textureLoadInfoMap.delete(n.cacheKey),this.textureCache.delete(n.cacheKey),this._errorTexturesReferenceCount.delete(n)):this._errorTexturesReferenceCount.set(n,i)}}_handleTextureOnDispose(e){e.registerOnDisposeCallback((()=>{this._textureLoadInfoMap.delete(e.cacheKey),this.textureCache.delete(e.cacheKey),this._errorTexturesReferenceCount.delete(e)}))}_createTextureCacheKey(e,t){const n=e.lastIndexOf(".");let o="";return-1!==n&&(o=e.substring(n),e=e.substring(0,n)),e+ +(t.noMipmap??!1)+ +(t.invertY??!0)+(t.samplingMode??r.Texture.TRILINEAR_SAMPLINGMODE)+(t.format??i.Constants.TEXTUREFORMAT_RGBA)+o}async _loadTextureAsyncInternal(e,t,n,i,r,o,a){const l=this._incrementLeftLoadCount(e),h=this._createTextureCacheKey(t,a);let u=this._textureLoadInfoMap.get(h);void 0===u&&(u=new d,this._textureLoadInfoMap.set(h,u));let m=this.textureCache.get(h);if(void 0===m&&!u.hasLoadError){const l=null!==i?s.A.Data[i]:t;m=new c(h,r,o,l,t,null!==n,a,(()=>{this._handleTextureOnDispose(m),u.hasLoadError=!1,u.observable.notifyObservers(!1),u.observable.clear()}),((t,n)=>{null!==m.texture&&this._handleTextureOnDispose(m),this._addErrorTextureReferenceCount(e,m),u.hasLoadError=!0,u.observable.notifyObservers(!0),u.observable.clear()}),a.forcedExtension),this.textureCache.set(h,m);const d=n instanceof Blob?await n.arrayBuffer():n;null!==d&&m.loadFromArrayBuffer(d)}return null!==m.texture&&m.texture.isReady()?(this._decrementLeftLoadCount(l),u.hasLoadError?null:m.texture):new Promise((e=>{u.observable.addOnce((t=>{this._decrementLeftLoadCount(l),e(t?null:m.texture)}))}))}async loadTextureAsync(e,t,n,i,r,o){let a;"number"==typeof n?((n<-1||9<n)&&(n=-1),n+=1,a=!0):a=!1;const s=a?a?"file:shared_toon_texture_"+n:n:(0,l.N)(t+n);return await this._loadTextureAsyncInternal(e,s,null,a?n:null,i,r,o)}async loadTextureFromBufferAsync(e,t,n,i,r,o,a=!0){return a&&(t=(0,l.N)(t)),await this._loadTextureAsyncInternal(e,t,n,null,i,r,o)}}},5197:e=>{e.exports=W},5272:(e,t,n)=>{n.d(t,{N:()=>l});var i=n(4232),r=n(6910),o=n(1599),a=n(5297),s=n(7556);class l{constructor(){}static async ParseAsync(e,t=new o.C){const n=new a.u(e);n.initializeTextDecoder("utf-8");const i=this._ParseHeader(n),r=1===n.getUint8(),s=await this._ParseGeometriesAsync(n,r);if((i.version[0]<<16|i.version[1]<<8|i.version[2])<this._V221Int){let e=!1;for(let t=0;t<s.length;++t)if(s[t].skinning?.sdef){e=!0;break}e&&t.warn("Sdef parameters in this file are incorrect. sdef deformation may have some problems.")}const l=await this._ParseImagesAsync(n),h=this._ParseTexturesAsync(n),d=this._ParseMaterials(n,i.version),c=r?this._ParseBones(n):[],u=this._ParseMorphs(n),m=this._ParseDisplayFrames(n),p=this._ParseRigidBodies(n),_=this._ParseJoints(n);return n.bytesAvailable>0&&t.warn(`There are ${n.bytesAvailable} bytes left after parsing`),{header:i,geometries:s,images:l,textures:h,materials:d,bones:c,morphs:u,displayFrames:m,rigidBodies:p,joints:_}}static _V200Int=2<<16;static _V221Int=131585;static _ParseHeader(e){if(e.bytesAvailable<7)throw new RangeError("is not bpmx file");const t=e.getDecoderString(4,!1);if("BPMX"!==t)throw new RangeError("is not bpmx file");const n=[e.getInt8(),e.getInt8(),e.getInt8()],r=n[0]<<16|n[1]<<8|n[2];if(r<this._V200Int||this._V221Int<r)throw new i.LoadFileError(`BPMX version ${n[0]}.${n[1]}.${n[2]} is not supported.`);return{signature:t,version:n,modelName:e.getDecoderString(e.getUint32(),!1),englishModelName:e.getDecoderString(e.getUint32(),!1),comment:e.getDecoderString(e.getUint32(),!1),englishComment:e.getDecoderString(e.getUint32(),!1)}}static async _ParseGeometriesAsync(e,t){let n=performance.now();const i=[],r=e.getUint32();for(let o=0;o<r;++o){const r=e.getDecoderString(e.getUint32(),!1);let o=e.getInt32();if(-2===o){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getInt32(),i=e.getUint32(),r=e.getUint32(),o=e.getUint32(),a=e.getUint32();n.push({materialIndex:t,verticesStart:i,verticesCount:r,indexStart:o,indexCount:a})}o=n}const a=e.getUint32(),l=new Float32Array(3*a);e.getFloat32Array(l),100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now());const h=new Float32Array(3*a);e.getFloat32Array(h),100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now());const d=new Float32Array(2*a);e.getFloat32Array(d);const c=[],u=e.getUint8();for(let t=0;t<u;++t){const t=new Float32Array(4*a);e.getFloat32Array(t),c.push(t)}100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now());const m=e.getUint8();let p,_,g;if(m&s.h.Geometry.GeometryType.IsIndexed){const t=e.getUint8(),i=e.getUint32();t===s.h.Geometry.IndexElementType.Int32?(p=new Int32Array(i),e.getInt32Array(p)):t===s.h.Geometry.IndexElementType.Uint32?(p=new Uint32Array(i),e.getUint32Array(p)):(p=new Uint16Array(i),e.getUint16Array(p)),100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now())}if(t){const t=new Float32Array(4*a);e.getFloat32Array(t);const i=new Float32Array(4*a);let r;if(e.getFloat32Array(i),100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now()),m&s.h.Geometry.GeometryType.HasSdef){const t=new Float32Array(3*a),i=new Float32Array(3*a),o=new Float32Array(3*a);e.getFloat32Array(t),e.getFloat32Array(i),e.getFloat32Array(o),r={c:t,r0:i,r1:o},100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now())}_={matricesIndices:t,matricesWeights:i,sdef:r}}m&s.h.Geometry.GeometryType.HasEdgeScale&&(g=new Float32Array(a),e.getFloat32Array(g));const f={name:r,materialIndex:o,positions:l,normals:h,uvs:d,additionalUvs:c,indices:p,skinning:_,edgeScale:g};i.push(f)}return i}static async _ParseImagesAsync(e){const t=e.getUint32();let n=performance.now();const i=[];for(let r=0;r<t;++r){const t=e.getDecoderString(e.getUint32(),!1),r=e.getUint8()&s.h.Image.Flag.HasMimeType?e.getDecoderString(e.getUint32(),!1):void 0,o=e.getUint32(),a=new ArrayBuffer(o);e.getUint8Array(new Uint8Array(a)),i.push({relativePath:t,mimeType:r,data:a}),100<performance.now()-n&&(await new Promise((e=>setTimeout(e,0))),n=performance.now())}return i}static _ParseTexturesAsync(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getUint8(),i=e.getUint8(),r=e.getInt32();n.push({flag:t,samplingMode:i,imageIndex:r})}return n}static _ParseMaterials(e,t){const n=e.getUint32(),i=[];for(let r=0;r<n;++r){const n={name:e.getDecoderString(e.getUint32(),!1),englishName:e.getDecoderString(e.getUint32(),!1),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),evaluatedTransparency:2===t[0]&&0===t[1]?240|e.getUint8():e.getUint8(),flag:e.getUint8(),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureIndex:e.getInt32(),sphereTextureIndex:e.getInt32(),sphereTextureMode:e.getUint8(),isSharedToonTexture:1===e.getUint8(),toonTextureIndex:e.getInt32(),comment:e.getDecoderString(e.getUint32(),!1)};i.push(n)}return i}static _ParseBones(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getDecoderString(e.getUint32(),!1),i=e.getDecoderString(e.getUint32(),!1),o=e.getFloat32Tuple(3),a=e.getInt32(),s=e.getInt32(),l=e.getUint16();let h,d,c,u,m,p;if(h=l&r.B.Bone.Flag.UseBoneIndexAsTailPosition?e.getInt32():e.getFloat32Tuple(3),(l&r.B.Bone.Flag.HasAppendMove||l&r.B.Bone.Flag.HasAppendRotate)&&(d={parentIndex:e.getInt32(),ratio:e.getFloat32()}),l&r.B.Bone.Flag.HasAxisLimit&&(c=e.getFloat32Tuple(3)),l&r.B.Bone.Flag.HasLocalVector&&(u={x:e.getFloat32Tuple(3),z:e.getFloat32Tuple(3)}),l&r.B.Bone.Flag.IsExternalParentTransformed&&(m=e.getInt32()),l&r.B.Bone.Flag.IsIkEnabled){const t=e.getInt32(),n=e.getInt32(),i=e.getFloat32(),r=[],o=e.getInt32();for(let t=0;t<o;++t){const t={target:e.getInt32(),limitation:1===e.getUint8()?{minimumAngle:e.getFloat32Tuple(3),maximumAngle:e.getFloat32Tuple(3)}:void 0};r.push(t)}p={target:t,iteration:n,rotationConstraint:i,links:r}}const _={name:t,englishName:i,position:o,parentBoneIndex:a,transformOrder:s,flag:l,tailPosition:h,appendTransform:d,axisLimit:c,localVector:u,externalParentTransform:m,ik:p};n.push(_)}return n}static _ParseMorphs(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getDecoderString(e.getUint32(),!1),i=e.getDecoderString(e.getUint32(),!1),o=e.getUint8(),a=e.getUint8();let s={name:t,englishName:i,category:o,type:a};switch(a){case r.B.Morph.Type.GroupMorph:{const t=e.getUint32(),n=new Int32Array(t);e.getInt32Array(n);const i=new Float32Array(t);e.getFloat32Array(i),s={...s,indices:n,ratios:i}}break;case r.B.Morph.Type.VertexMorph:{const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getUint32(),i=e.getUint32(),r=new Int32Array(i);e.getInt32Array(r);const o=new Float32Array(3*i);e.getFloat32Array(o);const a={meshIndex:t,indices:r,offsets:o};n.push(a)}s={...s,elements:n}}break;case r.B.Morph.Type.BoneMorph:{const t=e.getUint32(),n=new Int32Array(t);e.getInt32Array(n);const i=new Float32Array(3*t);e.getFloat32Array(i);const r=new Float32Array(4*t);e.getFloat32Array(r),s={...s,indices:n,positions:i,rotations:r}}break;case r.B.Morph.Type.UvMorph:case r.B.Morph.Type.AdditionalUvMorph1:case r.B.Morph.Type.AdditionalUvMorph2:case r.B.Morph.Type.AdditionalUvMorph3:case r.B.Morph.Type.AdditionalUvMorph4:{const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getUint32(),i=e.getUint32(),r=new Int32Array(i);e.getInt32Array(r);const o=new Float32Array(4*i);e.getFloat32Array(o);const a={meshIndex:t,indices:r,offsets:o};n.push(a)}s={...s,elements:n}}break;case r.B.Morph.Type.MaterialMorph:{const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t={index:e.getInt32(),type:e.getUint8(),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureColor:e.getFloat32Tuple(4),sphereTextureColor:e.getFloat32Tuple(4),toonTextureColor:e.getFloat32Tuple(4)};n.push(t)}s={...s,elements:n}}break;default:throw new Error(`Unknown morph type: ${a}`)}n.push(s)}return n}static _ParseDisplayFrames(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t=e.getDecoderString(e.getUint32(),!1),i=e.getDecoderString(e.getUint32(),!1),r=1===e.getUint8(),o=e.getUint32(),a=[];for(let t=0;t<o;++t){const t={type:e.getUint8(),index:e.getInt32()};a.push(t)}const s={name:t,englishName:i,isSpecialFrame:r,frames:a};n.push(s)}return n}static _ParseRigidBodies(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t={name:e.getDecoderString(e.getUint32(),!1),englishName:e.getDecoderString(e.getUint32(),!1),boneIndex:e.getInt32(),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};n.push(t)}return n}static _ParseJoints(e){const t=e.getUint32(),n=[];for(let i=0;i<t;++i){const t={name:e.getDecoderString(e.getUint32(),!1),englishName:e.getDecoderString(e.getUint32(),!1),type:e.getUint8(),rigidbodyIndexA:e.getInt32(),rigidbodyIndexB:e.getInt32(),position:e.getFloat32Tuple(3),rotation:e.getFloat32Tuple(3),positionMin:e.getFloat32Tuple(3),positionMax:e.getFloat32Tuple(3),rotationMin:e.getFloat32Tuple(3),rotationMax:e.getFloat32Tuple(3),springPosition:e.getFloat32Tuple(3),springRotation:e.getFloat32Tuple(3)};n.push(t)}return n}}},5297:(e,t,n)=>{n.d(t,{u:()=>i});class i{isDeviceLittleEndian;_dataView;_decoder;_offset;constructor(e){this.isDeviceLittleEndian=this._getIsDeviceLittleEndian(),this._dataView=new DataView(e),this._decoder=null,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}_getIsDeviceLittleEndian(){const e=new Int16Array([256]);return 1===new Int8Array(e.buffer)[1]}swap16Array(e){for(let t=0;t<e.length;++t){const n=e[t];e[t]=(255&n)<<8|n>>8&255}}swap32Array(e){for(let t=0;t<e.length;++t){const n=e[t];e[t]=(255&n)<<24|(65280&n)<<8|n>>8&65280|n>>24&255}}getUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}getInt8(){const e=this._dataView.getInt8(this._offset);return this._offset+=1,e}getUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);e.set(t),this._offset+=e.byteLength}getUint16(){const e=this._dataView.getUint16(this._offset,!0);return this._offset+=2,e}getUint16Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap16Array(e)}getInt16(){const e=this._dataView.getInt16(this._offset,!0);return this._offset+=2,e}getUint32(){const e=this._dataView.getUint32(this._offset,!0);return this._offset+=4,e}getUint32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getInt32(){const e=this._dataView.getInt32(this._offset,!0);return this._offset+=4,e}getInt32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getFloat32(){const e=this._dataView.getFloat32(this._offset,!0);return this._offset+=4,e}getFloat32Array(e){const t=new Uint8Array(this._dataView.buffer,this._offset,e.byteLength);new Uint8Array(e.buffer,e.byteOffset,e.byteLength).set(t),this._offset+=e.byteLength,this.isDeviceLittleEndian||this.swap32Array(e)}getFloat32Tuple(e){const t=new Array(e);for(let n=0;n<e;++n)t[n]=this._dataView.getFloat32(this._offset,!0),this._offset+=4;return t}initializeTextDecoder(e){this._decoder=new TextDecoder(e)}getDecoderString(e,t){if(null===this._decoder)throw new Error("TextDecoder is not initialized.");let n=new Uint8Array(this._dataView.buffer,this._offset,e);if(this._offset+=e,t)for(let e=0;e<n.length;++e)if(0===n[e]){n=n.subarray(0,e);break}return this._decoder.decode(n)}getSignatureString(e){const t=new TextDecoder("utf-8"),n=new Uint8Array(this._dataView.buffer,this._offset,e);return this._offset+=e,t.decode(n)}getPaddedArrayOffset(e,t){this._offset+=this._offset%e==0?0:e-this._offset%e;const n=this._offset;return this._offset+=e*t,n}get bytesAvailable(){return this._dataView.byteLength-this._offset}}},5378:e=>{e.exports=he},5501:e=>{e.exports=p},5527:e=>{e.exports=R},5567:(e,t,n)=>{n.d(t,{g:()=>r});var i=n(6641);class r{files;_fileRootId;_fileMap=new Map;constructor(e,t,n){if(t=(0,i.N)(t),this.files=e,this._fileRootId=n,0!==e.length)if(e[0]instanceof File)for(const r of e){const e=(0,i.N)(r.webkitRelativePath);if(!e.startsWith(t))continue;const o=n+(0,i.N)(e.slice(t.length));this._fileMap.set((0,i.N)(o).toUpperCase(),r)}else for(const t of e){const e=n+(0,i.N)(t.relativePath);this._fileMap.set((0,i.N)(e).toUpperCase(),t)}}createFullPath(e){return this._fileRootId+(0,i.N)(e)}resolve(e){const t=(0,i.N)(e);return this._fileMap.get(t.toUpperCase())}}},5587:e=>{e.exports=De},5718:(e,t,n)=>{n.r(t),n.d(t,{MmdPluginMaterial:()=>l});var i=n(9866),r=n(426);function o(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var a=n(7198),s=n(4122);class l extends r.ZL{isCompatible(e){return e===i.ShaderLanguage.WGSL}getCustomCode(e){if("vertex"===e){const e={};return e.CUSTOM_VERTEX_DEFINITIONS=a.B,e[`!${o("finalWorld=finalWorld*influence;")}`]=`\n${s.Z}\nfinalWorld=(finalWorld*influence);\n`,e}if("fragment"===e){const e={CUSTOM_FRAGMENT_DEFINITIONS:"\n#if defined(SPHERE_TEXTURE) && defined(NORMAL)\nvar sphereSamplerSampler: sampler;var sphereSampler: texture_2d<f32>;\n#endif\n#ifdef TOON_TEXTURE\nvar toonSamplerSampler: sampler;var toonSampler: texture_2d<f32>;\n#endif\n",CUSTOM_FRAGMENT_MAIN_BEGIN:"\n#ifdef TOON_TEXTURE\nvar toonNdl: vec3f;\n#endif\n"};e[`!${o("var diffuseColor: vec3f=uniforms.vDiffuseColor.rgb;")}`]="\n#ifdef APPLY_AMBIENT_COLOR_TO_DIFFUSE\nvar diffuseColor: vec3f=clamp(uniforms.vDiffuseColor.rgb+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0));\n#else\nvar diffuseColor: vec3f=(uniforms.vDiffuseColor.rgb);\n#endif\n",e[`!${o("var alpha: f32=uniforms.vDiffuseColor.a;")}`]="\n#ifdef CLAMP_ALPHA\nvar alpha: f32=clamp(uniforms.vDiffuseColor.a,0.0,1.0);\n#else\nvar alpha: f32=uniforms.vDiffuseColor.a;\n#endif\n",e[`!${o("baseColor=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vDiffuseUV+uvOffset);")}`]="\n#if defined(DIFFUSE) && defined(TEXTURE_COLOR)\nbaseColor=textureSample(diffuseSampler,diffuseSamplerSampler,(fragmentInputs.vDiffuseUV+uvOffset));baseColor=vec4f(\nmix(\nvec3f(1.0),\nbaseColor.rgb*uniforms.textureMultiplicativeColor.rgb,\nuniforms.textureMultiplicativeColor.a\n),\nbaseColor.a\n);baseColor=vec4f(\nclamp(\nbaseColor.rgb+(baseColor.rgb-vec3f(1.0))*uniforms.textureAdditiveColor.a,\nvec3f(0.0),\nvec3f(1.0)\n)+uniforms.textureAdditiveColor.rgb,\nbaseColor.a\n);\n#else\nbaseColor=textureSample(diffuseSampler,diffuseSamplerSampler,(fragmentInputs.vDiffuseUV+uvOffset));\n#endif\n",e[`!${o("struct lightingInfo\n{")}`]="\nstruct lightingInfo {\n#ifdef TOON_TEXTURE\n#ifndef NDOTL\nndl: f32,\n#endif\nisToon: f32,\n#endif\n",e[`!${o("result.diffuse=ndl*diffuseColor*attenuation;")}`]="\n#ifdef TOON_TEXTURE\nresult.diffuse=diffuseColor*attenuation;result.ndl=ndl;result.isToon=1.0;\n#elif defined(IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED)\nresult.diffuse=diffuseColor*attenuation;\n#else\nresult.diffuse=(ndl*diffuseColor*attenuation);\n#endif\n",e[`!${o("diffuseBase+=info.diffuse*shadow;")}`]="\n#ifdef TOON_TEXTURE\ntoonNdl=vec3f(clamp(info.ndl*shadow,0.02,0.98));toonNdl.r=textureSample(toonSampler,toonSamplerSampler,vec2f(0.5,toonNdl.r)).r;toonNdl.g=textureSample(toonSampler,toonSamplerSampler,vec2f(0.5,toonNdl.g)).g;toonNdl.b=textureSample(toonSampler,toonSamplerSampler,vec2f(0.5,toonNdl.b)).b;\n#ifdef TOON_TEXTURE_COLOR\ntoonNdl=mix(\nvec3f(1.0),\ntoonNdl*uniforms.toonTextureMultiplicativeColor.rgb,\nuniforms.toonTextureMultiplicativeColor.a\n);toonNdl=clamp(\ntoonNdl+(toonNdl-vec3f(1.0))*uniforms.toonTextureAdditiveColor.a,\nvec3f(0.0),\nvec3f(1.0)\n)+uniforms.toonTextureAdditiveColor.rgb;\n#endif\ndiffuseBase+=mix(info.diffuse*shadow,toonNdl*info.diffuse,info.isToon);\n#elif defined(IGNORE_DIFFUSE_WHEN_TOON_TEXTURE_DISABLED)\ndiffuseBase+=info.diffuse;\n#else\ndiffuseBase+=(info.diffuse*shadow);\n#endif\n";const t="\n#ifdef EMISSIVEASILLUMINATION\nvar finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvar finalDiffuse: vec3f=clamp((diffuseBase+emissiveColor)*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#else\nvar finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+emissiveColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#endif\n#endif\n";return e[`!${o(t)}`]=`\n#ifdef APPLY_AMBIENT_COLOR_TO_DIFFUSE\n#ifdef EMISSIVEASILLUMINATION\nvar finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvar finalDiffuse: vec3f=clamp((diffuseBase+emissiveColor)*diffuseColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#else\nvar finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+emissiveColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;\n#endif\n#endif\n#else\n${t.replace("diffuseBase","(diffuseBase)")}#endif\n`,e.CUSTOM_FRAGMENT_BEFORE_FOG="\n#if defined(NORMAL) && defined(SPHERE_TEXTURE)\nvar viewSpaceNormal: vec3f=normalize(mat3x3f(scene.view[0].xyz,scene.view[1].xyz,scene.view[2].xyz)*fragmentInputs.vNormalW);var sphereUV: vec2f=viewSpaceNormal.xy*0.5+0.5;var sphereReflectionColor: vec4f=textureSample(sphereSampler,sphereSamplerSampler,sphereUV);\n#ifdef SPHERE_TEXTURE_COLOR\nsphereReflectionColor=vec4f(\nmix(\nvec3f(1.0),\nsphereReflectionColor.rgb*uniforms.sphereTextureMultiplicativeColor.rgb,\nuniforms.sphereTextureMultiplicativeColor.a\n),\nsphereReflectionColor.a\n);sphereReflectionColor=vec4f(\nclamp(\nsphereReflectionColor.rgb+(sphereReflectionColor.rgb-vec3f(1.0))*uniforms.sphereTextureAdditiveColor.a,\nvec3f(0.0),\nvec3f(1.0)\n)+uniforms.sphereTextureAdditiveColor.rgb,\nsphereReflectionColor.a\n);\n#endif\nsphereReflectionColor=vec4f(sphereReflectionColor.rgb*diffuseBase,sphereReflectionColor.a);\n#ifdef SPHERE_TEXTURE_BLEND_MODE_MULTIPLY\ncolor*=sphereReflectionColor;\n#elif defined(SPHERE_TEXTURE_BLEND_MODE_ADD)\ncolor=vec4f(color.rgb+sphereReflectionColor.rgb,color.a);\n#endif\n#endif\n",e}return null}}},5755:e=>{e.exports=ne},5905:e=>{e.exports=K},5918:e=>{e.exports=q},5932:(e,t,n)=>{n.d(t,{R:()=>i});class i{static _IdMap=new WeakMap;static _NextId=0;constructor(){}static GetId(e){let t=this._IdMap.get(e);return void 0===t&&(t=this._NextId,this._NextId+=1,this._IdMap.set(e,t)),t}}},6018:e=>{e.exports=Fe},6089:e=>{e.exports=_e},6247:e=>{e.exports=X},6320:e=>{e.exports=L},6343:(e,t,n)=>{n.d(t,{S:()=>i});const i={name:"bpmx",extensions:{".bpmx":{isBinary:!0}}}},6377:e=>{e.exports=s},6429:e=>{e.exports=U},6462:e=>{e.exports=Me},6532:e=>{e.exports=I},6641:(e,t,n)=>{function i(e){const t=(e=e.replace(/\\/g,"/")).split("/"),n=[];for(let e=0;e<t.length;++e){const i=t[e];"."!==i&&(".."===i?n.pop():n.push(i))}return n.join("/")}n.d(t,{N:()=>i})},6713:e=>{e.exports=Be},6837:e=>{e.exports=j},6841:e=>{e.exports=ce},6867:e=>{e.exports=C},6871:e=>{e.exports=m},6876:(e,t,n)=>{n.r(t),n.d(t,{textureAlphaCheckerVertexShader:()=>o});const i="textureAlphaCheckerVertexShader",r="\nattribute uv: vec2f;varying vUv: vec2f;@vertex\nfn main(input: VertexInputs)->FragmentInputs {vertexOutputs.vUv=vertexInputs.uv;vertexOutputs.position=vec4f(\n(vertexInputs.uv % 1.0)*2.0-1.0,\n0.0,\n1.0\n);}\n";n(4234).ShaderStore.ShadersStoreWGSL[i]=r;const o={name:i,shader:r}},6910:(e,t,n)=>{var i;n.d(t,{B:()=>i}),function(e){let t,n,i,r,o,a,s,l,h;!function(e){let t;!function(e){e[e.Utf16le=0]="Utf16le",e[e.Utf8=1]="Utf8",e[e.ShiftJis=2]="ShiftJis"}(t=e.Encoding||(e.Encoding={}))}(t=e.Header||(e.Header={})),function(e){let t;!function(e){e[e.Bdef1=0]="Bdef1",e[e.Bdef2=1]="Bdef2",e[e.Bdef4=2]="Bdef4",e[e.Sdef=3]="Sdef",e[e.Qdef=4]="Qdef"}(t=e.BoneWeightType||(e.BoneWeightType={}))}(n=e.Vertex||(e.Vertex={})),function(e){let t,n;!function(e){e[e.IsDoubleSided=1]="IsDoubleSided",e[e.EnabledGroundShadow=2]="EnabledGroundShadow",e[e.EnabledDrawShadow=4]="EnabledDrawShadow",e[e.EnabledReceiveShadow=8]="EnabledReceiveShadow",e[e.EnabledToonEdge=16]="EnabledToonEdge",e[e.EnabledVertexColor=32]="EnabledVertexColor",e[e.EnabledPointDraw=64]="EnabledPointDraw",e[e.EnabledLineDraw=128]="EnabledLineDraw"}(t=e.Flag||(e.Flag={})),function(e){e[e.Off=0]="Off",e[e.Multiply=1]="Multiply",e[e.Add=2]="Add",e[e.SubTexture=3]="SubTexture"}(n=e.SphereTextureMode||(e.SphereTextureMode={}))}(i=e.Material||(e.Material={})),function(e){let t;!function(e){e[e.UseBoneIndexAsTailPosition=1]="UseBoneIndexAsTailPosition",e[e.IsRotatable=2]="IsRotatable",e[e.IsMovable=4]="IsMovable",e[e.IsVisible=8]="IsVisible",e[e.IsControllable=16]="IsControllable",e[e.IsIkEnabled=32]="IsIkEnabled",e[e.LocalAppendTransform=128]="LocalAppendTransform",e[e.HasAppendRotate=256]="HasAppendRotate",e[e.HasAppendMove=512]="HasAppendMove",e[e.HasAxisLimit=1024]="HasAxisLimit",e[e.HasLocalVector=2048]="HasLocalVector",e[e.TransformAfterPhysics=4096]="TransformAfterPhysics",e[e.IsExternalParentTransformed=8192]="IsExternalParentTransformed"}(t=e.Flag||(e.Flag={}))}(r=e.Bone||(e.Bone={})),function(e){let t,n,i;!function(e){e[e.System=0]="System",e[e.Eyebrow=1]="Eyebrow",e[e.Eye=2]="Eye",e[e.Lip=3]="Lip",e[e.Other=4]="Other"}(t=e.Category||(e.Category={})),function(e){e[e.GroupMorph=0]="GroupMorph",e[e.VertexMorph=1]="VertexMorph",e[e.BoneMorph=2]="BoneMorph",e[e.UvMorph=3]="UvMorph",e[e.AdditionalUvMorph1=4]="AdditionalUvMorph1",e[e.AdditionalUvMorph2=5]="AdditionalUvMorph2",e[e.AdditionalUvMorph3=6]="AdditionalUvMorph3",e[e.AdditionalUvMorph4=7]="AdditionalUvMorph4",e[e.MaterialMorph=8]="MaterialMorph",e[e.FlipMorph=9]="FlipMorph",e[e.ImpulseMorph=10]="ImpulseMorph"}(n=e.Type||(e.Type={})),function(e){let t;!function(e){e[e.Multiply=0]="Multiply",e[e.Add=1]="Add"}(t=e.Type||(e.Type={}))}(i=e.MaterialMorph||(e.MaterialMorph={}))}(o=e.Morph||(e.Morph={})),function(e){let t;!function(e){let t;!function(e){e[e.Bone=0]="Bone",e[e.Morph=1]="Morph"}(t=e.FrameType||(e.FrameType={}))}(t=e.FrameData||(e.FrameData={}))}(a=e.DisplayFrame||(e.DisplayFrame={})),function(e){let t,n;!function(e){e[e.Sphere=0]="Sphere",e[e.Box=1]="Box",e[e.Capsule=2]="Capsule"}(t=e.ShapeType||(e.ShapeType={})),function(e){e[e.FollowBone=0]="FollowBone",e[e.Physics=1]="Physics",e[e.PhysicsWithBone=2]="PhysicsWithBone"}(n=e.PhysicsMode||(e.PhysicsMode={}))}(s=e.RigidBody||(e.RigidBody={})),function(e){let t;!function(e){e[e.Spring6dof=0]="Spring6dof",e[e.Sixdof=1]="Sixdof",e[e.P2p=2]="P2p",e[e.ConeTwist=3]="ConeTwist",e[e.Slider=4]="Slider",e[e.Hinge=5]="Hinge"}(t=e.Type||(e.Type={}))}(l=e.Joint||(e.Joint={})),function(e){let t,n,i;!function(e){e[e.TriMesh=0]="TriMesh",e[e.Rope=1]="Rope"}(t=e.Type||(e.Type={})),function(e){e[e.Blink=1]="Blink",e[e.ClusterCreation=2]="ClusterCreation",e[e.LinkCrossing=4]="LinkCrossing"}(n=e.Flag||(e.Flag={})),function(e){e[e.VertexPoint=0]="VertexPoint",e[e.VertexTwoSided=1]="VertexTwoSided",e[e.VertexOneSided=2]="VertexOneSided",e[e.FaceTwoSided=3]="FaceTwoSided",e[e.FaceOneSided=4]="FaceOneSided"}(i=e.AeroDynamicModel||(e.AeroDynamicModel={}))}(h=e.SoftBody||(e.SoftBody={}))}(i||(i={}))},6970:e=>{e.exports=Z},7110:(e,t,n)=>{e.exports=n.p+"ea4341cdfc7fbd5645cd.wasm"},7116:e=>{e.exports=z},7198:(e,t,n)=>{n.d(t,{B:()=>i});const i="\n#ifndef SDEFDECLARATION\n#define SDEFDECLARATION\n#if NUM_BONE_INFLUENCERS>0 && defined(SDEF)\nattribute matricesSdefC: vec3f;attribute matricesSdefRW0: vec3f;attribute matricesSdefRW1: vec3f;fn rotationMatrixToQuaternion(matrix: mat3x3f)->vec4f {let trace: f32=matrix[0][0]+matrix[1][1]+matrix[2][2];var s: f32;var sqrtParam: f32;if (trace>0.0) {sqrtParam=trace+1.0;} else if (matrix[0][0]>matrix[1][1] && matrix[0][0]>matrix[2][2]) {sqrtParam=1.0+matrix[0][0]-matrix[1][1]-matrix[2][2];} else if (matrix[1][1]>matrix[2][2]) {sqrtParam=1.0+matrix[1][1]-matrix[0][0]-matrix[2][2];} else {sqrtParam=1.0+matrix[2][2]-matrix[0][0]-matrix[1][1];}\nlet sqrtValue: f32=sqrt(sqrtParam);if (trace>0.0) {s=0.5/sqrtValue;return vec4f(\n(matrix[1][2]-matrix[2][1])*s,\n(matrix[2][0]-matrix[0][2])*s,\n(matrix[0][1]-matrix[1][0])*s,\n0.25/s\n);} else if (matrix[0][0]>matrix[1][1] && matrix[0][0]>matrix[2][2]) {s=2.0*sqrtValue;return vec4f(\n0.25*s,\n(matrix[0][1]+matrix[1][0])/s,\n(matrix[2][0]+matrix[0][2])/s,\n(matrix[1][2]-matrix[2][1])/s\n);} else if (matrix[1][1]>matrix[2][2]) {s=2.0*sqrtValue;return vec4f(\n(matrix[0][1]+matrix[1][0])/s,\n0.25*s,\n(matrix[1][2]+matrix[2][1])/s,\n(matrix[2][0]-matrix[0][2])/s\n);} else {s=2.0*sqrtValue;return vec4f(\n(matrix[2][0]+matrix[0][2])/s,\n(matrix[1][2]+matrix[2][1])/s,\n0.25*s,\n(matrix[0][1]-matrix[1][0])/s\n);}}\nfn quaternionToRotationMatrix(q: vec4f)->mat3x3f {let xx: f32=q.x*q.x;let yy: f32=q.y*q.y;let zz: f32=q.z*q.z;let xy: f32=q.x*q.y;let zw: f32=q.z*q.w;let zx: f32=q.z*q.x;let yw: f32=q.y*q.w;let yz: f32=q.y*q.z;let xw: f32=q.x*q.w;return mat3x3f(\n1.0-2.0*(yy+zz),2.0*(xy+zw),2.0*(zx-yw),\n2.0*(xy-zw),1.0-2.0*(zz+xx),2.0*(yz+xw),\n2.0*(zx+yw),2.0*(yz-xw),1.0-2.0*(yy+xx)\n);}\nfn slerp(q0: vec4f,_q1: vec4f,t: f32)->vec4f {var q1: vec4f=_q1;var cosTheta: f32=dot(q0,q1);q1=mix(-q1,q1,step(0.0,cosTheta));cosTheta=abs(cosTheta);if (cosTheta>0.999999) {return normalize(mix(q0,q1,t));}\nvar theta: f32=acos(cosTheta);var sinTheta: f32=sin(theta);var w0: f32=sin((1.0-t)*theta)/sinTheta;var w1: f32=sin(t*theta)/sinTheta;return q0*w0+q1*w1;}\n#endif\n#endif\n"},7203:e=>{e.exports=o},7236:(e,t,n)=>{e.exports=n.p+"34b17d36de390d2a3229.wasm"},7325:e=>{e.exports=re},7348:e=>{e.exports=le},7396:e=>{e.exports=l},7466:e=>{e.exports=k},7508:e=>{e.exports=d},7518:(e,t,n)=>{e.exports=n.p+"d5e1deda0372ba1bd402.wasm"},7556:(e,t,n)=>{var i;n.d(t,{h:()=>i}),function(e){let t,n,i;!function(e){let t,n,i;!function(e){e[e.IsSkinnedMesh=1]="IsSkinnedMesh"}(t=e.MeshType||(e.MeshType={})),function(e){e[e.HasSdef=1]="HasSdef",e[e.IsIndexed=2]="IsIndexed",e[e.HasEdgeScale=4]="HasEdgeScale"}(n=e.GeometryType||(e.GeometryType={})),function(e){e[e.Int32=0]="Int32",e[e.Uint32=1]="Uint32",e[e.Uint16=2]="Uint16"}(i=e.IndexElementType||(e.IndexElementType={}))}(t=e.Geometry||(e.Geometry={})),function(e){let t;!function(e){e[e.HasMimeType=1]="HasMimeType"}(t=e.Flag||(e.Flag={}))}(n=e.Image||(e.Image={})),function(e){let t;!function(e){e[e.NoMipmap=1]="NoMipmap",e[e.InvertY=2]="InvertY"}(t=e.Flag||(e.Flag={}))}(i=e.Texture||(e.Texture={}))}(i||(i={}))},7569:(e,t,n)=>{n.d(t,{Q:()=>i});const i={name:"pmd",extensions:{".pmd":{isBinary:!0}}}},8257:e=>{e.exports=fe},8296:e=>{e.exports=xe},8474:e=>{e.exports=Se},8619:e=>{e.exports=V},8628:e=>{e.exports=Te},8698:e=>{e.exports=F},8754:(e,t,n)=>{e.exports=n.p+"15cf34a22bdccf9ec7a6.wasm"},8767:e=>{e.exports=ae},8980:(e,t,n)=>{n.r(t),n.d(t,{mmdOutlinePixelShader:()=>o}),n(9321),n(182),n(5587),n(4184);const i="mmdOutlinePixelShader",r="\nuniform color: vec4f;\n#ifdef ALPHATEST\nvarying vUV: vec2;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;\n#endif\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\n@fragment\nfn main(input: FragmentInputs)->FragmentOutputs {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n#ifdef ALPHATEST\nif (textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUV).a<0.4) {discard;}\n#endif\n#include<logDepthFragment>\nfragmentOutputs.color=uniforms.color;\n#define CUSTOM_FRAGMENT_MAIN_END\n}\n";n(4234).ShaderStore.ShadersStoreWGSL[i]=r;const o={name:i,shader:r}},9077:(e,t,n)=>{n.r(t),n.d(t,{_DxBmpTextureLoader:()=>o});var i=n(2074),r=n(3843);class o{supportCascades=!1;loadCubeData(){throw".dxbmp not supported in Cube"}static _HeaderExtension=new Uint8Array([0,0,255,0,0,255,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);_injectHeader(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(19778!==t.getUint16(0,!0))return e;if(40!==t.getUint32(14,!0))return e;if(32!==t.getUint16(28,!0))return e;if(0!==t.getUint32(30,!0))return e;const n=new Uint8Array(e.byteLength+68);n.set(new Uint8Array(e.buffer,e.byteOffset,54),0),n.set(new Uint8Array(e.buffer,e.byteOffset+54,e.byteLength-54),122);const i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=i.getUint32(2,!0);i.setUint32(2,r+68,!0);const a=i.getUint32(10,!0);return i.setUint32(10,a+68,!0),i.setUint32(14,108,!0),i.setUint32(30,3,!0),n.set(o._HeaderExtension,54),n}_workingCanvas=null;_workingContext=null;_prepareTextureProcess(e,t){const n=e.getEngine();if(!this._workingCanvas&&(this._workingCanvas=document.createElement("canvas"),this._workingContext=this._workingCanvas.getContext("2d"),!this._workingContext))throw new Error("Unable to get 2d context");const i=this._workingCanvas,o=this._workingContext;i.width=t.width,i.height=t.height,o.drawImage(t,0,0);const a=o.getImageData(0,0,t.width,t.height).data;e.type=r.Constants.TEXTURETYPE_UNSIGNED_BYTE,e.format=r.Constants.TEXTUREFORMAT_RGBA,n._uploadDataToTextureDirectly(e,a,void 0,void 0,void 0,!0)}loadData(e,t,n){const r=this._injectHeader(e),o=t.getEngine();i.AbstractEngine._FileToolsLoadImage(r,(e=>{n(e.width,e.height,!0,!1,(()=>this._prepareTextureProcess(t,e)))}),((e,t)=>{n(1,1,!1,!1,(()=>{}),!0)}),null,void 0,t.invertY&&o._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0)}}},9106:e=>{e.exports=Q},9125:e=>{e.exports=D},9127:e=>{e.exports=r},9150:e=>{e.exports=B},9190:e=>{e.exports=b},9321:e=>{e.exports=Ne},9339:(e,t,n)=>{n.d(t,{B:()=>i});const i="\n#ifndef SDEFDECLARATION\n#define SDEFDECLARATION\n#if NUM_BONE_INFLUENCERS>0 && defined(SDEF)\nattribute vec3 matricesSdefC;attribute vec3 matricesSdefRW0;attribute vec3 matricesSdefRW1;vec4 rotationMatrixToQuaternion(mat3 matrix) {float trace=matrix[0][0]+matrix[1][1]+matrix[2][2];float s;float sqrtParam;if (trace>0.0) {sqrtParam=trace+1.0;} else if (matrix[0][0]>matrix[1][1] && matrix[0][0]>matrix[2][2]) {sqrtParam=1.0+matrix[0][0]-matrix[1][1]-matrix[2][2];} else if (matrix[1][1]>matrix[2][2]) {sqrtParam=1.0+matrix[1][1]-matrix[0][0]-matrix[2][2];} else {sqrtParam=1.0+matrix[2][2]-matrix[0][0]-matrix[1][1];}\nfloat sqrtValue=sqrt(sqrtParam);if (trace>0.0) {s=0.5/sqrtValue;return vec4(\n(matrix[1][2]-matrix[2][1])*s,\n(matrix[2][0]-matrix[0][2])*s,\n(matrix[0][1]-matrix[1][0])*s,\n0.25/s\n);} else if (matrix[0][0]>matrix[1][1] && matrix[0][0]>matrix[2][2]) {s=2.0*sqrtValue;return vec4(\n0.25*s,\n(matrix[0][1]+matrix[1][0])/s,\n(matrix[2][0]+matrix[0][2])/s,\n(matrix[1][2]-matrix[2][1])/s\n);} else if (matrix[1][1]>matrix[2][2]) {s=2.0*sqrtValue;return vec4(\n(matrix[0][1]+matrix[1][0])/s,\n0.25*s,\n(matrix[1][2]+matrix[2][1])/s,\n(matrix[2][0]-matrix[0][2])/s\n);} else {s=2.0*sqrtValue;return vec4(\n(matrix[2][0]+matrix[0][2])/s,\n(matrix[1][2]+matrix[2][1])/s,\n0.25*s,\n(matrix[0][1]-matrix[1][0])/s\n);}}\nmat3 quaternionToRotationMatrix(vec4 q) {float xx=q.x*q.x;float yy=q.y*q.y;float zz=q.z*q.z;float xy=q.x*q.y;float zw=q.z*q.w;float zx=q.z*q.x;float yw=q.y*q.w;float yz=q.y*q.z;float xw=q.x*q.w;return mat3(\n1.0-2.0*(yy+zz),2.0*(xy+zw),2.0*(zx-yw),\n2.0*(xy-zw),1.0-2.0*(zz+xx),2.0*(yz+xw),\n2.0*(zx+yw),2.0*(yz-xw),1.0-2.0*(yy+xx)\n);}\nvec4 slerp(vec4 q0,vec4 q1,float t) {float cosTheta=dot(q0,q1);q1=mix(-q1,q1,step(0.0,cosTheta));cosTheta=abs(cosTheta);if (cosTheta>0.999999) {return normalize(mix(q0,q1,t));}\nfloat theta=acos(cosTheta);float sinTheta=sin(theta);float w0=sin((1.0-t)*theta)/sinTheta;float w1=sin(t*theta)/sinTheta;return q0*w0+q1*w1;}\n#endif\n#endif\n"},9430:e=>{e.exports=f},9457:(e,t,n)=>{n.r(t),n.d(t,{textureAlphaCheckerPixelShader:()=>o});const i="textureAlphaCheckerPixelShader",r="\nprecision highp float;uniform sampler2D textureSampler;varying vec2 vUv;void main() {gl_FragColor=vec4(vec3(1.0)-vec3(texture2D(textureSampler,vUv).a),1.0);}\n";n(4234).ShaderStore.ShadersStore[i]=r;const o={name:i,shader:r}},9481:(e,t,n)=>{n.d(t,{k:()=>l});var i=n(3376),r=n(6377),o=n(3929),a=n(2792),s=n(3036);class l extends o.Mesh{applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId===this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(i.VertexBuffer.PositionKind))return this;if(!this.isVerticesDataPresent(i.VertexBuffer.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(i.VertexBuffer.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(i.VertexBuffer.NormalKind),n=this._internalMeshDataInfo;if(!n._sourcePositions){const e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!n._sourceNormals&&this.setNormalsForCPUSkinning();let o=this.getVerticesData(i.VertexBuffer.PositionKind);if(!o)return this;o instanceof Float32Array||(o=new Float32Array(o));let a=this.getVerticesData(i.VertexBuffer.NormalKind);if(t){if(!a)return this;a instanceof Float32Array||(a=new Float32Array(a))}const l=this.isVerticesDataPresent(s.V.MatricesSdefCKind);let h=null,d=null,c=null;l&&(h=this.getVerticesData(s.V.MatricesSdefCKind),d=this.getVerticesData(s.V.MatricesSdefRW0Kind),c=this.getVerticesData(s.V.MatricesSdefRW1Kind));const u=this.getVerticesData(i.VertexBuffer.MatricesIndicesKind),m=this.getVerticesData(i.VertexBuffer.MatricesWeightsKind);if(!m||!u)return this;const p=this.numBoneInfluencers>4,_=p?this.getVerticesData(i.VertexBuffer.MatricesIndicesExtraKind):null,g=p?this.getVerticesData(i.VertexBuffer.MatricesWeightsExtraKind):null,f=e.getTransformMatrices(this),b=r.Vector3.Zero(),y=new r.Matrix,w=new r.Matrix,A=new r.Matrix,M=new r.Matrix,T=new r.Quaternion,x=new r.Quaternion,v=new r.Vector3,I=n._sourcePositions,B=n._sourceNormals;let P,S=0;for(let e=0;e<o.length;e+=3,S+=4){let n=0;if(l&&(n=d[e]),0===n){let n;for(P=0;P<4;P++)n=m[S+P],n>0&&(r.Matrix.FromFloat32ArrayToRefScaled(f,Math.floor(16*u[S+P]),n,w),y.addToSelf(w));if(p)for(P=0;P<4;P++)n=g[S+P],n>0&&(r.Matrix.FromFloat32ArrayToRefScaled(f,Math.floor(16*_[S+P]),n,w),y.addToSelf(w));r.Vector3.TransformCoordinatesFromFloatsToRef(I[e],I[e+1],I[e+2],y,b),b.toArray(o,e),t&&(r.Vector3.TransformNormalFromFloatsToRef(B[e],B[e+1],B[e+2],y,b),b.toArray(a,e)),y.reset()}else{const n=m[S+0],i=m[S+1];r.Matrix.FromArrayToRef(f,Math.floor(16*u[S+0]),A),r.Matrix.FromArrayToRef(f,Math.floor(16*u[S+1]),M),r.Quaternion.FromRotationMatrixToRef(A,T),r.Quaternion.FromRotationMatrixToRef(M,x),r.Matrix.FromQuaternionToRef(r.Quaternion.SlerpToRef(T,x,i,T),w),r.Vector3.TransformCoordinatesFromFloatsToRef(I[e]-h[e],I[e+1]-h[e+1],I[e+2]-h[e+2],w,v),r.Vector3.TransformCoordinatesFromFloatsToRef(d[e],d[e+1],d[e+2],A,b).scaleAndAddToRef(n,v),r.Vector3.TransformCoordinatesFromFloatsToRef(c[e],c[e+1],c[e+2],M,b).scaleAndAddToRef(i,v),v.toArray(o,e),t&&(r.Vector3.TransformNormalFromFloatsToRef(B[e],B[e+1],B[e+2],w,v),v.toArray(a,e))}}return this.updateVerticesData(i.VertexBuffer.PositionKind,o),t&&this.updateVerticesData(i.VertexBuffer.NormalKind,a),this}getClassName(){return"SdefMesh"}clone(e="",t=null,n,i=!0){return new l(e,this.getScene(),t,this,n,i)}}(0,a.RegisterClass)("BABYLON.SdefMesh",l)},9535:e=>{e.exports=Ie},9721:e=>{e.exports=ke},9722:(e,t,n)=>{n.d(t,{X:()=>s});var i=n(1599),r=n(5297),o=n(6910);class a{_vertexIndexSize;_textureIndexSize;_materialIndexSize;_boneIndexSize;_morphIndexSize;_rigidBodyIndexSize;constructor(e,t,n,i,r,o){this._vertexIndexSize=e,this._textureIndexSize=t,this._materialIndexSize=n,this._boneIndexSize=i,this._morphIndexSize=r,this._rigidBodyIndexSize=o}getVertexIndex(e){switch(this._vertexIndexSize){case 1:return e.getUint8();case 2:return e.getUint16();case 4:return e.getInt32();default:throw new Error(`Invalid vertexIndexSize: ${this._vertexIndexSize}`)}}_getNonVertexIndex(e,t){switch(t){case 1:return e.getInt8();case 2:return e.getInt16();case 4:return e.getInt32();default:throw new Error(`Invalid indexSize: ${t}`)}}getTextureIndex(e){return this._getNonVertexIndex(e,this._textureIndexSize)}getMaterialIndex(e){return this._getNonVertexIndex(e,this._materialIndexSize)}getBoneIndex(e){return this._getNonVertexIndex(e,this._boneIndexSize)}getMorphIndex(e){return this._getNonVertexIndex(e,this._morphIndexSize)}getRigidBodyIndex(e){return this._getNonVertexIndex(e,this._rigidBodyIndexSize)}}class s{constructor(){}static async ParseAsync(e,t=new i.C){const n=new r.u(e),o=this._ParseHeader(n,t),s=new a(o.vertexIndexSize,o.textureIndexSize,o.materialIndexSize,o.boneIndexSize,o.morphIndexSize,o.rigidBodyIndexSize),l=await this._ParseVerticesAsync(n,s,o),h=this._ParseIndices(n,s,o),d=this._ParseTextures(n),c=this._ParseMaterials(n,s),u=this._ParseBones(n,s),m=this._ParseMorphs(n,s),p=this._ParseDisplayFrames(n,s),_=this._ParseRigidBodies(n,s),g=this._ParseJoints(n,s),f=o.version<=2?[]:this._ParseSoftBodies(n,s,o);return n.bytesAvailable>0&&t.warn(`There are ${n.bytesAvailable} bytes left after parsing`),{header:o,vertices:l,indices:h,textures:d,materials:c,bones:u,morphs:m,displayFrames:p,rigidBodies:_,joints:g,softBodies:f}}static _ParseHeader(e,t){if(e.bytesAvailable<17)throw new RangeError("is not pmx file");const n=e.getSignatureString(3);if("PMX"!==n)throw new RangeError("is not pmx file");e.getInt8();const i=e.getFloat32(),r=e.getUint8(),a=e.getUint8();e.initializeTextDecoder(a===o.B.Header.Encoding.Utf8?"utf-8":"utf-16le");const s=e.getUint8(),l=e.getUint8(),h=e.getUint8(),d=e.getUint8(),c=e.getUint8(),u=e.getUint8(),m=e.getUint8();if(r<8)throw new Error(`Invalid globalsCount: ${r}`);if(8<r){t.warn(`globalsCount is greater than 8: ${r} files may be corrupted or higher version`);for(let t=8;t<r;++t)e.getUint8()}return{signature:n,version:i,encoding:a,additionalVec4Count:s,vertexIndexSize:l,textureIndexSize:h,materialIndexSize:d,boneIndexSize:c,morphIndexSize:u,rigidBodyIndexSize:m,modelName:e.getDecoderString(e.getInt32(),!1),englishModelName:e.getDecoderString(e.getInt32(),!1),comment:e.getDecoderString(e.getInt32(),!1),englishComment:e.getDecoderString(e.getInt32(),!1)}}static async _ParseVerticesAsync(e,t,n){const i=e.getInt32(),r=[];let a=performance.now();for(let s=0;s<i;++s){const i=e.getFloat32Tuple(3),l=e.getFloat32Tuple(3),h=e.getFloat32Tuple(2),d=[];for(let t=0;t<n.additionalVec4Count;++t)d.push(e.getFloat32Tuple(4));const c=e.getUint8();let u;switch(c){case o.B.Vertex.BoneWeightType.Bdef1:u={boneIndices:t.getBoneIndex(e),boneWeights:null};break;case o.B.Vertex.BoneWeightType.Bdef2:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:e.getFloat32()};break;case o.B.Vertex.BoneWeightType.Bdef4:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;case o.B.Vertex.BoneWeightType.Sdef:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:{boneWeight0:e.getFloat32(),c:e.getFloat32Tuple(3),r0:e.getFloat32Tuple(3),r1:e.getFloat32Tuple(3)}};break;case o.B.Vertex.BoneWeightType.Qdef:u={boneIndices:[t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e),t.getBoneIndex(e)],boneWeights:[e.getFloat32(),e.getFloat32(),e.getFloat32(),e.getFloat32()]};break;default:throw new Error(`Invalid weightType: ${c}`)}const m=e.getFloat32();r.push({position:i,normal:l,uv:h,additionalVec4:d,weightType:c,boneWeight:u,edgeScale:m}),s%1e4==0&&100<performance.now()-a&&(await new Promise((e=>setTimeout(e,0))),a=performance.now())}return r}static _ParseIndices(e,t,n){const i=e.getInt32(),r=new ArrayBuffer(i*n.vertexIndexSize);let o;switch(n.vertexIndexSize){case 1:o=new Uint8Array(r);break;case 2:o=new Uint16Array(r);break;case 4:o=new Int32Array(r);break;default:throw new Error(`Invalid vertexIndexSize: ${n.vertexIndexSize}`)}for(let n=0;n<i;++n)o[n]=t.getVertexIndex(e);return o}static _ParseTextures(e){const t=e.getInt32(),n=[];for(let i=0;i<t;++i){const t=e.getDecoderString(e.getInt32(),!1);n.push(t)}return n}static _ParseMaterials(e,t){const n=e.getInt32(),i=[];for(let r=0;r<n;++r){const n=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),o=e.getFloat32Tuple(4),a=e.getFloat32Tuple(3),s=e.getFloat32(),l=e.getFloat32Tuple(3),h=e.getUint8(),d=e.getFloat32Tuple(4),c=e.getFloat32(),u=t.getTextureIndex(e),m=t.getTextureIndex(e),p=e.getUint8(),_=1===e.getUint8(),g={name:n,englishName:r,diffuse:o,specular:a,shininess:s,ambient:l,flag:h,edgeColor:d,edgeSize:c,textureIndex:u,sphereTextureIndex:m,sphereTextureMode:p,isSharedToonTexture:_,toonTextureIndex:_?e.getUint8():t.getTextureIndex(e),comment:e.getDecoderString(e.getInt32(),!1),indexCount:e.getInt32()};i.push(g)}return i}static _ParseBones(e,t){const n=e.getInt32(),i=[];for(let r=0;r<n;++r){const n=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),a=e.getFloat32Tuple(3),s=t.getBoneIndex(e),l=e.getInt32(),h=e.getUint16();let d,c,u,m,p,_;if(d=h&o.B.Bone.Flag.UseBoneIndexAsTailPosition?t.getBoneIndex(e):e.getFloat32Tuple(3),(h&o.B.Bone.Flag.HasAppendMove||h&o.B.Bone.Flag.HasAppendRotate)&&(c={parentIndex:t.getBoneIndex(e),ratio:e.getFloat32()}),h&o.B.Bone.Flag.HasAxisLimit&&(u=e.getFloat32Tuple(3)),h&o.B.Bone.Flag.HasLocalVector&&(m={x:e.getFloat32Tuple(3),z:e.getFloat32Tuple(3)}),h&o.B.Bone.Flag.IsExternalParentTransformed&&(p=e.getInt32()),h&o.B.Bone.Flag.IsIkEnabled){const n=t.getBoneIndex(e),i=e.getInt32(),r=e.getFloat32(),o=[],a=e.getInt32();for(let n=0;n<a;++n){const n={target:t.getBoneIndex(e),limitation:1===e.getUint8()?{minimumAngle:e.getFloat32Tuple(3),maximumAngle:e.getFloat32Tuple(3)}:void 0};o.push(n)}_={target:n,iteration:i,rotationConstraint:r,links:o}}const g={name:n,englishName:r,position:a,parentBoneIndex:s,transformOrder:l,flag:h,tailPosition:d,appendTransform:c,axisLimit:u,localVector:m,externalParentTransform:p,ik:_};i.push(g)}return i}static _ParseMorphs(e,t){const n=e.getInt32(),i=[];for(let r=0;r<n;++r){const n=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),a=e.getInt8(),s=e.getInt8();let l={name:n,englishName:r,category:a,type:s};const h=e.getInt32();switch(s){case o.B.Morph.Type.GroupMorph:{const n=new Int32Array(h),i=new Float32Array(h);for(let r=0;r<h;++r)n[r]=t.getMorphIndex(e),i[r]=e.getFloat32();l={...l,indices:n,ratios:i}}break;case o.B.Morph.Type.VertexMorph:{const n=new Int32Array(h),i=new Float32Array(3*h);for(let r=0;r<h;++r)n[r]=t.getVertexIndex(e),i[3*r+0]=e.getFloat32(),i[3*r+1]=e.getFloat32(),i[3*r+2]=e.getFloat32();l={...l,indices:n,positions:i}}break;case o.B.Morph.Type.BoneMorph:{const n=new Int32Array(h),i=new Float32Array(3*h),r=new Float32Array(4*h);for(let o=0;o<h;++o)n[o]=t.getBoneIndex(e),i[3*o+0]=e.getFloat32(),i[3*o+1]=e.getFloat32(),i[3*o+2]=e.getFloat32(),r[4*o+0]=e.getFloat32(),r[4*o+1]=e.getFloat32(),r[4*o+2]=e.getFloat32(),r[4*o+3]=e.getFloat32();l={...l,indices:n,positions:i,rotations:r}}break;case o.B.Morph.Type.UvMorph:case o.B.Morph.Type.AdditionalUvMorph1:case o.B.Morph.Type.AdditionalUvMorph2:case o.B.Morph.Type.AdditionalUvMorph3:case o.B.Morph.Type.AdditionalUvMorph4:{const n=new Int32Array(h),i=new Float32Array(4*h);for(let r=0;r<h;++r)n[r]=t.getVertexIndex(e),i[4*r+0]=e.getFloat32(),i[4*r+1]=e.getFloat32(),i[4*r+2]=e.getFloat32(),i[4*r+3]=e.getFloat32();l={...l,indices:n,offsets:i}}break;case o.B.Morph.Type.MaterialMorph:{const n=[];for(let i=0;i<h;++i){const i={index:t.getMaterialIndex(e),type:e.getUint8(),diffuse:e.getFloat32Tuple(4),specular:e.getFloat32Tuple(3),shininess:e.getFloat32(),ambient:e.getFloat32Tuple(3),edgeColor:e.getFloat32Tuple(4),edgeSize:e.getFloat32(),textureColor:e.getFloat32Tuple(4),sphereTextureColor:e.getFloat32Tuple(4),toonTextureColor:e.getFloat32Tuple(4)};n.push(i)}l={...l,elements:n}}break;case o.B.Morph.Type.FlipMorph:{const n=new Int32Array(h),i=new Float32Array(h);for(let r=0;r<h;++r)n[r]=t.getMorphIndex(e),i[r]=e.getFloat32();l={...l,indices:n,ratios:i}}break;case o.B.Morph.Type.ImpulseMorph:{const n=new Int32Array(h),i=new Array(h),r=new Float32Array(3*h),o=new Float32Array(3*h);for(let a=0;a<h;++a)n[a]=t.getRigidBodyIndex(e),i[a]=1===e.getUint8(),r[3*a+0]=e.getFloat32(),r[3*a+1]=e.getFloat32(),r[3*a+2]=e.getFloat32(),o[3*a+0]=e.getFloat32(),o[3*a+1]=e.getFloat32(),o[3*a+2]=e.getFloat32();l={...l,indices:n,isLocals:i,velocities:r,torques:o}}break;default:throw new Error(`Unknown morph type: ${s}`)}i.push(l)}return i}static _ParseDisplayFrames(e,t){const n=e.getInt32(),i=[];for(let r=0;r<n;++r){const n=e.getDecoderString(e.getInt32(),!1),r=e.getDecoderString(e.getInt32(),!1),a=1===e.getUint8(),s=e.getInt32(),l=[];for(let n=0;n<s;++n){const n=e.getUint8(),i={type:n,index:n===o.B.DisplayFrame.FrameData.FrameType.Bone?t.getBoneIndex(e):t.getMorphIndex(e)};l.push(i)}const h={name:n,englishName:r,isSpecialFrame:a,frames:l};i.push(h)}return i}static _ParseRigidBodies(e,t){const n=e.getInt32(),i=[];for(let r=0;r<n;++r){const n={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),boneIndex:t.getBoneIndex(e),collisionGroup:e.getUint8(),collisionMask:e.getUint16(),shapeType:e.getUint8(),shapeSize:e.getFloat32Tuple(3),shapePosition:e.getFloat32Tuple(3),shapeRotation:e.getFloat32Tuple(3),mass:e.getFloat32(),linearDamping:e.getFloat32(),angularDamping:e.getFloat32(),repulsion:e.getFloat32(),friction:e.getFloat32(),physicsMode:e.getUint8()};i.push(n)}return i}static _ParseJoints(e,t){const n=e.getInt32(),i=[];for(let r=0;r<n;++r){const n={name:e.getDecoderString(e.getInt32(),!1),englishName:e.getDecoderString(e.getInt32(),!1),type:e.getUint8(),rigidbodyIndexA:t.getRigidBodyIndex(e),rigidbodyIndexB:t.getRigidBodyIndex(e),position:e.getFloat32Tuple(3),rotation:e.getFloat32Tuple(3),positionMin:e.getFloat32Tuple(3),positionMax:e.getFloat32Tuple(3),rotationMin:e.getFloat32Tuple(3),rotationMax:e.getFloat32Tuple(3),springPosition:e.getFloat32Tuple(3),springRotation:e.getFloat32Tuple(3)};i.push(n)}return i}static _ParseSoftBodies(e,t,n){const i=e.getInt32(),r=[];for(let o=0;o<i;++o){const i=e.getDecoderString(e.getInt32(),!1),o=e.getDecoderString(e.getInt32(),!1),a=e.getUint8(),s=t.getMaterialIndex(e),l=e.getUint8(),h=e.getUint16(),d=e.getUint8(),c=e.getInt32(),u=e.getInt32(),m=e.getFloat32(),p=e.getFloat32(),_=e.getInt32(),g={vcf:e.getFloat32(),dp:e.getFloat32(),dg:e.getFloat32(),lf:e.getFloat32(),pr:e.getFloat32(),vc:e.getFloat32(),df:e.getFloat32(),mt:e.getFloat32(),chr:e.getFloat32(),khr:e.getFloat32(),shr:e.getFloat32(),ahr:e.getFloat32()},f={srhrCl:e.getFloat32(),skhrCl:e.getFloat32(),sshrCl:e.getFloat32(),srSpltCl:e.getFloat32(),skSpltCl:e.getFloat32(),ssSpltCl:e.getFloat32()},b={vIt:e.getInt32(),pIt:e.getInt32(),dIt:e.getInt32(),cIt:e.getInt32()},y={lst:e.getInt32(),ast:e.getInt32(),vst:e.getInt32()},w=e.getInt32(),A=[];for(let n=0;n<w;++n){const n={rigidbodyIndex:t.getRigidBodyIndex(e),vertexIndex:t.getVertexIndex(e),isNearMode:0!==e.getUint8()};A.push(n)}const M=e.getInt32(),T=new ArrayBuffer(M*n.vertexIndexSize);let x;switch(n.vertexIndexSize){case 1:x=new Uint8Array(T);break;case 2:x=new Uint16Array(T);break;case 4:x=new Int32Array(T);break;default:throw new Error(`Invalid vertexIndexSize: ${n.vertexIndexSize}`)}for(let n=0;n<M;++n)x[n]=t.getVertexIndex(e);const v={name:i,englishName:o,type:a,materialIndex:s,collisionGroup:l,collisionMask:h,flags:d,bLinkDistance:c,clusterCount:u,totalMass:m,collisionMargin:p,aeroModel:_,config:g,cluster:f,iteration:b,material:y,anchors:A,vertexPins:x};r.push(v)}return r}}},9866:e=>{e.exports=a},9897:(e,t,n)=>{n.d(t,{A:()=>i});class i{static Data=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="]}},9928:(e,t,n)=>{e.exports=n.p+"4fafb77622a273a33dad.wasm"}},Ve={};function We(e){var t=Ve[e];if(void 0!==t)return t.exports;var n=Ve[e]={exports:{}};return Ue[e](n,n.exports,We),n.exports}We.m=Ue,We.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return We.d(t,{a:t}),t},We.d=(e,t)=>{for(var n in t)We.o(t,n)&&!We.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},We.u=e=>e+".babylon.mmd.min.js",We.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),We.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),We.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;We.g.importScripts&&(e=We.g.location+"");var t=We.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length)for(var i=n.length-1;i>-1&&(!e||!/^http(s?):/.test(e));)e=n[i--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),We.p=e})(),We.b=document.baseURI||self.location.href;var ze={};We.r(ze),We.d(ze,{AnimationRetargeter:()=>Gn,AudioElementPool:()=>ai,BpmxConverter:()=>Cn,BpmxLoader:()=>On.BpmxLoader,BpmxLoaderMetadata:()=>bn.S,BpmxObject:()=>Pn.h,BpmxReader:()=>Sn.N,BvmdConverter:()=>kn,BvmdLoader:()=>Dn,ConsoleLogger:()=>Ln.C,DisplayTimeFormat:()=>hl,HumanoidMmd:()=>Al,MixamoMmdHumanoidBoneMap:()=>Yn,MmdAmmoJSPlugin:()=>el,MmdAmmoPhysics:()=>ll,MmdAmmoPhysicsModel:()=>sl,MmdAnimation:()=>vn,MmdAnimationBase:()=>Mt,MmdAnimationSpan:()=>_t,MmdAnimationTrack:()=>$t,MmdAsyncTextureLoader:()=>$n.J,MmdBoneAnimationTrack:()=>Xt,MmdCamera:()=>gn,MmdCameraAnimationGroup:()=>Ot,MmdCameraAnimationGroupBezierBuilder:()=>Nt,MmdCameraAnimationGroupHermiteBuilder:()=>kt,MmdCameraAnimationGroupSampleBuilder:()=>Ft,MmdCameraAnimationTrack:()=>en,MmdCompositeAnimation:()=>gt,MmdCompositeRuntimeCameraAnimation:()=>ft,MmdCompositeRuntimeModelAnimation:()=>At,MmdHumanoidMapper:()=>Hn,MmdMesh:()=>In,MmdModel:()=>El,MmdModelAnimationGroup:()=>qt,MmdModelAnimationGroupBezierBuilder:()=>Qt,MmdModelAnimationGroupHermiteBuilder:()=>Gt,MmdModelAnimationGroupSampleBuilder:()=>Yt,MmdModelMetadata:()=>Bn,MmdMorphAnimationTrack:()=>Zt,MmdMorphController:()=>Pl,MmdMorphControllerBase:()=>Vs,MmdMovableBoneAnimationTrack:()=>Jt,MmdPhysics:()=>bl,MmdPhysicsModel:()=>fl,MmdPlayerControl:()=>Ml,MmdPropertyAnimationTrack:()=>tn,MmdRuntime:()=>Cl,MmdRuntimeAnimation:()=>xt,MmdRuntimeCameraAnimation:()=>vt,MmdRuntimeCameraAnimationGroup:()=>Lt,MmdRuntimeModelAnimation:()=>Vt,MmdRuntimeModelAnimationGroup:()=>Ht,MmdStandardMaterial:()=>un.t,MmdStandardMaterialBuilder:()=>Xn.c,MmdStandardMaterialProxy:()=>qs,MmdStandardMaterialRenderMethod:()=>Xn.L,MmdWasmAnimation:()=>hn,MmdWasmAnimationTrack:()=>rn,MmdWasmBoneAnimationTrack:()=>on,MmdWasmInstanceTypeMD:()=>Yi,MmdWasmInstanceTypeMPD:()=>Or,MmdWasmInstanceTypeMPR:()=>co,MmdWasmInstanceTypeMR:()=>zo,MmdWasmInstanceTypeSD:()=>fa,MmdWasmInstanceTypeSPD:()=>Ga,MmdWasmInstanceTypeSPR:()=>hs,MmdWasmInstanceTypeSR:()=>Is,MmdWasmModel:()=>Xs,MmdWasmMorphAnimationTrack:()=>sn,MmdWasmMorphController:()=>Ws,MmdWasmMovableBoneAnimationTrack:()=>an,MmdWasmPhysics:()=>Fs,MmdWasmPhysicsRuntime:()=>Rs,MmdWasmPropertyAnimationTrack:()=>ln,MmdWasmRuntime:()=>Ys,MmdWasmRuntimeAnimationEvaluationType:()=>zs,MmdWasmRuntimeBone:()=>$s,MmdWasmRuntimeModelAnimation:()=>dn,OiComputeTransformInjector:()=>Tl,PmdLoader:()=>Jn.PmdLoader,PmdLoaderMetadata:()=>yn.Q,PmdReader:()=>Un.D,PmxLoader:()=>Zn.PmxLoader,PmxLoaderMetadata:()=>wn.I,PmxObject:()=>bt.B,PmxReader:()=>Vn.X,ReferenceFileResolver:()=>ei.g,SdefInjector:()=>ut,SharedToonTextures:()=>ti.A,StreamAudioPlayer:()=>si,TextureAlphaChecker:()=>ni.n,TransparencyMode:()=>ni.S,VmdData:()=>Wn,VmdLoader:()=>ri,VmdObject:()=>zn,VpdLoader:()=>oi,VpdReader:()=>jn,VrmMmdHumanoidBoneMap:()=>Qn,getMmdWasmInstance:()=>Us,registerDxBmpTextureLoader:()=>xn,registerMmdModelLoaders:()=>An});var je={};We.r(je),We.d(je,{AnimationPool:()=>Ni,MmdRuntime:()=>Li,createAnimationPool:()=>vi,createMmdRuntime:()=>xi,default:()=>Gi,init:()=>Ti,initSync:()=>qi,initThreadPool:()=>Oi,wbg_rayon_PoolBuilder:()=>Vi,wbg_rayon_start_worker:()=>ki});var qe={};We.r(qe),We.d(qe,{AnimationPool:()=>Mr,MmdRuntime:()=>xr,createAnimationPool:()=>lr,createMmdRuntime:()=>sr,default:()=>Cr,init:()=>ar,initSync:()=>Rr,initThreadPool:()=>yr,wbg_rayon_PoolBuilder:()=>Ir,wbg_rayon_start_worker:()=>wr});var Ke={};We.r(Ke),We.d(Ke,{AnimationPool:()=>Zr,MmdRuntime:()=>to,createAnimationPool:()=>Qr,createMmdRuntime:()=>Yr,default:()=>ho,init:()=>Gr,initSync:()=>so,initThreadPool:()=>$r,wbg_rayon_PoolBuilder:()=>io,wbg_rayon_start_worker:()=>Xr});var Ge={};We.r(Ge),We.d(Ge,{AnimationPool:()=>Eo,MmdRuntime:()=>Oo,createAnimationPool:()=>xo,createMmdRuntime:()=>To,default:()=>Wo,init:()=>Mo,initSync:()=>Uo,initThreadPool:()=>Po,wbg_rayon_PoolBuilder:()=>Fo,wbg_rayon_start_worker:()=>So});var Ye={};We.r(Ye),We.d(Ye,{AnimationPool:()=>ha,MmdRuntime:()=>ca,createAnimationPool:()=>Zo,createMmdRuntime:()=>Jo,default:()=>ga,init:()=>Xo,initSync:()=>pa});var Qe={};We.r(Qe),We.d(Qe,{AnimationPool:()=>La,MmdRuntime:()=>Va,createAnimationPool:()=>Ra,createMmdRuntime:()=>Sa,default:()=>Ka,init:()=>Pa,initSync:()=>ja});var He={};We.r(He),We.d(He,{AnimationPool:()=>ts,MmdRuntime:()=>is,createAnimationPool:()=>Ja,createMmdRuntime:()=>Xa,default:()=>ls,init:()=>$a,initSync:()=>as});var $e={};We.r($e),We.d($e,{AnimationPool:()=>bs,MmdRuntime:()=>ws,createAnimationPool:()=>gs,createMmdRuntime:()=>_s,default:()=>vs,init:()=>ps,initSync:()=>Ts});var Xe=We(3376),Je=We(3843),Ze=We(3272),et=We(1308),tt=We(9127),nt=We(7203),it=We(9866),rt=We(6377),ot=We(7396),at=We(2929),st=We(3036),lt=We(9339),ht=We(5041),dt=We(7198),ct=We(4122);class ut{static OverrideEngineCreateEffect(e){const t=e.createEffect.bind(e);e.createEffect=function(e,n,i,r,o,a,s,l,h,d=it.ShaderLanguage.GLSL,c){let u;if(u=n.attributes?n:{attributes:n,uniformsNames:i,uniformBuffersNames:[],samplers:r??[],defines:o??"",fallbacks:a??null,onCompiled:s??null,onError:l??null,indexParameters:h??null,shaderLanguage:d,extraInitializationsAsync:c},(u.uniformsNames.includes("mBones")||u.samplers.includes("boneSampler"))&&-1===u.defines.indexOf("#define SDEF")){u.attributes.push(st.V.MatricesSdefCKind),u.attributes.push(st.V.MatricesSdefRW0Kind),u.attributes.push(st.V.MatricesSdefRW1Kind),u.defines+="\n#define SDEF";const e=u.processCodeAfterIncludes;u.processCodeAfterIncludes=e?function(t,n){return n=e(t,n),ut.ProcessSdefCode(t,n)}:ut.ProcessSdefCode}return t(e,u,this)}}static ProcessSdefCode(e,t){if("vertex"!==e)return t;if(t.includes("finalWorld=finalWorld*influence;")){const e=t.includes("fn main"),n="#define CUSTOM_VERTEX_DEFINITIONS";if(t.includes(n))t=t.replace(n,`${n}\n${e?dt.B:lt.B}`);else{const n="void main() {";t=t.replace(n,`${e?dt.B:lt.B}\nvoid main() {`)}const i=new RegExp("finalWorld=finalWorld\\*influence;","g");t=t.replace(i,`${e?ct.Z:ht.Z}\nfinalWorld=finalWorld*influence;`)}return t}}ot.Scene.prototype.getMmdOutlineRenderer=function(){return this._mmdOutlineRenderer||(this._mmdOutlineRenderer=new mt(this)),this._mmdOutlineRenderer};class mt{name="MmdOutline";scene;zOffset=4;zOffsetUnits=0;_engine;_passIdForDrawWrapper;constructor(e){this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=this._engine.createRenderPassId("Mmd Outline Renderer")}register(){this.scene._afterRenderingMeshStage.registerStep(at.SceneComponentConstants.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){this._engine.releaseRenderPassId(this._passIdForDrawWrapper)}static _ViewMatrix=new Float32Array(9);static _InverseViewProjectionMatrix=new rt.Matrix;render(e,t,n){n=n??this._passIdForDrawWrapper;const i=this.scene,r=i.getEngine(),o=r.getCaps().instancedArrays&&(null!==t.visibleInstances[e._id]&&void 0!==t.visibleInstances[e._id]||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,o,n))return;const a=e.getMesh(),s=a._internalAbstractMeshDataInfo._actAsRegularMesh?a:null,l=e.getRenderingMesh(),h=s||l,d=e.getMaterial();if(!d||!i.activeCamera)return;const c=e._getDrawWrapper(n),u=et.DrawWrapper.GetEffect(c);r.enableEffect(c),d.useLogarithmicDepth&&u.setFloat("logarithmicDepthConstant",2/(Math.log(i.activeCamera.maxZ+1)/Math.LN2)),u.setFloat("offset",d.outlineWidth),u.setColor4("color",d.outlineColor,d.outlineAlpha);const m=r.getRenderHeight(),p=r.getRenderWidth();u.setFloat2("viewport",p,m);const _=mt._ViewMatrix;{const e=i.getViewMatrix().m;_[0]=e[0],_[1]=e[1],_[2]=e[2],_[3]=e[4],_[4]=e[5],_[5]=e[6],_[6]=e[8],_[7]=e[9],_[8]=e[10]}u.setMatrix3x3("view",_),u.setMatrix("viewProjection",i.getTransformMatrix()),u.setMatrix("world",h.getWorldMatrix()),(0,nt.BindBonesParameters)(l,u),(0,nt.BindMorphTargetParameters)(l,u),l.morphTargetManager&&l.morphTargetManager.isUsingTextureForTargets&&l.morphTargetManager._bind(u),o||l._bind(e,u,d.fillMode);const g=e.getMesh().bakedVertexAnimationManager;if(g&&g.isEnabled&&g.bind(u,o),d&&d.needAlphaTestingForMesh(h)){const e=d.getAlphaTestTexture();e&&(u.setTexture("diffuseSampler",e),u.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,Ze.bindClipPlane)(u,d,i),u.defines.includes("WORLDPOS_REQUIRED")&&u.setMatrix("inverseViewProjection",i.getTransformMatrix().invertToRef(mt._InverseViewProjectionMatrix)),r.setZOffset(this.zOffset),r.setZOffsetUnits(this.zOffsetUnits),l._processRendering(h,e,u,d.fillMode,t,o,((e,t)=>{u.setMatrix("world",t)})),r.setZOffset(0),r.setZOffsetUnits(0)}isReady(e,t,n){n=n??this._passIdForDrawWrapper;const i=[],r=[Xe.VertexBuffer.PositionKind,Xe.VertexBuffer.NormalKind],o=e.getMesh(),a=e.getMaterial();if(!a)return!1;const s=o.getScene();let l=!1,h=!1;a.needAlphaTestingForMesh(o)&&(i.push("#define ALPHATEST"),o.isVerticesDataPresent(Xe.VertexBuffer.UVKind)&&(r.push(Xe.VertexBuffer.UVKind),i.push("#define UV1"),l=!0),o.isVerticesDataPresent(Xe.VertexBuffer.UV2Kind)&&(r.push(Xe.VertexBuffer.UV2Kind),i.push("#define UV2"),h=!0)),a.useLogarithmicDepth&&i.push("#define LOGARITHMICDEPTH"),(0,Ze.prepareStringDefinesForClipPlanes)(a,s,i);let d=!1;for(let e=0;e<i.length;++e)if(i[e].includes("CLIPPLANE")){d=!0;break}d&&i.push("#define WORLDPOS_REQUIRED");const c=new tt.EffectFallbacks;if(o.useBones&&o.computeBonesUsingShaders&&o.skeleton){r.push(Xe.VertexBuffer.MatricesIndicesKind),r.push(Xe.VertexBuffer.MatricesWeightsKind),o.numBoneInfluencers>4&&(r.push(Xe.VertexBuffer.MatricesIndicesExtraKind),r.push(Xe.VertexBuffer.MatricesWeightsExtraKind)),o.isVerticesDataPresent(st.V.MatricesSdefCKind)&&(r.push(st.V.MatricesSdefCKind),r.push(st.V.MatricesSdefRW0Kind),r.push(st.V.MatricesSdefRW1Kind),i.push("#define SDEF"));const e=o.skeleton;i.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers),o.numBoneInfluencers>0&&c.addCPUSkinningFallback(0,o),e.isUsingTextureForMatrices?i.push("#define BONETEXTURE"):i.push("#define BonesPerMesh "+(e.bones.length+1))}else i.push("#define NUM_BONE_INFLUENCERS 0");const u=o.morphTargetManager?(0,nt.PrepareDefinesAndAttributesForMorphTargets)(o.morphTargetManager,i,r,o,!0,!0,!1,l,h,!1):0;t&&(i.push("#define INSTANCES"),(0,nt.PushAttributesForInstances)(r),e.getRenderingMesh().hasThinInstances&&i.push("#define THIN_INSTANCES"));const m=o.bakedVertexAnimationManager;m&&m.isEnabled&&(i.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&r.push("bakedVertexAnimationSettingsInstanced"));const p=e._getDrawWrapper(n,!0),_=p.defines,g=i.join("\n");if(_!==g){const e=["world","mBones","viewport","view","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","boneTextureWidth","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],t=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"];(0,Ze.addClipPlaneUniforms)(e),d&&e.push("inverseViewProjection");const n=s.getEngine().isWebGPU?it.ShaderLanguage.WGSL:it.ShaderLanguage.GLSL;p.setEffect(this.scene.getEngine().createEffect("mmdOutline",{attributes:r,uniformsNames:e,uniformBuffersNames:[],samplers:t,defines:g,fallbacks:c,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:u},processCodeAfterIncludes:ut.ProcessSdefCode,shaderLanguage:n,extraInitializationsAsync:async()=>{n===it.ShaderLanguage.WGSL?await Promise.all([Promise.resolve().then(We.bind(We,8980)),Promise.resolve().then(We.bind(We,1870))]):await Promise.all([Promise.resolve().then(We.bind(We,3357)),Promise.resolve().then(We.bind(We,5043))])}},this.scene.getEngine()),g)}return p.effect.isReady()}_afterRenderingMesh(e,t,n){const i=t.getMaterial();if(null!==i&&i.renderOutline){const e=this._engine,i=e.getDepthWrite(),r=e.getAlphaMode(),o=e.alphaState.alphaBlend;e.setDepthWrite(!0),e.setAlphaMode(Je.Constants.ALPHA_COMBINE,!0),e.setState(!0,void 0,void 0,void 0,!!this.scene._mirroredCameraPosition),this.render(t,n,this._passIdForDrawWrapper),e.setAlphaMode(r,!0),e.setDepthWrite(i),e.alphaState.alphaBlend=o}}}var pt=We(7508);class _t{animation;startFrame;endFrame;offset;weight;easingFunction;easeInFrameTime;easeOutFrameTime;constructor(e,t,n,i,r){this.animation=e,this.startFrame=t??e.startFrame,this.endFrame=n??e.endFrame,this.offset=i??0,this.weight=r??1,this.easingFunction=null,this.easeInFrameTime=0,this.easeOutFrameTime=0}get name(){return this.animation.name}isInSpan(e){return this.startFrame+this.offset<=e&&e<=this.endFrame+this.offset}getFrameTime(e){return e-this.offset}getEasedWeight(e){const t=this.startFrame,n=this.endFrame,i=this.easeInFrameTime,r=this.easeOutFrameTime;if(Math.abs(e-t)<Math.abs(e-n)){if(t+i<=e)return this.weight;if(e<=t)return 0;{const n=e-t;return this.weight*(this.easingFunction?.ease(n/i)??n/i)}}if(e<=n-r)return this.weight;if(n<=e)return 0;{const t=e-n+r;return this.weight*(1-(this.easingFunction?.ease(t/r)??t/r))}}}class gt{onSpanAddedObservable;onSpanRemovedObservable;name;_startFrame;_endFrame;_spans;constructor(e){this.onSpanAddedObservable=new pt.Observable,this.onSpanRemovedObservable=new pt.Observable,this.name=e,this._startFrame=0,this._endFrame=0,this._spans=[]}addSpan(e){this._startFrame=0===this._spans.length?e.startFrame+e.offset:Math.min(this.startFrame,e.startFrame+e.offset),this._endFrame=Math.max(this.endFrame,e.endFrame+e.offset),this._spans.push(e),this.onSpanAddedObservable.notifyObservers(e)}removeSpan(e){const t=this._spans.indexOf(e);this.removeSpanFromIndex(t)}removeSpanFromIndex(e){const t=this._spans;if(!(e<0||t.length<=e)){if(t.splice(e,1),0===t.length)this._startFrame=0,this._endFrame=0;else{let e=t[0].startFrame+t[0].offset,n=t[0].endFrame+t[0].offset;for(let i=1;i<t.length;i++){const r=t[i];e=Math.min(e,r.startFrame+r.offset),n=Math.max(n,r.endFrame+r.offset)}this._startFrame=e,this._endFrame=n}this.onSpanRemovedObservable.notifyObservers(e)}}get startFrame(){return this._startFrame}get endFrame(){return this._endFrame}get spans(){return this._spans}}class ft{animation;_camera;_runtimeAnimations;_onSpanAdded;_onSpanRemoved;constructor(e,t,n,i,r){this.animation=e,this._camera=t,this._runtimeAnimations=n,this._onSpanAdded=i,this._onSpanRemoved=r,e.onSpanAddedObservable.add(i),e.onSpanRemovedObservable.add(r)}static _ActiveAnimationSpans=[];static _ActiveRuntimeAnimations=[];static _CameraPosition=new rt.Vector3;static _CameraRotation=new rt.Vector3;animate(e){e=Math.max(this.animation.startFrame,Math.min(this.animation.endFrame,e));const t=this.animation.spans,n=this._runtimeAnimations,i=ft._ActiveAnimationSpans,r=ft._ActiveRuntimeAnimations;for(let o=0;o<t.length;++o){const a=t[o],s=n[o];null!==s&&0<a.weight&&a.isInSpan(e)&&(i.push(a),r.push(s))}let o=0;for(let t=0;t<i.length;++t)o+=i[t].getEasedWeight(i[t].getFrameTime(e));const a=this._camera;if(0===o)return i.length=0,void(r.length=0);if(1===o&&1===i.length){const t=i[0];return r[0].animate(t.getFrameTime(e)),i.length=0,void(r.length=0)}const s=o<1?1:1/o,l=ft._CameraPosition.setAll(0),h=ft._CameraRotation.setAll(0);let d=0,c=0;for(let t=0;t<i.length;++t){const n=i[t],o=r[t],u=n.getFrameTime(e);o.animate(u);const m=n.getEasedWeight(u)*s;a.position.scaleAndAddToRef(m,l),a.rotation.scaleAndAddToRef(m,h),d+=a.distance*m,c+=a.fov*m}a.position.copyFrom(l),a.rotation.copyFrom(h),a.distance=d,a.fov=c,i.length=0,r.length=0}dispose(){null!==this._onSpanAdded&&(this.animation.onSpanAddedObservable.removeCallback(this._onSpanAdded),this.animation.onSpanRemovedObservable.removeCallback(this._onSpanRemoved),this._onSpanAdded=null,this._onSpanRemoved=null)}static Create(e,t){const n=new Array(e.spans.length).fill(null),i=e.spans;for(let e=0;e<i.length;++e){const r=i[e].animation;if(void 0!==r.createRuntimeCameraAnimation){const i=r.createRuntimeCameraAnimation(t);n[e]=i}else if(void 0===r.createRuntimeModelAnimation)throw new Error(`animation ${r.name} is not bindable. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimationGroup"?`)}return new ft(e,t,n,(e=>{const i=e.animation;if(void 0!==i.createRuntimeCameraAnimation){const e=i.createRuntimeCameraAnimation(t);n.push(e)}else{if(void 0===i.createRuntimeModelAnimation)throw new Error(`animation ${i.name} is not bindable. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimationGroup"?`);n.push(null)}}),(e=>{n.splice(e,1)}))}}gt.prototype.createRuntimeCameraAnimation=function(e){return ft.Create(this,e)};var bt=We(6910);function yt(e,t,n,i){let r=!1,o=!1,a=!1;const s=new Set,l=t=>{const n=t.materialElements;for(let t=0;t<n.length;++t){const i=n[t];if(null!==i.textureColor&&!r){const t=i.index;if(-1===i.index){for(let t=0;t<e.length;++t)e[t].textureMultiplicativeColor;r=!0}else{const n=e[t];n.textureMultiplicativeColor,s.add(n.name)}}if(null!==i.sphereTextureColor&&!o){const t=i.index;if(-1===i.index){for(let t=0;t<e.length;++t)e[t].sphereTextureMultiplicativeColor;o=!0}else{const n=e[t];n.sphereTextureMultiplicativeColor,s.add(n.name)}}if(null!==i.toonTextureColor&&!a){const t=i.index;if(-1===i.index){for(let t=0;t<e.length;++t)e[t].toonTextureMultiplicativeColor;a=!0}else{const n=e[t];n.toonTextureMultiplicativeColor,s.add(n.name)}}}},h=new Uint8Array(t.morphs.length);for(let e=0;e<n.length;++e){const i=n[e];if(null!==i){for(let e=0;e<i.length;++e){const n=i[e];if(1===h[n])continue;h[n]=1;const r=t.morphs[n];switch(r.type){case bt.B.Morph.Type.GroupMorph:{const e=r.elements;for(let n=0;n<e.length;++n){const i=e[n];if(1===h[i])continue;h[i]=1;const r=t.morphs[i];void 0!==r&&r.type===bt.B.Morph.Type.MaterialMorph&&l(r)}}break;case bt.B.Morph.Type.MaterialMorph:l(r)}}if(r&&o&&a)break}}r||o||a?i?.log("All materials could be recompiled for morph animation"):0<s.size&&i?.log(`Materials ${Array.from(s).join(", ")} could be recompiled for morph animation`)}function wt(e,t){const n=e.morphTargetManagers,i=new Array(n.length),r=new Array(n.length);for(let e=0;e<n.length;++e){const t=i[e]=new Set,o=r[e]=new Set,a=n[e],s=a.numTargets;for(let e=0;e<s;++e){const n=a.getTarget(e);t.add(n),0!==n.influence&&o.add(n)}}{const t=e.morphs;for(let e=0;e<t.length;++e){const n=t[e];switch(n.type){case bt.B.Morph.Type.VertexMorph:case bt.B.Morph.Type.UvMorph:{const e=n.elements;for(let t=0;t<e.length;++t){const n=e[t];for(let e=0;e<r.length;++e)r[e].delete(n)}}}}}const o=e=>{const t=e.elements;for(let e=0;e<t.length;++e){const o=t[e];for(let e=0;e<n.length;++e)i[e].has(o)&&r[e].add(o)}},a=new Uint8Array(e.morphs.length);for(let n=0;n<t.length;++n){const i=t[n];if(null!==i)for(let t=0;t<i.length;++t){const n=i[t];if(1===a[n])continue;a[n]=1;const r=e.morphs[n];switch(r.type){case bt.B.Morph.Type.GroupMorph:{const t=r.elements;for(let n=0;n<t.length;++n){const i=t[n];if(1===a[i])continue;a[i]=1;const r=e.morphs[i];if(void 0!==r)switch(r.type){case bt.B.Morph.Type.VertexMorph:case bt.B.Morph.Type.UvMorph:o(r)}}}break;case bt.B.Morph.Type.VertexMorph:case bt.B.Morph.Type.UvMorph:o(r)}}}for(let e=0;e<n.length;++e)n[e].numMaxInfluencers=r[e].size}class At{animation;_ikSolverStates;_morphController;_meshes;_runtimeAnimations;_onSpanAdded;_onSpanRemoved;constructor(e,t,n,i,r,o,a){this.animation=e,this._ikSolverStates=t,this._morphController=n,this._meshes=i,this._runtimeAnimations=r,this._onSpanAdded=o,this._onSpanRemoved=a,e.onSpanAddedObservable.add(o),e.onSpanRemovedObservable.add(a)}static _RuntimeAnimationIdMap=new WeakMap;static _RuntimeAnimationIdCounter=0;static _GetRuntimeAnimationId(e){let t=At._RuntimeAnimationIdMap.get(e);return void 0===t&&(t=At._RuntimeAnimationIdCounter+=1,At._RuntimeAnimationIdMap.set(e,t)),t}_boneResultMap=new Map;_movableBoneResultMap=new Map;_morphResultMap=new Map;_ikSolverResultMap=new Map;_activeAnimationSpans=[];_activeRuntimeAnimations=[];_activeRuntimeAnimationIds=[];_lastActiveRuntimeAnimationIds=[];_boneRestPosition=new rt.Vector3;static _IdentityQuaternion=rt.Quaternion.Identity();animate(e){e=Math.max(this.animation.startFrame,Math.min(this.animation.endFrame,e));const t=this.animation.spans,n=this._runtimeAnimations,i=this._activeAnimationSpans,r=this._activeRuntimeAnimations,o=this._morphController;for(let o=0;o<t.length;++o){const a=t[o],s=n[o];null!==s&&0<a.weight&&a.isInSpan(e)&&(i.push(a),r.push(s))}let a=0;for(let t=0;t<i.length;++t)a+=i[t].getEasedWeight(i[t].getFrameTime(e));const s=this._meshes,l=this._ikSolverStates,h=this._boneResultMap,d=this._movableBoneResultMap,c=this._morphResultMap,u=this._ikSolverResultMap;let m=!0;const p=this._activeRuntimeAnimationIds,_=this._lastActiveRuntimeAnimationIds;if(_.length!==r.length){m=!1;for(let e=0;e<r.length;++e)p.push(At._GetRuntimeAnimationId(r[e]))}else for(let e=0;e<r.length;++e){const t=At._GetRuntimeAnimationId(r[e]);p.push(t),_[e]!==t&&(m=!1)}if(this._lastActiveRuntimeAnimationIds=p,this._activeRuntimeAnimationIds=_,_.length=0,m)if(0===a){for(const[e,t]of h)e.rotationQuaternion.copyFromFloats(0,0,0,1),t[1]=0,t[2]=0;for(const[e,t]of d)e.rotationQuaternion.copyFromFloats(0,0,0,1),e.getRestMatrix().getTranslationToRef(this._boneRestPosition),t[0].copyFromFloats(0,0,0),t[2]=0,t[3]=0;for(const[e,t]of c)o.setMorphWeightFromIndex(e,0),c.set(e,0);for(let e=0;e<s.length;++e)s[e].visibility=1;for(const[e,t]of u)l[e]=0,u.set(e,!0)}else{for(const[e,t]of h)t[1]=0,t[2]=0;for(const[e,t]of d)t[0].copyFromFloats(0,0,0),t[2]=0,t[3]=0;for(const[e,t]of c)c.set(e,0);for(const[e,t]of u)u.set(e,!0)}else{for(const[e,t]of h)e.rotationQuaternion.copyFromFloats(0,0,0,1);for(const[e,t]of d)e.rotationQuaternion.copyFromFloats(0,0,0,1),e.getRestMatrix().getTranslationToRef(this._boneRestPosition);for(const[e,t]of c)o.setMorphWeightFromIndex(e,0);for(let e=0;e<s.length;++e)s[e].visibility=1;for(const[e,t]of u)l[e]=1;h.clear(),d.clear(),c.clear(),u.clear()}if(0===a)return i.length=0,void(r.length=0);if(1===a&&1===i.length){const t=i[0],n=r[0];n.animate(t.getFrameTime(e));const o=n.boneBindIndexMap;for(let e=0;e<o.length;++e){const t=o[e];null!==t&&void 0===h.get(t)&&h.set(t,[new rt.Quaternion,0,0])}const a=n.movableBoneBindIndexMap;for(let e=0;e<a.length;++e){const t=a[e];null!==t&&void 0===d.get(t)&&d.set(t,[new rt.Vector3,new rt.Quaternion,0,0])}const s=n.morphBindIndexMap;for(let e=0;e<s.length;++e){const t=s[e];if(null!==t)for(let e=0;e<t.length;++e){const n=t[e];void 0===c.get(n)&&c.set(n,0)}}const l=n.ikSolverBindIndexMap;for(let e=0;e<l.length;++e){const t=l[e];null!==t&&void 0===u.get(t)&&u.set(t,!0)}return i.length=0,void(r.length=0)}let g,f;a<1?(g=1,f=1-a):(g=1/a,f=0);for(let t=0;t<i.length;++t){const n=i[t],a=r[t];0!==s.length&&(s[0].visibility=1);const m=n.getFrameTime(e);a.animate(m);const p=n.getEasedWeight(m)*g,_=a.boneBindIndexMap;for(let e=0;e<_.length;++e){const t=_[e];if(null!==t){const e=h.get(t);void 0===e?h.set(t,[t.rotationQuaternion.clone(),p,1]):(0===e[2]?(e[0].copyFrom(t.rotationQuaternion),e[1]=p):(rt.Quaternion.SlerpToRef(e[0],t.rotationQuaternion,p/(e[1]+p),e[0]),e[1]+=p),e[2]+=1)}}const b=a.movableBoneBindIndexMap;for(let e=0;e<b.length;++e){const t=b[e];if(null!==t){const e=t.getRestMatrix().getTranslationToRef(this._boneRestPosition),n=d.get(t);void 0===n?d.set(t,[t.position.clone().subtractInPlace(e).scaleInPlace(p),t.rotationQuaternion.clone(),p,1]):(t.position.subtractInPlace(e).scaleAndAddToRef(p,n[0]),0===n[3]?(n[1].copyFrom(t.rotationQuaternion),n[2]=p):(rt.Quaternion.SlerpToRef(n[1],t.rotationQuaternion,p/(n[2]+p),n[1]),n[2]+=p),n[3]+=1)}}const y=a.morphBindIndexMap;for(let e=0;e<y.length;++e){const t=y[e];if(null!==t)for(let e=0;e<t.length;++e){const n=t[e],i=c.get(n);void 0===i?c.set(n,o.getMorphWeightFromIndex(n)*p):c.set(n,i+o.getMorphWeightFromIndex(n)*p)}}const w=a.ikSolverBindIndexMap;for(let e=0;e<w.length;++e){const t=w[e];if(-1!==t){const e=u.get(t);void 0===e?u.set(t,0!==l[t]):u.set(t,e&&0!==l[t])}}0!==s.length&&(f+=s[0].visibility*p)}for(const[e,t]of h)a<1?rt.Quaternion.SlerpToRef(At._IdentityQuaternion,t[0],t[1],e.rotationQuaternion):e.rotationQuaternion.copyFrom(t[0]);for(const[e,t]of d)e.getRestMatrix().getTranslationToRef(e.position).addInPlace(t[0]),a<1?rt.Quaternion.SlerpToRef(At._IdentityQuaternion,t[1],t[2],e.rotationQuaternion):e.rotationQuaternion.copyFrom(t[1]);for(const[e,t]of c)o.setMorphWeightFromIndex(e,t);if(Math.abs(f-1)<1e-6)for(let e=0;e<s.length;++e)s[e].visibility=1;else for(let e=0;e<s.length;++e)s[e].visibility=f;for(const[e,t]of u)l[e]=t?1:0;i.length=0,r.length=0}induceMaterialRecompile(e,t){const n=this._runtimeAnimations;for(let e=0;e<n.length;++e)n[e]?.induceMaterialRecompile(!1,t);if(e){const e=[];for(let t=0;t<n.length;++t){const i=n[t];if(null!==i){const t=i.morphBindIndexMap;e.push(...t)}}wt(this._morphController,e)}}dispose(){null!==this._onSpanAdded&&(this.animation.onSpanAddedObservable.removeCallback(this._onSpanAdded),this.animation.onSpanRemovedObservable.removeCallback(this._onSpanRemoved),this._onSpanAdded=null,this._onSpanRemoved=null)}static Create(e,t,n,i){const r=new Array(e.spans.length).fill(null),o=e.spans;for(let e=0;e<o.length;++e){const a=o[e].animation;if(void 0!==a.createRuntimeModelAnimation){const o=a.createRuntimeModelAnimation(t,n,i);r[e]=o}else if(void 0===a.createRuntimeModelAnimation)throw new Error(`animation ${a.name} is not bindable. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimationGroup"?`)}return new At(e,t.ikSolverStates,t.morph,t.mesh.metadata.meshes,r,(e=>{const o=e.animation;if(void 0!==o.createRuntimeModelAnimation){const e=o.createRuntimeModelAnimation(t,n,i);r.push(e)}else{if(void 0===o.createRuntimeModelAnimation)throw new Error(`animation ${o.name} is not bindable. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimationGroup"?`);r.push(null)}}),(e=>{r.splice(e,1)}))}}gt.prototype.createRuntimeModelAnimation=function(e,t,n){return At.Create(this,e,t,n)};class Mt{name;boneTracks;movableBoneTracks;morphTracks;propertyTrack;cameraTrack;startFrame;endFrame;constructor(e,t,n,i,r,o){this.name=e,this.boneTracks=t,this.movableBoneTracks=n,this.morphTracks=i,this.propertyTrack=r,this.cameraTrack=o;let a=Number.MAX_SAFE_INTEGER,s=Number.MIN_SAFE_INTEGER;for(let e=0;e<t.length;++e){const n=t[e];a=Math.min(a,n.startFrame),s=Math.max(s,n.endFrame)}for(let e=0;e<n.length;++e){const t=n[e];a=Math.min(a,t.startFrame),s=Math.max(s,t.endFrame)}for(let e=0;e<i.length;++e){const t=i[e];a=Math.min(a,t.startFrame),s=Math.max(s,t.endFrame)}a=Math.min(a,r.startFrame),s=Math.max(s,r.endFrame),a=Math.min(a,o.startFrame),s=Math.max(s,o.endFrame),this.startFrame=a,this.endFrame=s}}function Tt(e,t,n,i,r){let o=.5,a=o,s=1-a;const l=Math;let h,d,c;for(let n=0;n<15;++n){h=3*s*s*a,d=3*s*a*a,c=a*a*a;const n=h*e+d*t+c-r;if(l.abs(n)<1e-5)break;o*=.5,a+=n<0?o:-o,s=1-a}return h*n+d*i+c}class xt{_lastResults=new Map;_upperBoundFrameIndex(e,t){const n=t.frameNumbers;if(0===n.length)return 0;let i=this._lastResults.get(t);void 0===i&&(i=[Number.NEGATIVE_INFINITY,0],this._lastResults.set(t,i));const r=e-i[0];if(Math.abs(r)<6){let t=i[1];for(;0<t&&e<n[t-1];)t-=1;for(;t<n.length&&n[t]<=e;)t+=1;return i[0]=e,i[1]=t,t}{let t=0,r=n.length;for(;t<r;){const i=t+(r-t>>1);e<n[i]?r=i:t=i+1}return i[0]=e,i[1]=t,t}}}class vt extends xt{animation;_camera;constructor(e,t){super(),this.animation=e.cameraTrack,this._camera=t}static _CameraPositionA=new rt.Vector3;static _CameraPositionB=new rt.Vector3;static _CameraRotationA=new rt.Vector3;static _CameraRotationB=new rt.Vector3;static _DegToRad=Math.PI/180;animate(e){const t=this.animation,n=this._camera;if(0===t.frameNumbers.length)return n.position.set(0,10,0),n.rotation.set(0,0,0),n.distance=-45,void(n.fov=Math.PI/180*30);const i=Math.max(t.startFrame,Math.min(t.endFrame,e)),r=this._upperBoundFrameIndex(i,t),o=r-1,a=t.frameNumbers[o],s=t.frameNumbers[r];if(void 0===s||a+1===s){const e=t.positions;n.position.set(e[3*o],e[3*o+1],e[3*o+2]);const i=t.rotations;n.rotation.set(i[3*o],i[3*o+1],i[3*o+2]),n.distance=t.distances[o],n.fov=t.fovs[o]*vt._DegToRad}else{const e=(i-a)/(s-a),l=t.positions,h=t.positionInterpolations,d=vt._CameraPositionA.set(l[3*o],l[3*o+1],l[3*o+2]),c=vt._CameraPositionB.set(l[3*r],l[3*r+1],l[3*r+2]),u=Tt(h[12*r]/127,h[12*r+1]/127,h[12*r+2]/127,h[12*r+3]/127,e),m=Tt(h[12*r+4]/127,h[12*r+5]/127,h[12*r+6]/127,h[12*r+7]/127,e),p=Tt(h[12*r+8]/127,h[12*r+9]/127,h[12*r+10]/127,h[12*r+11]/127,e);n.position.set(d.x+(c.x-d.x)*u,d.y+(c.y-d.y)*m,d.z+(c.z-d.z)*p);const _=t.rotations,g=t.rotationInterpolations,f=vt._CameraRotationA.set(_[3*o],_[3*o+1],_[3*o+2]),b=vt._CameraRotationB.set(_[3*r],_[3*r+1],_[3*r+2]),y=Tt(g[4*r]/127,g[4*r+1]/127,g[4*r+2]/127,g[4*r+3]/127,e),w=1-y;n.rotation.set(f.x*w+b.x*y,f.y*w+b.y*y,f.z*w+b.z*y);const A=t.distances[o],M=t.distances[r],T=Tt(t.distanceInterpolations[4*r]/127,t.distanceInterpolations[4*r+1]/127,t.distanceInterpolations[4*r+2]/127,t.distanceInterpolations[4*r+3]/127,e);n.distance=A+(M-A)*T;const x=t.fovs[o],v=t.fovs[r],I=Tt(t.fovInterpolations[4*r]/127,t.fovInterpolations[4*r+1]/127,t.fovInterpolations[4*r+2]/127,t.fovInterpolations[4*r+3]/127,e);n.fov=(x+(v-x)*I)*vt._DegToRad}}static Create(e,t){return new vt(e,t)}}Mt.prototype.createRuntimeCameraAnimation=function(e){return vt.Create(this,e)};var It=We(4268),Bt=We(1259),Pt=We(6871),St=We(5501),Rt=We(2792);class Et extends It.Animation{static ANIMATIONTYPE_SLERP_TANGENT_QUATERNION=8;_interpolate(e,t,n=!1){if(t.loopMode===It.Animation.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const i=this._keys,r=i.length;let o=t.key;for(;o>=0&&e<i[o].frame;)o-=1;for(;o+1<=r-1&&e>=i[o+1].frame;)o+=1;if(t.key=o,o<0)return n?void 0:this._getKeyValue(i[0].value);if(o+1>r-1)return n?void 0:this._getKeyValue(i[r-1].value);const a=i[o],s=i[o+1];if(n&&(e===a.frame||e===s.frame))return;const l=this._getKeyValue(a.value),h=this._getKeyValue(s.value);if(a.interpolation===Pt.AnimationKeyInterpolation.STEP)return s.frame>e?l:h;const d=void 0!==a.outTangent&&void 0!==s.inTangent,c=s.frame-a.frame;let u=(e-a.frame)/c;const m=a.easingFunction||this.getEasingFunction();if(null!==m&&(u=m.ease(u)),a.interpolation===Pt.AnimationKeyInterpolation.NONE)switch(this.dataType){case It.Animation.ANIMATIONTYPE_FLOAT:{const e=d?this.floatInterpolateFunctionWithTangents(l,a.outTangent*c,h,s.inTangent*c,u):this.floatInterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(t.offsetValue??0)*t.repeatCount+e}break}case It.Animation.ANIMATIONTYPE_QUATERNION:{const e=d?this.quaternionInterpolateFunctionWithTangents(l,a.outTangent.scale(c),h,s.inTangent.scale(c),u):this.quaternionInterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||It._staticOffsetValueQuaternion).scale(t.repeatCount))}return e}case It.Animation.ANIMATIONTYPE_VECTOR3:{const e=d?this.vector3InterpolateFunctionWithTangents(l,a.outTangent.scale(c),h,s.inTangent.scale(c),u):this.vector3InterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||It._staticOffsetValueVector3).scale(t.repeatCount))}break}case It.Animation.ANIMATIONTYPE_VECTOR2:{const e=d?this.vector2InterpolateFunctionWithTangents(l,a.outTangent.scale(c),h,s.inTangent.scale(c),u):this.vector2InterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||It._staticOffsetValueVector2).scale(t.repeatCount))}break}case It.Animation.ANIMATIONTYPE_SIZE:switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(l,h,u);case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(l,h,u).add((t.offsetValue||It._staticOffsetValueSize).scale(t.repeatCount))}break;case It.Animation.ANIMATIONTYPE_COLOR3:{const e=d?this.color3InterpolateFunctionWithTangents(l,a.outTangent.scale(c),h,s.inTangent.scale(c),u):this.color3InterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||It._staticOffsetValueColor3).scale(t.repeatCount))}break}case It.Animation.ANIMATIONTYPE_COLOR4:{const e=d?this.color4InterpolateFunctionWithTangents(l,a.outTangent.scale(c),h,s.inTangent.scale(c),u):this.color4InterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||It._staticOffsetValueColor4).scale(t.repeatCount))}break}case It.Animation.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return It.Animation.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,h,u,t.workValue):l;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return l}}else switch(this.dataType){case It.Animation.ANIMATIONTYPE_FLOAT:{const e=d?this.floatInterpolateFunctionWithControlPoints(l,a.outTangent,h,s.inTangent,u):this.floatInterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(t.offsetValue??0)*t.repeatCount+e}break}case It.Animation.ANIMATIONTYPE_QUATERNION:{const e=d?this.quaternionInterpolateFunctionWithControlPoints(l,a.outTangent,h,s.inTangent,u):this.quaternionInterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||It._staticOffsetValueQuaternion).scale(t.repeatCount))}return e}case Et.ANIMATIONTYPE_SLERP_TANGENT_QUATERNION:{const e=d?this.quaternionInterpolateFunctionWithSlerpControlPoints(l,a.outTangent,h,s.inTangent,u):this.quaternionInterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||It._staticOffsetValueQuaternion).scale(t.repeatCount))}return e}case It.Animation.ANIMATIONTYPE_VECTOR3:{const e=d?this.vector3InterpolateFunctionWithControlPoints(l,a.outTangent,h,s.inTangent,u):this.vector3InterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||It._staticOffsetValueVector3).scale(t.repeatCount))}break}case It.Animation.ANIMATIONTYPE_VECTOR2:{const e=d?this.vector2InterpolateFunctionWithControlPoints(l,a.outTangent,h,s.inTangent,u):this.vector2InterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||It._staticOffsetValueVector2).scale(t.repeatCount))}break}case It.Animation.ANIMATIONTYPE_SIZE:switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(l,h,u);case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(l,h,u).add((t.offsetValue||It._staticOffsetValueSize).scale(t.repeatCount))}break;case It.Animation.ANIMATIONTYPE_COLOR3:{const e=d?this.color3InterpolateFunctionWithControlPoints(l,a.outTangent,h,s.inTangent,u):this.color3InterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||It._staticOffsetValueColor3).scale(t.repeatCount))}break}case It.Animation.ANIMATIONTYPE_COLOR4:{const e=d?this.color4InterpolateFunctionWithControlPoints(l,a.outTangent,h,s.inTangent,u):this.color4InterpolateFunction(l,h,u);switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return e;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||It._staticOffsetValueColor4).scale(t.repeatCount))}break}case It.Animation.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case It.Animation.ANIMATIONLOOPMODE_CYCLE:case It.Animation.ANIMATIONLOOPMODE_CONSTANT:case It.Animation.ANIMATIONLOOPMODE_YOYO:return It.Animation.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,h,u,t.workValue):l;case It.Animation.ANIMATIONLOOPMODE_RELATIVE:case It.Animation.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return l}}return 0}floatInterpolateFunctionWithControlPoints(e,t,n,i,r){const o=Tt(t.x,i.x,t.y,i.y,r);return e*(1-o)+n*o}quaternionInterpolateFunctionWithControlPoints(e,t,n,i,r){const o=Tt(t[0].x,i[0].x,t[0].y,i[0].y,r),a=Tt(t[1].x,i[1].x,t[1].y,i[1].y,r),s=Tt(t[2].x,i[2].x,t[2].y,i[2].y,r),l=Tt(t[3].x,i[3].x,t[3].y,i[3].y,r);return new rt.Quaternion(e.x*(1-o)+n.x*o,e.y*(1-a)+n.y*a,e.z*(1-s)+n.z*s,e.w*(1-l)+n.w*l)}quaternionInterpolateFunctionWithSlerpControlPoints(e,t,n,i,r){const o=Tt(t.x,i.x,t.y,i.y,r);return rt.Quaternion.Slerp(e,n,o)}vector3InterpolateFunctionWithControlPoints(e,t,n,i,r){const o=Tt(t[0].x,i[0].x,t[0].y,i[0].y,r),a=Tt(t[1].x,i[1].x,t[1].y,i[1].y,r),s=Tt(t[2].x,i[2].x,t[2].y,i[2].y,r);return new rt.Vector3(e.x*(1-o)+n.x*o,e.y*(1-a)+n.y*a,e.z*(1-s)+n.z*s)}vector2InterpolateFunctionWithControlPoints(e,t,n,i,r){const o=Tt(t[0].x,i[0].x,t[0].y,i[0].y,r),a=Tt(t[1].x,i[1].x,t[1].y,i[1].y,r);return new rt.Vector2(e.x*(1-o)+n.x*o,e.y*(1-a)+n.y*a)}color3InterpolateFunctionWithControlPoints(e,t,n,i,r){const o=Tt(t[0].x,i[0].x,t[0].y,i[0].y,r),a=Tt(t[1].x,i[1].x,t[1].y,i[1].y,r),s=Tt(t[2].x,i[2].x,t[2].y,i[2].y,r);return new St.Color3(e.r*(1-o)+n.r*o,e.g*(1-a)+n.g*a,e.b*(1-s)+n.b*s)}color4InterpolateFunctionWithControlPoints(e,t,n,i,r){const o=Tt(t.r,i.r,t.g,i.g,r),a=Tt(t.b,i.b,t.g,i.g,r),s=Tt(t.b,i.b,t.g,i.g,r),l=Tt(t.a,i.a,t.g,i.g,r);return new St.Color4(e.r*(1-o)+n.r*o,e.g*(1-a)+n.g*a,e.b*(1-s)+n.b*s,e.a*(1-l)+n.a*l)}clone(){const e=new Et(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const n=this._ranges[t];n&&(e._ranges[t]=n.clone())}}return e}}function Ct(e,t,n,i){let r;r=0===i?0:0===n?i<0?-1/0:1/0:0===e&&0===t?i/n:0===e?i<0?-1/0:1/0:0===t?0:t*i/(e*n);const o=3*Math.abs(i)/n;return Math.max(-o,Math.min(o,r))}(0,Rt.RegisterClass)("BABYLON.BezierAnimation",Et);class Ot{name;positionAnimation;rotationAnimation;distanceAnimation;fovAnimation;startFrame;endFrame;constructor(e,t){const n=this.name=e.name;this.positionAnimation=t.createPositionAnimation(n,e.cameraTrack),this.rotationAnimation=t.createRotationAnimation(n,e.cameraTrack),this.distanceAnimation=t.createDistanceAnimation(n,e.cameraTrack),this.fovAnimation=t.createFovAnimation(n,e.cameraTrack),this.startFrame=e.startFrame,this.endFrame=e.endFrame}createAnimationGroup(e){const t=new Bt.AnimationGroup(this.name,e.getScene());return t.addTargetedAnimation(this.positionAnimation,e),t.addTargetedAnimation(this.rotationAnimation,e),t.addTargetedAnimation(this.distanceAnimation,e),t.addTargetedAnimation(this.fovAnimation,e),t}}class kt{createPositionAnimation(e,t){const n=new It.Animation(e+"_camera_position","position",30,It.Animation.ANIMATIONTYPE_VECTOR3,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.positions,o=t.positionInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=t-(0<e?i[e-1]:-30),h=s-t,d=h<1.0001?Pt.AnimationKeyInterpolation.STEP:Pt.AnimationKeyInterpolation.NONE;a[e]={frame:t,value:new rt.Vector3(r[3*e],r[3*e+1],r[3*e+2]),inTangent:n?new rt.Vector3(Ct(1-o[12*e+1]/127,1-o[12*e+3]/127,l,r[3*e]-r[3*(e-1)]),Ct(1-o[12*e+5]/127,1-o[12*e+7]/127,l,r[3*e+1]-r[3*(e-1)+1]),Ct(1-o[12*e+9]/127,1-o[12*e+11]/127,l,r[3*e+2]-r[3*(e-1)+2])):void 0,outTangent:s<1/0?new rt.Vector3(Ct(o[12*(e+1)+0]/127,o[12*(e+1)+2]/127,h,r[3*(e+1)]-r[3*e]),Ct(o[12*(e+1)+4]/127,o[12*(e+1)+6]/127,h,r[3*(e+1)+1]-r[3*e+1]),Ct(o[12*(e+1)+8]/127,o[12*(e+1)+10]/127,h,r[3*(e+1)+2]-r[3*e+2])):void 0,interpolation:d,lockedTangent:!1}}return n.setKeys(a),n}createRotationAnimation(e,t){const n=new It.Animation(e+"_camera_rotation","rotation",30,It.Animation.ANIMATIONTYPE_VECTOR3,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.rotations,o=t.rotationInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=t-(0<e?i[e-1]:-30),h=s-t,d=h<1.0001?Pt.AnimationKeyInterpolation.STEP:Pt.AnimationKeyInterpolation.NONE;a[e]={frame:t,value:new rt.Vector3(r[3*e],r[3*e+1],r[3*e+2]),inTangent:n?new rt.Vector3(Ct(1-o[4*e+1]/127,1-o[4*e+3]/127,l,r[3*e]-r[3*(e-1)]),Ct(1-o[4*e+1]/127,1-o[4*e+3]/127,l,r[3*e+1]-r[3*(e-1)+1]),Ct(1-o[4*e+1]/127,1-o[4*e+3]/127,l,r[3*e+2]-r[3*(e-1)+2])):void 0,outTangent:s<1/0?new rt.Vector3(Ct(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127,h,r[3*(e+1)]-r[3*e]),Ct(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127,h,r[3*(e+1)+1]-r[3*e+1]),Ct(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127,h,r[3*(e+1)+2]-r[3*e+2])):void 0,interpolation:d,lockedTangent:!1}}return n.setKeys(a),n}createDistanceAnimation(e,t){const n=new It.Animation(e+"_camera_distance","distance",30,It.Animation.ANIMATIONTYPE_FLOAT,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.distances,o=t.distanceInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=t-(0<e?i[e-1]:-30),h=s-t,d=h<1.0001?Pt.AnimationKeyInterpolation.STEP:Pt.AnimationKeyInterpolation.NONE;a[e]={frame:t,value:r[e],inTangent:n?Ct(1-o[4*e+1]/127,1-o[4*e+3]/127,l,r[e]-r[e-1]):void 0,outTangent:s<1/0?Ct(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127,h,r[e+1]-r[e]):void 0,interpolation:d,lockedTangent:!1}}return n.setKeys(a),n}createFovAnimation(e,t){const n=new It.Animation(e+"_camera_fov","fov",30,It.Animation.ANIMATIONTYPE_FLOAT,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.fovs,o=t.fovInterpolations,a=Math.PI/180,s=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,l=e+1<i.length?i[e+1]:1/0,h=t-(0<e?i[e-1]:-30),d=l-t,c=d<1.0001?Pt.AnimationKeyInterpolation.STEP:Pt.AnimationKeyInterpolation.NONE;s[e]={frame:t,value:r[e]*a,inTangent:n?Ct(1-o[4*e+1]/127,1-o[4*e+3]/127,h,r[e]*a-r[e-1]*a):void 0,outTangent:l<1/0?Ct(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127,d,r[e+1]*a-r[e]*a):void 0,interpolation:c,lockedTangent:!1}}return n.setKeys(s),n}}class Ft{createPositionAnimation(e,t){const n=new It.Animation(e+"_camera_position","position",30,It.Animation.ANIMATIONTYPE_VECTOR3,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.positions,o=t.positionInterpolations,a=new Array(t.endFrame);let s=0;const l=new rt.Vector3(r[0],r[1],r[2]);for(let e=0;e<i.length;++e){const t=i[e];a[t]={frame:t,value:new rt.Vector3(r[3*e],r[3*e+1],r[3*e+2]),interpolation:t+1===i[e+1]?Pt.AnimationKeyInterpolation.STEP:Pt.AnimationKeyInterpolation.NONE};const n=o[12*e+0]/127,h=o[12*e+1]/127,d=o[12*e+2]/127,c=o[12*e+3]/127,u=o[12*e+4]/127,m=o[12*e+5]/127,p=o[12*e+6]/127,_=o[12*e+7]/127,g=o[12*e+8]/127,f=o[12*e+9]/127,b=o[12*e+10]/127,y=o[12*e+11]/127;for(let i=s+1;i<t;++i){const o=(i-s)/(t-s),w=Tt(n,h,d,c,o),A=Tt(u,m,p,_,o),M=Tt(g,f,b,y,o);a[i]={frame:i,value:new rt.Vector3(l.x+(r[3*e]-l.x)*w,l.y+(r[3*e+1]-l.y)*A,l.z+(r[3*e+2]-l.z)*M),interpolation:Pt.AnimationKeyInterpolation.NONE}}s=t,l.set(r[3*e],r[3*e+1],r[3*e+2])}return n.setKeys(a),n}createRotationAnimation(e,t){const n=new It.Animation(e+"_camera_rotation","rotation",30,It.Animation.ANIMATIONTYPE_VECTOR3,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.rotations,o=t.rotationInterpolations,a=new Array(t.endFrame);let s=0;const l=new rt.Vector3(r[0],r[1],r[2]);for(let e=0;e<i.length;++e){const t=i[e];a[t]={frame:t,value:new rt.Vector3(r[3*e],r[3*e+1],r[3*e+2]),interpolation:t+1===i[e+1]?Pt.AnimationKeyInterpolation.STEP:Pt.AnimationKeyInterpolation.NONE};const n=o[4*e+0]/127,h=o[4*e+1]/127,d=o[4*e+2]/127,c=o[4*e+3]/127;for(let i=s+1;i<t;++i){const o=Tt(n,h,d,c,(i-s)/(t-s));a[i]={frame:i,value:new rt.Vector3(l.x+(r[3*e]-l.x)*o,l.y+(r[3*e+1]-l.y)*o,l.z+(r[3*e+2]-l.z)*o),interpolation:Pt.AnimationKeyInterpolation.NONE}}s=t,l.set(r[3*e],r[3*e+1],r[3*e+2])}return n.setKeys(a),n}createDistanceAnimation(e,t){const n=new It.Animation(e+"_camera_distance","distance",30,It.Animation.ANIMATIONTYPE_FLOAT,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.distances,o=t.distanceInterpolations,a=new Array(t.endFrame);let s=0,l=r[0];for(let e=0;e<i.length;++e){const t=i[e];a[t]={frame:t,value:r[e],interpolation:t+1===i[e+1]?Pt.AnimationKeyInterpolation.STEP:Pt.AnimationKeyInterpolation.NONE};const n=o[4*e+0]/127,h=o[4*e+1]/127,d=o[4*e+2]/127,c=o[4*e+3]/127;for(let i=s+1;i<t;++i){const o=Tt(n,h,d,c,(i-s)/(t-s));a[i]={frame:i,value:l+(r[e]-l)*o,interpolation:Pt.AnimationKeyInterpolation.NONE}}s=t,l=r[e]}return n.setKeys(a),n}createFovAnimation(e,t){const n=new It.Animation(e+"_camera_fov","fov",30,It.Animation.ANIMATIONTYPE_FLOAT,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.fovs,o=t.fovInterpolations,a=Math.PI/180,s=new Array(t.endFrame);let l=0,h=r[0]*a;for(let e=0;e<i.length;++e){const t=i[e];s[t]={frame:t,value:r[e]*a,interpolation:t+1===i[e+1]?Pt.AnimationKeyInterpolation.STEP:Pt.AnimationKeyInterpolation.NONE};const n=o[4*e+0]/127,d=o[4*e+1]/127,c=o[4*e+2]/127,u=o[4*e+3]/127;for(let i=l+1;i<t;++i){const o=Tt(n,d,c,u,(i-l)/(t-l));s[i]={frame:i,value:h+(r[e]*a-h)*o,interpolation:Pt.AnimationKeyInterpolation.NONE}}l=t,h=r[e]*a}return n.setKeys(s),n}}class Nt{createPositionAnimation(e,t){const n=new Et(e+"_camera_position","position",30,It.Animation.ANIMATIONTYPE_VECTOR3,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.positions,o=t.positionInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=s-t<1.0001?Pt.AnimationKeyInterpolation.STEP:2;a[e]={frame:t,value:new rt.Vector3(r[3*e],r[3*e+1],r[3*e+2]),inTangent:n?[new rt.Vector2(o[12*e+1]/127,o[12*e+3]/127),new rt.Vector2(o[12*e+5]/127,o[12*e+7]/127),new rt.Vector2(o[12*e+9]/127,o[12*e+11]/127)]:void 0,outTangent:s<1/0?[new rt.Vector2(o[12*(e+1)+0]/127,o[12*(e+1)+2]/127),new rt.Vector2(o[12*(e+1)+4]/127,o[12*(e+1)+6]/127),new rt.Vector2(o[12*(e+1)+8]/127,o[12*(e+1)+10]/127)]:void 0,interpolation:l,lockedTangent:!1}}return n.setKeys(a),n}createRotationAnimation(e,t){const n=new Et(e+"_camera_rotation","rotation",30,It.Animation.ANIMATIONTYPE_VECTOR3,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.rotations,o=t.rotationInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=s-t<1.0001?Pt.AnimationKeyInterpolation.STEP:2;a[e]={frame:t,value:new rt.Vector3(r[3*e],r[3*e+1],r[3*e+2]),inTangent:n?[new rt.Vector2(o[4*e+1]/127,o[4*e+3]/127),new rt.Vector2(o[4*e+1]/127,o[4*e+3]/127),new rt.Vector2(o[4*e+1]/127,o[4*e+3]/127)]:void 0,outTangent:s<1/0?[new rt.Vector2(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127),new rt.Vector2(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127),new rt.Vector2(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127)]:void 0,interpolation:l,lockedTangent:!1}}return n.setKeys(a),n}createDistanceAnimation(e,t){const n=new Et(e+"_camera_distance","distance",30,It.Animation.ANIMATIONTYPE_FLOAT,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.distances,o=t.distanceInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=s-t<1.0001?Pt.AnimationKeyInterpolation.STEP:2;a[e]={frame:t,value:r[e],inTangent:n?new rt.Vector2(o[4*e+1]/127,o[4*e+3]/127):void 0,outTangent:s<1/0?new rt.Vector2(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127):void 0,interpolation:l,lockedTangent:!1}}return n.setKeys(a),n}createFovAnimation(e,t){const n=new Et(e+"_camera_fov","fov",30,It.Animation.ANIMATIONTYPE_FLOAT,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.fovs,o=t.fovInterpolations,a=Math.PI/180,s=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,l=e+1<i.length?i[e+1]:1/0,h=l-t<1.0001?Pt.AnimationKeyInterpolation.STEP:2;s[e]={frame:t,value:r[e]*a,inTangent:n?new rt.Vector2(o[4*e+1]/127,o[4*e+3]/127):void 0,outTangent:l<1/0?new rt.Vector2(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127):void 0,interpolation:h,lockedTangent:!1}}return n.setKeys(s),n}}function Dt(){return{key:0,repeatCount:0,loopMode:It.Animation.ANIMATIONLOOPMODE_CONSTANT}}class Lt{animation;_positionAnimationState;_rotationAnimationState;_distanceAnimationState;_fovAnimationState;_camera;constructor(e,t){this.animation=e,this._positionAnimationState=Dt(),this._rotationAnimationState=Dt(),this._distanceAnimationState=Dt(),this._fovAnimationState=Dt(),this._camera=t}animate(e){const t=this.animation,n=this._camera;n.position.copyFrom(t.positionAnimation._interpolate(e,this._positionAnimationState)),n.rotation.copyFrom(t.rotationAnimation._interpolate(e,this._rotationAnimationState)),n.distance=t.distanceAnimation._interpolate(e,this._distanceAnimationState),n.fov=t.fovAnimation._interpolate(e,this._fovAnimationState)}static Create(e,t){return new Lt(e,t)}}Ot.prototype.createRuntimeCameraAnimation=function(e){return Lt.Create(this,e)};var Ut=We(4619);class Vt extends xt{animation;boneBindIndexMap;movableBoneBindIndexMap;_morphController;morphBindIndexMap;_meshes;ikSolverBindIndexMap;_ikSolverStates;_materialRecompileInduceInfo;constructor(e,t,n,i,r,o,a,s,l){super(),this.animation=e,this.boneBindIndexMap=t,this.movableBoneBindIndexMap=n,this._morphController=i,this.morphBindIndexMap=r,this._meshes=o,this.ikSolverBindIndexMap=a,this._ikSolverStates=s,this._materialRecompileInduceInfo=l}static _BonePositionA=new rt.Vector3;static _BonePositionB=new rt.Vector3;static _BonePosition=new rt.Vector3;static _BoneRotationA=new rt.Quaternion;static _BoneRotationB=new rt.Quaternion;animate(e){const t=this.animation,n=t.boneTracks;if(0<n.length){const t=this.boneBindIndexMap;for(let i=0;i<n.length;++i){const r=t[i];if(null===r)continue;const o=n[i];if(0===o.frameNumbers.length){r.setRotationQuaternion(Vt._BoneRotationB.set(0,0,0,1),Ut.Space.LOCAL);continue}const a=Math.max(o.startFrame,Math.min(o.endFrame,e)),s=this._upperBoundFrameIndex(a,o),l=s-1,h=o.frameNumbers[s];if(void 0===h){const e=o.rotations;r.setRotationQuaternion(Vt._BoneRotationB.set(e[4*l],e[4*l+1],e[4*l+2],e[4*l+3]),Ut.Space.LOCAL)}else{const e=o.frameNumbers[l],t=(a-e)/(h-e),n=o.rotations,i=o.rotationInterpolations,d=Vt._BoneRotationA.set(n[4*l],n[4*l+1],n[4*l+2],n[4*l+3]),c=Vt._BoneRotationB.set(n[4*s],n[4*s+1],n[4*s+2],n[4*s+3]),u=Tt(i[4*s]/127,i[4*s+1]/127,i[4*s+2]/127,i[4*s+3]/127,t);rt.Quaternion.SlerpToRef(d,c,u,d),r.setRotationQuaternion(d,Ut.Space.LOCAL)}}}const i=t.movableBoneTracks;if(0<i.length){const t=this.movableBoneBindIndexMap;for(let n=0;n<i.length;++n){const r=t[n];if(null===r)continue;const o=i[n];if(0===o.frameNumbers.length){r.getRestMatrix().getTranslationToRef(Vt._BonePosition),r.position=Vt._BonePosition,r.setRotationQuaternion(Vt._BoneRotationB.set(0,0,0,1),Ut.Space.LOCAL);continue}const a=Math.max(o.startFrame,Math.min(o.endFrame,e)),s=this._upperBoundFrameIndex(a,o),l=s-1,h=o.frameNumbers[s];if(void 0===h){const e=o.positions;r.getRestMatrix().getTranslationToRef(Vt._BonePosition),r.position=Vt._BonePosition.addInPlaceFromFloats(e[3*l],e[3*l+1],e[3*l+2]);const t=o.rotations;r.setRotationQuaternion(Vt._BoneRotationB.set(t[4*l],t[4*l+1],t[4*l+2],t[4*l+3]),Ut.Space.LOCAL)}else{const e=o.frameNumbers[l],t=(a-e)/(h-e),n=o.positions,i=o.positionInterpolations,d=Vt._BonePositionA.set(n[3*l],n[3*l+1],n[3*l+2]),c=Vt._BonePositionB.set(n[3*s],n[3*s+1],n[3*s+2]),u=Tt(i[12*s]/127,i[12*s+1]/127,i[12*s+2]/127,i[12*s+3]/127,t),m=Tt(i[12*s+4]/127,i[12*s+5]/127,i[12*s+6]/127,i[12*s+7]/127,t),p=Tt(i[12*s+8]/127,i[12*s+9]/127,i[12*s+10]/127,i[12*s+11]/127,t);d.x+=(c.x-d.x)*u,d.y+=(c.y-d.y)*m,d.z+=(c.z-d.z)*p,r.getRestMatrix().getTranslationToRef(Vt._BonePosition),r.position=Vt._BonePosition.addInPlace(d);const _=o.rotations,g=o.rotationInterpolations,f=Vt._BoneRotationA.set(_[4*l],_[4*l+1],_[4*l+2],_[4*l+3]),b=Vt._BoneRotationB.set(_[4*s],_[4*s+1],_[4*s+2],_[4*s+3]),y=Tt(g[4*s]/127,g[4*s+1]/127,g[4*s+2]/127,g[4*s+3]/127,t);rt.Quaternion.SlerpToRef(f,b,y,f),r.setRotationQuaternion(f,Ut.Space.LOCAL)}}}const r=t.morphTracks;if(0<r.length){const t=this._morphController,n=this.morphBindIndexMap;for(let i=0;i<r.length;++i){const o=n[i];if(null===o)continue;const a=r[i];if(0===a.frameNumbers.length){for(let e=0;e<o.length;++e)t.setMorphWeightFromIndex(o[e],0);continue}const s=Math.max(a.startFrame,Math.min(a.endFrame,e)),l=this._upperBoundFrameIndex(s,a),h=l-1,d=a.frameNumbers[l];if(void 0===d){const e=a.weights[h];for(let n=0;n<o.length;++n)t.setMorphWeightFromIndex(o[n],e)}else{const e=a.frameNumbers[h],n=(s-e)/(d-e),i=a.weights[h],r=i+(a.weights[l]-i)*n;for(let e=0;e<o.length;++e)t.setMorphWeightFromIndex(o[e],r)}}}if(0<t.propertyTrack.frameNumbers.length){const n=t.propertyTrack,i=Math.max(n.startFrame,Math.min(n.endFrame,e)),r=this._upperBoundFrameIndex(i,n)-1,o=n.visibles[r],a=this._meshes;for(let e=0;e<a.length;++e)a[e].visibility=o;const s=this._ikSolverStates.ikSolverStates,l=this.ikSolverBindIndexMap;for(let e=0;e<l.length;++e){const t=l[e];if(-1===t)continue;const i=n.getIkState(e);s[t]=i[r]}}}induceMaterialRecompile(e,t){null!==this._materialRecompileInduceInfo&&(Vt.InduceMaterialRecompile(this._materialRecompileInduceInfo,this._morphController,this.morphBindIndexMap,t),e&&wt(this._morphController,this.morphBindIndexMap),this._materialRecompileInduceInfo=null)}static Create(e,t,n,i){const r=t.skeleton.bones,o=new Map;if(void 0===n)for(let e=0;e<r.length;++e)o.set(r[e].name,e);else for(let e=0;e<r.length;++e)o.set(n[r[e].name]??r[e].name,e);const a=new Array(e.boneTracks.length),s=e.boneTracks;for(let e=0;e<s.length;++e){const t=s[e],n=o.get(t.name);void 0===n?(i?.warn(`Binding failed: bone ${t.name} not found`),a[e]=null):a[e]=r[n]}const l=new Array(e.movableBoneTracks.length),h=e.movableBoneTracks;for(let e=0;e<h.length;++e){const t=h[e],n=o.get(t.name);void 0===n?(i?.warn(`Binding failed: bone ${t.name} not found`),l[e]=null):l[e]=r[n]}const d=t.morph,c=new Array(e.morphTracks.length),u=e.morphTracks;for(let e=0;e<u.length;++e){const t=u[e],r=n?.[t.name]??t.name,o=d.getMorphIndices(r);void 0===o?(i?.warn(`Binding failed: morph ${r} not found`),c[e]=null):c[e]=o}const m=t.runtimeBones,p=new Int32Array(e.propertyTrack.ikBoneNames.length),_=e.propertyTrack.ikBoneNames;for(let e=0;e<_.length;++e){const t=_[e],n=o.get(t);if(void 0===n)i?.warn(`Binding failed: IK bone ${t} not found`),p[e]=-1;else{const r=m[n].ikSolverIndex;-1===r?(i?.warn(`Binding failed: IK solver for bone ${t} not found`),p[e]=-1):p[e]=r}}return new Vt(e,a,l,d,c,t.mesh.metadata.meshes,p,t,t.mesh.metadata.materials)}static InduceMaterialRecompile=yt}Mt.prototype.createRuntimeModelAnimation=function(e,t,n){return Vt.Create(this,e,t,n)};class Wt{_morphController;_morphIndices;constructor(e,t){this._morphController=e,this._morphIndices=t}get influence(){return this._morphController.getMorphWeightFromIndex(this._morphIndices[0])}set influence(e){for(let t=0;t<this._morphIndices.length;++t)this._morphController.setMorphWeightFromIndex(this._morphIndices[t],e)}}class zt{_enabled;_ikSolverState;constructor(e,t){this._enabled=e[t],this._ikSolverState=new Uint8Array(e.buffer,e.byteOffset+t,1)}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._ikSolverState[0]=.5<e?1:0}}class jt{_meshes;constructor(e){this._meshes=e}get visibility(){return this._meshes[0].visibility}set visibility(e){for(let t=0;t<this._meshes.length;++t)this._meshes[t].visibility=e}}class qt{name;bonePositionAnimations;bonePositionAnimationBindMap;boneRotationAnimations;boneRotationAnimationBindMap;morphAnimations;morphAnimationBindMap;propertyAnimations;visibilityAnimation;propertyAnimationBindMap;startFrame;endFrame;constructor(e,t){const n=this.name=e.name,i=e.movableBoneTracks,r=this.bonePositionAnimations=new Array(i.length),o=this.bonePositionAnimationBindMap=new Array(i.length);for(let e=0;e<i.length;++e)r[e]=t.createBonePositionAnimation(n,i[e]),o[e]=i[e].name;const a=e.boneTracks,s=this.boneRotationAnimations=new Array(a.length+i.length),l=this.boneRotationAnimationBindMap=new Array(a.length+i.length);for(let e=0;e<a.length;++e)s[e]=t.createBoneRotationAnimation(n,a[e]),l[e]=a[e].name;for(let e=0;e<i.length;++e)s[a.length+e]=t.createBoneRotationAnimation(n,i[e]),l[a.length+e]=i[e].name;const h=e.morphTracks,d=this.morphAnimations=new Array(h.length),c=this.morphAnimationBindMap=new Array(h.length);for(let e=0;e<h.length;++e)d[e]=t.createMorphAnimation(n,h[e]),c[e]=h[e].name;this.visibilityAnimation=t.createVisibilityAnimation(n,e.propertyTrack),this.propertyAnimations=t.createPropertyAnimation(n,e.propertyTrack),this.propertyAnimationBindMap=e.propertyTrack.ikBoneNames,this.startFrame=e.startFrame,this.endFrame=e.endFrame}createAnimationGroup(e){const t=new Bt.AnimationGroup(this.name,e.mesh.getScene(),1);t.isAdditive=!0;const n=new Map,i=e.skeleton.bones;for(let e=0;e<i.length;++e)n.set(i[e].name,e);const r=this.bonePositionAnimations,o=this.bonePositionAnimationBindMap;for(let e=0;e<r.length;++e){const a=n.get(o[e]);void 0!==a&&t.addTargetedAnimation(r[e],i[a])}const a=this.boneRotationAnimations,s=this.boneRotationAnimationBindMap;for(let e=0;e<a.length;++e){const r=n.get(s[e]);void 0!==r&&t.addTargetedAnimation(a[e],i[r])}const l=this.morphAnimations,h=this.morphAnimationBindMap,d=e.morph;for(let e=0;e<l.length;++e){const n=d.getMorphIndices(h[e]);void 0!==n&&t.addTargetedAnimation(l[e],new Wt(d,n))}const c=e.runtimeBones,u=this.propertyAnimations,m=this.propertyAnimationBindMap,p=e.ikSolverStates;for(let e=0;e<u.length;++e){const i=n.get(m[e]);if(void 0!==i){const n=c[i].ikSolverIndex;-1!==n&&t.addTargetedAnimation(u[e],new zt(p,n))}}const _=this.visibilityAnimation;return null!==_&&0!==e.mesh.metadata.meshes.length&&t.addTargetedAnimation(_,new jt(e.mesh.metadata.meshes)),t}}class Kt{createMorphAnimation(e,t){const n=new It.Animation(e+"_morph_"+t.name,"influence",30,It.Animation.ANIMATIONTYPE_FLOAT,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.weights,o=new Array(i.length);for(let e=0;e<i.length;++e)o[e]={frame:i[e],value:r[e],interpolation:Pt.AnimationKeyInterpolation.NONE};return n.setKeys(o),n}createVisibilityAnimation(e,t){const n=new It.Animation(e+"_visibility","visibility",30,It.Animation.ANIMATIONTYPE_FLOAT,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.visibles,o=new Array(i.length);for(let e=0;e<i.length;++e)o[e]={frame:i[e],value:r[e]-1,interpolation:Pt.AnimationKeyInterpolation.STEP};return n.setKeys(o),0===i.length||1===i.length&&1===r[0]?null:n}createPropertyAnimation(e,t){const n=new Array(t.ikBoneNames.length),i=t.ikBoneNames;for(let r=0;r<i.length;++r){const o=n[r]=new It.Animation(e+"_ik_"+i[r],"enabled",30,It.Animation.ANIMATIONTYPE_FLOAT,It.Animation.ANIMATIONLOOPMODE_CYCLE),a=t.frameNumbers,s=t.getIkState(r),l=new Array(a.length);for(let e=0;e<a.length;++e)l[e]={frame:a[e],value:s[e]-1,interpolation:Pt.AnimationKeyInterpolation.STEP};o.setKeys(l)}return n}}class Gt extends Kt{createBonePositionAnimation(e,t){const n=new It.Animation(e+"_bone_position_"+t.name,"position",30,It.Animation.ANIMATIONTYPE_VECTOR3,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.positions,o=t.positionInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0,l=t-(0<e?i[e-1]:-30),h=s-t;a[e]={frame:t,value:new rt.Vector3(r[3*e],r[3*e+1],r[3*e+2]),inTangent:n?new rt.Vector3(Ct(1-o[12*e+1]/127,1-o[12*e+3]/127,l,r[3*e]-r[3*(e-1)]),Ct(1-o[12*e+5]/127,1-o[12*e+7]/127,l,r[3*e+1]-r[3*(e-1)+1]),Ct(1-o[12*e+9]/127,1-o[12*e+11]/127,l,r[3*e+2]-r[3*(e-1)+2])):void 0,outTangent:s<1/0?new rt.Vector3(Ct(o[12*(e+1)+0]/127,o[12*(e+1)+2]/127,h,r[3*(e+1)]-r[3*e]),Ct(o[12*(e+1)+4]/127,o[12*(e+1)+6]/127,h,r[3*(e+1)+1]-r[3*e+1]),Ct(o[12*(e+1)+8]/127,o[12*(e+1)+10]/127,h,r[3*(e+1)+2]-r[3*e+2])):void 0,interpolation:Pt.AnimationKeyInterpolation.NONE,lockedTangent:!1}}return n.setKeys(a),n}_minimizeRotationDifference(e,t){rt.Quaternion.Dot(e,t)<0&&(e.x=-e.x,e.y=-e.y,e.z=-e.z,e.w=-e.w)}createBoneRotationAnimation(e,t){const n=new It.Animation(e+"_bone_rotation_"+t.name,"rotationQuaternion",30,It.Animation.ANIMATIONTYPE_QUATERNION,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.rotations,o=t.rotationInterpolations;let a=new rt.Quaternion(0,0,0,0);const s=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,l=e+1<i.length?i[e+1]:1/0,h=t-(0<e?i[e-1]:-30),d=l-t,c=new rt.Quaternion(r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]);this._minimizeRotationDifference(c,a);const u=new rt.Quaternion(r[4*(e+1)],r[4*(e+1)+1],r[4*(e+1)+2],r[4*(e+1)+3]);this._minimizeRotationDifference(u,c),s[e]={frame:t,value:c,inTangent:n?new rt.Quaternion(Ct(1-o[4*e+1]/127,1-o[4*e+3]/127,h,c.x-a.x),Ct(1-o[4*e+1]/127,1-o[4*e+3]/127,h,c.y-a.y),Ct(1-o[4*e+1]/127,1-o[4*e+3]/127,h,c.z-a.z),Ct(1-o[4*e+1]/127,1-o[4*e+3]/127,h,c.w-a.w)):void 0,outTangent:l<1/0?new rt.Quaternion(Ct(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127,d,u.x-c.x),Ct(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127,d,u.y-c.y),Ct(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127,d,u.z-c.z),Ct(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127,d,u.w-c.w)):void 0,interpolation:Pt.AnimationKeyInterpolation.NONE,lockedTangent:!1},a=c}return n.setKeys(s),n}}class Yt extends Kt{createBonePositionAnimation(e,t){const n=new It.Animation(e+"_bone_position_"+t.name,"position",30,It.Animation.ANIMATIONTYPE_VECTOR3,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.positions,o=t.positionInterpolations,a=new Array(t.endFrame);let s=0;const l=new rt.Vector3(r[0],r[1],r[2]);for(let e=0;e<i.length;++e){const t=i[e];a[t]={frame:t,value:new rt.Vector3(r[3*e],r[3*e+1],r[3*e+2])};const n=o[12*e+0]/127,h=o[12*e+1]/127,d=o[12*e+2]/127,c=o[12*e+3]/127,u=o[12*e+4]/127,m=o[12*e+5]/127,p=o[12*e+6]/127,_=o[12*e+7]/127,g=o[12*e+8]/127,f=o[12*e+9]/127,b=o[12*e+10]/127,y=o[12*e+11]/127;for(let i=s+1;i<t;++i){const o=(i-s)/(t-s),w=Tt(n,h,d,c,o),A=Tt(u,m,p,_,o),M=Tt(g,f,b,y,o);a[i]={frame:i,value:new rt.Vector3(l.x+(r[3*e]-l.x)*w,l.y+(r[3*e+1]-l.y)*A,l.z+(r[3*e+2]-l.z)*M)}}s=t,l.set(r[3*e],r[3*e+1],r[3*e+2])}return n.setKeys(a),n}createBoneRotationAnimation(e,t){const n=new It.Animation(e+"_bone_rotation_"+t.name,"rotationQuaternion",30,It.Animation.ANIMATIONTYPE_QUATERNION,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.rotations,o=t.rotationInterpolations,a=new Array(t.endFrame);let s=0;const l=new rt.Quaternion(r[0],r[1],r[2],r[3]);for(let e=0;e<i.length;++e){const t=i[e];a[t]={frame:t,value:new rt.Quaternion(r[4*e],r[4*e+1],r[4*e+2],r[4*e+3])};const n=o[4*e+0]/127,h=o[4*e+1]/127,d=o[4*e+2]/127,c=o[4*e+3]/127;for(let i=s+1;i<t;++i){const o=Tt(n,h,d,c,(i-s)/(t-s)),u=new rt.Quaternion(r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]);a[i]={frame:i,value:rt.Quaternion.SlerpToRef(l,u,o,u)}}s=t,l.set(r[4*e],r[4*e+1],r[4*e+2],r[4*e+3])}return n.setKeys(a),n}}class Qt extends Kt{createBonePositionAnimation(e,t){const n=new Et(e+"_bone_position_"+t.name,"position",30,It.Animation.ANIMATIONTYPE_VECTOR3,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.positions,o=t.positionInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0;a[e]={frame:t,value:new rt.Vector3(r[3*e],r[3*e+1],r[3*e+2]),inTangent:n?[new rt.Vector2(o[12*e+1]/127,o[12*e+3]/127),new rt.Vector2(o[12*e+5]/127,o[12*e+7]/127),new rt.Vector2(o[12*e+9]/127,o[12*e+11]/127)]:void 0,outTangent:s<1/0?[new rt.Vector2(o[12*(e+1)+0]/127,o[12*(e+1)+2]/127),new rt.Vector2(o[12*(e+1)+4]/127,o[12*(e+1)+6]/127),new rt.Vector2(o[12*(e+1)+8]/127,o[12*(e+1)+10]/127)]:void 0,interpolation:2,lockedTangent:!1}}return n.setKeys(a),n}createBoneRotationAnimation(e,t){const n=new Et(e+"_bone_rotation_"+t.name,"rotationQuaternion",30,Et.ANIMATIONTYPE_SLERP_TANGENT_QUATERNION,It.Animation.ANIMATIONLOOPMODE_CYCLE),i=t.frameNumbers,r=t.rotations,o=t.rotationInterpolations,a=new Array(i.length);for(let e=0;e<i.length;++e){const t=i[e],n=0<e,s=e+1<i.length?i[e+1]:1/0;a[e]={frame:t,value:new rt.Quaternion(r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]),inTangent:n?new rt.Vector2(o[4*e+1]/127,o[4*e+3]/127):void 0,outTangent:s<1/0?new rt.Vector2(o[4*(e+1)+0]/127,o[4*(e+1)+2]/127):void 0,interpolation:2,lockedTangent:!1}}return n.setKeys(a),n}}class Ht{animation;boneBindIndexMap;movableBoneBindIndexMap;_morphController;morphBindIndexMap;_meshes;ikSolverBindIndexMap;_ikSolverStates;_materialRecompileInduceInfo;_bonePositionAnimationStates;_boneRotationAnimationStates;_morphAnimationStates;_propertyAnimationStates;_visibilityAnimationState;constructor(e,t,n,i,r,o,a,s,l){this.animation=e,this.boneBindIndexMap=t,this.movableBoneBindIndexMap=n,this._morphController=i,this.morphBindIndexMap=r,this._meshes=o,this.ikSolverBindIndexMap=a,this._ikSolverStates=s,this._materialRecompileInduceInfo=l;const h=this._bonePositionAnimationStates=new Array(e.bonePositionAnimations.length);for(let e=0;e<h.length;++e)h[e]=Dt();const d=this._boneRotationAnimationStates=new Array(e.boneRotationAnimations.length);for(let e=0;e<d.length;++e)d[e]=Dt();const c=this._morphAnimationStates=new Array(e.morphAnimations.length);for(let e=0;e<c.length;++e)c[e]=Dt();const u=this._propertyAnimationStates=new Array(e.propertyAnimations.length);for(let e=0;e<u.length;++e)u[e]=Dt();this._visibilityAnimationState=Dt()}static _BonePosition=new rt.Vector3;animate(e){const t=this.animation,n=t.boneRotationAnimations,i=this.boneBindIndexMap;for(let t=0;t<n.length;++t){const r=n[t],o=i[t];null!==o&&o.setRotationQuaternion(r._interpolate(e,this._boneRotationAnimationStates[t]),Ut.Space.LOCAL)}const r=t.bonePositionAnimations,o=this.movableBoneBindIndexMap;for(let t=0;t<r.length;++t){const n=r[t],i=o[t];null!==i&&(i.getRestMatrix().getTranslationToRef(Ht._BonePosition),i.position=Ht._BonePosition.addInPlace(n._interpolate(e,this._bonePositionAnimationStates[t])))}const a=t.morphAnimations,s=this.morphBindIndexMap,l=this._morphController;for(let t=0;t<a.length;++t){const n=a[t],i=s[t];if(null===i)continue;const r=n._interpolate(e,this._morphAnimationStates[t]);for(let e=0;e<i.length;++e)l.setMorphWeightFromIndex(i[e],r)}if(null!==t.visibilityAnimation){const n=this._meshes,i=1+t.visibilityAnimation._interpolate(e,this._visibilityAnimationState);for(let e=0;e<n.length;++e)n[e].visibility=i}const h=t.propertyAnimations,d=this.ikSolverBindIndexMap,c=this._ikSolverStates.ikSolverStates;for(let t=0;t<h.length;++t){const n=h[t],i=d[t];-1!==i&&(c[i]=0<1+n._interpolate(e,this._propertyAnimationStates[t])?1:0)}}induceMaterialRecompile(e,t){null!==this._materialRecompileInduceInfo&&(Ht.InduceMaterialRecompile(this._materialRecompileInduceInfo,this._morphController,this.morphBindIndexMap,t),e&&wt(this._morphController,this.morphBindIndexMap),this._materialRecompileInduceInfo=null)}static Create(e,t,n,i){const r=t.skeleton.bones,o=new Map;if(void 0===n)for(let e=0;e<r.length;++e)o.set(r[e].name,e);else for(let e=0;e<r.length;++e)o.set(n[r[e].name]??r[e].name,e);const a=new Array(e.boneRotationAnimations.length),s=e.boneRotationAnimationBindMap;for(let e=0;e<s.length;++e){const t=o.get(s[e]);void 0===t?(i?.warn(`Binding failed: bone ${s[e]} not found`),a[e]=null):a[e]=r[t]}const l=new Array(e.bonePositionAnimations.length),h=e.bonePositionAnimationBindMap;for(let e=0;e<h.length;++e){const t=o.get(h[e]);void 0===t?(i?.warn(`Binding failed: bone ${h[e]} not found`),l[e]=null):l[e]=r[t]}const d=t.morph,c=new Array(e.morphAnimations.length),u=e.morphAnimationBindMap;for(let e=0;e<u.length;++e){const t=u[e],r=n?.[t]??t,o=d.getMorphIndices(r);void 0===o?(i?.warn(`Binding failed: morph ${r} not found`),c[e]=null):c[e]=o}const m=t.runtimeBones,p=new Int32Array(e.propertyAnimations.length),_=e.propertyAnimationBindMap;for(let e=0;e<_.length;++e){const t=_[e],n=o.get(t);if(void 0===n)i?.warn(`Binding failed: IK bone ${t} not found`),p[e]=-1;else{const r=m[n].ikSolverIndex;-1===r?(i?.warn(`Binding failed: IK solver for bone ${t} not found`),p[e]=-1):p[e]=r}}return new Ht(e,a,l,d,c,t.mesh.metadata.meshes,p,t,t.mesh.metadata.materials)}static InduceMaterialRecompile=yt}qt.prototype.createRuntimeModelAnimation=function(e,t,n){return Ht.Create(this,e,t,n)};class $t{trackType;name;frameNumbers;constructor(e,t,n,i,r){this.trackType=e,this.name=t,this.frameNumbers=void 0===i?new Uint32Array(n):new Uint32Array(i,r,n)}validate(){for(let e=1;e<this.frameNumbers.length;++e)if(this.frameNumbers[e-1]>=this.frameNumbers[e])return!1;return!0}get startFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[0]}get endFrame(){return 0===this.frameNumbers.length?0:this.frameNumbers[this.frameNumbers.length-1]}}class Xt extends $t{rotations;rotationInterpolations;constructor(e,t,n,i,r,o){super("bone",e,t,n,i),void 0===n?(this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)):(this.rotations=new Float32Array(n,r,4*t),this.rotationInterpolations=new Uint8Array(n,o,4*t))}}class Jt extends $t{positions;positionInterpolations;rotations;rotationInterpolations;constructor(e,t,n,i,r,o,a,s){super("movableBone",e,t,n,i),void 0===n?(this.positions=new Float32Array(3*t),this.positionInterpolations=new Uint8Array(12*t),this.rotations=new Float32Array(4*t),this.rotationInterpolations=new Uint8Array(4*t)):(this.positions=new Float32Array(n,r,3*t),this.positionInterpolations=new Uint8Array(n,o,12*t),this.rotations=new Float32Array(n,a,4*t),this.rotationInterpolations=new Uint8Array(n,s,4*t))}}class Zt extends $t{weights;constructor(e,t,n,i,r){super("morph",e,t,n,i),this.weights=void 0===n?new Float32Array(t):new Float32Array(n,r,t)}}class en extends $t{positions;positionInterpolations;rotations;rotationInterpolations;distances;distanceInterpolations;fovs;fovInterpolations;constructor(e,t,n,i,r,o,a,s,l,h,d){super("camera","cameraTrack",e,t,n),void 0===t?(this.positions=new Float32Array(3*e),this.positionInterpolations=new Uint8Array(12*e),this.rotations=new Float32Array(3*e),this.rotationInterpolations=new Uint8Array(4*e),this.distances=new Float32Array(e),this.distanceInterpolations=new Uint8Array(4*e),this.fovs=new Float32Array(e),this.fovInterpolations=new Uint8Array(4*e)):(this.positions=new Float32Array(t,i,3*e),this.positionInterpolations=new Uint8Array(t,r,12*e),this.rotations=new Float32Array(t,o,3*e),this.rotationInterpolations=new Uint8Array(t,a,4*e),this.distances=new Float32Array(t,s,e),this.distanceInterpolations=new Uint8Array(t,l,4*e),this.fovs=new Float32Array(t,h,e),this.fovInterpolations=new Uint8Array(t,d,4*e))}}class tn extends $t{visibles;ikBoneNames;_ikStates;constructor(e,t,n,i,r,o){if(super("property","propertyTrack",e,n,i),void 0===n){this.visibles=new Uint8Array(e),this.ikBoneNames=t,this._ikStates=new Array(t.length);for(let n=0;n<t.length;++n)this._ikStates[n]=new Uint8Array(e)}else{this.visibles=new Uint8Array(n,r,e),this.ikBoneNames=t,this._ikStates=new Array(t.length),void 0===o&&(o=new Array(t.length));for(let i=0;i<t.length;++i)this._ikStates[i]=new Uint8Array(n,o[i],e)}}getIkState(e){return this._ikStates[e]}}class nn{static _Map=new Map;instance;pool;_referenceCount;constructor(e,t){this.instance=e,this.pool=t,this._referenceCount=0}addReference(){this._referenceCount+=1}removeReference(){this._referenceCount-=1,0===this._referenceCount&&(this.pool.free(),nn._Map.delete(this.instance))}static Get(e){let t=this._Map.get(e);if(!t){const n=e.createAnimationPool();t=new nn(e,n),this._Map.set(e,t)}return t}}class rn{trackType;name;_frameNumbers;get frameNumbers(){return this._frameNumbers.array}constructor(e,t,n,i,r){this.trackType=e,this.name=t,this._frameNumbers=i.createTypedArray(Uint32Array,r,n)}get startFrame(){const e=this._frameNumbers.array;return 0===e.length?0:e[0]}get endFrame(){const e=this._frameNumbers.array;return 0===e.length?0:e[e.length-1]}}class on extends rn{_rotations;get rotations(){return this._rotations.array}_rotationInterpolations;get rotationInterpolations(){return this._rotationInterpolations.array}constructor(e,t,n,i,r,o){super("bone",e,t,n,i),this._rotations=n.createTypedArray(Float32Array,r,4*t),this._rotationInterpolations=n.createTypedArray(Uint8Array,o,4*t)}}class an extends rn{_positions;get positions(){return this._positions.array}_positionInterpolations;get positionInterpolations(){return this._positionInterpolations.array}_rotations;get rotations(){return this._rotations.array}_rotationInterpolations;get rotationInterpolations(){return this._rotationInterpolations.array}constructor(e,t,n,i,r,o,a,s){super("movableBone",e,t,n,i),this._positions=n.createTypedArray(Float32Array,r,3*t),this._positionInterpolations=n.createTypedArray(Uint8Array,o,12*t),this._rotations=n.createTypedArray(Float32Array,a,4*t),this._rotationInterpolations=n.createTypedArray(Uint8Array,s,4*t)}}class sn extends rn{_weights;get weights(){return this._weights.array}constructor(e,t,n,i,r){super("morph",e,t,n,i),this._weights=n.createTypedArray(Float32Array,r,t)}}class ln extends rn{visibles;ikBoneNames;_ikStates;constructor(e,t,n,i,r,o){if(super("property","propertyTrack",e,n,i),r.length!==e)throw new Error("visibles.length !== frameCount");this.visibles=r,this.ikBoneNames=t,this._ikStates=new Array(t.length),void 0===o&&(o=new Array(t.length));for(let i=0;i<t.length;++i)this._ikStates[i]=n.createTypedArray(Uint8Array,o[i],e)}getIkState(e){return this._ikStates[e].array}}class hn extends Mt{ptr;_poolWrapper;_disposed;_bindedDispose;_disposeObservableObject;constructor(e,t,n){const i=nn.Get(t);i.addReference();const r=i.pool,o=e.boneTracks,a=r.allocateLengthsBuffer(o.length),s=t.createTypedArray(Uint32Array,a,o.length).array;for(let e=0;e<o.length;++e)s[e]=o[e].frameNumbers.length;const l=r.createBoneTracks(a,s.length);r.deallocateLengthsBuffer(a,s.length);const h=new Array(o.length);for(let e=0;e<o.length;++e){const n=o[e],i=r.getBoneTrackFrameNumbers(l,e),a=r.getBoneTrackRotations(l,e),s=r.getBoneTrackRotationInterpolations(l,e),d=new on(n.name,n.frameNumbers.length,t,i,a,s);d.frameNumbers.set(n.frameNumbers),d.rotations.set(n.rotations),d.rotationInterpolations.set(n.rotationInterpolations),h[e]=d}const d=e.movableBoneTracks,c=r.allocateLengthsBuffer(d.length),u=t.createTypedArray(Uint32Array,c,d.length).array;for(let e=0;e<d.length;++e)u[e]=d[e].frameNumbers.length;const m=r.createMovableBoneTracks(c,u.length);r.deallocateLengthsBuffer(c,u.length);const p=new Array(d.length);for(let e=0;e<d.length;++e){const n=d[e],i=r.getMovableBoneTrackFrameNumbers(m,e),o=r.getMovableBoneTrackPositions(m,e),a=r.getMovableBoneTrackPositionInterpolations(m,e),s=r.getMovableBoneTrackRotations(m,e),l=r.getMovableBoneTrackRotationInterpolations(m,e),h=new an(n.name,n.frameNumbers.length,t,i,o,a,s,l);h.frameNumbers.set(n.frameNumbers),h.positions.set(n.positions),h.positionInterpolations.set(n.positionInterpolations),h.rotations.set(n.rotations),h.rotationInterpolations.set(n.rotationInterpolations),p[e]=h}const _=e.morphTracks,g=r.allocateLengthsBuffer(_.length),f=t.createTypedArray(Uint32Array,g,_.length).array;for(let e=0;e<_.length;++e)f[e]=_[e].frameNumbers.length;const b=r.createMorphTracks(g,f.length);r.deallocateLengthsBuffer(g,f.length);const y=new Array(_.length);for(let e=0;e<_.length;++e){const n=_[e],i=r.getMorphTrackFrameNumbers(b,e),o=r.getMorphTrackWeights(b,e),a=new sn(n.name,n.frameNumbers.length,t,i,o);a.frameNumbers.set(n.frameNumbers),a.weights.set(n.weights),y[e]=a}const w=e.propertyTrack,A=r.createAnimation(l,h.length,m,p.length,b,y.length,w.frameNumbers.length,w.ikBoneNames.length),M=r.getPropertyTrackFrameNumbers(A);let T;w.visibles.buffer.byteLength-w.visibles.byteLength<w.visibles.byteLength?T=w.visibles:(T=new Uint8Array(w.visibles.length),T.set(w.visibles));const x=[];for(let e=0;e<w.ikBoneNames.length;++e){const t=r.getPropertyTrackIkStates(A,e);x.push(t)}const v=new ln(w.frameNumbers.length,w.ikBoneNames,t,M,T,x);v.frameNumbers.set(w.frameNumbers);for(let e=0;e<w.ikBoneNames.length;++e){const t=w.getIkState(e);v.getIkState(e).set(t)}const I=e.cameraTrack,B=I.frameNumbers.byteLength+I.positions.byteLength+I.positionInterpolations.byteLength+I.rotations.byteLength+I.rotationInterpolations.byteLength+I.distances.byteLength+I.distanceInterpolations.byteLength+I.fovs.byteLength+I.fovInterpolations.byteLength;let P;I.frameNumbers.buffer.byteLength-B<B?P=I:(P=new en(I.frameNumbers.length),P.frameNumbers.set(I.frameNumbers),P.positions.set(I.positions),P.positionInterpolations.set(I.positionInterpolations),P.rotations.set(I.rotations),P.rotationInterpolations.set(I.rotationInterpolations),P.distances.set(I.distances),P.distanceInterpolations.set(I.distanceInterpolations),P.fovs.set(I.fovs),P.fovInterpolations.set(I.fovInterpolations)),super(e.name,h,p,y,v,P),this.ptr=A,this._poolWrapper=i,this._disposed=!1,this._bindedDispose=this.dispose.bind(this),this._disposeObservableObject=n,null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.add(this._bindedDispose)}dispose(){this._disposed||(this._disposed=!0,this._poolWrapper.pool.destroyAnimation(this.ptr),this._poolWrapper.removeReference(),this._poolWrapper=null,this.boneTracks.length=0,this.movableBoneTracks.length=0,this.morphTracks.length=0,this.propertyTrack=new tn(0,[]),this.cameraTrack=new en(0),null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.removeCallback(this._bindedDispose))}get isDisposed(){return this._disposed}}class dn extends xt{ptr;_modelPtr;_onDispose;animation;_boneBindIndexMap;get boneBindIndexMap(){return this._boneBindIndexMap.array}_movableBoneBindIndexMap;get movableBoneBindIndexMap(){return this._movableBoneBindIndexMap.array}_morphController;morphBindIndexMap;_meshes;_ikSolverBindIndexMap;get ikSolverBindIndexMap(){return this._ikSolverBindIndexMap.array}_materialRecompileInduceInfo;constructor(e,t,n,i,r,o,a,s,l,h,d){super(),this.ptr=e,this._modelPtr=t,this._onDispose=d,this.animation=n,this._boneBindIndexMap=i,this._movableBoneBindIndexMap=r,this._morphController=o,this.morphBindIndexMap=a,this._meshes=s,this._ikSolverBindIndexMap=l,this._materialRecompileInduceInfo=h}dispose(e=!1){if(null!==this._onDispose){if(!e){const e=this.animation._runtimeModelAnimations;if(void 0!==e){const t=e.indexOf(this);-1!==t&&e.splice(t,1)}}this._onDispose(),this._onDispose=null,this.animation._poolWrapper.pool.destroyRuntimeAnimation(this.ptr)}}wasmAnimate(e){this.animation._poolWrapper.pool.animateMmdModel(this.ptr,this._modelPtr,e)}animate(e){const t=this.animation,n=t.morphTracks;if(0<n.length){const t=this._morphController,i=this.morphBindIndexMap;for(let r=0;r<n.length;++r){const o=i[r];if(null===o)continue;const a=n[r];if(0===a.frameNumbers.length){for(let e=0;e<o.length;++e)t.setMorphWeightFromIndex(o[e],0);continue}const s=Math.max(a.startFrame,Math.min(a.endFrame,e)),l=this._upperBoundFrameIndex(s,a),h=l-1,d=a.frameNumbers[l];if(void 0===d){const e=a.weights[h];for(let n=0;n<o.length;++n)t.setMorphWeightFromIndex(o[n],e,!1)}else{const e=a.frameNumbers[h],n=(s-e)/(d-e),i=a.weights[h],r=i+(a.weights[l]-i)*n;for(let e=0;e<o.length;++e)t.setMorphWeightFromIndex(o[e],r,!1)}}}if(0<t.propertyTrack.frameNumbers.length){const n=t.propertyTrack,i=Math.max(n.startFrame,Math.min(n.endFrame,e)),r=this._upperBoundFrameIndex(i,n)-1,o=n.visibles[r],a=this._meshes;for(let e=0;e<a.length;++e)a[e].visibility=o}}induceMaterialRecompile(e,t){null!==this._materialRecompileInduceInfo&&(dn.InduceMaterialRecompile(this._materialRecompileInduceInfo,this._morphController,this.morphBindIndexMap,t),e&&wt(this._morphController,this.morphBindIndexMap),this._materialRecompileInduceInfo=null)}static Create(e,t,n,i,r){const o=e._poolWrapper.instance,a=e._poolWrapper.pool,s=t.skeleton.bones,l=new Map;if(void 0===i)for(let e=0;e<s.length;++e)l.set(s[e].name,e);else for(let e=0;e<s.length;++e)l.set(i[s[e].name]??s[e].name,e);const h=a.createBoneBindIndexMap(e.ptr),d=o.createTypedArray(Int32Array,h,e.boneTracks.length);{const t=e.boneTracks,n=d.array;for(let e=0;e<t.length;++e){const i=t[e],o=l.get(i.name);void 0===o?(r?.warn(`Binding failed: bone ${i.name} not found`),n[e]=-1):n[e]=o}}const c=a.createMovableBoneBindIndexMap(e.ptr),u=o.createTypedArray(Int32Array,c,e.movableBoneTracks.length);{const t=u.array,n=e.movableBoneTracks;for(let e=0;e<n.length;++e){const i=n[e],o=l.get(i.name);void 0===o?(r?.warn(`Binding failed: bone ${i.name} not found`),t[e]=-1):t[e]=o}}const m=new Array(e.morphTracks.length),p=t.morph,_=e.morphTracks;for(let e=0;e<_.length;++e){const t=_[e],n=i?.[t.name]??t.name,o=p.getMorphIndices(n);void 0===o?(r?.warn(`Binding failed: morph ${n} not found`),m[e]=null):m[e]=o}const g=a.allocateLengthsBuffer(_.length),f=o.createTypedArray(Uint32Array,g,_.length);{const e=f.array,t=p.wasmMorphIndexMap;for(let n=0;n<_.length;++n){let i=0;const r=m[n];if(null!==r)for(let e=0;e<r.length;++e){const n=t[r[e]];void 0!==n&&-1!==n&&(i+=1)}e[n]=i}}const b=a.createMorphBindIndexMap(e.ptr,g);{const e=p.wasmMorphIndexMap;for(let t=0;t<_.length;++t){const n=a.getNthMorphBindIndexMap(b,t),i=o.createTypedArray(Int32Array,n,f.array[t]).array;let r=0;const s=m[t];if(null!==s)for(let t=0;t<s.length;++t){const n=e[s[t]];void 0!==n&&-1!==n&&(i[r]=n,r+=1)}}}a.deallocateLengthsBuffer(g,_.length);const y=a.createIkSolverBindIndexMap(e.ptr),w=o.createTypedArray(Int32Array,y,e.propertyTrack.ikBoneNames.length);{const n=w.array,i=t.runtimeBones,o=e.propertyTrack.ikBoneNames;for(let e=0;e<o.length;++e){const t=o[e],a=l.get(t);if(void 0===a)r?.warn(`Binding failed: IK bone ${t} not found`),n[e]=-1;else{const o=i[a].ikSolverIndex;-1===o?(r?.warn(`Binding failed: IK solver for bone ${t} not found`),n[e]=-1):n[e]=o}}}const A=a.createRuntimeAnimation(e.ptr,h,c,b,y);return new dn(A,t.ptr,e,d,u,p,m,t.mesh.metadata.meshes,w,t.mesh.metadata.materials,n)}static InduceMaterialRecompile=yt}hn.prototype.createWasmRuntimeModelAnimation=function(e,t,n,i){void 0===this._runtimeModelAnimations&&(this._runtimeModelAnimations=[]);const r=dn.Create(this,e,t,n,i);return this._runtimeModelAnimations.push(r),r};const cn=hn.prototype.dispose;hn.prototype.dispose=function(){if(this.isDisposed)return;const e=this._runtimeModelAnimations;if(void 0!==e){for(let t=0;t<e.length;++t)e[t].dispose(!0);this._runtimeModelAnimations=void 0}cn.call(this)},We(426);var un=We(2620),mn=(We(9481),We(1068)),pn=We(169),_n=function(e,t,n,i){var r,o=arguments.length,a=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(a=(o<3?r(a):o>3?r(t,n,a):r(t,n))||a);return o>3&&a&&Object.defineProperty(t,n,a),a};We(4570).Node.AddNodeConstructor("MmdCamera",((e,t)=>()=>new gn(e,void 0,t)));class gn extends mn.Camera{ignoreParentScaling=!1;rotation=new rt.Vector3;distance=-45;_viewMatrix=rt.Matrix.Zero();_tmpUpVector=rt.Vector3.Zero();_tmpTargetVector=rt.Vector3.Zero();onCurrentAnimationChangedObservable;_animations;_animationNameMap=new Map;_currentAnimation;constructor(e,t=new rt.Vector3(0,10,0),n,i=!0){super(e,t,n,i),this.fov=Math.PI/180*30,this.onCurrentAnimationChangedObservable=new pt.Observable,this._animations=[],this._animationNameMap=new Map,this._currentAnimation=null}addAnimation(e){let t;if(!e.createRuntimeCameraAnimation)throw new Error('animation is not MmdAnimation or MmdCameraAnimationGroup or MmdCompositeAnimation. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeCameraAnimationGroup" or "babylon-mmd/esm/Runtime/Animation/mmdCompositeRuntimeCameraAnimation"?');t=e.createRuntimeCameraAnimation(this);const n=this._animationNameMap.get(e.name);if(n){const e=this._animations.indexOf(n),i=this._animations[e];this._animations[e]=t,this._currentAnimation===i&&(this._currentAnimation=t,this.onCurrentAnimationChangedObservable.notifyObservers(this._currentAnimation))}else this._animations.push(t);this._animationNameMap.set(e.name,t)}removeAnimation(e){const t=this._animations[e];if(void 0!==t){this._currentAnimation===t&&(this._currentAnimation=null,this.onCurrentAnimationChangedObservable.notifyObservers(null));for(const[e,n]of this._animationNameMap)if(n===t){this._animationNameMap.delete(e);break}this._animations.splice(e,1),t.dispose?.()}}setAnimation(e){if(null===e)return void(null!==this._currentAnimation&&(this._currentAnimation=null,this.onCurrentAnimationChangedObservable.notifyObservers(null)));const t=this._animationNameMap.get(e);if(void 0===t)throw new Error(`Animation ${e} is not found`);this._currentAnimation=t,this.onCurrentAnimationChangedObservable.notifyObservers(this._currentAnimation)}get runtimeAnimations(){return this._animations}get currentAnimation(){return this._currentAnimation}animate(e){null!==this._currentAnimation&&this._currentAnimation.animate(e)}_storedPosition=null;_storedRotation=null;_storedDistance=0;storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this._storedDistance=this.distance,super.storeState()}_restoreStateValues(){return!!super._restoreStateValues()&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.distance=this._storedDistance,!0)}_initCache(){super._initCache(),this._cache.rotation=new rt.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.distance=Number.MAX_VALUE}_updateCache(e){e||super._updateCache(),this._cache.rotation.copyFrom(this.rotation),this._cache.distance=this.distance}_isSynchronizedViewMatrix(){return!!super._isSynchronizedViewMatrix()&&this._cache.rotation.equals(this.rotation)&&this._cache.distance===this.distance}static _RotationMatrix=new rt.Matrix;static _CameraEyePosition=new rt.Vector3;static _UpVector=new rt.Vector3;static _TargetVector=new rt.Vector3;_getViewMatrix(){const e=rt.Matrix.RotationYawPitchRollToRef(-this.rotation.y,-this.rotation.x,-this.rotation.z,gn._RotationMatrix),t=this.position.addToRef(rt.Vector3.TransformCoordinatesFromFloatsToRef(0,0,this.distance,e,gn._CameraEyePosition),gn._CameraEyePosition),n=rt.Vector3.TransformNormalFromFloatsToRef(0,0,1,e,gn._TargetVector).addInPlace(t),i=rt.Vector3.TransformNormalFromFloatsToRef(0,1,0,e,gn._UpVector);if(this.ignoreParentScaling){if(this.parent){const e=this.parent.getWorldMatrix();rt.Vector3.TransformCoordinatesToRef(t,e,this._globalPosition),rt.Vector3.TransformCoordinatesToRef(n,e,this._tmpTargetVector),rt.Vector3.TransformNormalToRef(i,e,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t),this._tmpTargetVector.copyFrom(n),this._tmpUpVector.copyFrom(i);return this.getScene().useRightHandedSystem?rt.Matrix.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):rt.Matrix.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix),this._viewMatrix}if(this.getScene().useRightHandedSystem?rt.Matrix.LookAtRHToRef(t,n,i,this._viewMatrix):rt.Matrix.LookAtLHToRef(t,n,i,this._viewMatrix),this.parent){const e=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(e,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(t);return this._viewMatrix}getClassName(){return"MmdCamera"}}_n([(0,pn.serializeAsVector3)()],gn.prototype,"rotation",void 0),_n([(0,pn.serialize)()],gn.prototype,"distance",void 0);var fn=We(6532),bn=We(6343),yn=We(7569),wn=We(3789);function An(){(0,fn.registerSceneLoaderPlugin)({...wn.I,createPlugin:async e=>{const{PmxLoader:t}=await Promise.resolve().then(We.bind(We,4756));return new t(e.mmdmodel)}}),(0,fn.registerSceneLoaderPlugin)({...yn.Q,createPlugin:async e=>{const{PmdLoader:t}=await Promise.resolve().then(We.bind(We,224));return new t(e.mmdmodel)}}),(0,fn.registerSceneLoaderPlugin)({...bn.S,createPlugin:async e=>{const{BpmxLoader:t}=await Promise.resolve().then(We.bind(We,4870));return new t(e.mmdmodel)}})}var Mn=We(9150);let Tn=!1;function xn(){Tn||(Tn=!0,(0,Mn.registerTextureLoader)(".dxbmp",(()=>Promise.resolve().then(We.bind(We,9077)).then((e=>new e._DxBmpTextureLoader)))))}class vn extends Mt{constructor(e,t,n,i,r,o){super(e,t,n,i,r,o)}validate(){const e=this.boneTracks;for(let t=0;t<e.length;++t)if(!e[t].validate())return!1;const t=this.movableBoneTracks;for(let e=0;e<t.length;++e)if(!t[e].validate())return!1;const n=this.morphTracks;for(let e=0;e<n.length;++e)if(!n[e].validate())return!1;return this.propertyTrack.validate()&&this.cameraTrack.validate()}}var In,Bn,Pn=We(7556),Sn=We(5272),Rn=We(4751);!function(e){e.isMmdMesh=function(e){return!(null===e.metadata||!e.metadata.isMmdModel)},e.isMmdSkinnedMesh=function(e){return!(null===e.metadata||!e.metadata.isMmdModel)&&null!==e.metadata.skeleton}}(In||(In={})),function(e){e.isSerializationMetadata=function(e){return!0===e.containsSerializationData}}(Bn||(Bn={}));class En{_dataView;_encoder;_offset;constructor(e){this._dataView=new DataView(e),this._encoder=new TextEncoder,this._offset=0}get offset(){return this._offset}set offset(e){this._offset=e}setUint8(e){this._dataView.setUint8(this._offset,e),this._offset+=1}setUint8Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint8(this._offset,e[n]),this._offset+=1}setInt8(e){this._dataView.setInt8(this._offset,e),this._offset+=1}setInt8Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setInt8(this._offset,e[n]),this._offset+=1}setUint16(e){this._dataView.setUint16(this._offset,e,!0),this._offset+=2}setUint16Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint16(this._offset,e[n],!0),this._offset+=2}setUint32(e){this._dataView.setUint32(this._offset,e,!0),this._offset+=4}setUint32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setUint32(this._offset,e[n],!0),this._offset+=4}setInt32(e){this._dataView.setInt32(this._offset,e,!0),this._offset+=4}setInt32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setInt32(this._offset,e[n],!0),this._offset+=4}setFloat32(e){this._dataView.setFloat32(this._offset,e,!0),this._offset+=4}setFloat32Array(e){const t=this._dataView;for(let n=0;n<e.length;++n)t.setFloat32(this._offset,e[n],!0),this._offset+=4}setString(e){const t=this._dataView,n=this._encoder.encode(e);t.setUint32(this._offset,n.length,!0),this._offset+=4;for(let e=0;e<n.length;++e)t.setUint8(this._offset,n[e]),this._offset+=1}get bytesAvailable(){return this._dataView.byteLength-this._offset}static Padding(e,t){return e%t==0?0:t-e%t}}class Cn{_loggingEnabled;log;warn;error;constructor(){this._loggingEnabled=!0,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled}convert(e,t={}){if(!In.isMmdMesh(e))throw new Error(`${e.name} is not MmdMesh`);const{includeSkinningData:n=!0,includeMorphData:i=!0,translucentMaterials:r=[],alphaEvaluateResults:o=[]}=t,a=e.metadata,s=Bn.isSerializationMetadata(a);n&&null===a.skeleton&&this.log("MmdMesh has no skeleton. Skinning data will not be included");const l=[],h=new Int32Array(a.bones.length).fill(-1);let d=-1;const c=a.skeleton?.bones??[];for(let e=0;e<c.length;++e)d=Math.max(d,c[e].getIndex());const u=new Int32Array(d+1).fill(-1);if(n&&null!==a.skeleton){const e=a.bones,t=new Map;{const n=new Map;for(let e=0;e<c.length;++e){const t=c[e];let i=n.get(t.name);void 0===i&&(i=[],n.set(t.name,i)),i.push({index:e,value:t})}for(let i=0;i<e.length;++i){const r=e[i],o=n.get(r.name);if(void 0!==o)if(1===o.length)t.set(r,o[0].value);else{let e;for(let t=0;t<o.length;++t)if(o[t].index===i){e=o[t].value;break}void 0!==e&&t.set(r,e)}}}const n=new Map;{const t=new Map;for(let n=0;n<e.length;++n){const i=e[n];let r=t.get(i.name);void 0===r&&(r=[],t.set(i.name,r)),r.push({index:n,value:i})}for(let e=0;e<c.length;++e){const i=c[e],r=t.get(i.name);if(void 0!==r)if(1===r.length)n.set(i,r[0].value);else{let t;for(let n=0;n<r.length;++n)if(r[n].index===e){t=r[n].value;break}void 0!==t&&n.set(i,t)}}}const i=new Map;for(let t=0;t<e.length;++t){const n=e[t];let r=i.get(e[n.parentBoneIndex]);void 0===r&&0<=n.parentBoneIndex&&n.parentBoneIndex<e.length&&(r=[],i.set(e[n.parentBoneIndex],r)),r?.push(n)}const r=new Map;for(let e=0;e<c.length;++e){if(null!==c[e].getParent())continue;const t=[c[e]];for(r.set(c[e],c[e].getRestMatrix());t.length>0;){const e=t.pop(),n=r.get(e),i=e.children;for(let e=0;e<i.length;++e){const o=i[e];r.set(o,o.getRestMatrix().multiply(n)),t.push(o)}}}const o=new Map;for(let a=0;a<e.length;++a){const s=e[a];let d=t.get(s);const c=[],m=e=>{const t=e.children;for(let i=0;i<t.length;++i){const r=t[i],a=n.get(r);void 0===a?(c.push(e),m(r)):o.has(a)||o.set(a,l.length+c.length)}};if(void 0!==d)m(d);else{const e=i.get(s);if(void 0!==e)for(let t=0;t<e.length;++t){const n=e[t];o.set(n,l.length+c.length)}}const p=e=>{const n=i.get(e);if(void 0!==n)for(let e=0;e<n.length;++e){const i=n[e];let r=t.get(i);if(void 0!==r)return r;if(r=p(i),void 0!==r)return r}};if(void 0===d&&(d=p(s)),void 0===d){let n=e[s.parentBoneIndex];for(;void 0!==n&&(d=t.get(n),void 0===d);)n=e[n.parentBoneIndex]}const _=s.name,g=s.englishName,f=void 0!==d?r.get(d).getTranslation().asArray():[0,0,0],b=-1,y=s.transformOrder,w=s.tailPosition??-2,A=s.appendTransform,M=s.axisLimit,T=s.localVector,x=s.externalParentTransform,v=s.ik;let I=0;I=s.flag?s.flag:bt.B.Bone.Flag.IsRotatable|bt.B.Bone.Flag.IsMovable|bt.B.Bone.Flag.IsVisible|bt.B.Bone.Flag.IsControllable,I&=(Array.isArray(w)?~bt.B.Bone.Flag.UseBoneIndexAsTailPosition:-1)&(A?-1:~bt.B.Bone.Flag.HasAppendRotate|~bt.B.Bone.Flag.HasAppendMove)&(M?-1:~bt.B.Bone.Flag.HasAxisLimit)&(T?-1:~bt.B.Bone.Flag.HasLocalVector)&(x?-1:~bt.B.Bone.Flag.IsExternalParentTransformed)&(v?-1:~bt.B.Bone.Flag.IsIkEnabled),I|=(Array.isArray(w)?0:bt.B.Bone.Flag.UseBoneIndexAsTailPosition)|(A?bt.B.Bone.Flag.HasAppendRotate|bt.B.Bone.Flag.HasAppendMove:0)|(M?bt.B.Bone.Flag.HasAxisLimit:0)|(T?bt.B.Bone.Flag.HasLocalVector:0)|(x?bt.B.Bone.Flag.IsExternalParentTransformed:0)|(v?bt.B.Bone.Flag.IsIkEnabled:0);const B={name:_,englishName:g,position:f,parentBoneIndex:b,transformOrder:y,flag:I,tailPosition:w,appendTransform:A,axisLimit:M,localVector:T,externalParentTransform:x,ik:v},P=h[a]=l.length;void 0!==d&&(u[d.getIndex()]=P),l.push(B);const S=bt.B.Bone.Flag.UseBoneIndexAsTailPosition|bt.B.Bone.Flag.IsRotatable|bt.B.Bone.Flag.IsVisible|bt.B.Bone.Flag.IsControllable;for(let e=0;e<c.length;++e){const t=c[e];u[t.getIndex()]=l.length;let i=-1;const o=t.getParent();null!==o&&(i=n.get(o)===s?P:u[o.getIndex()]),l.push({name:t.name,englishName:"",position:r.get(t).getTranslation().asArray(),parentBoneIndex:i,transformOrder:0,flag:S,tailPosition:i,appendTransform:void 0,axisLimit:void 0,localVector:void 0,externalParentTransform:void 0,ik:void 0})}}for(let t=0;t<e.length;++t){const n=e[t],i=l[h[t]],r=i.parentBoneIndex=o.get(n)??-1;-2===i.tailPosition?i.tailPosition=r:"number"==typeof i.tailPosition&&0<=i.tailPosition&&i.tailPosition<e.length&&(i.tailPosition=h[i.tailPosition]);const a=i.appendTransform;void 0!==a&&(i.appendTransform={parentIndex:h[a.parentIndex]??a.parentIndex,ratio:a.ratio});const s=i.ik;if(void 0!==s){const e=[];i.ik={target:h[s.target]??s.target,iteration:s.iteration,rotationConstraint:s.rotationConstraint,links:e};const t=s.links;for(let n=0;n<t.length;++n){const i=t[n];e.push({target:h[i.target]??i.target,limitation:i.limitation})}}}}const m=[],p=new Map;{const e=a.meshes;for(let t=0;t<e.length;++t){const n=e[t];if(null===n.geometry){this.warn(`mesh ${n.name} has no geometry. skippping`);continue}const i=n.geometry;null!==i.getVerticesData(Xe.VertexBuffer.PositionKind)?null!==i.getVerticesData(Xe.VertexBuffer.NormalKind)?null!==i.getVerticesData(Xe.VertexBuffer.UVKind)?n.isUnIndexed||null!==i.getIndices()?null===a.skeleton||a.skeleton===n.skeleton?(p.set(t,m.length),m.push(n)):this.warn(`mesh ${n.name} has different skeleton. skippping`):this.warn(`mesh ${n.name} has no indices data. skippping`):this.warn(`mesh ${n.name} has no uv data. skippping`):this.warn(`mesh ${n.name} has no normal data. skippping`):this.warn(`mesh ${n.name} has no position data. skippping`)}}const _=[],g=[];{const e=new Set;for(let t=0;t<m.length;++t){const n=m[t].material;if(null===n)continue;const i=n.subMaterials??[n];for(let t=0;t<i.length;++t){const n=i[t];if(null!==n&&(n.diffuseTexture?e.add(n.diffuseTexture):n.albedoTexture&&e.add(n.albedoTexture),n.sphereTexture&&e.add(n.sphereTexture),n.toonTexture)){const t=n.toonTexture.name;t.startsWith("file:shared_toon_texture_")&&t.length<=27&&!isNaN(Number(t.substring(25)))||e.add(n.toonTexture)}}}const t=s?a.textureNameMap:null;null===t&&this.warn("metadata.textureNameMap is not defined. texture names will be fallback to converted string by loader");const n=new Map,i=new Map;for(const r of e){let e=null;const o=r._buffer;o instanceof ArrayBuffer?e=new Uint8Array(o):null==o?this.warn(`texture ${r.name} has no texture buffer. make sure load model with materialBuilder.deleteTextureBufferAfterLoad = false`):o.buffer instanceof ArrayBuffer?e=new Uint8Array(o.buffer,o.byteOffset,o.byteLength):this.warn(`texture ${r.name} has unsupported type of texture buffer. only ArrayBuffer and TypedArray is supported`);const a=(r.noMipmap?Pn.h.Texture.Flag.NoMipmap:0)|(r.invertY?Pn.h.Texture.Flag.InvertY:0);let s;if(null!==e){let o=i.get(e.buffer);void 0===o&&(o=i.size,i.set(e.buffer,o));const a=`${o}_${e.byteOffset}_${e.byteLength}`;if(s=n.get(a),void 0===s){s=_.length,n.set(a,s);let i=t?.get(r);void 0===i&&(this.warn(`texture ${r.name} has no name in textureNameMap. falling back to converted string by loader`),i=r.name),_.push({relativePath:i,mimeType:r.mimeType,buffer:e})}}g.push({flag:a,samplingMode:r.samplingMode,imageIndex:s??-1,texture:r})}}const f=[],b=new Map;{const e=new Map;{const t=a.materials;for(let n=0;n<t.length;++n){const i=t[n];e.set(i,n)}}const t=new Map;{const e=a.materials,n=s?a.materialsMetadata:null;if(null!==n)for(let i=0;i<e.length;++i){const r=e[i],o=n[i];t.has(r)||void 0!==o&&t.set(r,o)}}let n=!1;const i=new Map;for(let a=0;a<m.length;++a){const s=m[a],l=[];{const e=s.material?.subMaterials??[s.material],t=s.subMeshes;for(let n=0;n<t.length;++n){const i=e[t[n].materialIndex];l.push(i)}}for(let a=0;a<l.length;++a){const h=l[a];if(null===h){if(n)this.warn(`mesh ${s.name} has no material. using default material metadata`);else{n=!0,this.warn(`mesh ${s.name} has no material. adding default material metadata`);const e={name:"default",englishName:"default",diffuse:[1,1,1,1],specular:[0,0,0],shininess:0,ambient:[0,0,0],evaluatedTransparency:0,flag:0,edgeColor:[0,0,0,1],edgeSize:0,textureIndex:-1,sphereTextureIndex:-1,sphereTextureMode:bt.B.Material.SphereTextureMode.Off,isSharedToonTexture:!1,toonTextureIndex:-1,comment:"",linkedMaterial:null};f.push(e)}continue}const d=i.get(h),c=e.get(h);if(void 0===c)this.warn(`mesh ${s.name} has material which is not included in model metadata`);else if(void 0!==d)b.set(c,d);else{b.set(c,f.length),i.set(h,f.length);const e=t.get(h);void 0===e&&this.log(`mesh ${s.name} has no additional material metadata`);const n=h.name??"",a=e?.englishName??"",l=h.diffuseColor?.asArray()??[1,1,1,1];l.length=4,l[3]=h.alpha??1;const d=h.specularColor?.asArray()??h.reflectivityColor?.asArray()??[0,0,0];d.length=3;const u=h.specularPower??0,m=h.ambientColor?.asArray()??[0,0,0];m.length=3;const p=(3&+(r[c]??-1))<<4|15&(o[c]??-1),_=(!1===h.backFaceCulling?bt.B.Material.Flag.IsDoubleSided:0)|(h.renderOutline?bt.B.Material.Flag.EnabledToonEdge:0),y=h.outlineColor?.asArray()??[0,0,0];y.length=4,y[3]=h.outlineAlpha??0;const w=h.outlineWidth??0,A=h.diffuseTexture??h.albedoTexture,M=A?g.findIndex((e=>e.texture===A)):-1,T=h.sphereTexture,x=T?g.findIndex((e=>e.texture===T)):-1,v=h.sphereTextureBlendMode??bt.B.Material.SphereTextureMode.Off,I=h.toonTexture,B=!!I&&I.name.startsWith("file:shared_toon_texture_")&&I.name.length<=27&&!isNaN(Number(I.name.substring(25)));let P;P=B?Number(I.name.substring(25))-1:I?g.findIndex((e=>e.texture===I)):-1;const S={name:n,englishName:a,diffuse:l,specular:d,shininess:u,ambient:m,evaluatedTransparency:p,flag:_,edgeColor:y,edgeSize:w,textureIndex:M,sphereTextureIndex:x,sphereTextureMode:v,isSharedToonTexture:B,toonTextureIndex:P,comment:e?.comment??"",linkedMaterial:h};f.push(S)}}}}const y=new Array(a.morphs.length).fill(null);for(let e=0;e<y.length;++e)y[e]=[];if(i)if(s){const e=a.morphs;for(let t=0;t<e.length;++t){const n=e[t];switch(n.type){case bt.B.Morph.Type.VertexMorph:case bt.B.Morph.Type.UvMorph:case bt.B.Morph.Type.AdditionalUvMorph1:case bt.B.Morph.Type.AdditionalUvMorph2:case bt.B.Morph.Type.AdditionalUvMorph3:case bt.B.Morph.Type.AdditionalUvMorph4:{const e=[],i=n.elements;for(let t=0;t<i.length;++t){const r=i[t],o=p.get(r.meshIndex);void 0!==o?e.push({meshIndex:o,indices:r.indices,offsets:r.offsets}):this.warn(`morph ${n.name} has invalid mesh. skipping`)}y[t]=e}}}}else{this.warn("metadata.morphsMetadata is not defined. UV morphs will be lossy converted");const e=a.morphs;for(let t=0;t<e.length;++t){const n=e[t];let i=!1;switch(n.type){case bt.B.Morph.Type.VertexMorph:case bt.B.Morph.Type.UvMorph:case bt.B.Morph.Type.AdditionalUvMorph1:case bt.B.Morph.Type.AdditionalUvMorph2:case bt.B.Morph.Type.AdditionalUvMorph3:case bt.B.Morph.Type.AdditionalUvMorph4:i=!0}if(!i)continue;const r=y[t]=[],o=n.morphTargets;for(let e=0;e<o.length;++e){let t=-1;const i=o[e];e:for(let e=0;e<m.length;++e){const n=m[e].morphTargetManager;if(null===n)continue;const r=n.numTargets;for(let o=0;o<r;++o)if(n.getTarget(o)===i){t=e;break e}}if(-1===t){this.warn(`morph ${n.name} has no target mesh. skipping`);continue}let a,s,l=0;if(n.type===bt.B.Morph.Type.VertexMorph){const e=m[t].geometry.getVerticesData(Xe.VertexBuffer.PositionKind),r=i.getPositions();if(null===r){this.warn(`morph ${n.name} has no positions data. skipping`);continue}if(e.length!==r.length){this.warn(`morph ${n.name} has different number of positions. skipping`);continue}for(let t=0;t<e.length;t+=3)e[t+0]===r[t+0]&&e[t+1]===r[t+1]&&e[t+2]===r[t+2]||(l+=1);a=new Int32Array(l),s=new Float32Array(3*l);const o=e.length/3;for(let t=0,n=0;t<o;++t)e[3*t+0]===r[3*t+0]&&e[3*t+1]===r[3*t+1]&&e[3*t+2]===r[3*t+2]||(a[n]=t,s[3*n+0]=r[3*t+0]-e[3*t+0],s[3*n+1]=r[3*t+1]-e[3*t+1],s[3*n+2]=r[3*t+2]-e[3*t+2],n+=1)}else{const e=m[t].geometry.getVerticesData(Xe.VertexBuffer.UVKind),r=i.getUVs();if(null===r){this.warn(`morph ${n.name} has no uvs data. skipping`);continue}if(e.length!==r.length){this.warn(`morph ${n.name} has different number of uvs. skipping`);continue}for(let t=0;t<e.length;t+=2)e[t+0]===r[t+0]&&e[t+1]===r[t+1]||(l+=1);a=new Int32Array(l),s=new Float32Array(4*l);const o=e.length/2;for(let t=0,n=0;t<o;++t)e[2*t+0]===r[2*t+0]&&e[2*t+1]===r[2*t+1]||(a[n]=t,s[4*n+0]=r[2*t+0]-e[2*t+0],s[4*n+1]=r[2*t+1]-e[2*t+1],n+=1)}r.push({meshIndex:t,indices:a,offsets:s})}}}const w=new TextEncoder;let A=7;{const e=a.header;A+=4+w.encode(e.modelName).length,A+=4+w.encode(e.englishModelName).length,A+=4+w.encode(e.comment).length,A+=4+w.encode(e.englishComment).length,A+=1,A+=4;for(let e=0;e<m.length;++e){const t=m[e],n=t.geometry;A+=4+w.encode(t.name).length,A+=4;const i=t.material;if(void 0!==i?.subMaterials){const e=i.subMaterials;A+=4;for(let t=0;t<e.length;++t)A+=4,A+=4,A+=4,A+=4,A+=4}A+=4;const r=n.getVerticesData(Xe.VertexBuffer.PositionKind);A+=4*r.length;const o=r.length/3;if(A+=3*o*4,A+=2*o*4,A+=1,null!==n.getVerticesData(st.V.AdditionalUV1Kind)&&(A+=4*o*4),null!==n.getVerticesData(st.V.AdditionalUV2Kind)&&(A+=4*o*4),null!==n.getVerticesData(st.V.AdditionalUV3Kind)&&(A+=4*o*4),null!==n.getVerticesData(st.V.AdditionalUV4Kind)&&(A+=4*o*4),A+=1,!t.isUnIndexed){A+=1,A+=4;const e=n.getIndices();A+=Array.isArray(e)?4*e.length:e.byteLength}0!==l.length&&(null===n.getVerticesData(Xe.VertexBuffer.MatricesIndicesKind)&&this.warn(`mesh ${t.name} has no matricesIndices data. falling back to zero matricesIndices`),A+=4*o*4,null===n.getVerticesData(Xe.VertexBuffer.MatricesWeightsKind)&&this.warn(`mesh ${t.name} has no matricesWeights data. falling back to zero matricesWeights`),A+=4*o*4);const a=n.getVerticesData(st.V.MatricesSdefCKind),s=n.getVerticesData(st.V.MatricesSdefR0Kind),h=n.getVerticesData(st.V.MatricesSdefR1Kind);null!==a&&null!==s&&null!==h?(A+=3*o*4,A+=3*o*4,A+=3*o*4):null!==a&&null!==s&&null!==h||null===a&&null===s&&null===h||this.warn(`mesh ${t.name} has incomplete sdef data. sdefC, sdefR0, sdefR1 must be all defined or all undefined. falling back to linear blend skinning`),null!==n.getVerticesData(st.V.EdgeScaleKind)&&(A+=4*o)}A+=4;for(let e=0;e<_.length;++e){const t=_[e];A+=4+w.encode(t.relativePath).length,A+=1,void 0!==t.mimeType&&(A+=4+w.encode(t.mimeType).length),A+=4,A+=t.buffer.byteLength}A+=4;for(let e=0;e<g.length;++e)A+=6;A+=4;for(let e=0;e<f.length;++e){const t=f[e];A+=4+w.encode(t.name).length,A+=4+w.encode(t.englishName).length,A+=16,A+=12,A+=4,A+=12,A+=1,A+=1,A+=16,A+=4,A+=4,A+=4,A+=1,A+=1,A+=4,A+=4+w.encode(t.comment).length}if(0!==l.length){A+=4,s||this.warn("metadata.bones has following missing properties: tailPosition, axisLimit, localVector, externalParentTransform. lossy conversion will be applied");for(let e=0;e<l.length;++e){const t=l[e];if(A+=4+w.encode(t.name).length,A+=4+w.encode(t.englishName).length,A+=12,A+=4,A+=4,A+=2,s?"number"==typeof t.tailPosition?A+=4:A+=12:A+=4,void 0!==t.appendTransform&&(A+=4,A+=4),void 0!==t.axisLimit&&(A+=12),void 0!==t.localVector&&(A+=12,A+=12),void 0!==t.externalParentTransform&&(A+=4),void 0!==t.ik){A+=4,A+=4,A+=4,A+=4;const e=t.ik.links;for(let t=0;t<e.length;++t)A+=4,A+=1,void 0!==e[t].limitation&&(A+=12,A+=12)}}}A+=4;const t=a.morphs;for(let e=0;e<t.length;++e){const n=t[e];switch(A+=4+w.encode(n.name).length,A+=4+w.encode(n.englishName).length,A+=1,A+=1,n.type){case bt.B.Morph.Type.GroupMorph:A+=4+8*n.indices.length;break;case bt.B.Morph.Type.VertexMorph:{A+=4;const t=y[e];for(let e=0;e<t.length;++e){const n=t[e];A+=8+4*n.indices.length+4*n.offsets.length}}break;case bt.B.Morph.Type.BoneMorph:A+=4+32*n.indices.length;break;case bt.B.Morph.Type.UvMorph:case bt.B.Morph.Type.AdditionalUvMorph1:case bt.B.Morph.Type.AdditionalUvMorph2:case bt.B.Morph.Type.AdditionalUvMorph3:case bt.B.Morph.Type.AdditionalUvMorph4:{A+=4;const t=y[e];for(let e=0;e<t.length;++e){const n=t[e];A+=8+4*n.indices.length+4*n.offsets.length}}break;case bt.B.Morph.Type.MaterialMorph:A+=4+117*n.elements.length}}if(A+=4,s&&null!==a.displayFrames){const e=a.displayFrames;for(let t=0;t<e.length;++t){const n=e[t];A+=4+w.encode(n.name).length,A+=4+w.encode(n.englishName).length,A+=1,A+=4,A+=5*n.frames.length}}A+=4;const n=a.rigidBodies;for(let e=0;e<n.length;++e){const t=n[e];A+=4+w.encode(t.name).length,A+=4+w.encode(t.englishName).length,A+=4,A+=1,A+=2,A+=1,A+=12,A+=12,A+=12,A+=4,A+=4,A+=4,A+=4,A+=4,A+=1}A+=4;const i=a.joints;for(let e=0;e<i.length;++e){const t=i[e];A+=4+w.encode(t.name).length,A+=4+w.encode(t.englishName).length,A+=1,A+=4,A+=4,A+=12,A+=12,A+=12,A+=12,A+=12,A+=12,A+=12,A+=12}}const M=new ArrayBuffer(A),T=new En(M);T.setUint8Array(w.encode("BPMX")),T.setInt8Array([2,2,1]);{const e=a.header;T.setString(e.modelName),T.setString(e.englishModelName),T.setString(e.comment),T.setString(e.englishComment)}const x=0!==l.length?Pn.h.Geometry.MeshType.IsSkinnedMesh:0;T.setUint8(x),T.setUint32(m.length);for(let e=0;e<m.length;++e){const t=m[e],n=t.geometry;T.setString(t.name);let i=!1;if(1<t.subMeshes.length||0===t.subMeshes.length)i=!0;else{const e=t.subMeshes[0];0===e.materialIndex&&0===e.verticesStart&&e.verticesCount===n.getTotalVertices()&&0===e.indexStart&&e.indexCount===n.getTotalIndices()||(i=!0)}if(i){T.setInt32(-2);const e=t.subMeshes;T.setUint32(e.length);const n=t.material?.subMaterials??[t.material];for(let t=0;t<e.length;++t){const i=e[t],r=n[i.materialIndex]??null,o=f.findIndex((e=>e.linkedMaterial===r));T.setInt32(o),T.setUint32(i.verticesStart),T.setUint32(i.verticesCount),T.setUint32(i.indexStart),T.setUint32(i.indexCount)}}else{const e=t.material,n=f.findIndex((t=>t.linkedMaterial===e));T.setInt32(n)}const r=n.getVerticesData(Xe.VertexBuffer.PositionKind),o=r.length/3;T.setUint32(o),T.setFloat32Array(r);let a=n.getVerticesData(Xe.VertexBuffer.NormalKind);if(a.length!==3*o){this.warn(`mesh ${t.name} normals vertex count is different from positions vertex count`);const e=new Float32Array(3*o);e.set(a),a=e}T.setFloat32Array(a);let s=n.getVerticesData(Xe.VertexBuffer.UVKind);if(s.length!==2*o){this.warn(`mesh ${t.name} uv vertex count is different from positions vertex count`);const e=new Float32Array(2*o);e.set(s),s=e}T.setFloat32Array(s);const h=[];{const e=n.getVerticesData(st.V.AdditionalUV1Kind);null!==e&&h.push(e);const t=n.getVerticesData(st.V.AdditionalUV2Kind);null!==t&&h.push(t);const i=n.getVerticesData(st.V.AdditionalUV3Kind);null!==i&&h.push(i);const r=n.getVerticesData(st.V.AdditionalUV4Kind);null!==r&&h.push(r)}T.setUint8(h.length);for(let e=0;e<h.length;++e){const n=h[e];if(n.length!==4*o){this.warn(`mesh ${t.name} additional uv vertex count is different from positions vertex count`);const i=new Float32Array(4*o);i.set(n),h[e]=i}T.setFloat32Array(n)}let d=n.getVerticesData(st.V.MatricesSdefCKind),c=n.getVerticesData(st.V.MatricesSdefR0Kind),p=n.getVerticesData(st.V.MatricesSdefR1Kind);const _=null!==d&&null!==c&&null!==p;let g=n.getVerticesData(st.V.EdgeScaleKind);const b=(_?Pn.h.Geometry.GeometryType.HasSdef:0)|(t.isUnIndexed?0:Pn.h.Geometry.GeometryType.IsIndexed)|(null!==g?Pn.h.Geometry.GeometryType.HasEdgeScale:0);if(T.setUint8(b),!t.isUnIndexed){const e=n.getIndices();T.setUint8(e instanceof Uint32Array?Pn.h.Geometry.IndexElementType.Uint32:e instanceof Uint16Array?Pn.h.Geometry.IndexElementType.Uint16:Pn.h.Geometry.IndexElementType.Int32),T.setUint32(e.length),e instanceof Uint16Array?T.setUint16Array(e):e instanceof Uint32Array?T.setUint32Array(e):T.setInt32Array(e)}if(0!==l.length){const e=new Float32Array(4*o);{const i=n.getVerticesData(Xe.VertexBuffer.MatricesIndicesKind);if(null!==i&&i.length===4*o||this.warn(`mesh ${t.name} bone indices vertex count is different from positions vertex count`),null!==i)for(let t=0;t<e.length;++t)e[t]=u[i[t]]??i[t]}T.setFloat32Array(e);let i=n.getVerticesData(Xe.VertexBuffer.MatricesWeightsKind);if(null===i&&(i=new Float32Array(4*o)),i.length!==4*o){this.warn(`mesh ${t.name} bone weights vertex count is different from positions vertex count`);const e=new Float32Array(4*o);e.set(i),i=e}if(T.setFloat32Array(i),_){if(d.length!==3*o){this.warn(`mesh ${t.name} sdefC vertex count is different from positions vertex count`);const e=new Float32Array(3*o);e.set(d),d=e}if(c.length!==3*o){this.warn(`mesh ${t.name} sdefR0 vertex count is different from positions vertex count`);const e=new Float32Array(3*o);e.set(c),c=e}if(p.length!==3*o){this.warn(`mesh ${t.name} sdefR1 vertex count is different from positions vertex count`);const e=new Float32Array(3*o);e.set(p),p=e}T.setFloat32Array(d),T.setFloat32Array(c),T.setFloat32Array(p)}}if(null!==g){if(g.length!==o){this.warn(`mesh ${t.name} edgeScale vertex count is different from positions vertex count`);const e=new Float32Array(o);e.set(g),g=e}T.setFloat32Array(g)}}T.setUint32(_.length);for(let e=0;e<_.length;++e){const t=_[e];T.setString(t.relativePath);const n=void 0!==t.mimeType?Pn.h.Image.Flag.HasMimeType:0;T.setUint8(n),void 0!==t.mimeType&&T.setString(t.mimeType),T.setUint32(t.buffer.byteLength),T.setUint8Array(t.buffer)}T.setUint32(g.length);for(let e=0;e<g.length;++e){const t=g[e];T.setUint8(t.flag),T.setUint8(t.samplingMode),T.setInt32(t.imageIndex)}T.setUint32(f.length);for(let e=0;e<f.length;++e){const t=f[e];T.setString(t.name),T.setString(t.englishName),T.setFloat32Array(t.diffuse),T.setFloat32Array(t.specular),T.setFloat32(t.shininess),T.setFloat32Array(t.ambient),T.setUint8(t.evaluatedTransparency),T.setUint8(t.flag),T.setFloat32Array(t.edgeColor),T.setFloat32(t.edgeSize),T.setInt32(t.textureIndex),T.setInt32(t.sphereTextureIndex),T.setUint8(t.sphereTextureMode),T.setUint8(t.isSharedToonTexture?1:0),T.setInt32(t.toonTextureIndex),T.setString(t.comment)}if(0!==l.length){T.setUint32(l.length);for(let e=0;e<l.length;++e){const t=l[e];if(T.setString(t.name),T.setString(t.englishName),T.setFloat32Array(t.position),T.setInt32(t.parentBoneIndex),T.setInt32(t.transformOrder),T.setUint16(t.flag),"number"==typeof t.tailPosition?T.setInt32(t.tailPosition):T.setFloat32Array(t.tailPosition),void 0!==t.appendTransform&&(T.setInt32(t.appendTransform.parentIndex),T.setFloat32(t.appendTransform.ratio)),void 0!==t.axisLimit&&T.setFloat32Array(t.axisLimit),void 0!==t.localVector&&(T.setFloat32Array(t.localVector.x),T.setFloat32Array(t.localVector.z)),void 0!==t.externalParentTransform&&T.setInt32(t.externalParentTransform),void 0!==t.ik){const e=t.ik;T.setInt32(e.target),T.setInt32(e.iteration),T.setFloat32(e.rotationConstraint);const n=e.links;T.setInt32(n.length);for(let e=0;e<n.length;++e){const t=n[e];T.setInt32(t.target),T.setUint8(void 0!==t.limitation?1:0),void 0!==t.limitation&&(T.setFloat32Array(t.limitation.minimumAngle),T.setFloat32Array(t.limitation.maximumAngle))}}}}T.setUint32(a.morphs.length);const v=a.morphs;for(let e=0;e<v.length;++e){const t=v[e];switch(T.setString(t.name),T.setString(t.englishName),T.setUint8(t.category),T.setUint8(t.type),t.type){case bt.B.Morph.Type.GroupMorph:{T.setUint32(t.indices.length),T.setInt32Array(t.indices);let e=t.ratios;if(e.length!==t.indices.length){this.warn(`morph ${t.name} group morph ratio count is different from indices count`);const n=new Float32Array(t.indices.length);n.set(e),e=n}T.setFloat32Array(e)}break;case bt.B.Morph.Type.VertexMorph:case bt.B.Morph.Type.UvMorph:case bt.B.Morph.Type.AdditionalUvMorph1:case bt.B.Morph.Type.AdditionalUvMorph2:case bt.B.Morph.Type.AdditionalUvMorph3:case bt.B.Morph.Type.AdditionalUvMorph4:{const n=y[e];T.setUint32(n.length);for(let e=0;e<n.length;++e){const i=n[e];T.setUint32(i.meshIndex),T.setUint32(i.indices.length),T.setInt32Array(i.indices);let r=i.offsets;const o=t.type===bt.B.Morph.Type.VertexMorph?3:4;if(r.length!==i.indices.length*o){this.warn(`morph ${t.name} vertex/uv morph offset count is different from indices count`);const e=new Float32Array(i.indices.length*o);e.set(r),r=e}T.setFloat32Array(r)}}break;case bt.B.Morph.Type.BoneMorph:{const e=new Int32Array(t.indices.length);{const n=t.indices;for(let t=0;t<n.length;++t)e[t]=h[n[t]]??n[t]}T.setUint32(e.length),T.setInt32Array(e);let n=t.positions;if(n.length!==3*e.length){this.warn(`morph ${t.name} bone morph position count is different from indices count`);const i=new Float32Array(3*e.length);i.set(n),n=i}T.setFloat32Array(n);let i=t.rotations;if(i.length!==4*e.length){this.warn(`morph ${t.name} bone morph rotation count is different from indices count`);const n=new Float32Array(4*e.length);n.set(i),i=n}T.setFloat32Array(i)}break;case bt.B.Morph.Type.MaterialMorph:{T.setUint32(t.elements.length);const e=t.elements;for(let t=0;t<e.length;++t){const n=e[t],i=b.get(n.index)??n.index;T.setInt32(i),T.setUint8(n.type),T.setFloat32Array(n.diffuse),T.setFloat32Array(n.specular),T.setFloat32(n.shininess),T.setFloat32Array(n.ambient),T.setFloat32Array(n.edgeColor),T.setFloat32(n.edgeSize),T.setFloat32Array(n.textureColor),T.setFloat32Array(n.sphereTextureColor),T.setFloat32Array(n.toonTextureColor)}}break;default:T.setUint32(0)}}if(s&&null!==a.displayFrames){T.setUint32(a.displayFrames.length);const e=a.displayFrames;for(let t=0;t<e.length;++t){const n=e[t];T.setString(n.name),T.setString(n.englishName),T.setUint8(n.isSpecialFrame?1:0),T.setUint32(n.frames.length);const i=n.frames;for(let e=0;e<i.length;++e){const t=i[e];T.setUint8(t.type);const n=t.type===bt.B.DisplayFrame.FrameData.FrameType.Bone?h[t.index]??t.index:t.index;T.setInt32(n)}}}else T.setUint32(0);T.setUint32(a.rigidBodies.length);const I=a.rigidBodies;for(let e=0;e<I.length;++e){const t=I[e];T.setString(t.name),T.setString(t.englishName),T.setInt32(h[t.boneIndex]??t.boneIndex),T.setUint8(t.collisionGroup),T.setUint16(t.collisionMask),T.setUint8(t.shapeType),T.setFloat32Array(t.shapeSize),T.setFloat32Array(t.shapePosition),T.setFloat32Array(t.shapeRotation),T.setFloat32(t.mass),T.setFloat32(t.linearDamping),T.setFloat32(t.angularDamping),T.setFloat32(t.repulsion),T.setFloat32(t.friction),T.setUint8(t.physicsMode)}T.setUint32(a.joints.length);const B=a.joints;for(let e=0;e<B.length;++e){const t=B[e];T.setString(t.name),T.setString(t.englishName),T.setUint8(t.type),T.setInt32(t.rigidbodyIndexA),T.setInt32(t.rigidbodyIndexB),T.setFloat32Array(t.position),T.setFloat32Array(t.rotation),T.setFloat32Array(t.positionMin),T.setFloat32Array(t.positionMax),T.setFloat32Array(t.rotationMin),T.setFloat32Array(t.rotationMax),T.setFloat32Array(t.springPosition),T.setFloat32Array(t.springRotation)}return 0!==T.bytesAvailable&&this.error(`unexpected bytes available: ${T.bytesAvailable}`),M}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){Rn.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){Rn.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){Rn.Logger.Error(e)}_errorDisabled(){}}var On=We(4870);class kn{constructor(){}static Convert(e){const t=new TextEncoder;let n=7;{n+=4;const i=e.boneTracks.length;for(let r=0;r<i;++r){const i=e.boneTracks[r];n+=4+t.encode(i.name).length,n+=4,n+=4*i.frameNumbers.length+En.Padding(n,4),n+=16*i.frameNumbers.length+En.Padding(n,4),n+=4*i.frameNumbers.length}n+=4;const r=e.movableBoneTracks.length;for(let i=0;i<r;++i){const r=e.movableBoneTracks[i];n+=4+t.encode(r.name).length,n+=4,n+=4*r.frameNumbers.length+En.Padding(n,4),n+=12*r.frameNumbers.length+En.Padding(n,4),n+=12*r.frameNumbers.length,n+=16*r.frameNumbers.length+En.Padding(n,4),n+=4*r.frameNumbers.length}n+=4;const o=e.morphTracks.length;for(let i=0;i<o;++i){const r=e.morphTracks[i];n+=4+t.encode(r.name).length,n+=4,n+=4*r.frameNumbers.length+En.Padding(n,4),n+=4*r.frameNumbers.length+En.Padding(n,4)}n+=4,n+=4*e.propertyTrack.frameNumbers.length+En.Padding(n,4),n+=1*e.propertyTrack.frameNumbers.length+En.Padding(n,4),n+=4;const a=e.propertyTrack.ikBoneNames.length;for(let i=0;i<a;++i){const r=e.propertyTrack.ikBoneNames[i];n+=4+t.encode(r).length}n+=1*a*e.propertyTrack.frameNumbers.length,n+=4,n+=4*e.cameraTrack.frameNumbers.length+En.Padding(n,4),n+=12*e.cameraTrack.frameNumbers.length+En.Padding(n,4),n+=12*e.cameraTrack.frameNumbers.length,n+=12*e.cameraTrack.frameNumbers.length+En.Padding(n,4),n+=4*e.cameraTrack.frameNumbers.length,n+=4*e.cameraTrack.frameNumbers.length+En.Padding(n,4),n+=4*e.cameraTrack.frameNumbers.length,n+=4*e.cameraTrack.frameNumbers.length+En.Padding(n,4),n+=4*e.cameraTrack.frameNumbers.length}const i=new ArrayBuffer(n),r=new En(i);r.setUint8Array(t.encode("BVMD")),r.setInt8Array([2,0,0]);const o=e.boneTracks;r.setUint32(o.length);for(let e=0;e<o.length;++e){const t=o[e];r.setString(t.name),r.setUint32(t.frameNumbers.length),r.offset+=En.Padding(r.offset,4),r.setUint32Array(t.frameNumbers),r.offset+=En.Padding(r.offset,4),r.setFloat32Array(t.rotations),r.setUint8Array(t.rotationInterpolations)}const a=e.movableBoneTracks;r.setUint32(a.length);for(let e=0;e<a.length;++e){const t=a[e];r.setString(t.name),r.setUint32(t.frameNumbers.length),r.offset+=En.Padding(r.offset,4),r.setUint32Array(t.frameNumbers),r.offset+=En.Padding(r.offset,4),r.setFloat32Array(t.positions),r.setUint8Array(t.positionInterpolations),r.offset+=En.Padding(r.offset,4),r.setFloat32Array(t.rotations),r.setUint8Array(t.rotationInterpolations)}const s=e.morphTracks;r.setUint32(s.length);for(let e=0;e<s.length;++e){const t=s[e];r.setString(t.name),r.setUint32(t.frameNumbers.length),r.offset+=En.Padding(r.offset,4),r.setUint32Array(t.frameNumbers),r.offset+=En.Padding(r.offset,4),r.setFloat32Array(t.weights)}r.setUint32(e.propertyTrack.frameNumbers.length),r.setUint32(e.propertyTrack.ikBoneNames.length),r.offset+=En.Padding(r.offset,4),r.setUint32Array(e.propertyTrack.frameNumbers),r.setUint8Array(e.propertyTrack.visibles);const l=e.propertyTrack.ikBoneNames;for(let t=0;t<l.length;++t){const n=l[t];r.setString(n),r.setUint8Array(e.propertyTrack.getIkState(t))}return r.setUint32(e.cameraTrack.frameNumbers.length),r.offset+=En.Padding(r.offset,4),r.setUint32Array(e.cameraTrack.frameNumbers),r.offset+=En.Padding(r.offset,4),r.setFloat32Array(e.cameraTrack.positions),r.setUint8Array(e.cameraTrack.positionInterpolations),r.offset+=En.Padding(r.offset,4),r.setFloat32Array(e.cameraTrack.rotations),r.setUint8Array(e.cameraTrack.rotationInterpolations),r.offset+=En.Padding(r.offset,4),r.setFloat32Array(e.cameraTrack.distances),r.setUint8Array(e.cameraTrack.distanceInterpolations),r.offset+=En.Padding(r.offset,4),r.setFloat32Array(e.cameraTrack.fovs),r.setUint8Array(e.cameraTrack.fovInterpolations),i}}var Fn=We(4232),Nn=We(5297);class Dn{_scene;_loggingEnabled;log;warn;error;constructor(e){this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._scene=e}loadFromBuffer(e,t){const n=new Nn.u(t);if(n.initializeTextDecoder("utf-8"),"BVMD"!==n.getDecoderString(4,!1))throw new Fn.LoadFileError("BVMD signature is not valid.");const i=[n.getInt8(),n.getInt8(),n.getInt8()];if(2!==i[0]||0!==i[1]||0!==i[2])throw new Fn.LoadFileError(`BVMD version ${i[0]}.${i[1]}.${i[2]} is not supported.`);const r=n.getUint32(),o=new Array(r);for(let e=0;e<r;++e){const i=n.getDecoderString(n.getUint32(),!0),r=n.getUint32(),a=n.getPaddedArrayOffset(4,r),s=n.getPaddedArrayOffset(4,4*r),l=n.getPaddedArrayOffset(1,4*r),h=o[e]=new Xt(i,r,t,a,s,l);n.isDeviceLittleEndian||(n.swap32Array(h.frameNumbers),n.swap32Array(h.rotations))}const a=n.getUint32(),s=new Array(a);for(let e=0;e<a;++e){const i=n.getDecoderString(n.getUint32(),!0),r=n.getUint32(),o=n.getPaddedArrayOffset(4,r),a=n.getPaddedArrayOffset(4,3*r),l=n.getPaddedArrayOffset(1,12*r),h=n.getPaddedArrayOffset(4,4*r),d=n.getPaddedArrayOffset(1,4*r),c=s[e]=new Jt(i,r,t,o,a,l,h,d);n.isDeviceLittleEndian||(n.swap32Array(c.frameNumbers),n.swap32Array(c.positions),n.swap32Array(c.rotations))}const l=n.getUint32(),h=new Array(l);for(let e=0;e<l;++e){const i=n.getDecoderString(n.getUint32(),!0),r=n.getUint32(),o=n.getPaddedArrayOffset(4,r),a=n.getPaddedArrayOffset(4,r),s=h[e]=new Zt(i,r,t,o,a);n.isDeviceLittleEndian||(n.swap32Array(s.frameNumbers),n.swap32Array(s.weights))}const d=n.getUint32(),c=n.getUint32(),u=n.getPaddedArrayOffset(4,d),m=n.getPaddedArrayOffset(1,d),p=new Array(c),_=new Array(c);for(let e=0;e<c;++e)p[e]=n.getDecoderString(n.getUint32(),!0),_[e]=n.getPaddedArrayOffset(1,d);const g=new tn(d,p,t,u,m,_);n.isDeviceLittleEndian||n.swap32Array(g.frameNumbers);const f=n.getUint32(),b=n.getPaddedArrayOffset(4,f),y=n.getPaddedArrayOffset(4,3*f),w=n.getPaddedArrayOffset(1,12*f),A=n.getPaddedArrayOffset(4,3*f),M=n.getPaddedArrayOffset(1,4*f),T=n.getPaddedArrayOffset(4,f),x=n.getPaddedArrayOffset(1,4*f),v=n.getPaddedArrayOffset(4,f),I=n.getPaddedArrayOffset(1,4*f),B=new en(f,t,b,y,w,A,M,T,x,v,I);return n.isDeviceLittleEndian||(n.swap32Array(B.frameNumbers),n.swap32Array(B.positions),n.swap32Array(B.rotations),n.swap32Array(B.distances),n.swap32Array(B.fovs)),new vn(e,o,s,h,g,B)}load(e,t,n,i,r){return this._scene._loadFile(t,((t,i)=>{try{n(this.loadFromBuffer(e,t))}catch(e){r?.(void 0,e)}}),i,!0,!0,r)}loadAsync(e,t,n){return new Promise(((i,r)=>{this.load(e,t,i,n,((e,t)=>r({request:e,exception:t})))}))}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){Rn.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){Rn.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){Rn.Logger.Error(e)}_errorDisabled(){}}var Ln=We(1599),Un=We(1433),Vn=We(9722);class Wn{static _Signature="Vocaloid Motion Data 0002";static SignatureBytes=30;static ModelNameBytes=20;static BoneKeyFrameBytes=111;static MorphKeyFrameBytes=23;static CameraKeyFrameBytes=61;static LightKeyFrameBytes=28;static SelfShadowKeyFrameBytes=9;static PropertyKeyFrameBytes=5;static PropertyKeyFrameIkStateBytes=21;dataDeserializer;boneKeyFrameCount;morphKeyFrameCount;cameraKeyFrameCount;lightKeyFrameCount;selfShadowKeyFrameCount;propertyKeyFrameCount;constructor(e,t,n,i,r,o,a){this.dataDeserializer=e,this.boneKeyFrameCount=t,this.morphKeyFrameCount=n,this.cameraKeyFrameCount=i,this.lightKeyFrameCount=r,this.selfShadowKeyFrameCount=o,this.propertyKeyFrameCount=a}static CheckedCreate(e,t=new Ln.C){const n=new Nn.u(e);if(n.initializeTextDecoder("shift-jis"),n.bytesAvailable<Wn.SignatureBytes+Wn.ModelNameBytes)return null;if(n.getSignatureString(this.SignatureBytes).substring(0,this._Signature.length)!==this._Signature)return null;n.offset+=Wn.ModelNameBytes;let i=0,r=0,o=0,a=0,s=0,l=0;if(n.bytesAvailable<4)return null;if(i=n.getUint32(),n.bytesAvailable<i*Wn.BoneKeyFrameBytes)return null;if(n.offset+=i*Wn.BoneKeyFrameBytes,n.bytesAvailable<4)return null;if(r=n.getUint32(),n.bytesAvailable<r*Wn.MorphKeyFrameBytes)return null;if(n.offset+=r*Wn.MorphKeyFrameBytes,0!==n.bytesAvailable){if(n.bytesAvailable<4)return null;if(o=n.getUint32(),n.bytesAvailable<o*Wn.CameraKeyFrameBytes)return null;if(n.offset+=o*Wn.CameraKeyFrameBytes,n.bytesAvailable<4)return null;if(a=n.getUint32(),n.bytesAvailable<a*Wn.LightKeyFrameBytes)return null;n.offset+=a*Wn.LightKeyFrameBytes}if(0!==n.bytesAvailable){if(n.bytesAvailable<4)return null;if(s=n.getUint32(),n.bytesAvailable<s*Wn.SelfShadowKeyFrameBytes)return null;n.offset+=s*Wn.SelfShadowKeyFrameBytes}if(0!==n.bytesAvailable){if(n.bytesAvailable<4)return null;l=n.getUint32();for(let e=0;e<l;++e){if(n.bytesAvailable<Wn.PropertyKeyFrameBytes)return null;if(n.offset+=Wn.PropertyKeyFrameBytes,n.bytesAvailable<4)return null;const e=n.getUint32();if(n.bytesAvailable<e*Wn.PropertyKeyFrameIkStateBytes)return null;n.offset+=e*Wn.PropertyKeyFrameIkStateBytes}}return n.bytesAvailable>0&&t.warn(`There are ${n.bytesAvailable} bytes left after parsing`),n.offset=0,new Wn(n,i,r,o,a,s,l)}}class zn{propertyKeyFrames;_vmdData;constructor(e,t){this._vmdData=e,this.propertyKeyFrames=t}static Parse(e){const t=e.dataDeserializer,n=[];t.offset=Wn.SignatureBytes+Wn.ModelNameBytes+4+e.boneKeyFrameCount*Wn.BoneKeyFrameBytes+4+e.morphKeyFrameCount*Wn.MorphKeyFrameBytes+4+e.cameraKeyFrameCount*Wn.CameraKeyFrameBytes+4+e.lightKeyFrameCount*Wn.LightKeyFrameBytes+4+e.selfShadowKeyFrameCount*Wn.SelfShadowKeyFrameBytes+4;const i=e.propertyKeyFrameCount;for(let e=0;e<i;++e){const e=t.getUint32(),i=0!==t.getUint8(),r=t.getUint32(),o=[];for(let e=0;e<r;++e){const e=t.getDecoderString(20,!0),n=0!==t.getUint8();o.push([e,n])}const a={frameNumber:e,visible:i,ikStates:o};n.push(a)}return new zn(e,n)}static ParseFromBuffer(e){const t=Wn.CheckedCreate(e);if(null===t)throw new Error("Invalid VMD data");return zn.Parse(t)}get boneKeyFrames(){const e=Wn.SignatureBytes+Wn.ModelNameBytes+4;return new zn.BoneKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.boneKeyFrameCount)}get morphKeyFrames(){const e=Wn.SignatureBytes+Wn.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*Wn.BoneKeyFrameBytes+4;return new zn.MorphKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.morphKeyFrameCount)}get cameraKeyFrames(){const e=Wn.SignatureBytes+Wn.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*Wn.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*Wn.MorphKeyFrameBytes+4;return new zn.CameraKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.cameraKeyFrameCount)}get lightKeyFrames(){const e=Wn.SignatureBytes+Wn.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*Wn.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*Wn.MorphKeyFrameBytes+4+this._vmdData.cameraKeyFrameCount*Wn.CameraKeyFrameBytes+4;return new zn.LightKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.lightKeyFrameCount)}get selfShadowKeyFrames(){const e=Wn.SignatureBytes+Wn.ModelNameBytes+4+this._vmdData.boneKeyFrameCount*Wn.BoneKeyFrameBytes+4+this._vmdData.morphKeyFrameCount*Wn.MorphKeyFrameBytes+4+this._vmdData.cameraKeyFrameCount*Wn.CameraKeyFrameBytes+4+this._vmdData.lightKeyFrameCount*Wn.LightKeyFrameBytes+4;return new zn.SelfShadowKeyFrames(this._vmdData.dataDeserializer,e,this._vmdData.selfShadowKeyFrameCount)}}!function(e){class t{_dataDeserializer;_startOffset;_length;constructor(e,t,n){this._dataDeserializer=e,this._startOffset=t,this._length=n}get length(){return this._length}}e.BufferArrayReader=t,e.BoneKeyFrames=class extends t{constructor(e,t,n){super(e,t,n)}get(e){const t=this._startOffset+e*Wn.BoneKeyFrameBytes;return new n(this._dataDeserializer,t)}};class n{boneName;frameNumber;position;rotation;interpolation;constructor(e,t){e.offset=t,this.boneName=e.getDecoderString(15,!0),this.frameNumber=e.getUint32(),this.position=e.getFloat32Tuple(3),this.rotation=e.getFloat32Tuple(4),this.interpolation=new Uint8Array(64);for(let t=0;t<64;++t)this.interpolation[t]=e.getUint8()}}e.BoneKeyFrame=n,e.MorphKeyFrames=class extends t{constructor(e,t,n){super(e,t,n)}get(e){const t=this._startOffset+e*Wn.MorphKeyFrameBytes;return new i(this._dataDeserializer,t)}};class i{morphName;frameNumber;weight;constructor(e,t){e.offset=t,this.morphName=e.getDecoderString(15,!0),this.frameNumber=e.getUint32(),this.weight=e.getFloat32()}}e.MorphKeyFrame=i,e.CameraKeyFrames=class extends t{constructor(e,t,n){super(e,t,n)}get(e){const t=this._startOffset+e*Wn.CameraKeyFrameBytes;return new r(this._dataDeserializer,t)}};class r{frameNumber;distance;position;rotation;interpolation;fov;perspective;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.distance=e.getFloat32(),this.position=e.getFloat32Tuple(3),this.rotation=e.getFloat32Tuple(3),this.interpolation=new Uint8Array(24);for(let t=0;t<24;++t)this.interpolation[t]=e.getUint8();this.fov=e.getUint32(),this.perspective=0!==e.getUint8()}}e.CameraKeyFrame=r,e.LightKeyFrames=class extends t{constructor(e,t,n){super(e,t,n)}get(e){const t=this._startOffset+e*Wn.LightKeyFrameBytes;return new o(this._dataDeserializer,t)}};class o{frameNumber;color;direction;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.color=e.getFloat32Tuple(3),this.direction=e.getFloat32Tuple(3)}}e.LightKeyFrame=o,e.SelfShadowKeyFrames=class extends t{constructor(e,t,n){super(e,t,n)}get(e){const t=this._startOffset+e*Wn.SelfShadowKeyFrameBytes;return new a(this._dataDeserializer,t)}};class a{frameNumber;mode;distance;constructor(e,t){e.offset=t,this.frameNumber=e.getUint32(),this.mode=e.getUint8(),this.distance=e.getFloat32()}}e.SelfShadowKeyFrame=a}(zn||(zn={}));class jn{static _Signature="Vocaloid Pose Data file";constructor(){}static Parse(e,t=new Ln.C){if(!e.startsWith(jn._Signature))throw new Error("VPD signature is not valid.");const n=[jn._Signature.length];jn._ConsumeStatement(e,n),jn._ConsumeStatement(e,n);const i={},r={};for(;n[0]<e.length&&(n[0]=jn._ConsumeEmpty(e,n[0]),!(e.length<=n[0]));){const o=jn._ConsumeBeforeOpenBracket(e,n);if(o.startsWith("Bone")){const r=jn._ConsumeBeforeLineEnding(e,n);let o,a;const s=jn._ConsumeStatement(e,n),l=s.split(",");if(3!==l.length)t.warn(`Position components are not 3: ${s}`);else{const e=Number(l[0]),n=Number(l[1]),i=Number(l[2]);isNaN(e)||isNaN(n)||isNaN(e)?t.warn(`Invalid position: ${s}`):0===e&&0===n&&0===i||(o=[e,n,i])}const h=jn._ConsumeStatement(e,n),d=h.split(",");if(4!==d.length)t.warn(`Rotation components are not 4: ${h}`);else{const e=Number(d[0]),n=Number(d[1]),i=Number(d[2]),r=Number(d[3]);isNaN(e)||isNaN(n)||isNaN(e)||isNaN(r)?t.warn(`Invalid rotation: ${h}`):a=[e,n,i,r]}void 0!==a&&(void 0!==i[r]&&t.warn(`Duplicate bone: ${r}. Use the last one.`),i[r]={position:o,rotation:a})}else if(o.startsWith("Morph")){const i=jn._ConsumeBeforeLineEnding(e,n),o=jn._ConsumeStatement(e,n),a=Number(o);isNaN(a)?t.warn(`Invalid weight: ${o}`):(void 0!==r[i]&&t.warn(`Duplicate morph: ${i}. Use the last one.`),r[i]=a)}else t.warn(`Unknown type: ${o}`);n[0]=jn._ConsumeWhileCloseBracket(e,n[0])}return{bones:i,morphs:r}}static _ConsumeWhiteSpace(e,t){for(;t<e.length&&(" "===e[t]||"\t"===e[t]||"\r"===e[t]||"\n"===e[t]);)t+=1;return t}static _ConsumeLine(e,t){for(;t<e.length;){if("\r"===e[t]||"\n"===e[t]){t+=1;break}t+=1}return"\r"===e[t-1]&&"\n"===e[t]&&(t+=1),t}static _ConsumeEmpty(e,t){let n=t;for(;t<e.length&&(n=t,"/"===e[t=jn._ConsumeWhiteSpace(e,t)]&&"/"===e[t+1]&&(t=jn._ConsumeLine(e,t)),n!==t););return t}static _ConsumeWhileCloseBracket(e,t){for(;t<e.length;){if("}"===e[t]){t+=1;break}t+=1}return t}static _ConsumeStatement(e,t){let n=t[0],i="";for(;;)if(n=jn._ConsumeWhiteSpace(e,n),"/"!==e[n]||"/"!==e[n+1]){if(e.length<=n)break;if(";"===e[n]){n+=1;break}i+=e[n],n+=1}else n=jn._ConsumeLine(e,n);return t[0]=n,i}static _ConsumeBeforeLineEnding(e,t){const n=t[0];let i=t[0];for(;i<e.length&&"\r"!==e[i]&&"\n"!==e[i];)i+=1;return t[0]=i,e.substring(n,i)}static _ConsumeBeforeOpenBracket(e,t){let n=t[0],i="";for(;n<e.length;){if("{"===e[n]){n+=1;break}i+=e[n],n+=1}return t[0]=n,i}}function qn(e,t,n){if(void 0===t[e.targetProperty])return void n?.warn(`Wrong target property ${e.targetProperty} for ${e.name} ${t.name}`);const i="rotationQuaternion"===e.targetProperty?rt.Quaternion.FromRotationMatrix(t.getRestMatrix()):"position"===e.targetProperty?t.getRestMatrix().getTranslation():void 0;if(void 0===i)return void n?.warn(`Failed to get rest pose for ${e.name} ${e.targetProperty}`);const r=e.getKeys();switch(e.dataType){case It.Animation.ANIMATIONTYPE_QUATERNION:{const e=i.clone().invertInPlace();for(let t=0;t<r.length;++t)e.multiplyToRef(r[t].value,r[t].value);break}case It.Animation.ANIMATIONTYPE_VECTOR3:for(let e=0;e<r.length;++e)r[e].value.subtractInPlace(i);break;default:n?.warn("Animation data type is not supported")}}function Kn(e){const t=new It.Animation(e.name,e.targetProperty,e.framePerSecond,e.dataType,e.loopMode);t.enableBlending=e.enableBlending,t.blendingSpeed=e.blendingSpeed;const n=e.getKeys();if(void 0!==n){const e=new Array(n.length);for(let t=0;t<n.length;t++){const i=e[t]={...n[t]};void 0!==i.value.clone&&(i.value=i.value.clone()),void 0!==i.inTangent&&void 0!==i.inTangent.clone&&(i.inTangent=i.inTangent.clone()),void 0!==i.outTangent&&void 0!==i.outTangent.clone&&(i.outTangent=i.outTangent.clone())}t.setKeys(e)}if(t._ranges){t._ranges={};for(const n in e._ranges){const i=e._ranges[n];i&&(t._ranges[n]=i.clone())}}return t}class Gn{_boneNameMap;_sourceSkeleton;_targetSkeleton;_sourceSkeletonTransformOffset;_sourceSkeletonAbsoluteMatrices;_targetBoneNameMap;_loggingEnabled;log;warn;error;constructor(){this._boneNameMap=null,this._sourceSkeleton=null,this._targetSkeleton=null,this._sourceSkeletonTransformOffset=null,this._sourceSkeletonAbsoluteMatrices=null,this._targetBoneNameMap=null,this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled}setBoneMap(e){return this._boneNameMap=e,this}setSourceSkeleton(e,t){return this._sourceSkeleton=e,void 0===t?this._sourceSkeletonTransformOffset=null:void 0!==t.getWorldMatrix?this._sourceSkeletonTransformOffset=t.computeWorldMatrix(!0).clone():this._sourceSkeletonTransformOffset=t.clone(),this._sourceSkeletonAbsoluteMatrices=null,this}setTargetSkeleton(e){return this._targetSkeleton=e,this._targetBoneNameMap=null,this}retargetAnimation(e,t={}){if(!this._isSkeletonAnimation(e))return this.warn("Animation is not skeleton animation. animation retargeting is aborted."),null;if(t.cloneAnimation??=!0,t.removeBoneRotationOffset??=!1,null===this._boneNameMap)throw new Error("Bone map is not set");if(null===this._sourceSkeleton)throw new Error("Source skeleton is not set");if(null===this._targetSkeleton)throw new Error("Target skeleton is not set");if(null===this._targetBoneNameMap){const e=this._targetBoneNameMap=new Map;{const t=this._targetSkeleton.bones;for(let n=0;n<t.length;++n){const i=t[n];e.set(i.name,i)}}}t.cloneAnimation&&(e=function(e,t){const n=new Bt.AnimationGroup(t||e.name,e._scene);for(const t of e.targetedAnimations)n.addTargetedAnimation(Kn(t.animation),t.target);return n}(e,e.name+"_retargeted")),this._removeScaleAnimation(e);const n=e.targetedAnimations;for(let e=0;e<n.length;++e)this._flattenAnimationTarget(n[e]);if(e.isAdditive||function(e,t,n){if(e.isAdditive)return void n?.warn("Animation group is already additive");const i=new Map;{const e=t.bones;for(let t=0;t<e.length;++t){const n=e[t],r=n.getTransformNode();null!==r&&i.set(r,n)}}const r=e.targetedAnimations;for(let e=0;e<r.length;++e){const t=r[e].animation,o=r[e].target,a=i.get(o);void 0===a&&r[e].target,void 0!==a?qn(t,a):n?.warn(`Failed to find rest pose for ${t.name}`)}e.isAdditive=!0}(e,this._sourceSkeleton),void 0!==t.rotationOffsets){const n=new rt.Quaternion,i=t.rotationOffsets,r=e.targetedAnimations;for(let e=0;e<r.length;++e){const t=r[e].target,o=r[e].animation.targetPropertyPath;if("rotationQuaternion"===o[o.length-1]){const o=i[t.name];if(void 0!==o){rt.Quaternion.FromEulerAnglesToRef(o.x,o.y,o.z,n);const t=r[e].animation.getKeys();for(let e=0;e<t.length;++e){const i=t[e].value;n.multiplyToRef(i,i)}}}}}if(t.removeBoneRotationOffset){const t=new Map,i=new Map;{const e=this._sourceSkeleton.bones;for(let n=0;n<e.length;++n){const r=e[n],o=r.getTransformNode();null!==o&&t.set(o,r),i.set(r,n)}}const r=new Int32Array(n.length);for(let e=0;e<n.length;++e){const o=n[e].target;let a=t.get(o);void 0===a&&(a=o);const s=i.get(a);void 0===s?(r[e]=-1,this.warn(`${a.name} is not found in source skeleton`)):r[e]=s}null===this._sourceSkeletonAbsoluteMatrices&&(this._sourceSkeletonAbsoluteMatrices=this._computeSkeletonAbsoluteMatrices(this._sourceSkeleton,this._sourceSkeletonTransformOffset,i)),this._removeBoneRotationOffset(e,r,this._sourceSkeleton,this._sourceSkeletonAbsoluteMatrices,i)}return this._retargetAnimationInternal(e,this._boneNameMap,this._targetBoneNameMap),e.isAdditive=!0,e.weight=1,e}_isSkeletonAnimation(e){const t=e.targetedAnimations;for(let e=0;e<t.length;++e){const n=t[e].animation,i=n.targetPropertyPath[n.targetPropertyPath.length-1];if("position"!==i&&"rotationQuaternion"!==i&&"scaling"!==i)return!1}return!0}static _Stack=[];_computeSkeletonAbsoluteMatrices(e,t,n){const i=e.bones,r=Gn._Stack;r.length=0;for(let e=0;e<i.length;++e){const t=i[e];null===t.getParent()&&r.push(t)}null===t&&(t=rt.Matrix.Identity());const o=new Array(i.length);for(;r.length>0;){const e=r.pop(),i=e.getParent(),a=null===i?t:o[n.get(i)];o[n.get(e)]=e.getRestMatrix().multiply(a);const s=e.getChildren();for(let e=0;e<s.length;++e)r.push(s[e])}return o}_removeScaleAnimation(e){const t=[],n=e.targetedAnimations;for(let e=0;e<n.length;++e){const i=n[e];i.target&&("scaling"===i.animation.targetProperty&&t.push(e))}for(let e=0,i=0;e<n.length;++e)e!==t[i]?n[e-i]=n[e]:i+=1;n.length-=t.length}_getFinalTarget(e,t){if(t.length>1){let n=e[t[0]];for(let e=1;e<t.length-1;e++)n=n[t[e]];return n}return e}_flattenAnimationTarget(e){const t=e.target,n=e.animation.targetPropertyPath,i=this._getFinalTarget(t,n);e.target=i,n[0]=e.animation.targetPropertyPath[e.animation.targetPropertyPath.length-1],n.length=1,e.animation.targetProperty=e.animation.targetPropertyPath[0]}_removeBoneRotationOffset(e,t,n,i,r){const o=e.targetedAnimations,a=new rt.Matrix,s=new rt.Matrix,l=this._sourceSkeletonTransformOffset;for(let e=0;e<o.length;++e){const h=t[e];if(-1===h)continue;const d=o[e].animation,c=d.targetProperty,u=n.bones[h];if("rotationQuaternion"===c){const e=i[h];e.invertToRef(s);const t=d.getKeys();for(let n=0;n<t.length;++n){const i=t[n].value;s.multiplyToRef(rt.Matrix.FromQuaternionToRef(i,a),a),a.multiplyToRef(e,a),rt.Quaternion.FromRotationMatrixToRef(a,i)}}else if("position"===c){const e=u.getParent(),t=null!==e?r.get(e):-1,n=-1!==t?i[t]:l;if(null!==n){const e=d.getKeys();for(let t=0;t<e.length;++t){const i=e[t].value;rt.Vector3.TransformNormalToRef(i,n,i)}}}else this.warn(`Unsupported target property: ${c}`)}}_retargetAnimationInternal(e,t,n){const i=[],r=e.targetedAnimations;for(let e=0;e<r.length;++e){const o=r[e];if(!o.target){i.push(e),this.warn(`Animation target is null. Animation name: ${o.animation.name}`);continue}const a=t[o.target.name];if(void 0!==a){const t=n.get(a);void 0!==t?o.target=t:(i.push(e),this.warn(`Bone not found. Bone name: ${o.target.name}`))}else i.push(e),this.warn(`Bone not found. Bone name: ${o.target.name}`)}for(let e=0,t=0;e<r.length;++e)e!==i[t]?r[e-t]=r[e]:t+=1;r.length-=i.length}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){Rn.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){Rn.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){Rn.Logger.Error(e)}_errorDisabled(){}}const Yn={hips:"mixamorig:Hips",spine:"mixamorig:Spine",chest:"mixamorig:Spine2",neck:"mixamorig:Neck",head:"mixamorig:Head",leftShoulder:"mixamorig:LeftShoulder",leftUpperArm:"mixamorig:LeftArm",leftLowerArm:"mixamorig:LeftForeArm",leftHand:"mixamorig:LeftHand",rightShoulder:"mixamorig:RightShoulder",rightUpperArm:"mixamorig:RightArm",rightLowerArm:"mixamorig:RightForeArm",rightHand:"mixamorig:RightHand",leftUpperLeg:"mixamorig:LeftUpLeg",leftLowerLeg:"mixamorig:LeftLeg",leftFoot:"mixamorig:LeftFoot",leftToes:"mixamorig:LeftToeBase",rightUpperLeg:"mixamorig:RightUpLeg",rightLowerLeg:"mixamorig:RightLeg",rightFoot:"mixamorig:RightFoot",rightToes:"mixamorig:RightToeBase",leftEye:void 0,rightEye:void 0,leftThumbProximal:"mixamorig:LeftHandThumb1",leftThumbIntermediate:"mixamorig:LeftHandThumb2",leftThumbDistal:"mixamorig:LeftHandThumb3",leftIndexProximal:"mixamorig:LeftHandIndex1",leftIndexIntermediate:"mixamorig:LeftHandIndex2",leftIndexDistal:"mixamorig:LeftHandIndex3",leftMiddleProximal:"mixamorig:LeftHandMiddle1",leftMiddleIntermediate:"mixamorig:LeftHandMiddle2",leftMiddleDistal:"mixamorig:LeftHandMiddle3",leftRingProximal:"mixamorig:LeftHandRing1",leftRingIntermediate:"mixamorig:LeftHandRing2",leftRingDistal:"mixamorig:LeftHandRing3",leftLittleProximal:"mixamorig:LeftHandPinky1",leftLittleIntermediate:"mixamorig:LeftHandPinky2",leftLittleDistal:"mixamorig:LeftHandPinky3",rightThumbProximal:"mixamorig:RightHandThumb1",rightThumbIntermediate:"mixamorig:RightHandThumb2",rightThumbDistal:"mixamorig:RightHandThumb3",rightIndexProximal:"mixamorig:RightHandIndex1",rightIndexIntermediate:"mixamorig:RightHandIndex2",rightIndexDistal:"mixamorig:RightHandIndex3",rightMiddleProximal:"mixamorig:RightHandMiddle1",rightMiddleIntermediate:"mixamorig:RightHandMiddle2",rightMiddleDistal:"mixamorig:RightHandMiddle3",rightRingProximal:"mixamorig:RightHandRing1",rightRingIntermediate:"mixamorig:RightHandRing2",rightRingDistal:"mixamorig:RightHandRing3",rightLittleProximal:"mixamorig:RightHandPinky1",rightLittleIntermediate:"mixamorig:RightHandPinky2",rightLittleDistal:"mixamorig:RightHandPinky3"},Qn={hips:"hips",spine:"spine",chest:"chest",neck:"neck",head:"head",leftShoulder:"leftShoulder",leftUpperArm:"leftUpperArm",leftLowerArm:"leftLowerArm",leftHand:"leftHand",rightShoulder:"rightShoulder",rightUpperArm:"rightUpperArm",rightLowerArm:"rightLowerArm",rightHand:"rightHand",leftUpperLeg:"leftUpperLeg",leftLowerLeg:"leftLowerLeg",leftFoot:"leftFoot",leftToes:"leftToes",rightUpperLeg:"rightUpperLeg",rightLowerLeg:"rightLowerLeg",rightFoot:"rightFoot",rightToes:"rightToes",leftEye:"leftEye",rightEye:"rightEye",leftThumbProximal:"leftThumbProximal",leftThumbIntermediate:"leftThumbIntermediate",leftThumbDistal:"leftThumbDistal",leftIndexProximal:"leftIndexProximal",leftIndexIntermediate:"leftIndexIntermediate",leftIndexDistal:"leftIndexDistal",leftMiddleProximal:"leftMiddleProximal",leftMiddleIntermediate:"leftMiddleIntermediate",leftMiddleDistal:"leftMiddleDistal",leftRingProximal:"leftRingProximal",leftRingIntermediate:"leftRingIntermediate",leftRingDistal:"leftRingDistal",leftLittleProximal:"leftLittleProximal",leftLittleIntermediate:"leftLittleIntermediate",leftLittleDistal:"leftLittleDistal",rightThumbProximal:"rightThumbProximal",rightThumbIntermediate:"rightThumbIntermediate",rightThumbDistal:"rightThumbDistal",rightIndexProximal:"rightIndexProximal",rightIndexIntermediate:"rightIndexIntermediate",rightIndexDistal:"rightIndexDistal",rightMiddleProximal:"rightMiddleProximal",rightMiddleIntermediate:"rightMiddleIntermediate",rightMiddleDistal:"rightMiddleDistal",rightRingProximal:"rightRingProximal",rightRingIntermediate:"rightRingIntermediate",rightRingDistal:"rightRingDistal",rightLittleProximal:"rightLittleProximal",rightLittleIntermediate:"rightLittleIntermediate",rightLittleDistal:"rightLittleDistal"};class Hn{static _PropertyMap={hips:"センター",spine:"上半身",chest:"上半身2",neck:"首",head:"頭",leftShoulder:"左肩",leftUpperArm:"左腕",leftLowerArm:"左ひじ",leftHand:"左手首",rightShoulder:"右肩",rightUpperArm:"右腕",rightLowerArm:"右ひじ",rightHand:"右手首",leftUpperLeg:"左足",leftLowerLeg:"左ひざ",leftFoot:"左足首",leftToes:"左つま先",rightUpperLeg:"右足",rightLowerLeg:"右ひざ",rightFoot:"右足首",rightToes:"右つま先",leftEye:"左目",rightEye:"右目",leftThumbProximal:"左親指０",leftThumbIntermediate:"左親指１",leftThumbDistal:"左親指２",leftIndexProximal:"左人指１",leftIndexIntermediate:"左人指２",leftIndexDistal:"左人指３",leftMiddleProximal:"左中指１",leftMiddleIntermediate:"左中指２",leftMiddleDistal:"左中指３",leftRingProximal:"左薬指１",leftRingIntermediate:"左薬指２",leftRingDistal:"左薬指３",leftLittleProximal:"左小指１",leftLittleIntermediate:"左小指２",leftLittleDistal:"左小指３",rightThumbProximal:"右親指０",rightThumbIntermediate:"右親指１",rightThumbDistal:"右親指２",rightIndexProximal:"右人指１",rightIndexIntermediate:"右人指２",rightIndexDistal:"右人指３",rightMiddleProximal:"右中指１",rightMiddleIntermediate:"右中指２",rightMiddleDistal:"右中指３",rightRingProximal:"右薬指１",rightRingIntermediate:"右薬指２",rightRingDistal:"右薬指３",rightLittleProximal:"右小指１",rightLittleIntermediate:"右小指２",rightLittleDistal:"右小指３"};static _PropertyKeys=Object.keys(Hn._PropertyMap);boneMap;constructor(e){const t=this.boneMap={},n=Hn._PropertyMap,i=Hn._PropertyKeys;for(let r=0,o=i.length;r<o;++r){const o=i[r],a=e[o],s=n[o];void 0!==a&&void 0!==s&&(t[a]=s)}}}var $n=We(5092),Xn=We(577),Jn=We(224),Zn=We(4756),ei=We(5567),ti=We(9897),ni=We(1494),ii=We(7466);class ri{optimizeEmptyTracks;_scene;_loggingEnabled;log;warn;error;constructor(e){this.optimizeEmptyTracks=!0,this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._scene=e}loadFromVmdObject(e,t,n,i){this.loadFromVmdObjectAsync(e,t,i).then(n)}async loadFromVmdObjectAsync(e,t,n){const i=this.optimizeEmptyTracks;Array.isArray(t)||(t=[t]);let r=0,o=0,a=0,s=0;for(let e=0;e<t.length;++e){const n=t[e];r+=n.boneKeyFrames.length,o+=n.morphKeyFrames.length,a+=n.propertyKeyFrames.length,s+=n.cameraKeyFrames.length}const l={lengthComputable:!0,loaded:0,total:r+o+a+s};let h=0,d=performance.now();const c=[];{const e=new Map,i=[],r=[],o=[];for(let e=0;e<t.length;++e){const n=t[e].boneKeyFrames,i=n.length;for(let e=0;e<i;++e)o.push(n.get(e))}100<performance.now()-d&&(await ii.Tools.DelayAsync(0),d=performance.now());const a=o.length;for(let t=0;t<a;++t){const n=o[t].boneName;let a=e.get(n);void 0===a&&(a=e.size,e.set(n,a),i.push(0),r.push(n)),i[a]+=1}o.sort(((e,t)=>e.frameNumber-t.frameNumber));for(let t=0;t<e.size;++t)c.push(new Jt(r[t],i[t]));100<performance.now()-d&&(await ii.Tools.DelayAsync(0),d=performance.now());const s=new Uint32Array(e.size);for(let t=0;t<a;++t){const i=o[t],r=e.get(i.boneName),a=c[r],u=s[r],m=i.interpolation;a.frameNumbers[u]=i.frameNumber;const p=a.positions,_=i.position;p[3*u+0]=_[0],p[3*u+1]=_[1],p[3*u+2]=_[2];const g=a.positionInterpolations;g[12*u+0]=m[0],g[12*u+1]=m[8],g[12*u+2]=m[4],g[12*u+3]=m[12],g[12*u+4]=m[16],g[12*u+5]=m[24],g[12*u+6]=m[20],g[12*u+7]=m[28],g[12*u+8]=m[32],g[12*u+9]=m[40],g[12*u+10]=m[36],g[12*u+11]=m[44];const f=a.rotations,b=i.rotation;f[4*u+0]=b[0],f[4*u+1]=b[1],f[4*u+2]=b[2],f[4*u+3]=b[3];const y=a.rotationInterpolations;y[4*u+0]=m[48],y[4*u+1]=m[56],y[4*u+2]=m[52],y[4*u+3]=m[60],s[r]+=1,t%1e3==0&&100<performance.now()-d&&(l.loaded=h+t,n?.({...l}),await ii.Tools.DelayAsync(0),d=performance.now())}}const u=[],m=[];if(i)for(let e=0;e<c.length;++e){const t=c[e];let n=!0;for(let e=0;e<t.frameNumbers.length;++e){const i=t.positions;if(0!==i[3*e+0]||0!==i[3*e+1]||0!==i[3*e+2]){n=!1;break}const r=t.rotations;if(0!==r[4*e+0]||0!==r[4*e+1]||0!==r[4*e+2]||1!==r[4*e+3]){n=!1;break}}if(n)continue;let i=!1;for(let e=0;e<t.positions.length;++e)if(0!==t.positions[e]){i=!0;break}if(i)m.push(t);else{const e=new Xt(t.name,t.frameNumbers.length);e.frameNumbers.set(t.frameNumbers),e.rotations.set(t.rotations),e.rotationInterpolations.set(t.rotationInterpolations),u.push(e)}}else m.push(...c);if(c.length=0,1<t.length){const e=new Int32Array(u.length).fill(-1);for(let t=0;t<u.length;++t){const n=u[t].frameNumbers;let i=0,r=n[0];for(let e=1;e<=n.length;++e){const t=n[e];r!==t&&(i+=1,r=t)}n.length!==i&&(e[t]=i)}for(let t=0;t<u.length;++t){const n=e[t];if(-1===n)continue;const i=u[t],r=i.frameNumbers,o=i.rotations,a=i.rotationInterpolations,s=new Xt(i.name,n);let l=0,h=r[0];for(let e=1;e<=r.length;++e){const t=r[e];if(h!==t){const n=e-1;s.frameNumbers[l]=h;const i=s.rotations;i[4*l+0]=o[4*n+0],i[4*l+1]=o[4*n+1],i[4*l+2]=o[4*n+2],i[4*l+3]=o[4*n+3];const r=s.rotationInterpolations;r[4*l+0]=a[4*n+0],r[4*l+1]=a[4*n+1],r[4*l+2]=a[4*n+2],r[4*l+3]=a[4*n+3],l+=1,h=t}}u[t]=s}const t=new Int32Array(m.length).fill(-1);for(let e=0;e<m.length;++e){const n=m[e].frameNumbers;let i=0,r=n[0];for(let e=1;e<=n.length;++e){const t=n[e];r!==t&&(i+=1,r=t)}n.length!==i&&(t[e]=i)}for(let e=0;e<m.length;++e){const n=t[e];if(-1===n)continue;const i=m[e],r=i.frameNumbers,o=i.positions,a=i.positionInterpolations,s=i.rotations,l=i.rotationInterpolations,h=new Jt(i.name,n);let d=0,c=r[0];for(let e=1;e<=r.length;++e){const t=r[e];if(c!==t){const n=e-1;h.frameNumbers[d]=c;const i=h.positions;i[3*d+0]=o[3*n+0],i[3*d+1]=o[3*n+1],i[3*d+2]=o[3*n+2];const r=h.positionInterpolations;r[12*d+0]=a[12*n+0],r[12*d+1]=a[12*n+1],r[12*d+2]=a[12*n+2],r[12*d+3]=a[12*n+3],r[12*d+4]=a[12*n+4],r[12*d+5]=a[12*n+5],r[12*d+6]=a[12*n+6],r[12*d+7]=a[12*n+7],r[12*d+8]=a[12*n+8],r[12*d+9]=a[12*n+9],r[12*d+10]=a[12*n+10],r[12*d+11]=a[12*n+11];const u=h.rotations;u[4*d+0]=s[4*n+0],u[4*d+1]=s[4*n+1],u[4*d+2]=s[4*n+2],u[4*d+3]=s[4*n+3];const m=h.rotationInterpolations;m[4*d+0]=l[4*n+0],m[4*d+1]=l[4*n+1],m[4*d+2]=l[4*n+2],m[4*d+3]=l[4*n+3],d+=1,c=t}}m[e]=h}}l.loaded=h+r,n?.({...l}),h+=r;const p=[];{const e=new Map,i=[],r=[],o=[];for(let e=0;e<t.length;++e){const n=t[e].morphKeyFrames,i=n.length;for(let e=0;e<i;++e)o.push(n.get(e))}100<performance.now()-d&&(await ii.Tools.DelayAsync(0),d=performance.now());const a=o.length;for(let t=0;t<a;++t){const n=o[t].morphName;let a=e.get(n);void 0===a&&(a=e.size,e.set(n,a),i.push(0),r.push(n)),i[a]+=1}o.sort(((e,t)=>e.frameNumber-t.frameNumber));for(let t=0;t<e.size;++t)p.push(new Zt(r[t],i[t]));100<performance.now()-d&&(await ii.Tools.DelayAsync(0),d=performance.now());const s=new Uint32Array(e.size);for(let t=0;t<a;++t){const i=o[t],r=e.get(i.morphName),a=p[r],c=s[r];a.frameNumbers[c]=i.frameNumber,a.weights[c]=i.weight,s[r]+=1,t%1e3==0&&100<performance.now()-d&&(l.loaded=h+t,n?.({...l}),await ii.Tools.DelayAsync(0),d=performance.now())}}const _=[];if(i)for(let e=0;e<p.length;++e){const t=p[e];let n=!0;for(let e=0;e<t.weights.length;++e)if(0!==t.weights[e]){n=!1;break}n||_.push(t)}else _.push(...p);if(p.length=0,1<t.length){const e=new Int32Array(_.length).fill(-1);for(let t=0;t<_.length;++t){const n=_[t].frameNumbers;let i=0,r=n[0];for(let e=1;e<=n.length;++e){const t=n[e];r!==t&&(i+=1,r=t)}n.length!==i&&(e[t]=i)}for(let t=0;t<_.length;++t){const n=e[t];if(-1===n)continue;const i=_[t],r=i.frameNumbers,o=i.weights,a=new Zt(i.name,n);let s=0,l=r[0];for(let e=1;e<=r.length;++e){const t=r[e];l!==t&&(a.frameNumbers[s]=l,a.weights[s]=o[e-1],s+=1,l=t)}_[t]=a}}l.loaded=h+o,n?.({...l}),h+=o;const g=[];for(let e=0;e<t.length;++e){const n=t[e].propertyKeyFrames;for(let e=0;e<n.length;++e)g.push(n[e])}let f;if(g.sort(((e,t)=>e.frameNumber-t.frameNumber)),1<t.length)f=g;else{f=[];let e=g[0]?.frameNumber;for(let t=1;t<=g.length;++t){const n=g[t]?.frameNumber;e!==n&&(f.push(g[t-1]),e=n)}}const b=new Set;for(let e=0;e<t.length;++e){const n=t[e].propertyKeyFrames;for(let e=0;e<n.length;++e){const t=n[e];for(let e=0;e<t.ikStates.length;++e)b.add(t.ikStates[e][0])}}const y=new Array(b.size),w=new Map;{let e=0;for(const t of b)w.set(t,e),y[e]=t,e+=1}const A=new tn(f.length,y);{const e=new Uint8Array(b.size);for(let t=0;t<f.length;++t){const n=f[t];A.frameNumbers[t]=n.frameNumber,A.visibles[t]=n.visible?1:0;const i=n.ikStates;e.fill(0);for(let n=0;n<i.length;++n){const r=i[n],o=w.get(r[0]);A.getIkState(o)[t]=r[1]?1:0,e[o]=1}for(let n=0;n<e.length;++n)if(0===e[n]){const e=A.getIkState(n)[t-1];A.getIkState(n)[t]=void 0===e?0:e}}}l.loaded=h+a,n?.({...l}),h+=a;const M=[];for(let e=0;e<t.length;++e){const n=t[e].cameraKeyFrames;for(let e=0;e<n.length;++e)M.push(n.get(e))}let T;if(M.sort(((e,t)=>e.frameNumber-t.frameNumber)),1<t.length)T=M;else{T=[];let e=M[0]?.frameNumber;for(let t=1;t<=M.length;++t){const n=M[t]?.frameNumber;e!==n&&(T.push(M[t-1]),e=n)}}const x=new en(T.length);for(let e=0;e<T.length;++e){const t=T[e],i=t.interpolation;x.frameNumbers[e]=t.frameNumber;const r=x.positions,o=t.position;r[3*e+0]=o[0],r[3*e+1]=o[1],r[3*e+2]=o[2];const a=x.positionInterpolations;a[12*e+0]=i[0],a[12*e+1]=i[1],a[12*e+2]=i[2],a[12*e+3]=i[3],a[12*e+4]=i[4],a[12*e+5]=i[5],a[12*e+6]=i[6],a[12*e+7]=i[7],a[12*e+8]=i[8],a[12*e+9]=i[9],a[12*e+10]=i[10],a[12*e+11]=i[11];const s=x.rotations,c=t.rotation;s[3*e+0]=c[0],s[3*e+1]=c[1],s[3*e+2]=c[2];const u=x.rotationInterpolations;u[4*e+0]=i[12],u[4*e+1]=i[13],u[4*e+2]=i[14],u[4*e+3]=i[15],x.distances[e]=t.distance;const m=x.distanceInterpolations;m[4*e+0]=i[16],m[4*e+1]=i[17],m[4*e+2]=i[18],m[4*e+3]=i[19],x.fovs[e]=t.fov;const p=x.fovInterpolations;p[4*e+0]=i[20],p[4*e+1]=i[21],p[4*e+2]=i[22],p[4*e+3]=i[23],e%1e3==0&&100<performance.now()-d&&(l.loaded=h+e,n?.({...l}),await ii.Tools.DelayAsync(0),d=performance.now())}return l.loaded=h+s,n?.({...l}),h+=s,new vn(e,u,m,_,A,x)}loadFromVmdData(e,t,n,i){Array.isArray(t)||(t=[t]);const r=[];for(let e=0;e<t.length;++e)r.push(zn.Parse(t[e]));this.loadFromVmdObject(e,r,n,i)}loadFromVmdDataAsync(e,t,n){return new Promise((i=>{this.loadFromVmdData(e,t,i,n)}))}loadFromBuffer(e,t,n,i,r){Array.isArray(t)||(t=[t]);const o=[];for(let e=0;e<t.length;++e){const n=Wn.CheckedCreate(t[e]);if(null===n)return void r?.(new Error("VMD data validation failed."));o.push(n)}this.loadFromVmdData(e,o,n,i)}loadFromBufferAsync(e,t,n){return new Promise(((i,r)=>{this.loadFromBuffer(e,t,i,n,r)}))}load(e,t,n,i,r){Array.isArray(t)||(t=[t]);const o=this._scene,a=[],s=[];for(let l=0;l<t.length;++l){const h=t[l];s.push(o._loadFile(h,((o,s)=>{try{a.push(o),a.length===t.length&&this.loadFromBuffer(e,a,n,i,(e=>{r?.(void 0,e)}))}catch(e){r?.(void 0,e)}}),i,!0,!0,r))}return 1===t.length?s[0]:s}loadAsync(e,t,n){return new Promise(((i,r)=>{this.load(e,t,i,n,((e,t)=>r({request:e,exception:t})))}))}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){Rn.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){Rn.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){Rn.Logger.Error(e)}_errorDisabled(){}}class oi{_scene;_textDecoder;_loggingEnabled;log;warn;error;constructor(e){this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._scene=e,this._textDecoder=new TextDecoder("shift_jis")}loadFromVpdObject(e,t){const n=t.bones,i=Object.keys(n);let r=0;for(let e=0;e<i.length;e++)void 0!==n[i[e]].position&&(r+=1);const o=new Array(i.length-r),a=new Array(r);let s=0,l=0;for(let e=0;e<i.length;e++){const t=i[e],r=n[t];if(void 0===r.position){const e=o[s]=new Xt(t,1);e.rotations[0]=r.rotation[0],e.rotations[1]=r.rotation[1],e.rotations[2]=r.rotation[2],e.rotations[3]=r.rotation[3],s+=1}else{const e=a[l]=new Jt(t,1);e.positions[0]=r.position[0],e.positions[1]=r.position[1],e.positions[2]=r.position[2],e.rotations[0]=r.rotation[0],e.rotations[1]=r.rotation[1],e.rotations[2]=r.rotation[2],e.rotations[3]=r.rotation[3],l+=1}}const h=t.morphs,d=Object.keys(h),c=new Array(d.length);for(let e=0;e<d.length;e++){const t=d[e];(c[e]=new Zt(t,1)).weights[0]=h[t]}return new vn(e,o,a,c,new tn(0,[]),new en(0))}loadFromBuffer(e,t){const n=this._textDecoder.decode(t),i=jn.Parse(n,this);return this.loadFromVpdObject(e,i)}load(e,t,n,i,r){return this._scene._loadFile(t,(t=>{try{n(this.loadFromBuffer(e,t))}catch(e){r?.(void 0,e)}}),i,!0,!0,r)}loadAsync(e,t,n){return new Promise(((i,r)=>{this.load(e,t,i,n,((e,t)=>r({request:e,exception:t})))}))}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){Rn.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){Rn.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){Rn.Logger.Error(e)}_errorDisabled(){}}class ai{_audioElements=[];rent(){if(0===this._audioElements.length)return new Audio;{const e=this._audioElements.pop();return e.loop=!1,e.autoplay=!1,e.playbackRate=1,e.volume=1,e.muted=!1,e.preservesPitch=!0,e.ondurationchange=null,e.onerror=null,e.onplaying=null,e.onpause=null,e.onseeked=null,e}}return(e){e.pause(),e.src="",e.load(),this._audioElements.push(e)}}class si{static DefaultAudioElementPool=new ai;onLoadErrorObservable;onDurationChangedObservable;onPlaybackRateChangedObservable;onMuteStateChangedObservable;onPlayObservable;onPauseObservable;onSeekObservable;_pool;_audio;_duration;_playbackRate;_isVirtualPlay;_virtualStartTime;_virtualPaused;_virtualPauseCurrentTime;_metadataLoaded;_bindedDispose;_disposeObservableObject;constructor(e,t={}){const n=t.pool??!1;this.onLoadErrorObservable=new pt.Observable,this.onDurationChangedObservable=new pt.Observable,this.onPlaybackRateChangedObservable=new pt.Observable,this.onMuteStateChangedObservable=new pt.Observable,this.onPlayObservable=new pt.Observable,this.onPauseObservable=new pt.Observable,this.onSeekObservable=new pt.Observable;const i=this._pool="boolean"==typeof n?n?si.DefaultAudioElementPool:null:n,r=this._audio=null!==i?i.rent():new Audio;r.loop=!1,r.autoplay=!1,this._duration=0,this._playbackRate=1,this._isVirtualPlay=!1,this._virtualStartTime=0,this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._metadataLoaded=!1,r.ondurationchange=this._onDurationChanged,r.onerror=this._onLoadError,r.onplaying=this._onPlay,r.onpause=this._onPause,r.onseeked=this._onSeek,this._bindedDispose=this.dispose.bind(this),this._disposeObservableObject=e,null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.add(this._bindedDispose)}_onDurationChanged=()=>{this._duration=this._audio.duration,this._isVirtualPlay&&(this._isVirtualPlay=!1,this.onMuteStateChangedObservable.notifyObservers()),this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._metadataLoaded=!0,this.onDurationChangedObservable.notifyObservers()};_onLoadError=()=>{this._duration=0,this._isVirtualPlay&&(this._isVirtualPlay=!1,this.onMuteStateChangedObservable.notifyObservers()),this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._metadataLoaded=!1,this.onLoadErrorObservable.notifyObservers(),this.onDurationChangedObservable.notifyObservers()};_onPlay=()=>{this._isVirtualPlay||(this._audio.playbackRate=this._playbackRate),this.onPlayObservable.notifyObservers()};_onPause=()=>{this._isVirtualPlay?this._virtualPaused&&this.onPauseObservable.notifyObservers():this.onPauseObservable.notifyObservers()};_ignoreSeekedEventOnce=!1;_onSeek=()=>{this._ignoreSeekedEventOnce?this._ignoreSeekedEventOnce=!1:this.onSeekObservable.notifyObservers()};get duration(){return this._duration}get currentTime(){if(this._isVirtualPlay){if(this._virtualPaused)return this._virtualPauseCurrentTime;{const e=(performance.now()/1e3-this._virtualStartTime)*this._playbackRate;return e>this._duration?(this._virtualPaused=!0,this._virtualPauseCurrentTime=this._duration,this._onPause(),this._virtualPauseCurrentTime):e}}return this._audio?.currentTime??0}set currentTime(e){this._isVirtualPlay?(this._virtualPaused?this._virtualPauseCurrentTime=e:this._virtualStartTime=performance.now()/1e3-e/this._playbackRate,this._onSeek()):null!==this._audio&&(this._audio.currentTime=e)}_setCurrentTimeWithoutNotify(e){this._isVirtualPlay?this._virtualPaused?this._virtualPauseCurrentTime=e:this._virtualStartTime=performance.now()/1e3-e/this._playbackRate:(this._ignoreSeekedEventOnce=!0,null!==this._audio&&(this._audio.currentTime=e))}get volume(){return this._audio?.volume??0}set volume(e){null!==this._audio&&(this._audio.volume=e)}get muted(){return this._isVirtualPlay}mute(){null!==this._audio&&(this._isVirtualPlay||(this._isVirtualPlay=!0,this._virtualStartTime=performance.now()/1e3-this._audio.currentTime/this._playbackRate,this._virtualPaused=this._audio.paused,this._virtualPauseCurrentTime=this._audio.currentTime,this._audio.pause(),this.onMuteStateChangedObservable.notifyObservers()))}async unmute(){if(null===this._audio)return!1;if(!this._isVirtualPlay)return!0;let e=!1;if(this._ignoreSeekedEventOnce=!0,this._virtualPaused)this._audio.currentTime=this._virtualPauseCurrentTime;else{this._audio.currentTime=(performance.now()/1e3-this._virtualStartTime)*this._playbackRate;try{await this._audio.play(),this._audio.playbackRate=this._playbackRate}catch(t){if(!(t instanceof DOMException&&"NotAllowedError"===t.name))throw t;e=!0}}return!e&&(this._isVirtualPlay=!1,this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this.onMuteStateChangedObservable.notifyObservers(),!0)}get playbackRate(){return this._playbackRate}set playbackRate(e){this._setPlaybackRateWithoutNotify(e),this.onPlaybackRateChangedObservable.notifyObservers()}_setPlaybackRateWithoutNotify(e){if(this._isVirtualPlay&&!this._virtualPaused){const t=performance.now()/1e3,n=(t-this._virtualStartTime)*this._playbackRate;this._virtualStartTime=t-n/e}this._playbackRate=e,null!==this._audio&&(this._audio.playbackRate=e)}get preservesPitch(){return this._audio?.preservesPitch??!0}set preservesPitch(e){null!==this._audio&&(this._audio.preservesPitch=e)}get paused(){return this._isVirtualPlay?this._virtualPaused:this._audio?.paused??!0}get source(){return this._audio?.src??""}set source(e){null!==this._audio&&e!==this._audio.src&&(this._audio.src=e,this._metadataLoaded=!1,this._isVirtualPlay&&(this._isVirtualPlay=!1,this.onMuteStateChangedObservable.notifyObservers()),this._virtualPaused=!0,this._virtualPauseCurrentTime=0,this._audio.load())}get metadataLoaded(){return this._metadataLoaded}async _virtualPlay(){this._metadataLoaded?(this._virtualPaused&&(this._virtualStartTime=performance.now()/1e3-this._virtualPauseCurrentTime/this._playbackRate,this._virtualPaused=!1),this._isVirtualPlay||(this._isVirtualPlay=!0,this.onMuteStateChangedObservable.notifyObservers()),this._onPlay()):await new Promise(((e,t)=>{const n=()=>{this._virtualPaused&&(this._virtualStartTime=performance.now()/1e3-this._virtualPauseCurrentTime/this._playbackRate,this._virtualPaused=!1),this._isVirtualPlay||(this._isVirtualPlay=!0,this.onMuteStateChangedObservable.notifyObservers()),this._onPlay(),this.onLoadErrorObservable.removeCallback(i),e()},i=()=>{this.onDurationChangedObservable.removeCallback(n),t(new DOMException("The media resource indicated by the src attribute or assigned media provider object was not suitable.","NotSupportedError"))};this.onDurationChangedObservable.addOnce(n),this.onLoadErrorObservable.addOnce(i)}))}_playRequestBlocking=!1;async play(){if(!this._isVirtualPlay||this._virtualPaused)if(this._isVirtualPlay)await this._virtualPlay();else if(!this._playRequestBlocking){this._playRequestBlocking=!0;try{await(this._audio?.play())}catch(e){if(!(e instanceof DOMException&&"NotAllowedError"===e.name))throw e;await this._virtualPlay()}finally{this._playRequestBlocking=!1}}}pause(){if(this._isVirtualPlay){if(this._virtualPaused)return;this._virtualPaused=!0,this._virtualPauseCurrentTime=(performance.now()/1e3-this._virtualStartTime)*this._playbackRate,this._onPause()}else this._audio?.pause()}dispose(){if(null===this._audio)return;const e=this._audio;e.pause(),e.ondurationchange=null,e.onerror=null,e.onplaying=null,e.onpause=null,e.onseeked=null,e.src="",e.load(),null!==this._pool?this._pool.return(e):this._audio.remove(),this.onLoadErrorObservable.clear(),this.onDurationChangedObservable.clear(),this.onPlaybackRateChangedObservable.clear(),this.onMuteStateChangedObservable.clear(),this.onPlayObservable.clear(),this.onPauseObservable.clear(),this.onSeekObservable.clear(),null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.removeCallback(this._bindedDispose),this._audio=null,this._pool=null}}let li,hi;const di=new Array(128).fill(void 0);function ci(e){return di[e]}di.push(void 0,null,!0,!1);let ui=di.length;function mi(e){const t=ci(e);return function(e){e<132||(di[e]=ui,ui=e)}(e),t}function pi(e){ui===di.length&&di.push(di.length+1);const t=ui;if(ui=di[t],"number"!=typeof ui)throw new Error("corrupt heap");return di[t]=e,t}function _i(e){if("boolean"!=typeof e)throw new Error("expected a boolean argument, found "+typeof e)}const gi="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&gi.decode();let fi=null;function bi(){return null!==fi&&fi.buffer===hi.memory.buffer||(fi=new Uint8Array(hi.memory.buffer)),fi}function yi(e,t){return e>>>=0,gi.decode(bi().slice(e,e+t))}function wi(e){if("number"!=typeof e)throw new Error("expected a number argument, found "+typeof e)}function Ai(e){return null==e}function Mi(e,t){if(!(e instanceof t))throw new Error(`expected instance of ${t.name}`);return e.ptr}function Ti(){hi.init()}function xi(){const e=hi.createMmdRuntime();return Li.__wrap(e)}function vi(){const e=hi.createAnimationPool();return Ni.__wrap(e)}function Ii(e,t){try{return e.apply(this,t)}catch(e){let t=function(){try{return e instanceof Error?`${e.message}\n\nStack:\n${e.stack}`:e.toString()}catch(e){return"<failed to stringify thrown value>"}}();throw console.error("wasm-bindgen: imported JS function that was not marked as `catch` threw an error:",t),e}}let Bi=0;const Pi="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},Si=function(e,t){const n=Pi.encode(e);return t.set(n),{read:e.length,written:n.length}};let Ri=null;function Ei(){return null!==Ri&&Ri.buffer===hi.memory.buffer||(Ri=new Int32Array(hi.memory.buffer)),Ri}function Ci(e,t){try{return e.apply(this,t)}catch(e){hi.__wbindgen_exn_store(pi(e))}}function Oi(e){return wi(e),mi(hi.initThreadPool(e))}function ki(e){wi(e),hi.wbg_rayon_start_worker(e)}const Fi="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>hi.__wbg_animationpool_free(e>>>0)));class Ni{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(Ni.prototype);return t.__wbg_ptr=e,Fi.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Fi.unregister(this),e}free(){const e=this.__destroy_into_raw();hi.__wbg_animationpool_free(e)}allocateLengthsBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),hi.animationpool_allocateLengthsBuffer(this.__wbg_ptr,e)>>>0}deallocateLengthsBuffer(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_deallocateLengthsBuffer(this.__wbg_ptr,e,t)}createBoneTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_createBoneTracks(this.__wbg_ptr,e,t)>>>0}getBoneTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_getBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_getBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotationInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_getBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMovableBoneTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_createMovableBoneTracks(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_getMovableBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositions(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_getMovableBoneTrackPositions(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositionInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_getMovableBoneTrackPositionInterpolations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_getMovableBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotationInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_getMovableBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMorphTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_createMorphTracks(this.__wbg_ptr,e,t)>>>0}getMorphTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_getMorphTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMorphTrackWeights(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_getMorphTrackWeights(this.__wbg_ptr,e,t)>>>0}createAnimation(e,t,n,i,r,o,a,s){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),wi(n),wi(i),wi(r),wi(o),wi(a),wi(s),hi.animationpool_createAnimation(this.__wbg_ptr,e,t,n,i,r,o,a,s)>>>0}getPropertyTrackFrameNumbers(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),hi.animationpool_getPropertyTrackFrameNumbers(this.__wbg_ptr,e)>>>0}getPropertyTrackIkStates(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_getPropertyTrackIkStates(this.__wbg_ptr,e,t)>>>0}destroyAnimation(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),wi(e),hi.animationpool_destroyAnimation(this.__wbg_ptr,e)}createBoneBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),hi.animationpool_createBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMovableBoneBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),hi.animationpool_createMovableBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMorphBindIndexMap(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_createMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}getNthMorphBindIndexMap(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_getNthMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}createIkSolverBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),hi.animationpool_createIkSolverBindIndexMap(this.__wbg_ptr,e)>>>0}createRuntimeAnimation(e,t,n,i,r){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),wi(n),wi(i),wi(r),hi.animationpool_createRuntimeAnimation(this.__wbg_ptr,e,t,n,i,r)>>>0}destroyRuntimeAnimation(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),wi(e),hi.animationpool_destroyRuntimeAnimation(this.__wbg_ptr,e)}animateMmdModel(e,t,n){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),wi(e),wi(t),hi.animationpool_animateMmdModel(this.__wbg_ptr,e,t,n)}}const Di="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>hi.__wbg_mmdruntime_free(e>>>0)));class Li{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(Li.prototype);return t.__wbg_ptr=e,Di.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Di.unregister(this),e}free(){const e=this.__destroy_into_raw();hi.__wbg_mmdruntime_free(e)}allocateBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),hi.mmdruntime_allocateBuffer(this.__wbg_ptr,e)>>>0}deallocateBuffer(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),wi(e),wi(t),hi.mmdruntime_deallocateBuffer(this.__wbg_ptr,e,t)}createMmdModel(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),wi(t),hi.mmdruntime_createMmdModel(this.__wbg_ptr,e,t)>>>0}destroyMmdModel(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),wi(e),hi.mmdruntime_destroyMmdModel(this.__wbg_ptr,e)}getAnimationArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),hi.mmdruntime_getAnimationArena(this.__wbg_ptr,e)>>>0}getAnimationIkSolverStateArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),hi.mmdruntime_getAnimationIkSolverStateArena(this.__wbg_ptr,e)>>>0}getAnimationMorphArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),hi.mmdruntime_getAnimationMorphArena(this.__wbg_ptr,e)>>>0}getBoneWorldMatrixArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),hi.mmdruntime_getBoneWorldMatrixArena(this.__wbg_ptr,e)>>>0}createBoneWorldMatrixBackBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),wi(e),hi.mmdruntime_createBoneWorldMatrixBackBuffer(this.__wbg_ptr,e)>>>0}setRuntimeAnimation(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),wi(e),wi(t),hi.mmdruntime_setRuntimeAnimation(this.__wbg_ptr,e,t)}setExternalPhysics(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),wi(e),_i(t),hi.mmdruntime_setExternalPhysics(this.__wbg_ptr,e,t)}beforePhysics(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),Ai(e)||wi(e),hi.mmdruntime_beforePhysics(this.__wbg_ptr,!Ai(e),Ai(e)?0:e)}afterPhysics(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),hi.mmdruntime_afterPhysics(this.__wbg_ptr)}getLockStatePtr(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),hi.mmdruntime_getLockStatePtr(this.__wbg_ptr)>>>0}swapWorldMatrixBuffer(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),hi.mmdruntime_swapWorldMatrixBuffer(this.__wbg_ptr)}static bufferedBeforePhysics(e,t){if(Mi(e,Li),0===e.__wbg_ptr)throw new Error("Attempt to use a moved value");Ai(t)||wi(t),hi.mmdruntime_bufferedBeforePhysics(e.__wbg_ptr,!Ai(t),Ai(t)?0:t)}static bufferedUpdate(e,t){if(Mi(e,Li),0===e.__wbg_ptr)throw new Error("Attempt to use a moved value");Ai(t)||wi(t),hi.mmdruntime_bufferedUpdate(e.__wbg_ptr,!Ai(t),Ai(t)?0:t)}acquireDiagnosticErrorResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),hi.mmdruntime_acquireDiagnosticErrorResult(this.__wbg_ptr)>>>0}acquireDiagnosticWarningResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),hi.mmdruntime_acquireDiagnosticWarningResult(this.__wbg_ptr)>>>0}acquireDiagnosticInfoResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),hi.mmdruntime_acquireDiagnosticInfoResult(this.__wbg_ptr)>>>0}releaseDiagnosticResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),hi.mmdruntime_releaseDiagnosticResult(this.__wbg_ptr)}}const Ui="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>hi.__wbg_wbg_rayon_poolbuilder_free(e>>>0)));class Vi{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(Vi.prototype);return t.__wbg_ptr=e,Ui.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Ui.unregister(this),e}free(){const e=this.__destroy_into_raw();hi.__wbg_wbg_rayon_poolbuilder_free(e)}numThreads(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),hi.wbg_rayon_poolbuilder_numThreads(this.__wbg_ptr)>>>0}receiver(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return wi(this.__wbg_ptr),hi.wbg_rayon_poolbuilder_receiver(this.__wbg_ptr)>>>0}build(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");wi(this.__wbg_ptr),hi.wbg_rayon_poolbuilder_build(this.__wbg_ptr)}}function Wi(){const e={wbg:{}};return e.wbg.__wbindgen_object_drop_ref=function(e){mi(e)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){return Ii((function(){return pi(new Error)}),arguments)},e.wbg.__wbg_stack_658279fe44541cf6=function(){return Ii((function(e,t){const n=function(e,t,n){if("string"!=typeof e)throw new Error("expected a string argument, found "+typeof e);if(void 0===n){const n=Pi.encode(e),i=t(n.length,1)>>>0;return bi().subarray(i,i+n.length).set(n),Bi=n.length,i}let i=e.length,r=t(i,1)>>>0;const o=bi();let a=0;for(;a<i;a++){const t=e.charCodeAt(a);if(t>127)break;o[r+a]=t}if(a!==i){0!==a&&(e=e.slice(a)),r=n(r,i,i=a+3*e.length,1)>>>0;const t=bi().subarray(r+a,r+i),o=Si(e,t);if(o.read!==e.length)throw new Error("failed to pass whole string");a+=o.written,r=n(r,i,a,1)>>>0}return Bi=a,r}(ci(t).stack,hi.__wbindgen_malloc,hi.__wbindgen_realloc),i=Bi;Ei()[e/4+1]=i,Ei()[e/4+0]=n}),arguments)},e.wbg.__wbg_error_f851667af71bcfc6=function(){return Ii((function(e,t){let n,i;try{n=e,i=t,console.error(yi(e,t))}finally{hi.__wbindgen_free(n,i,1)}}),arguments)},e.wbg.__wbg_instanceof_Window_f401953a2cf86220=function(){return Ii((function(e){let t;try{t=ci(e)instanceof Window}catch(e){t=!1}const n=t;return _i(n),n}),arguments)},e.wbg.__wbg_newnoargs_e258087cd0daa0ea=function(){return Ii((function(e,t){return pi(new Function(yi(e,t)))}),arguments)},e.wbg.__wbg_call_27c0f87801dedf93=function(){return Ci((function(e,t){return pi(ci(e).call(ci(t)))}),arguments)},e.wbg.__wbindgen_object_clone_ref=function(e){return pi(ci(e))},e.wbg.__wbg_self_ce0dbfc45cf2f5be=function(){return Ci((function(){return pi(self.self)}),arguments)},e.wbg.__wbg_window_c6fb939a7f436783=function(){return Ci((function(){return pi(window.window)}),arguments)},e.wbg.__wbg_globalThis_d1e6af4856ba331b=function(){return Ci((function(){return pi(globalThis.globalThis)}),arguments)},e.wbg.__wbg_global_207b558942527489=function(){return Ci((function(){return pi(global.global)}),arguments)},e.wbg.__wbindgen_is_undefined=function(e){const t=void 0===ci(e);return _i(t),t},e.wbg.__wbindgen_throw=function(e,t){throw new Error(yi(e,t))},e.wbg.__wbindgen_module=function(){return pi(Ki.__wbindgen_wasm_module)},e.wbg.__wbindgen_memory=function(){return pi(hi.memory)},e.wbg.__wbg_startWorkers_2ee336a9694dda13=function(){return Ii((function(e,t,n){return pi(async function(e,t,n){if(0===n.numThreads())throw new Error("num_threads must be > 0.");const i={module:e,memory:t,receiver:n.receiver()};li=await Promise.all(Array.from({length:n.numThreads()},(async()=>{const e=new Worker(new URL(We.p+We.u(649),We.b),{type:void 0});return e.postMessage(i),await new Promise((t=>e.addEventListener("message",t,{once:!0}))),e}))),n.build()}(mi(e),mi(t),Vi.__wrap(n)))}),arguments)},e}function zi(e,t){e.wbg.memory=t||new WebAssembly.Memory({initial:19,maximum:16384,shared:!0})}function ji(e,t){return hi=e.exports,Ki.__wbindgen_wasm_module=t,Ri=null,fi=null,hi.__wbindgen_start(),hi}function qi(e,t){if(void 0!==hi)return hi;const n=Wi();return zi(n,t),e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),ji(new WebAssembly.Instance(e,n),e)}async function Ki(e,t){if(void 0!==hi)return hi;void 0===e&&(e=new URL(We(858),We.b));const n=Wi();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e)),zi(n,t);const{instance:i,module:r}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,n);return ji(i,r)}const Gi=Ki;class Yi{getWasmInstanceInner(){return je}}let Qi,Hi;const $i=new Array(128).fill(void 0);function Xi(e){return $i[e]}$i.push(void 0,null,!0,!1);let Ji=$i.length;function Zi(e){const t=Xi(e);return function(e){e<132||($i[e]=Ji,Ji=e)}(e),t}function er(e){Ji===$i.length&&$i.push($i.length+1);const t=Ji;if(Ji=$i[t],"number"!=typeof Ji)throw new Error("corrupt heap");return $i[t]=e,t}function tr(e){if("boolean"!=typeof e)throw new Error("expected a boolean argument, found "+typeof e)}const nr="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&nr.decode();let ir=null;function rr(){return null!==ir&&ir.buffer===Hi.memory.buffer||(ir=new Uint8Array(Hi.memory.buffer)),ir}function or(e,t){return e>>>=0,nr.decode(rr().slice(e,e+t))}function ar(){Hi.init()}function sr(){const e=Hi.createMmdRuntime();return xr.__wrap(e)}function lr(){const e=Hi.createAnimationPool();return Mr.__wrap(e)}function hr(e){if("number"!=typeof e)throw new Error("expected a number argument, found "+typeof e)}function dr(e){return null==e}function cr(e,t){if(!(e instanceof t))throw new Error(`expected instance of ${t.name}`);return e.ptr}function ur(e,t){try{return e.apply(this,t)}catch(e){let t=function(){try{return e instanceof Error?`${e.message}\n\nStack:\n${e.stack}`:e.toString()}catch(e){return"<failed to stringify thrown value>"}}();throw console.error("wasm-bindgen: imported JS function that was not marked as `catch` threw an error:",t),e}}let mr=0;const pr="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},_r=function(e,t){const n=pr.encode(e);return t.set(n),{read:e.length,written:n.length}};let gr=null;function fr(){return null!==gr&&gr.buffer===Hi.memory.buffer||(gr=new Int32Array(Hi.memory.buffer)),gr}function br(e,t){try{return e.apply(this,t)}catch(e){Hi.__wbindgen_exn_store(er(e))}}function yr(e){return hr(e),Zi(Hi.initThreadPool(e))}function wr(e){hr(e),Hi.wbg_rayon_start_worker(e)}const Ar="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Hi.__wbg_animationpool_free(e>>>0)));class Mr{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(Mr.prototype);return t.__wbg_ptr=e,Ar.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Ar.unregister(this),e}free(){const e=this.__destroy_into_raw();Hi.__wbg_animationpool_free(e)}allocateLengthsBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),Hi.animationpool_allocateLengthsBuffer(this.__wbg_ptr,e)>>>0}deallocateLengthsBuffer(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_deallocateLengthsBuffer(this.__wbg_ptr,e,t)}createBoneTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_createBoneTracks(this.__wbg_ptr,e,t)>>>0}getBoneTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_getBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_getBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotationInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_getBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMovableBoneTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_createMovableBoneTracks(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_getMovableBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositions(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_getMovableBoneTrackPositions(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositionInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_getMovableBoneTrackPositionInterpolations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_getMovableBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotationInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_getMovableBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMorphTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_createMorphTracks(this.__wbg_ptr,e,t)>>>0}getMorphTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_getMorphTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMorphTrackWeights(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_getMorphTrackWeights(this.__wbg_ptr,e,t)>>>0}createAnimation(e,t,n,i,r,o,a,s){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),hr(n),hr(i),hr(r),hr(o),hr(a),hr(s),Hi.animationpool_createAnimation(this.__wbg_ptr,e,t,n,i,r,o,a,s)>>>0}getPropertyTrackFrameNumbers(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),Hi.animationpool_getPropertyTrackFrameNumbers(this.__wbg_ptr,e)>>>0}getPropertyTrackIkStates(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_getPropertyTrackIkStates(this.__wbg_ptr,e,t)>>>0}destroyAnimation(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),Hi.animationpool_destroyAnimation(this.__wbg_ptr,e)}createBoneBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),Hi.animationpool_createBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMovableBoneBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),Hi.animationpool_createMovableBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMorphBindIndexMap(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_createMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}getNthMorphBindIndexMap(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_getNthMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}createIkSolverBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),Hi.animationpool_createIkSolverBindIndexMap(this.__wbg_ptr,e)>>>0}createRuntimeAnimation(e,t,n,i,r){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),hr(n),hr(i),hr(r),Hi.animationpool_createRuntimeAnimation(this.__wbg_ptr,e,t,n,i,r)>>>0}destroyRuntimeAnimation(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),Hi.animationpool_destroyRuntimeAnimation(this.__wbg_ptr,e)}animateMmdModel(e,t,n){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),hr(t),Hi.animationpool_animateMmdModel(this.__wbg_ptr,e,t,n)}}const Tr="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Hi.__wbg_mmdruntime_free(e>>>0)));class xr{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(xr.prototype);return t.__wbg_ptr=e,Tr.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Tr.unregister(this),e}free(){const e=this.__destroy_into_raw();Hi.__wbg_mmdruntime_free(e)}allocateBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),Hi.mmdruntime_allocateBuffer(this.__wbg_ptr,e)>>>0}deallocateBuffer(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),hr(t),Hi.mmdruntime_deallocateBuffer(this.__wbg_ptr,e,t)}createMmdModel(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),hr(t),Hi.mmdruntime_createMmdModel(this.__wbg_ptr,e,t)>>>0}destroyMmdModel(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),Hi.mmdruntime_destroyMmdModel(this.__wbg_ptr,e)}getAnimationArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),Hi.mmdruntime_getAnimationArena(this.__wbg_ptr,e)>>>0}getAnimationIkSolverStateArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),Hi.mmdruntime_getAnimationIkSolverStateArena(this.__wbg_ptr,e)>>>0}getAnimationMorphArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),Hi.mmdruntime_getAnimationMorphArena(this.__wbg_ptr,e)>>>0}getBoneWorldMatrixArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),Hi.mmdruntime_getBoneWorldMatrixArena(this.__wbg_ptr,e)>>>0}createBoneWorldMatrixBackBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),Hi.mmdruntime_createBoneWorldMatrixBackBuffer(this.__wbg_ptr,e)>>>0}setRuntimeAnimation(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),hr(t),Hi.mmdruntime_setRuntimeAnimation(this.__wbg_ptr,e,t)}setExternalPhysics(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),tr(t),Hi.mmdruntime_setExternalPhysics(this.__wbg_ptr,e,t)}beforePhysics(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),dr(e)||hr(e),dr(t)||hr(t),Hi.mmdruntime_beforePhysics(this.__wbg_ptr,!dr(e),dr(e)?0:e,!dr(t),dr(t)?0:t)}afterPhysics(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),Hi.mmdruntime_afterPhysics(this.__wbg_ptr)}getLockStatePtr(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),Hi.mmdruntime_getLockStatePtr(this.__wbg_ptr)>>>0}swapWorldMatrixBuffer(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),Hi.mmdruntime_swapWorldMatrixBuffer(this.__wbg_ptr)}static bufferedBeforePhysics(e,t,n){if(cr(e,xr),0===e.__wbg_ptr)throw new Error("Attempt to use a moved value");dr(t)||hr(t),dr(n)||hr(n),Hi.mmdruntime_bufferedBeforePhysics(e.__wbg_ptr,!dr(t),dr(t)?0:t,!dr(n),dr(n)?0:n)}static bufferedUpdate(e,t,n){if(cr(e,xr),0===e.__wbg_ptr)throw new Error("Attempt to use a moved value");dr(t)||hr(t),dr(n)||hr(n),Hi.mmdruntime_bufferedUpdate(e.__wbg_ptr,!dr(t),dr(t)?0:t,!dr(n),dr(n)?0:n)}acquireDiagnosticErrorResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),Hi.mmdruntime_acquireDiagnosticErrorResult(this.__wbg_ptr)>>>0}acquireDiagnosticWarningResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),Hi.mmdruntime_acquireDiagnosticWarningResult(this.__wbg_ptr)>>>0}acquireDiagnosticInfoResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),Hi.mmdruntime_acquireDiagnosticInfoResult(this.__wbg_ptr)>>>0}releaseDiagnosticResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),Hi.mmdruntime_releaseDiagnosticResult(this.__wbg_ptr)}setPhysicsMaxSubSteps(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),Hi.mmdruntime_setPhysicsMaxSubSteps(this.__wbg_ptr,e)}setPhysicsFixedTimeStep(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),Hi.mmdruntime_setPhysicsFixedTimeStep(this.__wbg_ptr,e)}setPhysicsGravity(e,t,n){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),Hi.mmdruntime_setPhysicsGravity(this.__wbg_ptr,e,t,n)}getPhysicsGravity(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),Hi.mmdruntime_getPhysicsGravity(this.__wbg_ptr)>>>0}overridePhysicsGravity(e,t,n,i){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),Hi.mmdruntime_overridePhysicsGravity(this.__wbg_ptr,e,t,n,i)}restorePhysicsGravity(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),Hi.mmdruntime_restorePhysicsGravity(this.__wbg_ptr,e)}getPhysicsWorldGravity(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),hr(e),Hi.mmdruntime_getPhysicsWorldGravity(this.__wbg_ptr,e)>>>0}setMmdModelWorldMatrix(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),hr(t),Hi.mmdruntime_setMmdModelWorldMatrix(this.__wbg_ptr,e,t)}markMmdModelPhysicsAsNeedInit(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),hr(e),Hi.mmdruntime_markMmdModelPhysicsAsNeedInit(this.__wbg_ptr,e)}}const vr="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Hi.__wbg_wbg_rayon_poolbuilder_free(e>>>0)));class Ir{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(Ir.prototype);return t.__wbg_ptr=e,vr.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,vr.unregister(this),e}free(){const e=this.__destroy_into_raw();Hi.__wbg_wbg_rayon_poolbuilder_free(e)}numThreads(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),Hi.wbg_rayon_poolbuilder_numThreads(this.__wbg_ptr)>>>0}receiver(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return hr(this.__wbg_ptr),Hi.wbg_rayon_poolbuilder_receiver(this.__wbg_ptr)>>>0}build(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");hr(this.__wbg_ptr),Hi.wbg_rayon_poolbuilder_build(this.__wbg_ptr)}}function Br(){const e={wbg:{}};return e.wbg.__wbindgen_object_drop_ref=function(e){Zi(e)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){return ur((function(){return er(new Error)}),arguments)},e.wbg.__wbg_stack_658279fe44541cf6=function(){return ur((function(e,t){const n=function(e,t,n){if("string"!=typeof e)throw new Error("expected a string argument, found "+typeof e);if(void 0===n){const n=pr.encode(e),i=t(n.length,1)>>>0;return rr().subarray(i,i+n.length).set(n),mr=n.length,i}let i=e.length,r=t(i,1)>>>0;const o=rr();let a=0;for(;a<i;a++){const t=e.charCodeAt(a);if(t>127)break;o[r+a]=t}if(a!==i){0!==a&&(e=e.slice(a)),r=n(r,i,i=a+3*e.length,1)>>>0;const t=rr().subarray(r+a,r+i),o=_r(e,t);if(o.read!==e.length)throw new Error("failed to pass whole string");a+=o.written,r=n(r,i,a,1)>>>0}return mr=a,r}(Xi(t).stack,Hi.__wbindgen_malloc,Hi.__wbindgen_realloc),i=mr;fr()[e/4+1]=i,fr()[e/4+0]=n}),arguments)},e.wbg.__wbg_error_f851667af71bcfc6=function(){return ur((function(e,t){let n,i;try{n=e,i=t,console.error(or(e,t))}finally{Hi.__wbindgen_free(n,i,1)}}),arguments)},e.wbg.__wbg_instanceof_Window_f401953a2cf86220=function(){return ur((function(e){let t;try{t=Xi(e)instanceof Window}catch(e){t=!1}const n=t;return tr(n),n}),arguments)},e.wbg.__wbg_newnoargs_e258087cd0daa0ea=function(){return ur((function(e,t){return er(new Function(or(e,t)))}),arguments)},e.wbg.__wbg_call_27c0f87801dedf93=function(){return br((function(e,t){return er(Xi(e).call(Xi(t)))}),arguments)},e.wbg.__wbindgen_object_clone_ref=function(e){return er(Xi(e))},e.wbg.__wbg_self_ce0dbfc45cf2f5be=function(){return br((function(){return er(self.self)}),arguments)},e.wbg.__wbg_window_c6fb939a7f436783=function(){return br((function(){return er(window.window)}),arguments)},e.wbg.__wbg_globalThis_d1e6af4856ba331b=function(){return br((function(){return er(globalThis.globalThis)}),arguments)},e.wbg.__wbg_global_207b558942527489=function(){return br((function(){return er(global.global)}),arguments)},e.wbg.__wbindgen_is_undefined=function(e){const t=void 0===Xi(e);return tr(t),t},e.wbg.__wbindgen_throw=function(e,t){throw new Error(or(e,t))},e.wbg.__wbindgen_module=function(){return er(Er.__wbindgen_wasm_module)},e.wbg.__wbindgen_memory=function(){return er(Hi.memory)},e.wbg.__wbg_startWorkers_2ee336a9694dda13=function(){return ur((function(e,t,n){return er(async function(e,t,n){if(0===n.numThreads())throw new Error("num_threads must be > 0.");const i={module:e,memory:t,receiver:n.receiver()};Qi=await Promise.all(Array.from({length:n.numThreads()},(async()=>{const e=new Worker(new URL(We.p+We.u(975),We.b),{type:void 0});return e.postMessage(i),await new Promise((t=>e.addEventListener("message",t,{once:!0}))),e}))),n.build()}(Zi(e),Zi(t),Ir.__wrap(n)))}),arguments)},e}function Pr(e,t){e.wbg.memory=t||new WebAssembly.Memory({initial:19,maximum:16384,shared:!0})}function Sr(e,t){return Hi=e.exports,Er.__wbindgen_wasm_module=t,gr=null,ir=null,Hi.__wbindgen_start(),Hi}function Rr(e,t){if(void 0!==Hi)return Hi;const n=Br();return Pr(n,t),e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),Sr(new WebAssembly.Instance(e,n),e)}async function Er(e,t){if(void 0!==Hi)return Hi;void 0===e&&(e=new URL(We(1072),We.b));const n=Br();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e)),Pr(n,t);const{instance:i,module:r}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,n);return Sr(i,r)}const Cr=Er;class Or{getWasmInstanceInner(){return qe}}let kr,Fr;const Nr=new Array(128).fill(void 0);function Dr(e){return Nr[e]}Nr.push(void 0,null,!0,!1);let Lr=Nr.length;function Ur(e){const t=Dr(e);return function(e){e<132||(Nr[e]=Lr,Lr=e)}(e),t}function Vr(e){Lr===Nr.length&&Nr.push(Nr.length+1);const t=Lr;return Lr=Nr[t],Nr[t]=e,t}const Wr="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&Wr.decode();let zr=null;function jr(e,t){return e>>>=0,Wr.decode((null!==zr&&zr.buffer===Fr.memory.buffer||(zr=new Uint8Array(Fr.memory.buffer)),zr).slice(e,e+t))}function qr(e){return null==e}function Kr(e,t){if(!(e instanceof t))throw new Error(`expected instance of ${t.name}`);return e.ptr}function Gr(){Fr.init()}function Yr(){const e=Fr.createMmdRuntime();return to.__wrap(e)}function Qr(){const e=Fr.createAnimationPool();return Zr.__wrap(e)}function Hr(e,t){try{return e.apply(this,t)}catch(e){Fr.__wbindgen_exn_store(Vr(e))}}function $r(e){return Ur(Fr.initThreadPool(e))}function Xr(e){Fr.wbg_rayon_start_worker(e)}const Jr="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Fr.__wbg_animationpool_free(e>>>0)));class Zr{static __wrap(e){e>>>=0;const t=Object.create(Zr.prototype);return t.__wbg_ptr=e,Jr.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Jr.unregister(this),e}free(){const e=this.__destroy_into_raw();Fr.__wbg_animationpool_free(e)}allocateLengthsBuffer(e){return Fr.animationpool_allocateLengthsBuffer(this.__wbg_ptr,e)>>>0}deallocateLengthsBuffer(e,t){Fr.animationpool_deallocateLengthsBuffer(this.__wbg_ptr,e,t)}createBoneTracks(e,t){return Fr.animationpool_createBoneTracks(this.__wbg_ptr,e,t)>>>0}getBoneTrackFrameNumbers(e,t){return Fr.animationpool_getBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotations(e,t){return Fr.animationpool_getBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotationInterpolations(e,t){return Fr.animationpool_getBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMovableBoneTracks(e,t){return Fr.animationpool_createMovableBoneTracks(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackFrameNumbers(e,t){return Fr.animationpool_getMovableBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositions(e,t){return Fr.animationpool_getMovableBoneTrackPositions(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositionInterpolations(e,t){return Fr.animationpool_getMovableBoneTrackPositionInterpolations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotations(e,t){return Fr.animationpool_getMovableBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotationInterpolations(e,t){return Fr.animationpool_getMovableBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMorphTracks(e,t){return Fr.animationpool_createMorphTracks(this.__wbg_ptr,e,t)>>>0}getMorphTrackFrameNumbers(e,t){return Fr.animationpool_getMorphTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMorphTrackWeights(e,t){return Fr.animationpool_getMorphTrackWeights(this.__wbg_ptr,e,t)>>>0}createAnimation(e,t,n,i,r,o,a,s){return Fr.animationpool_createAnimation(this.__wbg_ptr,e,t,n,i,r,o,a,s)>>>0}getPropertyTrackFrameNumbers(e){return Fr.animationpool_getPropertyTrackFrameNumbers(this.__wbg_ptr,e)>>>0}getPropertyTrackIkStates(e,t){return Fr.animationpool_getPropertyTrackIkStates(this.__wbg_ptr,e,t)>>>0}destroyAnimation(e){Fr.animationpool_destroyAnimation(this.__wbg_ptr,e)}createBoneBindIndexMap(e){return Fr.animationpool_createBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMovableBoneBindIndexMap(e){return Fr.animationpool_createMovableBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMorphBindIndexMap(e,t){return Fr.animationpool_createMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}getNthMorphBindIndexMap(e,t){return Fr.animationpool_getNthMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}createIkSolverBindIndexMap(e){return Fr.animationpool_createIkSolverBindIndexMap(this.__wbg_ptr,e)>>>0}createRuntimeAnimation(e,t,n,i,r){return Fr.animationpool_createRuntimeAnimation(this.__wbg_ptr,e,t,n,i,r)>>>0}destroyRuntimeAnimation(e){Fr.animationpool_destroyRuntimeAnimation(this.__wbg_ptr,e)}animateMmdModel(e,t,n){Fr.animationpool_animateMmdModel(this.__wbg_ptr,e,t,n)}}const eo="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Fr.__wbg_mmdruntime_free(e>>>0)));class to{static __wrap(e){e>>>=0;const t=Object.create(to.prototype);return t.__wbg_ptr=e,eo.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,eo.unregister(this),e}free(){const e=this.__destroy_into_raw();Fr.__wbg_mmdruntime_free(e)}allocateBuffer(e){return Fr.mmdruntime_allocateBuffer(this.__wbg_ptr,e)>>>0}deallocateBuffer(e,t){Fr.mmdruntime_deallocateBuffer(this.__wbg_ptr,e,t)}createMmdModel(e,t){return Fr.mmdruntime_createMmdModel(this.__wbg_ptr,e,t)>>>0}destroyMmdModel(e){Fr.mmdruntime_destroyMmdModel(this.__wbg_ptr,e)}getAnimationArena(e){return Fr.mmdruntime_getAnimationArena(this.__wbg_ptr,e)>>>0}getAnimationIkSolverStateArena(e){return Fr.mmdruntime_getAnimationIkSolverStateArena(this.__wbg_ptr,e)>>>0}getAnimationMorphArena(e){return Fr.mmdruntime_getAnimationMorphArena(this.__wbg_ptr,e)>>>0}getBoneWorldMatrixArena(e){return Fr.mmdruntime_getBoneWorldMatrixArena(this.__wbg_ptr,e)>>>0}createBoneWorldMatrixBackBuffer(e){return Fr.mmdruntime_createBoneWorldMatrixBackBuffer(this.__wbg_ptr,e)>>>0}setRuntimeAnimation(e,t){Fr.mmdruntime_setRuntimeAnimation(this.__wbg_ptr,e,t)}setExternalPhysics(e,t){Fr.mmdruntime_setExternalPhysics(this.__wbg_ptr,e,t)}beforePhysics(e,t){Fr.mmdruntime_beforePhysics(this.__wbg_ptr,!qr(e),qr(e)?0:e,!qr(t),qr(t)?0:t)}afterPhysics(){Fr.mmdruntime_afterPhysics(this.__wbg_ptr)}getLockStatePtr(){return Fr.mmdruntime_getLockStatePtr(this.__wbg_ptr)>>>0}swapWorldMatrixBuffer(){Fr.mmdruntime_swapWorldMatrixBuffer(this.__wbg_ptr)}static bufferedBeforePhysics(e,t,n){Kr(e,to),Fr.mmdruntime_bufferedBeforePhysics(e.__wbg_ptr,!qr(t),qr(t)?0:t,!qr(n),qr(n)?0:n)}static bufferedUpdate(e,t,n){Kr(e,to),Fr.mmdruntime_bufferedUpdate(e.__wbg_ptr,!qr(t),qr(t)?0:t,!qr(n),qr(n)?0:n)}acquireDiagnosticErrorResult(){return Fr.mmdruntime_acquireDiagnosticErrorResult(this.__wbg_ptr)>>>0}acquireDiagnosticWarningResult(){return Fr.mmdruntime_acquireDiagnosticWarningResult(this.__wbg_ptr)>>>0}acquireDiagnosticInfoResult(){return Fr.mmdruntime_acquireDiagnosticInfoResult(this.__wbg_ptr)>>>0}releaseDiagnosticResult(){Fr.mmdruntime_releaseDiagnosticResult(this.__wbg_ptr)}setPhysicsMaxSubSteps(e){Fr.mmdruntime_setPhysicsMaxSubSteps(this.__wbg_ptr,e)}setPhysicsFixedTimeStep(e){Fr.mmdruntime_setPhysicsFixedTimeStep(this.__wbg_ptr,e)}setPhysicsGravity(e,t,n){Fr.mmdruntime_setPhysicsGravity(this.__wbg_ptr,e,t,n)}getPhysicsGravity(){return Fr.mmdruntime_getPhysicsGravity(this.__wbg_ptr)>>>0}overridePhysicsGravity(e,t,n,i){Fr.mmdruntime_overridePhysicsGravity(this.__wbg_ptr,e,t,n,i)}restorePhysicsGravity(e){Fr.mmdruntime_restorePhysicsGravity(this.__wbg_ptr,e)}getPhysicsWorldGravity(e){return Fr.mmdruntime_getPhysicsWorldGravity(this.__wbg_ptr,e)>>>0}setMmdModelWorldMatrix(e,t){Fr.mmdruntime_setMmdModelWorldMatrix(this.__wbg_ptr,e,t)}markMmdModelPhysicsAsNeedInit(e){Fr.mmdruntime_markMmdModelPhysicsAsNeedInit(this.__wbg_ptr,e)}}const no="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Fr.__wbg_wbg_rayon_poolbuilder_free(e>>>0)));class io{static __wrap(e){e>>>=0;const t=Object.create(io.prototype);return t.__wbg_ptr=e,no.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,no.unregister(this),e}free(){const e=this.__destroy_into_raw();Fr.__wbg_wbg_rayon_poolbuilder_free(e)}numThreads(){return Fr.wbg_rayon_poolbuilder_numThreads(this.__wbg_ptr)>>>0}receiver(){return Fr.wbg_rayon_poolbuilder_receiver(this.__wbg_ptr)>>>0}build(){Fr.wbg_rayon_poolbuilder_build(this.__wbg_ptr)}}function ro(){const e={wbg:{}};return e.wbg.__wbindgen_object_drop_ref=function(e){Ur(e)},e.wbg.__wbg_instanceof_Window_f401953a2cf86220=function(e){let t;try{t=Dr(e)instanceof Window}catch(e){t=!1}return t},e.wbg.__wbg_newnoargs_e258087cd0daa0ea=function(e,t){return Vr(new Function(jr(e,t)))},e.wbg.__wbg_call_27c0f87801dedf93=function(){return Hr((function(e,t){return Vr(Dr(e).call(Dr(t)))}),arguments)},e.wbg.__wbindgen_object_clone_ref=function(e){return Vr(Dr(e))},e.wbg.__wbg_self_ce0dbfc45cf2f5be=function(){return Hr((function(){return Vr(self.self)}),arguments)},e.wbg.__wbg_window_c6fb939a7f436783=function(){return Hr((function(){return Vr(window.window)}),arguments)},e.wbg.__wbg_globalThis_d1e6af4856ba331b=function(){return Hr((function(){return Vr(globalThis.globalThis)}),arguments)},e.wbg.__wbg_global_207b558942527489=function(){return Hr((function(){return Vr(global.global)}),arguments)},e.wbg.__wbindgen_is_undefined=function(e){return void 0===Dr(e)},e.wbg.__wbindgen_throw=function(e,t){throw new Error(jr(e,t))},e.wbg.__wbindgen_module=function(){return Vr(lo.__wbindgen_wasm_module)},e.wbg.__wbindgen_memory=function(){return Vr(Fr.memory)},e.wbg.__wbg_startWorkers_2ee336a9694dda13=function(e,t,n){return Vr(async function(e,t,n){if(0===n.numThreads())throw new Error("num_threads must be > 0.");const i={module:e,memory:t,receiver:n.receiver()};kr=await Promise.all(Array.from({length:n.numThreads()},(async()=>{const e=new Worker(new URL(We.p+We.u(821),We.b),{type:void 0});return e.postMessage(i),await new Promise((t=>e.addEventListener("message",t,{once:!0}))),e}))),n.build()}(Ur(e),Ur(t),io.__wrap(n)))},e}function oo(e,t){e.wbg.memory=t||new WebAssembly.Memory({initial:18,maximum:16384,shared:!0})}function ao(e,t){return Fr=e.exports,lo.__wbindgen_wasm_module=t,zr=null,Fr.__wbindgen_start(),Fr}function so(e,t){if(void 0!==Fr)return Fr;const n=ro();return oo(n,t),e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),ao(new WebAssembly.Instance(e,n),e)}async function lo(e,t){if(void 0!==Fr)return Fr;void 0===e&&(e=new URL(We(7110),We.b));const n=ro();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e)),oo(n,t);const{instance:i,module:r}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,n);return ao(i,r)}const ho=lo;class co{getWasmInstanceInner(){return Ke}}let uo,mo;const po=new Array(128).fill(void 0);function _o(e){return po[e]}po.push(void 0,null,!0,!1);let go=po.length;function fo(e){const t=_o(e);return function(e){e<132||(po[e]=go,go=e)}(e),t}function bo(e){go===po.length&&po.push(po.length+1);const t=go;return go=po[t],po[t]=e,t}const yo="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&yo.decode();let wo=null;function Ao(e,t){return e>>>=0,yo.decode((null!==wo&&wo.buffer===mo.memory.buffer||(wo=new Uint8Array(mo.memory.buffer)),wo).slice(e,e+t))}function Mo(){mo.init()}function To(){const e=mo.createMmdRuntime();return Oo.__wrap(e)}function xo(){const e=mo.createAnimationPool();return Eo.__wrap(e)}function vo(e){return null==e}function Io(e,t){if(!(e instanceof t))throw new Error(`expected instance of ${t.name}`);return e.ptr}function Bo(e,t){try{return e.apply(this,t)}catch(e){mo.__wbindgen_exn_store(bo(e))}}function Po(e){return fo(mo.initThreadPool(e))}function So(e){mo.wbg_rayon_start_worker(e)}const Ro="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>mo.__wbg_animationpool_free(e>>>0)));class Eo{static __wrap(e){e>>>=0;const t=Object.create(Eo.prototype);return t.__wbg_ptr=e,Ro.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Ro.unregister(this),e}free(){const e=this.__destroy_into_raw();mo.__wbg_animationpool_free(e)}allocateLengthsBuffer(e){return mo.animationpool_allocateLengthsBuffer(this.__wbg_ptr,e)>>>0}deallocateLengthsBuffer(e,t){mo.animationpool_deallocateLengthsBuffer(this.__wbg_ptr,e,t)}createBoneTracks(e,t){return mo.animationpool_createBoneTracks(this.__wbg_ptr,e,t)>>>0}getBoneTrackFrameNumbers(e,t){return mo.animationpool_getBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotations(e,t){return mo.animationpool_getBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotationInterpolations(e,t){return mo.animationpool_getBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMovableBoneTracks(e,t){return mo.animationpool_createMovableBoneTracks(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackFrameNumbers(e,t){return mo.animationpool_getMovableBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositions(e,t){return mo.animationpool_getMovableBoneTrackPositions(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositionInterpolations(e,t){return mo.animationpool_getMovableBoneTrackPositionInterpolations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotations(e,t){return mo.animationpool_getMovableBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotationInterpolations(e,t){return mo.animationpool_getMovableBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMorphTracks(e,t){return mo.animationpool_createMorphTracks(this.__wbg_ptr,e,t)>>>0}getMorphTrackFrameNumbers(e,t){return mo.animationpool_getMorphTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMorphTrackWeights(e,t){return mo.animationpool_getMorphTrackWeights(this.__wbg_ptr,e,t)>>>0}createAnimation(e,t,n,i,r,o,a,s){return mo.animationpool_createAnimation(this.__wbg_ptr,e,t,n,i,r,o,a,s)>>>0}getPropertyTrackFrameNumbers(e){return mo.animationpool_getPropertyTrackFrameNumbers(this.__wbg_ptr,e)>>>0}getPropertyTrackIkStates(e,t){return mo.animationpool_getPropertyTrackIkStates(this.__wbg_ptr,e,t)>>>0}destroyAnimation(e){mo.animationpool_destroyAnimation(this.__wbg_ptr,e)}createBoneBindIndexMap(e){return mo.animationpool_createBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMovableBoneBindIndexMap(e){return mo.animationpool_createMovableBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMorphBindIndexMap(e,t){return mo.animationpool_createMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}getNthMorphBindIndexMap(e,t){return mo.animationpool_getNthMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}createIkSolverBindIndexMap(e){return mo.animationpool_createIkSolverBindIndexMap(this.__wbg_ptr,e)>>>0}createRuntimeAnimation(e,t,n,i,r){return mo.animationpool_createRuntimeAnimation(this.__wbg_ptr,e,t,n,i,r)>>>0}destroyRuntimeAnimation(e){mo.animationpool_destroyRuntimeAnimation(this.__wbg_ptr,e)}animateMmdModel(e,t,n){mo.animationpool_animateMmdModel(this.__wbg_ptr,e,t,n)}}const Co="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>mo.__wbg_mmdruntime_free(e>>>0)));class Oo{static __wrap(e){e>>>=0;const t=Object.create(Oo.prototype);return t.__wbg_ptr=e,Co.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Co.unregister(this),e}free(){const e=this.__destroy_into_raw();mo.__wbg_mmdruntime_free(e)}allocateBuffer(e){return mo.mmdruntime_allocateBuffer(this.__wbg_ptr,e)>>>0}deallocateBuffer(e,t){mo.mmdruntime_deallocateBuffer(this.__wbg_ptr,e,t)}createMmdModel(e,t){return mo.mmdruntime_createMmdModel(this.__wbg_ptr,e,t)>>>0}destroyMmdModel(e){mo.mmdruntime_destroyMmdModel(this.__wbg_ptr,e)}getAnimationArena(e){return mo.mmdruntime_getAnimationArena(this.__wbg_ptr,e)>>>0}getAnimationIkSolverStateArena(e){return mo.mmdruntime_getAnimationIkSolverStateArena(this.__wbg_ptr,e)>>>0}getAnimationMorphArena(e){return mo.mmdruntime_getAnimationMorphArena(this.__wbg_ptr,e)>>>0}getBoneWorldMatrixArena(e){return mo.mmdruntime_getBoneWorldMatrixArena(this.__wbg_ptr,e)>>>0}createBoneWorldMatrixBackBuffer(e){return mo.mmdruntime_createBoneWorldMatrixBackBuffer(this.__wbg_ptr,e)>>>0}setRuntimeAnimation(e,t){mo.mmdruntime_setRuntimeAnimation(this.__wbg_ptr,e,t)}setExternalPhysics(e,t){mo.mmdruntime_setExternalPhysics(this.__wbg_ptr,e,t)}beforePhysics(e){mo.mmdruntime_beforePhysics(this.__wbg_ptr,!vo(e),vo(e)?0:e)}afterPhysics(){mo.mmdruntime_afterPhysics(this.__wbg_ptr)}getLockStatePtr(){return mo.mmdruntime_getLockStatePtr(this.__wbg_ptr)>>>0}swapWorldMatrixBuffer(){mo.mmdruntime_swapWorldMatrixBuffer(this.__wbg_ptr)}static bufferedBeforePhysics(e,t){Io(e,Oo),mo.mmdruntime_bufferedBeforePhysics(e.__wbg_ptr,!vo(t),vo(t)?0:t)}static bufferedUpdate(e,t){Io(e,Oo),mo.mmdruntime_bufferedUpdate(e.__wbg_ptr,!vo(t),vo(t)?0:t)}acquireDiagnosticErrorResult(){return mo.mmdruntime_acquireDiagnosticErrorResult(this.__wbg_ptr)>>>0}acquireDiagnosticWarningResult(){return mo.mmdruntime_acquireDiagnosticWarningResult(this.__wbg_ptr)>>>0}acquireDiagnosticInfoResult(){return mo.mmdruntime_acquireDiagnosticInfoResult(this.__wbg_ptr)>>>0}releaseDiagnosticResult(){mo.mmdruntime_releaseDiagnosticResult(this.__wbg_ptr)}}const ko="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>mo.__wbg_wbg_rayon_poolbuilder_free(e>>>0)));class Fo{static __wrap(e){e>>>=0;const t=Object.create(Fo.prototype);return t.__wbg_ptr=e,ko.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,ko.unregister(this),e}free(){const e=this.__destroy_into_raw();mo.__wbg_wbg_rayon_poolbuilder_free(e)}numThreads(){return mo.wbg_rayon_poolbuilder_numThreads(this.__wbg_ptr)>>>0}receiver(){return mo.wbg_rayon_poolbuilder_receiver(this.__wbg_ptr)>>>0}build(){mo.wbg_rayon_poolbuilder_build(this.__wbg_ptr)}}function No(){const e={wbg:{}};return e.wbg.__wbindgen_object_drop_ref=function(e){fo(e)},e.wbg.__wbg_instanceof_Window_f401953a2cf86220=function(e){let t;try{t=_o(e)instanceof Window}catch(e){t=!1}return t},e.wbg.__wbg_newnoargs_e258087cd0daa0ea=function(e,t){return bo(new Function(Ao(e,t)))},e.wbg.__wbg_call_27c0f87801dedf93=function(){return Bo((function(e,t){return bo(_o(e).call(_o(t)))}),arguments)},e.wbg.__wbindgen_object_clone_ref=function(e){return bo(_o(e))},e.wbg.__wbg_self_ce0dbfc45cf2f5be=function(){return Bo((function(){return bo(self.self)}),arguments)},e.wbg.__wbg_window_c6fb939a7f436783=function(){return Bo((function(){return bo(window.window)}),arguments)},e.wbg.__wbg_globalThis_d1e6af4856ba331b=function(){return Bo((function(){return bo(globalThis.globalThis)}),arguments)},e.wbg.__wbg_global_207b558942527489=function(){return Bo((function(){return bo(global.global)}),arguments)},e.wbg.__wbindgen_is_undefined=function(e){return void 0===_o(e)},e.wbg.__wbindgen_throw=function(e,t){throw new Error(Ao(e,t))},e.wbg.__wbindgen_module=function(){return bo(Vo.__wbindgen_wasm_module)},e.wbg.__wbindgen_memory=function(){return bo(mo.memory)},e.wbg.__wbg_startWorkers_2ee336a9694dda13=function(e,t,n){return bo(async function(e,t,n){if(0===n.numThreads())throw new Error("num_threads must be > 0.");const i={module:e,memory:t,receiver:n.receiver()};uo=await Promise.all(Array.from({length:n.numThreads()},(async()=>{const e=new Worker(new URL(We.p+We.u(163),We.b),{type:void 0});return e.postMessage(i),await new Promise((t=>e.addEventListener("message",t,{once:!0}))),e}))),n.build()}(fo(e),fo(t),Fo.__wrap(n)))},e}function Do(e,t){e.wbg.memory=t||new WebAssembly.Memory({initial:18,maximum:16384,shared:!0})}function Lo(e,t){return mo=e.exports,Vo.__wbindgen_wasm_module=t,wo=null,mo.__wbindgen_start(),mo}function Uo(e,t){if(void 0!==mo)return mo;const n=No();return Do(n,t),e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),Lo(new WebAssembly.Instance(e,n),e)}async function Vo(e,t){if(void 0!==mo)return mo;void 0===e&&(e=new URL(We(2524),We.b));const n=No();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e)),Do(n,t);const{instance:i,module:r}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,n);return Lo(i,r)}const Wo=Vo;class zo{getWasmInstanceInner(){return Ge}}let jo;const qo=new Array(128).fill(void 0);function Ko(e){return qo[e]}qo.push(void 0,null,!0,!1);let Go=qo.length;const Yo="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&Yo.decode();let Qo=null;function Ho(){return null!==Qo&&0!==Qo.byteLength||(Qo=new Uint8Array(jo.memory.buffer)),Qo}function $o(e,t){return e>>>=0,Yo.decode(Ho().subarray(e,e+t))}function Xo(){jo.init()}function Jo(){const e=jo.createMmdRuntime();return ca.__wrap(e)}function Zo(){const e=jo.createAnimationPool();return ha.__wrap(e)}function ea(e){if("number"!=typeof e)throw new Error("expected a number argument, found "+typeof e)}function ta(e){return null==e}function na(e,t){try{return e.apply(this,t)}catch(e){let t=function(){try{return e instanceof Error?`${e.message}\n\nStack:\n${e.stack}`:e.toString()}catch(e){return"<failed to stringify thrown value>"}}();throw console.error("wasm-bindgen: imported JS function that was not marked as `catch` threw an error:",t),e}}let ia=0;const ra="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},oa="function"==typeof ra.encodeInto?function(e,t){return ra.encodeInto(e,t)}:function(e,t){const n=ra.encode(e);return t.set(n),{read:e.length,written:n.length}};let aa=null;function sa(){return null!==aa&&0!==aa.byteLength||(aa=new Int32Array(jo.memory.buffer)),aa}const la="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>jo.__wbg_animationpool_free(e>>>0)));class ha{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(ha.prototype);return t.__wbg_ptr=e,la.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,la.unregister(this),e}free(){const e=this.__destroy_into_raw();jo.__wbg_animationpool_free(e)}allocateLengthsBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),jo.animationpool_allocateLengthsBuffer(this.__wbg_ptr,e)>>>0}deallocateLengthsBuffer(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_deallocateLengthsBuffer(this.__wbg_ptr,e,t)}createBoneTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_createBoneTracks(this.__wbg_ptr,e,t)>>>0}getBoneTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_getBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_getBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotationInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_getBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMovableBoneTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_createMovableBoneTracks(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_getMovableBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositions(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_getMovableBoneTrackPositions(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositionInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_getMovableBoneTrackPositionInterpolations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_getMovableBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotationInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_getMovableBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMorphTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_createMorphTracks(this.__wbg_ptr,e,t)>>>0}getMorphTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_getMorphTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMorphTrackWeights(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_getMorphTrackWeights(this.__wbg_ptr,e,t)>>>0}createAnimation(e,t,n,i,r,o,a,s){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),ea(n),ea(i),ea(r),ea(o),ea(a),ea(s),jo.animationpool_createAnimation(this.__wbg_ptr,e,t,n,i,r,o,a,s)>>>0}getPropertyTrackFrameNumbers(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),jo.animationpool_getPropertyTrackFrameNumbers(this.__wbg_ptr,e)>>>0}getPropertyTrackIkStates(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_getPropertyTrackIkStates(this.__wbg_ptr,e,t)>>>0}destroyAnimation(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");ea(this.__wbg_ptr),ea(e),jo.animationpool_destroyAnimation(this.__wbg_ptr,e)}createBoneBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),jo.animationpool_createBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMovableBoneBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),jo.animationpool_createMovableBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMorphBindIndexMap(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_createMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}getNthMorphBindIndexMap(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_getNthMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}createIkSolverBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),jo.animationpool_createIkSolverBindIndexMap(this.__wbg_ptr,e)>>>0}createRuntimeAnimation(e,t,n,i,r){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),ea(n),ea(i),ea(r),jo.animationpool_createRuntimeAnimation(this.__wbg_ptr,e,t,n,i,r)>>>0}destroyRuntimeAnimation(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");ea(this.__wbg_ptr),ea(e),jo.animationpool_destroyRuntimeAnimation(this.__wbg_ptr,e)}animateMmdModel(e,t,n){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");ea(this.__wbg_ptr),ea(e),ea(t),jo.animationpool_animateMmdModel(this.__wbg_ptr,e,t,n)}}const da="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>jo.__wbg_mmdruntime_free(e>>>0)));class ca{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(ca.prototype);return t.__wbg_ptr=e,da.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,da.unregister(this),e}free(){const e=this.__destroy_into_raw();jo.__wbg_mmdruntime_free(e)}allocateBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),jo.mmdruntime_allocateBuffer(this.__wbg_ptr,e)>>>0}deallocateBuffer(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");ea(this.__wbg_ptr),ea(e),ea(t),jo.mmdruntime_deallocateBuffer(this.__wbg_ptr,e,t)}createMmdModel(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),ea(t),jo.mmdruntime_createMmdModel(this.__wbg_ptr,e,t)>>>0}destroyMmdModel(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");ea(this.__wbg_ptr),ea(e),jo.mmdruntime_destroyMmdModel(this.__wbg_ptr,e)}getAnimationArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),jo.mmdruntime_getAnimationArena(this.__wbg_ptr,e)>>>0}getAnimationIkSolverStateArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),jo.mmdruntime_getAnimationIkSolverStateArena(this.__wbg_ptr,e)>>>0}getAnimationMorphArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),jo.mmdruntime_getAnimationMorphArena(this.__wbg_ptr,e)>>>0}getBoneWorldMatrixArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),jo.mmdruntime_getBoneWorldMatrixArena(this.__wbg_ptr,e)>>>0}createBoneWorldMatrixBackBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),ea(e),jo.mmdruntime_createBoneWorldMatrixBackBuffer(this.__wbg_ptr,e)>>>0}setRuntimeAnimation(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");ea(this.__wbg_ptr),ea(e),ea(t),jo.mmdruntime_setRuntimeAnimation(this.__wbg_ptr,e,t)}setExternalPhysics(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");ea(this.__wbg_ptr),ea(e),function(e){if("boolean"!=typeof e)throw new Error("expected a boolean argument, found "+typeof e)}(t),jo.mmdruntime_setExternalPhysics(this.__wbg_ptr,e,t)}beforePhysics(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");ea(this.__wbg_ptr),ta(e)||ea(e),jo.mmdruntime_beforePhysics(this.__wbg_ptr,!ta(e),ta(e)?0:e)}afterPhysics(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");ea(this.__wbg_ptr),jo.mmdruntime_afterPhysics(this.__wbg_ptr)}getLockStatePtr(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),jo.mmdruntime_getLockStatePtr(this.__wbg_ptr)>>>0}swapWorldMatrixBuffer(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");ea(this.__wbg_ptr),jo.mmdruntime_swapWorldMatrixBuffer(this.__wbg_ptr)}acquireDiagnosticErrorResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),jo.mmdruntime_acquireDiagnosticErrorResult(this.__wbg_ptr)>>>0}acquireDiagnosticWarningResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),jo.mmdruntime_acquireDiagnosticWarningResult(this.__wbg_ptr)>>>0}acquireDiagnosticInfoResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return ea(this.__wbg_ptr),jo.mmdruntime_acquireDiagnosticInfoResult(this.__wbg_ptr)>>>0}releaseDiagnosticResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");ea(this.__wbg_ptr),jo.mmdruntime_releaseDiagnosticResult(this.__wbg_ptr)}}function ua(){const e={wbg:{}};return e.wbg.__wbindgen_object_drop_ref=function(e){!function(e){const t=Ko(e);(function(e){e<132||(qo[e]=Go,Go=e)})(e)}(e)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){return na((function(){return function(e){Go===qo.length&&qo.push(qo.length+1);const t=Go;if(Go=qo[t],"number"!=typeof Go)throw new Error("corrupt heap");return qo[t]=e,t}(new Error)}),arguments)},e.wbg.__wbg_stack_658279fe44541cf6=function(){return na((function(e,t){const n=function(e,t,n){if("string"!=typeof e)throw new Error("expected a string argument, found "+typeof e);if(void 0===n){const n=ra.encode(e),i=t(n.length,1)>>>0;return Ho().subarray(i,i+n.length).set(n),ia=n.length,i}let i=e.length,r=t(i,1)>>>0;const o=Ho();let a=0;for(;a<i;a++){const t=e.charCodeAt(a);if(t>127)break;o[r+a]=t}if(a!==i){0!==a&&(e=e.slice(a)),r=n(r,i,i=a+3*e.length,1)>>>0;const t=Ho().subarray(r+a,r+i),o=oa(e,t);if(o.read!==e.length)throw new Error("failed to pass whole string");a+=o.written,r=n(r,i,a,1)>>>0}return ia=a,r}(Ko(t).stack,jo.__wbindgen_malloc,jo.__wbindgen_realloc),i=ia;sa()[e/4+1]=i,sa()[e/4+0]=n}),arguments)},e.wbg.__wbg_error_f851667af71bcfc6=function(){return na((function(e,t){let n,i;try{n=e,i=t,console.error($o(e,t))}finally{jo.__wbindgen_free(n,i,1)}}),arguments)},e.wbg.__wbindgen_throw=function(e,t){throw new Error($o(e,t))},e}function ma(e,t){return jo=e.exports,_a.__wbindgen_wasm_module=t,aa=null,Qo=null,jo}function pa(e){if(void 0!==jo)return jo;const t=ua();return e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),ma(new WebAssembly.Instance(e,t),e)}async function _a(e){if(void 0!==jo)return jo;void 0===e&&(e=new URL(We(7236),We.b));const t=ua();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:i}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,t);return ma(n,i)}const ga=_a;class fa{getWasmInstanceInner(){return Ye}}let ba;const ya=new Array(128).fill(void 0);function wa(e){return ya[e]}ya.push(void 0,null,!0,!1);let Aa=ya.length;const Ma="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&Ma.decode();let Ta=null;function xa(){return null!==Ta&&0!==Ta.byteLength||(Ta=new Uint8Array(ba.memory.buffer)),Ta}function va(e,t){return e>>>=0,Ma.decode(xa().subarray(e,e+t))}function Ia(e){if("number"!=typeof e)throw new Error("expected a number argument, found "+typeof e)}function Ba(e){return null==e}function Pa(){ba.init()}function Sa(){const e=ba.createMmdRuntime();return Va.__wrap(e)}function Ra(){const e=ba.createAnimationPool();return La.__wrap(e)}function Ea(e,t){try{return e.apply(this,t)}catch(e){let t=function(){try{return e instanceof Error?`${e.message}\n\nStack:\n${e.stack}`:e.toString()}catch(e){return"<failed to stringify thrown value>"}}();throw console.error("wasm-bindgen: imported JS function that was not marked as `catch` threw an error:",t),e}}let Ca=0;const Oa="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},ka="function"==typeof Oa.encodeInto?function(e,t){return Oa.encodeInto(e,t)}:function(e,t){const n=Oa.encode(e);return t.set(n),{read:e.length,written:n.length}};let Fa=null;function Na(){return null!==Fa&&0!==Fa.byteLength||(Fa=new Int32Array(ba.memory.buffer)),Fa}const Da="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>ba.__wbg_animationpool_free(e>>>0)));class La{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(La.prototype);return t.__wbg_ptr=e,Da.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Da.unregister(this),e}free(){const e=this.__destroy_into_raw();ba.__wbg_animationpool_free(e)}allocateLengthsBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),ba.animationpool_allocateLengthsBuffer(this.__wbg_ptr,e)>>>0}deallocateLengthsBuffer(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_deallocateLengthsBuffer(this.__wbg_ptr,e,t)}createBoneTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_createBoneTracks(this.__wbg_ptr,e,t)>>>0}getBoneTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_getBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_getBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotationInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_getBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMovableBoneTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_createMovableBoneTracks(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_getMovableBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositions(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_getMovableBoneTrackPositions(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositionInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_getMovableBoneTrackPositionInterpolations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_getMovableBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotationInterpolations(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_getMovableBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMorphTracks(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_createMorphTracks(this.__wbg_ptr,e,t)>>>0}getMorphTrackFrameNumbers(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_getMorphTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMorphTrackWeights(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_getMorphTrackWeights(this.__wbg_ptr,e,t)>>>0}createAnimation(e,t,n,i,r,o,a,s){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),Ia(n),Ia(i),Ia(r),Ia(o),Ia(a),Ia(s),ba.animationpool_createAnimation(this.__wbg_ptr,e,t,n,i,r,o,a,s)>>>0}getPropertyTrackFrameNumbers(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),ba.animationpool_getPropertyTrackFrameNumbers(this.__wbg_ptr,e)>>>0}getPropertyTrackIkStates(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_getPropertyTrackIkStates(this.__wbg_ptr,e,t)>>>0}destroyAnimation(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),ba.animationpool_destroyAnimation(this.__wbg_ptr,e)}createBoneBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),ba.animationpool_createBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMovableBoneBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),ba.animationpool_createMovableBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMorphBindIndexMap(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_createMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}getNthMorphBindIndexMap(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_getNthMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}createIkSolverBindIndexMap(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),ba.animationpool_createIkSolverBindIndexMap(this.__wbg_ptr,e)>>>0}createRuntimeAnimation(e,t,n,i,r){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),Ia(n),Ia(i),Ia(r),ba.animationpool_createRuntimeAnimation(this.__wbg_ptr,e,t,n,i,r)>>>0}destroyRuntimeAnimation(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),ba.animationpool_destroyRuntimeAnimation(this.__wbg_ptr,e)}animateMmdModel(e,t,n){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.animationpool_animateMmdModel(this.__wbg_ptr,e,t,n)}}const Ua="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>ba.__wbg_mmdruntime_free(e>>>0)));class Va{constructor(){throw new Error("cannot invoke `new` directly")}static __wrap(e){e>>>=0;const t=Object.create(Va.prototype);return t.__wbg_ptr=e,Ua.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,Ua.unregister(this),e}free(){const e=this.__destroy_into_raw();ba.__wbg_mmdruntime_free(e)}allocateBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),ba.mmdruntime_allocateBuffer(this.__wbg_ptr,e)>>>0}deallocateBuffer(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.mmdruntime_deallocateBuffer(this.__wbg_ptr,e,t)}createMmdModel(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.mmdruntime_createMmdModel(this.__wbg_ptr,e,t)>>>0}destroyMmdModel(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),ba.mmdruntime_destroyMmdModel(this.__wbg_ptr,e)}getAnimationArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),ba.mmdruntime_getAnimationArena(this.__wbg_ptr,e)>>>0}getAnimationIkSolverStateArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),ba.mmdruntime_getAnimationIkSolverStateArena(this.__wbg_ptr,e)>>>0}getAnimationMorphArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),ba.mmdruntime_getAnimationMorphArena(this.__wbg_ptr,e)>>>0}getBoneWorldMatrixArena(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),ba.mmdruntime_getBoneWorldMatrixArena(this.__wbg_ptr,e)>>>0}createBoneWorldMatrixBackBuffer(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),ba.mmdruntime_createBoneWorldMatrixBackBuffer(this.__wbg_ptr,e)>>>0}setRuntimeAnimation(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.mmdruntime_setRuntimeAnimation(this.__wbg_ptr,e,t)}setExternalPhysics(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),function(e){if("boolean"!=typeof e)throw new Error("expected a boolean argument, found "+typeof e)}(t),ba.mmdruntime_setExternalPhysics(this.__wbg_ptr,e,t)}beforePhysics(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ba(e)||Ia(e),Ba(t)||Ia(t),ba.mmdruntime_beforePhysics(this.__wbg_ptr,!Ba(e),Ba(e)?0:e,!Ba(t),Ba(t)?0:t)}afterPhysics(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),ba.mmdruntime_afterPhysics(this.__wbg_ptr)}getLockStatePtr(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),ba.mmdruntime_getLockStatePtr(this.__wbg_ptr)>>>0}swapWorldMatrixBuffer(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),ba.mmdruntime_swapWorldMatrixBuffer(this.__wbg_ptr)}acquireDiagnosticErrorResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),ba.mmdruntime_acquireDiagnosticErrorResult(this.__wbg_ptr)>>>0}acquireDiagnosticWarningResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),ba.mmdruntime_acquireDiagnosticWarningResult(this.__wbg_ptr)>>>0}acquireDiagnosticInfoResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),ba.mmdruntime_acquireDiagnosticInfoResult(this.__wbg_ptr)>>>0}releaseDiagnosticResult(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),ba.mmdruntime_releaseDiagnosticResult(this.__wbg_ptr)}setPhysicsMaxSubSteps(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),ba.mmdruntime_setPhysicsMaxSubSteps(this.__wbg_ptr,e)}setPhysicsFixedTimeStep(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),ba.mmdruntime_setPhysicsFixedTimeStep(this.__wbg_ptr,e)}setPhysicsGravity(e,t,n){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),ba.mmdruntime_setPhysicsGravity(this.__wbg_ptr,e,t,n)}getPhysicsGravity(){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),ba.mmdruntime_getPhysicsGravity(this.__wbg_ptr)>>>0}overridePhysicsGravity(e,t,n,i){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),ba.mmdruntime_overridePhysicsGravity(this.__wbg_ptr,e,t,n,i)}restorePhysicsGravity(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),ba.mmdruntime_restorePhysicsGravity(this.__wbg_ptr,e)}getPhysicsWorldGravity(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");return Ia(this.__wbg_ptr),Ia(e),ba.mmdruntime_getPhysicsWorldGravity(this.__wbg_ptr,e)>>>0}setMmdModelWorldMatrix(e,t){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),Ia(t),ba.mmdruntime_setMmdModelWorldMatrix(this.__wbg_ptr,e,t)}markMmdModelPhysicsAsNeedInit(e){if(0==this.__wbg_ptr)throw new Error("Attempt to use a moved value");Ia(this.__wbg_ptr),Ia(e),ba.mmdruntime_markMmdModelPhysicsAsNeedInit(this.__wbg_ptr,e)}}function Wa(){const e={wbg:{}};return e.wbg.__wbindgen_object_drop_ref=function(e){!function(e){const t=wa(e);(function(e){e<132||(ya[e]=Aa,Aa=e)})(e)}(e)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){return Ea((function(){return function(e){Aa===ya.length&&ya.push(ya.length+1);const t=Aa;if(Aa=ya[t],"number"!=typeof Aa)throw new Error("corrupt heap");return ya[t]=e,t}(new Error)}),arguments)},e.wbg.__wbg_stack_658279fe44541cf6=function(){return Ea((function(e,t){const n=function(e,t,n){if("string"!=typeof e)throw new Error("expected a string argument, found "+typeof e);if(void 0===n){const n=Oa.encode(e),i=t(n.length,1)>>>0;return xa().subarray(i,i+n.length).set(n),Ca=n.length,i}let i=e.length,r=t(i,1)>>>0;const o=xa();let a=0;for(;a<i;a++){const t=e.charCodeAt(a);if(t>127)break;o[r+a]=t}if(a!==i){0!==a&&(e=e.slice(a)),r=n(r,i,i=a+3*e.length,1)>>>0;const t=xa().subarray(r+a,r+i),o=ka(e,t);if(o.read!==e.length)throw new Error("failed to pass whole string");a+=o.written,r=n(r,i,a,1)>>>0}return Ca=a,r}(wa(t).stack,ba.__wbindgen_malloc,ba.__wbindgen_realloc),i=Ca;Na()[e/4+1]=i,Na()[e/4+0]=n}),arguments)},e.wbg.__wbg_error_f851667af71bcfc6=function(){return Ea((function(e,t){let n,i;try{n=e,i=t,console.error(va(e,t))}finally{ba.__wbindgen_free(n,i,1)}}),arguments)},e.wbg.__wbindgen_throw=function(e,t){throw new Error(va(e,t))},e}function za(e,t){return ba=e.exports,qa.__wbindgen_wasm_module=t,Fa=null,Ta=null,ba}function ja(e){if(void 0!==ba)return ba;const t=Wa();return e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),za(new WebAssembly.Instance(e,t),e)}async function qa(e){if(void 0!==ba)return ba;void 0===e&&(e=new URL(We(7518),We.b));const t=Wa();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:i}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,t);return za(n,i)}const Ka=qa;class Ga{getWasmInstanceInner(){return Qe}}let Ya;const Qa="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&Qa.decode();let Ha=null;function $a(){Ya.init()}function Xa(){const e=Ya.createMmdRuntime();return is.__wrap(e)}function Ja(){const e=Ya.createAnimationPool();return ts.__wrap(e)}function Za(e){return null==e}const es="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Ya.__wbg_animationpool_free(e>>>0)));class ts{static __wrap(e){e>>>=0;const t=Object.create(ts.prototype);return t.__wbg_ptr=e,es.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,es.unregister(this),e}free(){const e=this.__destroy_into_raw();Ya.__wbg_animationpool_free(e)}allocateLengthsBuffer(e){return Ya.animationpool_allocateLengthsBuffer(this.__wbg_ptr,e)>>>0}deallocateLengthsBuffer(e,t){Ya.animationpool_deallocateLengthsBuffer(this.__wbg_ptr,e,t)}createBoneTracks(e,t){return Ya.animationpool_createBoneTracks(this.__wbg_ptr,e,t)>>>0}getBoneTrackFrameNumbers(e,t){return Ya.animationpool_getBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotations(e,t){return Ya.animationpool_getBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotationInterpolations(e,t){return Ya.animationpool_getBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMovableBoneTracks(e,t){return Ya.animationpool_createMovableBoneTracks(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackFrameNumbers(e,t){return Ya.animationpool_getMovableBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositions(e,t){return Ya.animationpool_getMovableBoneTrackPositions(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositionInterpolations(e,t){return Ya.animationpool_getMovableBoneTrackPositionInterpolations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotations(e,t){return Ya.animationpool_getMovableBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotationInterpolations(e,t){return Ya.animationpool_getMovableBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMorphTracks(e,t){return Ya.animationpool_createMorphTracks(this.__wbg_ptr,e,t)>>>0}getMorphTrackFrameNumbers(e,t){return Ya.animationpool_getMorphTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMorphTrackWeights(e,t){return Ya.animationpool_getMorphTrackWeights(this.__wbg_ptr,e,t)>>>0}createAnimation(e,t,n,i,r,o,a,s){return Ya.animationpool_createAnimation(this.__wbg_ptr,e,t,n,i,r,o,a,s)>>>0}getPropertyTrackFrameNumbers(e){return Ya.animationpool_getPropertyTrackFrameNumbers(this.__wbg_ptr,e)>>>0}getPropertyTrackIkStates(e,t){return Ya.animationpool_getPropertyTrackIkStates(this.__wbg_ptr,e,t)>>>0}destroyAnimation(e){Ya.animationpool_destroyAnimation(this.__wbg_ptr,e)}createBoneBindIndexMap(e){return Ya.animationpool_createBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMovableBoneBindIndexMap(e){return Ya.animationpool_createMovableBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMorphBindIndexMap(e,t){return Ya.animationpool_createMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}getNthMorphBindIndexMap(e,t){return Ya.animationpool_getNthMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}createIkSolverBindIndexMap(e){return Ya.animationpool_createIkSolverBindIndexMap(this.__wbg_ptr,e)>>>0}createRuntimeAnimation(e,t,n,i,r){return Ya.animationpool_createRuntimeAnimation(this.__wbg_ptr,e,t,n,i,r)>>>0}destroyRuntimeAnimation(e){Ya.animationpool_destroyRuntimeAnimation(this.__wbg_ptr,e)}animateMmdModel(e,t,n){Ya.animationpool_animateMmdModel(this.__wbg_ptr,e,t,n)}}const ns="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>Ya.__wbg_mmdruntime_free(e>>>0)));class is{static __wrap(e){e>>>=0;const t=Object.create(is.prototype);return t.__wbg_ptr=e,ns.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,ns.unregister(this),e}free(){const e=this.__destroy_into_raw();Ya.__wbg_mmdruntime_free(e)}allocateBuffer(e){return Ya.mmdruntime_allocateBuffer(this.__wbg_ptr,e)>>>0}deallocateBuffer(e,t){Ya.mmdruntime_deallocateBuffer(this.__wbg_ptr,e,t)}createMmdModel(e,t){return Ya.mmdruntime_createMmdModel(this.__wbg_ptr,e,t)>>>0}destroyMmdModel(e){Ya.mmdruntime_destroyMmdModel(this.__wbg_ptr,e)}getAnimationArena(e){return Ya.mmdruntime_getAnimationArena(this.__wbg_ptr,e)>>>0}getAnimationIkSolverStateArena(e){return Ya.mmdruntime_getAnimationIkSolverStateArena(this.__wbg_ptr,e)>>>0}getAnimationMorphArena(e){return Ya.mmdruntime_getAnimationMorphArena(this.__wbg_ptr,e)>>>0}getBoneWorldMatrixArena(e){return Ya.mmdruntime_getBoneWorldMatrixArena(this.__wbg_ptr,e)>>>0}createBoneWorldMatrixBackBuffer(e){return Ya.mmdruntime_createBoneWorldMatrixBackBuffer(this.__wbg_ptr,e)>>>0}setRuntimeAnimation(e,t){Ya.mmdruntime_setRuntimeAnimation(this.__wbg_ptr,e,t)}setExternalPhysics(e,t){Ya.mmdruntime_setExternalPhysics(this.__wbg_ptr,e,t)}beforePhysics(e,t){Ya.mmdruntime_beforePhysics(this.__wbg_ptr,!Za(e),Za(e)?0:e,!Za(t),Za(t)?0:t)}afterPhysics(){Ya.mmdruntime_afterPhysics(this.__wbg_ptr)}getLockStatePtr(){return Ya.mmdruntime_getLockStatePtr(this.__wbg_ptr)>>>0}swapWorldMatrixBuffer(){Ya.mmdruntime_swapWorldMatrixBuffer(this.__wbg_ptr)}acquireDiagnosticErrorResult(){return Ya.mmdruntime_acquireDiagnosticErrorResult(this.__wbg_ptr)>>>0}acquireDiagnosticWarningResult(){return Ya.mmdruntime_acquireDiagnosticWarningResult(this.__wbg_ptr)>>>0}acquireDiagnosticInfoResult(){return Ya.mmdruntime_acquireDiagnosticInfoResult(this.__wbg_ptr)>>>0}releaseDiagnosticResult(){Ya.mmdruntime_releaseDiagnosticResult(this.__wbg_ptr)}setPhysicsMaxSubSteps(e){Ya.mmdruntime_setPhysicsMaxSubSteps(this.__wbg_ptr,e)}setPhysicsFixedTimeStep(e){Ya.mmdruntime_setPhysicsFixedTimeStep(this.__wbg_ptr,e)}setPhysicsGravity(e,t,n){Ya.mmdruntime_setPhysicsGravity(this.__wbg_ptr,e,t,n)}getPhysicsGravity(){return Ya.mmdruntime_getPhysicsGravity(this.__wbg_ptr)>>>0}overridePhysicsGravity(e,t,n,i){Ya.mmdruntime_overridePhysicsGravity(this.__wbg_ptr,e,t,n,i)}restorePhysicsGravity(e){Ya.mmdruntime_restorePhysicsGravity(this.__wbg_ptr,e)}getPhysicsWorldGravity(e){return Ya.mmdruntime_getPhysicsWorldGravity(this.__wbg_ptr,e)>>>0}setMmdModelWorldMatrix(e,t){Ya.mmdruntime_setMmdModelWorldMatrix(this.__wbg_ptr,e,t)}markMmdModelPhysicsAsNeedInit(e){Ya.mmdruntime_markMmdModelPhysicsAsNeedInit(this.__wbg_ptr,e)}}function rs(){const e={wbg:{}};return e.wbg.__wbindgen_throw=function(e,t){throw new Error((n=e,i=t,n>>>=0,Qa.decode((null!==Ha&&0!==Ha.byteLength||(Ha=new Uint8Array(Ya.memory.buffer)),Ha).subarray(n,n+i))));var n,i},e}function os(e,t){return Ya=e.exports,ss.__wbindgen_wasm_module=t,Ha=null,Ya}function as(e){if(void 0!==Ya)return Ya;const t=rs();return e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),os(new WebAssembly.Instance(e,t),e)}async function ss(e){if(void 0!==Ya)return Ya;void 0===e&&(e=new URL(We(9928),We.b));const t=rs();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:i}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,t);return os(n,i)}const ls=ss;class hs{getWasmInstanceInner(){return He}}let ds;const cs="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&cs.decode();let us=null;function ms(e){return null==e}function ps(){ds.init()}function _s(){const e=ds.createMmdRuntime();return ws.__wrap(e)}function gs(){const e=ds.createAnimationPool();return bs.__wrap(e)}const fs="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>ds.__wbg_animationpool_free(e>>>0)));class bs{static __wrap(e){e>>>=0;const t=Object.create(bs.prototype);return t.__wbg_ptr=e,fs.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,fs.unregister(this),e}free(){const e=this.__destroy_into_raw();ds.__wbg_animationpool_free(e)}allocateLengthsBuffer(e){return ds.animationpool_allocateLengthsBuffer(this.__wbg_ptr,e)>>>0}deallocateLengthsBuffer(e,t){ds.animationpool_deallocateLengthsBuffer(this.__wbg_ptr,e,t)}createBoneTracks(e,t){return ds.animationpool_createBoneTracks(this.__wbg_ptr,e,t)>>>0}getBoneTrackFrameNumbers(e,t){return ds.animationpool_getBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotations(e,t){return ds.animationpool_getBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getBoneTrackRotationInterpolations(e,t){return ds.animationpool_getBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMovableBoneTracks(e,t){return ds.animationpool_createMovableBoneTracks(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackFrameNumbers(e,t){return ds.animationpool_getMovableBoneTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositions(e,t){return ds.animationpool_getMovableBoneTrackPositions(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackPositionInterpolations(e,t){return ds.animationpool_getMovableBoneTrackPositionInterpolations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotations(e,t){return ds.animationpool_getMovableBoneTrackRotations(this.__wbg_ptr,e,t)>>>0}getMovableBoneTrackRotationInterpolations(e,t){return ds.animationpool_getMovableBoneTrackRotationInterpolations(this.__wbg_ptr,e,t)>>>0}createMorphTracks(e,t){return ds.animationpool_createMorphTracks(this.__wbg_ptr,e,t)>>>0}getMorphTrackFrameNumbers(e,t){return ds.animationpool_getMorphTrackFrameNumbers(this.__wbg_ptr,e,t)>>>0}getMorphTrackWeights(e,t){return ds.animationpool_getMorphTrackWeights(this.__wbg_ptr,e,t)>>>0}createAnimation(e,t,n,i,r,o,a,s){return ds.animationpool_createAnimation(this.__wbg_ptr,e,t,n,i,r,o,a,s)>>>0}getPropertyTrackFrameNumbers(e){return ds.animationpool_getPropertyTrackFrameNumbers(this.__wbg_ptr,e)>>>0}getPropertyTrackIkStates(e,t){return ds.animationpool_getPropertyTrackIkStates(this.__wbg_ptr,e,t)>>>0}destroyAnimation(e){ds.animationpool_destroyAnimation(this.__wbg_ptr,e)}createBoneBindIndexMap(e){return ds.animationpool_createBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMovableBoneBindIndexMap(e){return ds.animationpool_createMovableBoneBindIndexMap(this.__wbg_ptr,e)>>>0}createMorphBindIndexMap(e,t){return ds.animationpool_createMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}getNthMorphBindIndexMap(e,t){return ds.animationpool_getNthMorphBindIndexMap(this.__wbg_ptr,e,t)>>>0}createIkSolverBindIndexMap(e){return ds.animationpool_createIkSolverBindIndexMap(this.__wbg_ptr,e)>>>0}createRuntimeAnimation(e,t,n,i,r){return ds.animationpool_createRuntimeAnimation(this.__wbg_ptr,e,t,n,i,r)>>>0}destroyRuntimeAnimation(e){ds.animationpool_destroyRuntimeAnimation(this.__wbg_ptr,e)}animateMmdModel(e,t,n){ds.animationpool_animateMmdModel(this.__wbg_ptr,e,t,n)}}const ys="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>ds.__wbg_mmdruntime_free(e>>>0)));class ws{static __wrap(e){e>>>=0;const t=Object.create(ws.prototype);return t.__wbg_ptr=e,ys.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,ys.unregister(this),e}free(){const e=this.__destroy_into_raw();ds.__wbg_mmdruntime_free(e)}allocateBuffer(e){return ds.mmdruntime_allocateBuffer(this.__wbg_ptr,e)>>>0}deallocateBuffer(e,t){ds.mmdruntime_deallocateBuffer(this.__wbg_ptr,e,t)}createMmdModel(e,t){return ds.mmdruntime_createMmdModel(this.__wbg_ptr,e,t)>>>0}destroyMmdModel(e){ds.mmdruntime_destroyMmdModel(this.__wbg_ptr,e)}getAnimationArena(e){return ds.mmdruntime_getAnimationArena(this.__wbg_ptr,e)>>>0}getAnimationIkSolverStateArena(e){return ds.mmdruntime_getAnimationIkSolverStateArena(this.__wbg_ptr,e)>>>0}getAnimationMorphArena(e){return ds.mmdruntime_getAnimationMorphArena(this.__wbg_ptr,e)>>>0}getBoneWorldMatrixArena(e){return ds.mmdruntime_getBoneWorldMatrixArena(this.__wbg_ptr,e)>>>0}createBoneWorldMatrixBackBuffer(e){return ds.mmdruntime_createBoneWorldMatrixBackBuffer(this.__wbg_ptr,e)>>>0}setRuntimeAnimation(e,t){ds.mmdruntime_setRuntimeAnimation(this.__wbg_ptr,e,t)}setExternalPhysics(e,t){ds.mmdruntime_setExternalPhysics(this.__wbg_ptr,e,t)}beforePhysics(e){ds.mmdruntime_beforePhysics(this.__wbg_ptr,!ms(e),ms(e)?0:e)}afterPhysics(){ds.mmdruntime_afterPhysics(this.__wbg_ptr)}getLockStatePtr(){return ds.mmdruntime_getLockStatePtr(this.__wbg_ptr)>>>0}swapWorldMatrixBuffer(){ds.mmdruntime_swapWorldMatrixBuffer(this.__wbg_ptr)}acquireDiagnosticErrorResult(){return ds.mmdruntime_acquireDiagnosticErrorResult(this.__wbg_ptr)>>>0}acquireDiagnosticWarningResult(){return ds.mmdruntime_acquireDiagnosticWarningResult(this.__wbg_ptr)>>>0}acquireDiagnosticInfoResult(){return ds.mmdruntime_acquireDiagnosticInfoResult(this.__wbg_ptr)>>>0}releaseDiagnosticResult(){ds.mmdruntime_releaseDiagnosticResult(this.__wbg_ptr)}}function As(){const e={wbg:{}};return e.wbg.__wbindgen_throw=function(e,t){throw new Error((n=e,i=t,n>>>=0,cs.decode((null!==us&&0!==us.byteLength||(us=new Uint8Array(ds.memory.buffer)),us).subarray(n,n+i))));var n,i},e}function Ms(e,t){return ds=e.exports,xs.__wbindgen_wasm_module=t,us=null,ds}function Ts(e){if(void 0!==ds)return ds;const t=As();return e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),Ms(new WebAssembly.Instance(e,t),e)}async function xs(e){if(void 0!==ds)return ds;void 0===e&&(e=new URL(We(8754),We.b));const t=As();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:i}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,t);return Ms(n,i)}const vs=xs;class Is{getWasmInstanceInner(){return $e}}class Bs{_encodePhysicsOptions;constructor(){this._encodePhysicsOptions=!0}setEncodePhysicsOptions(e){if("boolean"==typeof e)this._encodePhysicsOptions=e;else{let t=e.worldId;void 0!==t&&(t<0||4294967295<t)&&(t=void 0);const n=[],i=e.kinematicSharedWorldIds;if(void 0!==i)for(let e=0;e<i.length;++e){const t=i[e];0<=t&&t<=4294967295&&n.push(t)}this._encodePhysicsOptions={worldId:t,kinematicSharedWorldIds:n}}}_computeBonesSize(e){let t=12;const n=e.bones;for(let e=0;e<n.length;++e){t+=88;const i=n[e];if(i.appendTransform&&(t+=8),i.axisLimit&&(t+=12),i.ik){t+=16;const e=i.ik.links;for(let n=0;n<e.length;++n)t+=8,e[n].limitation&&(t+=24)}}return t}_computeMorphsSize(e){let t=4;const n=e.morphs;for(let e=0;e<n.length;++e){const i=n[e];switch(i.type){case bt.B.Morph.Type.BoneMorph:{const e=i.indices;t+=8+4*e.length+12*e.length+16*e.length;break}case bt.B.Morph.Type.GroupMorph:{const e=i.indices;t+=8+4*e.length+4*e.length;break}}}return t}_computePhysicsSize(e){if(null===e)return 4;let t=8;const n=e.rigidBodies;for(let e=0;e<n.length;++e)t+=8;return t}computeSize(e){const t=e.metadata;return this._computeBonesSize(t)+this._computeMorphsSize(t)+this._computePhysicsSize(this._encodePhysicsOptions?t:null)}_encodeBones(e,t,n){const i=new rt.Vector3,r=t.bones;e.setUint32(r.length);let o=0,a=0;for(let e=0;e<r.length;++e){const t=r[e];t.appendTransform&&(o+=1),t.ik&&(a+=1)}e.setUint32(o),e.setUint32(a);for(let t=0;t<r.length;++t){const o=r[t],a=n[t];let s=o.flag;if(s&=(void 0===o.appendTransform?~(bt.B.Bone.Flag.HasAppendMove&bt.B.Bone.Flag.HasAppendRotate):-1)&~bt.B.Bone.Flag.HasAxisLimit&~bt.B.Bone.Flag.IsIkEnabled,o.axisLimit&&(s|=bt.B.Bone.Flag.HasAxisLimit),o.ik&&(s|=bt.B.Bone.Flag.IsIkEnabled),e.setFloat32Array(a.getRestMatrix().getTranslationToRef(i).asArray()),e.setFloat32Array(a.getAbsoluteInverseBindMatrix().m),e.setInt32(o.parentBoneIndex),e.setInt32(o.transformOrder),e.setUint16(o.flag),e.offset+=2,o.appendTransform&&(e.setInt32(o.appendTransform.parentIndex),e.setFloat32(o.appendTransform.ratio)),o.axisLimit&&e.setFloat32Array(o.axisLimit),o.ik){e.setInt32(o.ik.target),e.setInt32(o.ik.iteration),e.setFloat32(o.ik.rotationConstraint),e.setUint32(o.ik.links.length);const t=o.ik.links;for(let n=0;n<t.length;++n){const i=t[n];e.setInt32(i.target),e.setUint8(i.limitation?1:0),e.offset+=3,i.limitation&&(e.setFloat32Array(i.limitation.minimumAngle),e.setFloat32Array(i.limitation.maximumAngle))}}}}_encodeMorphs(e,t){const n=t.morphs;let i=0;for(let e=0;e<n.length;++e)switch(n[e].type){case bt.B.Morph.Type.BoneMorph:case bt.B.Morph.Type.GroupMorph:i+=1}const r=new Int32Array(n.length).fill(-1);for(let e=0,t=0;e<n.length;++e){const i=n[e];i.type!==bt.B.Morph.Type.BoneMorph&&i.type!==bt.B.Morph.Type.GroupMorph||(r[e]=t,t+=1)}e.setUint32(i);for(let t=0;t<n.length;++t){const i=n[t];switch(i.type){case bt.B.Morph.Type.BoneMorph:e.setUint8(i.type),e.offset+=3,e.setUint32(i.indices.length),e.setInt32Array(i.indices),e.setFloat32Array(i.positions),e.setFloat32Array(i.rotations);break;case bt.B.Morph.Type.GroupMorph:{e.setUint8(i.type),e.offset+=3,e.setUint32(i.indices.length);const t=i.indices,n=new Int32Array(t.length);for(let e=0;e<n.length;++e)n[e]=r[t[e]];e.setInt32Array(n),e.setFloat32Array(i.ratios)}}}return r}_encodePhysics(e,t,n){if(null===t)return e.setUint8(0),void(e.offset+=3);e.setUint8(1),e.offset+=3;const i=t.bones,r=new Map;for(let e=0;e<i.length;++e)r.set(i[e].name,e);const o=t.rigidBodies;e.setUint32(o.length);for(let t=0;t<o.length;++t){const n=o[t],a=n.boneIndex<0||i.length<=n.boneIndex?r.get(n.name)??-1:n.boneIndex;e.setInt32(a),e.setUint8(n.physicsMode),e.offset+=3}}encode(e,t,n){const i=e.metadata,r=new En(n.buffer);r.offset=n.byteOffset,this._encodeBones(r,i,t);const o=this._encodeMorphs(r,i);return this._encodePhysics(r,this._encodePhysicsOptions?i:null,e),o}}class Ps extends Bs{_physicsRuntime;constructor(e){super(),this._physicsRuntime=e}_computePhysicsSize(e){if(null===e)return 4;let t=8;t+=4;const n=this._encodePhysicsOptions.kinematicSharedWorldIds;if(void 0!==n){const e=new Set(n),i=this._encodePhysicsOptions.worldId??this._physicsRuntime.nextWorldId;e.delete(i),t+=4*e.size}t+=64,t+=4;const i=e.rigidBodies;for(let e=0;e<i.length;++e)t+=72;t+=4;const r=e.joints;for(let e=0;e<r.length;++e)t+=108;return t}_encodePhysics(e,t,n){if(null===t)return e.setUint8(0),void(e.offset+=3);e.setUint8(2),e.offset+=3;let i=this._encodePhysicsOptions.worldId;void 0===i&&(i=this._physicsRuntime.nextWorldId,this._physicsRuntime.nextWorldId+=1),e.setUint32(i);const r=this._encodePhysicsOptions.kinematicSharedWorldIds;if(void 0===r)e.setUint32(0);else{const t=new Set(r);t.delete(i),e.setUint32(t.size);for(const n of t)e.setUint32(n)}const o=n.computeWorldMatrix(!0);e.setFloat32Array(o.m);const a=t.bones,s=new Map;for(let e=0;e<a.length;++e)s.set(a[e].name,e);const l=t.rigidBodies;e.setUint32(l.length);for(let t=0;t<l.length;++t){const n=l[t],i=n.boneIndex<0||a.length<=n.boneIndex?s.get(n.name)??-1:n.boneIndex;e.setInt32(i),e.setUint8(n.collisionGroup),e.setUint8(n.shapeType),e.setUint16(n.collisionMask),e.setFloat32Array(n.shapeSize),3===n.shapeSize.length&&e.setFloat32(0),e.setFloat32Array(n.shapePosition),e.setFloat32Array(n.shapeRotation),e.setFloat32(n.mass),e.setFloat32(n.linearDamping),e.setFloat32(n.angularDamping),e.setFloat32(n.repulsion),e.setFloat32(n.friction),e.setUint8(n.physicsMode),e.offset+=3}const h=t.joints;e.setUint32(h.length);for(let t=0;t<h.length;++t){const n=h[t];e.setUint8(n.type),e.offset+=3,e.setInt32(n.rigidbodyIndexA),e.setInt32(n.rigidbodyIndexB),e.setFloat32Array(n.position),e.setFloat32Array(n.rotation),e.setFloat32Array(n.positionMin),e.setFloat32Array(n.positionMax),e.setFloat32Array(n.rotationMin),e.setFloat32Array(n.rotationMax),e.setFloat32Array(n.springPosition),e.setFloat32Array(n.springRotation)}}}class Ss{_wasmInternal;constructor(e){this._wasmInternal=e}add(e){this._wasmInternal.markMmdModelPhysicsAsNeedInit(e.ptr)}}class Rs{nextWorldId;initializer;_mmdRuntime;_maxSubSteps;_fixedTimeStep;_worldMatrixBuffer;constructor(e){this.nextWorldId=0,this.initializer=new Ss(e.wasmInternal),this._mmdRuntime=e,this._maxSubSteps=5,this._fixedTimeStep=1/60;const t=e.wasmInternal.allocateBuffer(64);this._worldMatrixBuffer=e.wasmInstance.createTypedArray(Float32Array,t,16)}dispose(){if(!this._worldMatrixBuffer)return;const e=this._worldMatrixBuffer.array;this._mmdRuntime.wasmInternal.deallocateBuffer(e.byteOffset,e.byteLength),this._worldMatrixBuffer=null}get maxSubSteps(){return this._maxSubSteps}set maxSubSteps(e){this._mmdRuntime.lock.wait(),this._maxSubSteps=e,this._mmdRuntime.wasmInternal.setPhysicsMaxSubSteps(e)}get fixedTimeStep(){return this._fixedTimeStep}set fixedTimeStep(e){this._mmdRuntime.lock.wait(),this._fixedTimeStep=e,this._mmdRuntime.wasmInternal.setPhysicsFixedTimeStep(e)}setGravity(e){this._mmdRuntime.lock.wait(),this._mmdRuntime.wasmInternal.setPhysicsGravity(e.x,e.y,e.z)}getGravity(e){const t=this._mmdRuntime.wasmInternal.getPhysicsGravity();if(0===t)return null;e??=new rt.Vector3;const n=this._mmdRuntime.wasmInstance.createTypedArray(Float32Array,t,3).array;return e.set(n[0],n[1],n[2])}overrideWorldGravity(e,t){this._mmdRuntime.lock.wait(),null!==t?this._mmdRuntime.wasmInternal.overridePhysicsGravity(e,t.x,t.y,t.z):this._mmdRuntime.wasmInternal.restorePhysicsGravity(e)}getWorldGravity(e,t){const n=this._mmdRuntime.wasmInternal.getPhysicsWorldGravity(e);if(0===n)return null;t??=new rt.Vector3;const i=this._mmdRuntime.wasmInstance.createTypedArray(Float32Array,n,3).array;return t.set(i[0],i[1],i[2])}setMmdModelsWorldMatrix(e){const t=this._mmdRuntime.wasmInternal,n=this._worldMatrixBuffer;for(let i=0,r=e.length;i<r;++i){const r=e[i],o=n.array;r.mesh.getWorldMatrix().copyToArray(o,0),t.setMmdModelWorldMatrix(r.ptr,o.byteOffset)}}createGroundModel(e,t=new rt.Vector3(0,1,0),n=0){const i=new Os(t,n);return this._mmdRuntime.createMmdModel(i,{materialProxyConstructor:null,buildPhysics:!(e.length<0)&&{worldId:e[0],kinematicSharedWorldIds:e.slice(1)}})}}class Es{bones;constructor(){this.bones=[new Cs]}prepare(){}_markAsDirty(){}}class Cs{_matrix;position;rotationQuaternion;scaling;constructor(){this._matrix=rt.Matrix.Identity(),this.position=rt.Vector3.Zero(),this.rotationQuaternion=rt.Quaternion.Identity(),this.scaling=rt.Vector3.One()}getRestMatrix(){return this._matrix}getAbsoluteInverseBindMatrix(){return this._matrix}}class Os{metadata;skeleton;_matrix;constructor(e,t){this._matrix=rt.Matrix.Identity();const n=new Es;this.metadata={isMmdModel:!0,header:{modelName:"Ground",englishModelName:"Ground",comment:"",englishComment:""},bones:[{name:"root",englishName:"root",parentBoneIndex:-1,transformOrder:0,flag:0,appendTransform:void 0,axisLimit:void 0,ik:void 0}],morphs:[],rigidBodies:[{name:"root",englishName:"root",boneIndex:0,collisionGroup:0,collisionMask:65535,shapeType:5,shapeSize:[e.x,e.y,e.z,t],shapePosition:[0,0,0],shapeRotation:[0,0,0],mass:0,linearDamping:0,angularDamping:0,repulsion:0,friction:0,physicsMode:3}],joints:[],meshes:[],materials:[],skeleton:n},this.skeleton=n}computeWorldMatrix(){return this._matrix}getWorldMatrix(){return this._matrix}}class ks{_engine;constructor(e){this._engine=e}getDeltaTime(){const e=this._engine.getDeltaTime();return 0===e?1/60:e/1e3}}class Fs{_scene;constructor(e){this._scene=e}createRuntime(e){return new Rs(e)}createPhysicsClock(){return new ks(this._scene.getEngine())}createMetadataEncoder(e){return new Ps(e)}}class Ns{array;constructor(e,t,n,i){this.array=new e(t.buffer,n,i)}}class Ds{_memory;_byteOffset;_length;_array;constructor(e,t,n,i){this._memory=t,this._byteOffset=n,this._length=i,this._array=0===i?new e(0):new e(t.buffer,n,i)}get array(){return this._array.length!==this._length&&(this._array=new this._array.constructor(this._memory.buffer,this._byteOffset,this._length)),this._array}}const Ls=new WeakMap;async function Us(e,t=navigator.hardwareConcurrency){const n=e.getWasmInstanceInner();{const e=Ls.get(n);if(void 0!==e)return e}let i=null;Ls.set(n,new Promise((e=>i=e)));const r={...n},o=await r.default();r.init();const a=o.memory;return r.memory=a,a.buffer instanceof ArrayBuffer?r.createTypedArray=function(e,t,n){return new Ds(e,a,t,n)}:r.createTypedArray=function(e,t,n){return new Ns(e,a,t,n)},await(r.initThreadPool?.(t)),i(r),r}class Vs{_runtimeBones;_materials;_morphs;_morphIndexMap;_morphWeights;_activeMorphs;morphTargetManagers;constructor(e,t,n,i,r,o){if(this._runtimeBones=e??[],null!==i){const e=this._materials=new Array(t.length);for(let r=0;r<t.length;++r){const o=t[r],a=[];for(let e=0;e<n.length;++e)n[e].material===o&&a.push(n[e]);e[r]=new i(o,a)}}else this._materials=[];const a=this._morphs=this._createRuntimeMorphData(r,null!==e,null!==i),s=this._morphIndexMap=new Map;for(let e=0;e<a.length;++e){const t=a[e];let n=s.get(t.name);void 0===n&&(n=[],s.set(t.name,n)),n.push(e)}this._morphWeights=new Float32Array(a.length),this._activeMorphs=new Set,this.morphTargetManagers=o}getMorphWeight(e){const t=this._morphIndexMap.get(e);return void 0===t?0:this._morphWeights[t[0]]}getMorphIndices(e){return this._morphIndexMap.get(e)}getMorphWeightFromIndex(e){return this._morphWeights[e]}getMorphWeights(){return this._morphWeights}resetMorphWeights(){this._morphWeights.fill(0)}_updatedMaterials=new Set;update(){const e=this._morphs,t=this._morphIndexMap,n=this._morphWeights,i=this._activeMorphs,r=this.morphTargetManagers;for(let e=0;e<r.length;++e)r[e].areUpdatesFrozen=!0;for(const n of i){const i=t.get(n);for(let t=0;t<i.length;++t)this._resetMorph(e[i[t]])}for(const r of i){const o=t.get(r);for(let t=0;t<o.length;++t){const a=o[t],s=n[a];this._applyMorph(e[a],s),0===s&&i.delete(r)}}for(let e=0;e<r.length;++e)r[e].areUpdatesFrozen=!1;const o=this._updatedMaterials;for(const e of o)e.applyChanges();o.clear()}get morphs(){return this._morphs}_createRuntimeMorphData(e,t,n){const i=[];for(let r=0;r<e.length;++r){const o=e[r];let a=null,s=null,l=null,h=null;switch(o.type){case bt.B.Morph.Type.GroupMorph:s=o.indices,l=o.ratios;break;case bt.B.Morph.Type.BoneMorph:t?(s=o.indices,l=o.positions,h=o.rotations):(s=new Int32Array(0),l=new Float32Array(0),h=new Float32Array(0));break;case bt.B.Morph.Type.MaterialMorph:if(n){const e=o.elements,t=new Array(e.length);for(let n=0;n<e.length;++n){const i=e[n];i.type===bt.B.Morph.MaterialMorph.Type.Multiply?t[n]={index:i.index,type:i.type,diffuse:1!==i.diffuse[0]||1!==i.diffuse[1]||1!==i.diffuse[2]||1!==i.diffuse[3]?i.diffuse:null,specular:1!==i.specular[0]||1!==i.specular[1]||1!==i.specular[2]?i.specular:null,shininess:1!==i.shininess?i.shininess:null,ambient:1!==i.ambient[0]||1!==i.ambient[1]||1!==i.ambient[2]?i.ambient:null,edgeColor:1!==i.edgeColor[0]||1!==i.edgeColor[1]||1!==i.edgeColor[2]||1!==i.edgeColor[3]?i.edgeColor:null,edgeSize:1!==i.edgeSize?i.edgeSize:null,textureColor:1!==i.textureColor[0]||1!==i.textureColor[1]||1!==i.textureColor[2]||1!==i.textureColor[3]?i.textureColor:null,sphereTextureColor:1!==i.sphereTextureColor[0]||1!==i.sphereTextureColor[1]||1!==i.sphereTextureColor[2]||1!==i.sphereTextureColor[3]?i.sphereTextureColor:null,toonTextureColor:1!==i.toonTextureColor[0]||1!==i.toonTextureColor[1]||1!==i.toonTextureColor[2]||1!==i.toonTextureColor[3]?i.toonTextureColor:null}:t[n]={index:i.index,type:i.type,diffuse:0!==i.diffuse[0]||0!==i.diffuse[1]||0!==i.diffuse[2]||0!==i.diffuse[3]?i.diffuse:null,specular:0!==i.specular[0]||0!==i.specular[1]||0!==i.specular[2]?i.specular:null,shininess:0!==i.shininess?i.shininess:null,ambient:0!==i.ambient[0]||0!==i.ambient[1]||0!==i.ambient[2]?i.ambient:null,edgeColor:0!==i.edgeColor[0]||0!==i.edgeColor[1]||0!==i.edgeColor[2]||0!==i.edgeColor[3]?i.edgeColor:null,edgeSize:0!==i.edgeSize?i.edgeSize:null,textureColor:0!==i.textureColor[0]||0!==i.textureColor[1]||0!==i.textureColor[2]||0!==i.textureColor[3]?i.textureColor:null,sphereTextureColor:0!==i.sphereTextureColor[0]||0!==i.sphereTextureColor[1]||0!==i.sphereTextureColor[2]||0!==i.sphereTextureColor[3]?i.sphereTextureColor:null,toonTextureColor:0!==i.toonTextureColor[0]||0!==i.toonTextureColor[1]||0!==i.toonTextureColor[2]||0!==i.toonTextureColor[3]?i.toonTextureColor:null}}a=t}else a=[];break;case bt.B.Morph.Type.UvMorph:case bt.B.Morph.Type.AdditionalUvMorph1:case bt.B.Morph.Type.AdditionalUvMorph2:case bt.B.Morph.Type.AdditionalUvMorph3:case bt.B.Morph.Type.AdditionalUvMorph4:case bt.B.Morph.Type.VertexMorph:s=o.morphTargets}const d={name:o.name,type:o.type,materialElements:a,elements:s,elements2:l,elements3:h};i.push(d)}return i}_groupMorphForeach(e,t){const n=this._morphs,i=e.elements,r=e.elements2;for(let e=0;e<i.length;++e){const o=i[e],a=r[e],s=n[o];void 0!==s&&s.type!==bt.B.Morph.Type.GroupMorph&&t(s,a)}}_resetMorph(e){switch(e.type){case bt.B.Morph.Type.GroupMorph:this._groupMorphForeach(e,((e,t)=>this._resetMorph(e)));break;case bt.B.Morph.Type.BoneMorph:this._resetBoneMorph(e);break;case bt.B.Morph.Type.MaterialMorph:{const t=e.materialElements;for(let e=0;e<t.length;++e){const n=t[e],i=this._materials;if(-1===n.index)for(let e=0;e<i.length;++e)i[e]?.reset();else i[n.index]?.reset()}}break;case bt.B.Morph.Type.VertexMorph:case bt.B.Morph.Type.UvMorph:case bt.B.Morph.Type.AdditionalUvMorph1:case bt.B.Morph.Type.AdditionalUvMorph2:case bt.B.Morph.Type.AdditionalUvMorph3:case bt.B.Morph.Type.AdditionalUvMorph4:{const t=e.elements;for(let e=0;e<t.length;++e)t[e].influence=0}}}_applyMorph(e,t){switch(e.type){case bt.B.Morph.Type.GroupMorph:this._groupMorphForeach(e,((e,n)=>this._applyMorph(e,t*n)));break;case bt.B.Morph.Type.BoneMorph:this._applyBoneMorph(e,t);break;case bt.B.Morph.Type.MaterialMorph:{const n=e.materialElements;for(let e=0;e<n.length;++e){const i=n[e],r=this._materials;if(-1===i.index)for(let e=0;e<r.length;++e){const n=r[e];void 0!==n&&this._applyMaterialMorph(i,n,t)}else{const e=r[i.index];void 0!==e&&this._applyMaterialMorph(i,e,t)}}}break;case bt.B.Morph.Type.VertexMorph:case bt.B.Morph.Type.UvMorph:case bt.B.Morph.Type.AdditionalUvMorph1:case bt.B.Morph.Type.AdditionalUvMorph2:case bt.B.Morph.Type.AdditionalUvMorph3:case bt.B.Morph.Type.AdditionalUvMorph4:{const n=e.elements;for(let e=0;e<n.length;++e)n[e].influence+=t}}}_applyMaterialMorph(e,t,n){if(e.type===bt.B.Morph.MaterialMorph.Type.Multiply){if(null!==e.diffuse){const i=t.diffuse;for(let t=0;t<4;++t)i[t]=i[t]+(i[t]*e.diffuse[t]-i[t])*n}if(null!==e.specular){const i=t.specular;for(let t=0;t<3;++t)i[t]=i[t]+(i[t]*e.specular[t]-i[t])*n}if(null!==e.shininess&&(t.shininess=t.shininess+(t.shininess*e.shininess-t.shininess)*n),null!==e.ambient){const i=t.ambient;for(let t=0;t<3;++t)i[t]=i[t]+(i[t]*e.ambient[t]-i[t])*n}if(null!==e.edgeColor){const i=t.edgeColor;for(let t=0;t<4;++t)i[t]=i[t]+(i[t]*e.edgeColor[t]-i[t])*n}if(null!==e.edgeSize&&(t.edgeSize=t.edgeSize+(t.edgeSize*e.edgeSize-t.edgeSize)*n),null!==e.textureColor){const i=t.textureMultiplicativeColor;for(let t=0;t<4;++t)i[t]=i[t]+(i[t]*e.textureColor[t]-i[t])*n}if(null!==e.sphereTextureColor){const i=t.sphereTextureMultiplicativeColor;for(let t=0;t<4;++t)i[t]=i[t]+(i[t]*e.sphereTextureColor[t]-i[t])*n}if(null!==e.toonTextureColor){const i=t.toonTextureMultiplicativeColor;for(let t=0;t<4;++t)i[t]=i[t]+(i[t]*e.toonTextureColor[t]-i[t])*n}}else{if(null!==e.diffuse){const i=t.diffuse;for(let t=0;t<4;++t)i[t]+=e.diffuse[t]*n}if(null!==e.specular){const i=t.specular;for(let t=0;t<3;++t)i[t]+=e.specular[t]*n}if(null!==e.shininess&&(t.shininess+=e.shininess*n),null!==e.ambient){const i=t.ambient;for(let t=0;t<3;++t)i[t]+=e.ambient[t]*n}if(null!==e.edgeColor){const i=t.edgeColor;for(let t=0;t<4;++t)i[t]+=e.edgeColor[t]*n}if(null!==e.edgeSize&&(t.edgeSize+=e.edgeSize*n),null!==e.textureColor){const i=t.textureAdditiveColor;for(let t=0;t<4;++t)i[t]+=e.textureColor[t]*n}if(null!==e.sphereTextureColor){const i=t.sphereTextureAdditiveColor;for(let t=0;t<4;++t)i[t]+=e.sphereTextureColor[t]*n}if(null!==e.toonTextureColor){const i=t.toonTextureAdditiveColor;for(let t=0;t<4;++t)i[t]+=e.toonTextureColor[t]*n}}this._updatedMaterials.add(t)}}class Ws extends Vs{_wasmMorphWeights;_wasmMorphIndexMap;constructor(e,t,n,i,r,o,a){super(null,n,i,r,o,a),this._wasmMorphWeights=e,this._wasmMorphIndexMap=t}setMorphWeight(e,t){const n=this._morphIndexMap.get(e);if(void 0===n)return;const i=this._morphWeights,r=this._wasmMorphWeights.array,o=this._wasmMorphIndexMap;for(let e=0;e<n.length;++e){const a=n[e];i[a]=t,r[o[a]]=t}0!==t&&this._activeMorphs.add(e)}setMorphWeightFromIndex(e,t,n=!0){this._morphWeights[e]=t,n&&(this._wasmMorphWeights.array[this._wasmMorphIndexMap[e]]=t),0!==t&&this._activeMorphs.add(this._morphs[e].name)}resetMorphWeights(){super.resetMorphWeights(),this._wasmMorphWeights.array.fill(0)}syncWasmMorphWeights(){const e=this._morphWeights,t=this._wasmMorphWeights.array,n=this._wasmMorphIndexMap;for(let i=0;i<e.length;++i)t[n[i]]=e[i]}_resetBoneMorph(e){}_applyBoneMorph(e,t){}get wasmMorphIndexMap(){return this._wasmMorphIndexMap}}var zs,js=We(1860);class qs{diffuse;specular;shininess;ambient;edgeColor;edgeSize;textureMultiplicativeColor;textureAdditiveColor;sphereTextureMultiplicativeColor;sphereTextureAdditiveColor;toonTextureMultiplicativeColor;toonTextureAdditiveColor;_material;_referencedMeshes;_initialDiffuse;_initialSpecular;_initialShininess;_initialAmbient;_initialEdgeColor;_initialEdgeSize;_initialTextureMultiplicativeColor;_initialTextureAdditiveColor;_initialSphereTextureMultiplicativeColor;_initialSphereTextureAdditiveColor;_initialToonTextureMultiplicativeColor;_initialToonTextureAdditiveColor;_initialTransparencyMode;constructor(e,t){this._material=e,this._referencedMeshes=t;const n=e.diffuseColor;this.diffuse=[n.r,n.g,n.b,e.alpha];const i=e.specularColor;this.specular=[i.r,i.g,i.b],this.shininess=e.specularPower;const r=e.ambientColor;this.ambient=[r.r,r.g,r.b];const o=e.outlineColor;this.edgeColor=[o.r,o.g,o.b,e.outlineAlpha],this.edgeSize=e.outlineWidth,this.textureMultiplicativeColor=[1,1,1,1],this.textureAdditiveColor=[0,0,0,0],this.sphereTextureMultiplicativeColor=[1,1,1,1],this.sphereTextureAdditiveColor=[0,0,0,0],this.toonTextureMultiplicativeColor=[1,1,1,1],this.toonTextureAdditiveColor=[0,0,0,0],this._initialDiffuse=[...this.diffuse],this._initialSpecular=[...this.specular],this._initialShininess=this.shininess,this._initialAmbient=[...this.ambient],this._initialEdgeColor=[...this.edgeColor],this._initialEdgeSize=this.edgeSize,this._initialTextureMultiplicativeColor=[...this.textureMultiplicativeColor],this._initialTextureAdditiveColor=[...this.textureAdditiveColor],this._initialSphereTextureMultiplicativeColor=[...this.sphereTextureMultiplicativeColor],this._initialSphereTextureAdditiveColor=[...this.sphereTextureAdditiveColor],this._initialToonTextureMultiplicativeColor=[...this.toonTextureMultiplicativeColor],this._initialToonTextureAdditiveColor=[...this.toonTextureAdditiveColor],this._initialTransparencyMode=e.transparencyMode}reset(){for(let e=0;e<4;++e)this.diffuse[e]=this._initialDiffuse[e],this.edgeColor[e]=this._initialEdgeColor[e],this.textureMultiplicativeColor[e]=this._initialTextureMultiplicativeColor[e],this.textureAdditiveColor[e]=this._initialTextureAdditiveColor[e],this.sphereTextureMultiplicativeColor[e]=this._initialSphereTextureMultiplicativeColor[e],this.sphereTextureAdditiveColor[e]=this._initialSphereTextureAdditiveColor[e],this.toonTextureMultiplicativeColor[e]=this._initialToonTextureMultiplicativeColor[e],this.toonTextureAdditiveColor[e]=this._initialToonTextureAdditiveColor[e];for(let e=0;e<3;++e)this.specular[e]=this._initialSpecular[e],this.ambient[e]=this._initialAmbient[e];this.shininess=this._initialShininess,this.edgeSize=this._initialEdgeSize}applyChanges(){const e=this._material;e.diffuseColor.set(this.diffuse[0],this.diffuse[1],this.diffuse[2]),e.alpha=this.diffuse[3],1===this.diffuse[3]?e.transparencyMode=this._initialTransparencyMode:e.transparencyMode=js.Material.MATERIAL_ALPHABLEND;const t=this._referencedMeshes;if(this.diffuse[3]<=0)for(let e=0;e<t.length;++e)t[e].isVisible=!1;else for(let e=0;e<t.length;++e)t[e].isVisible=!0;e.specularColor.set(this.specular[0],this.specular[1],this.specular[2]),e.specularPower=this.shininess,e.ambientColor.set(this.ambient[0],this.ambient[1],this.ambient[2]),e.outlineColor.set(this.edgeColor[0],this.edgeColor[1],this.edgeColor[2]),e.outlineAlpha=this.edgeColor[3],e.outlineWidth=this.edgeSize;{const t=this.textureMultiplicativeColor;e.textureMultiplicativeColor.set(t[0],t[1],t[2],t[3])}{const t=this.textureAdditiveColor;e.textureAdditiveColor.set(t[0],t[1],t[2],t[3])}{const t=this.sphereTextureMultiplicativeColor;e.sphereTextureMultiplicativeColor.set(t[0],t[1],t[2],t[3])}{const t=this.sphereTextureAdditiveColor;e.sphereTextureAdditiveColor.set(t[0],t[1],t[2],t[3])}{const t=this.toonTextureMultiplicativeColor;e.toonTextureMultiplicativeColor.set(t[0],t[1],t[2],t[3])}{const t=this.toonTextureAdditiveColor;e.toonTextureAdditiveColor.set(t[0],t[1],t[2],t[3])}}}class Ks{getDeltaTime(){}}class Gs{_lock;constructor(e){this._lock=e}wait(){const e=this._lock.array;for(;0!==Atomics.load(e,0););}}!function(e){e[e.Immediate=0]="Immediate",e[e.Buffered=1]="Buffered"}(zs||(zs={}));class Ys{wasmInstance;wasmInternal;lock;_usingWasmBackBuffer;_lastRequestAnimationFrameTime;_needToSyncEvaluate;_externalPhysics;_physicsRuntime;_physicsClock;_mmdMetadataEncoder;_models;_camera;_audioPlayer;autoPhysicsInitialization;_loggingEnabled;log;warn;error;_isRegistered;onAnimationDurationChangedObservable;onPlayAnimationObservable;onPauseAnimationObservable;onSeekAnimationObservable;onAnimationTickObservable;_evaluationType;_currentFrameTime;_animationTimeScale;_animationPaused;_animationFrameTimeDuration;_useManualAnimationDuration;_needToInitializePhysicsModels;_needToInitializePhysicsModelsBuffer;_beforePhysicsBinded;_afterPhysicsBinded;_bindedDispose;_disposeObservableObject;constructor(e,t=null,n=null){this.wasmInstance=e,this.wasmInternal=e.createMmdRuntime(),this.lock=new Gs(e.createTypedArray(Uint8Array,this.wasmInternal.getLockStatePtr(),1)),this._usingWasmBackBuffer=!1,this._lastRequestAnimationFrameTime=null,this._needToSyncEvaluate=!0,void 0!==n?.createRuntime?(this._externalPhysics=null,this._physicsRuntime=n.createRuntime(this),this._physicsClock=n.createPhysicsClock(),this._mmdMetadataEncoder=n.createMetadataEncoder(this._physicsRuntime)):(this._externalPhysics=n,this._physicsRuntime=null,this._physicsClock=new Ks,this._mmdMetadataEncoder=new Bs),this._models=[],this._camera=null,this._audioPlayer=null,this.autoPhysicsInitialization=!0,this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._isRegistered=!1,this.onAnimationDurationChangedObservable=new pt.Observable,this.onPlayAnimationObservable=new pt.Observable,this.onPauseAnimationObservable=new pt.Observable,this.onSeekAnimationObservable=new pt.Observable,this.onAnimationTickObservable=new pt.Observable,this._evaluationType=zs.Immediate,this._currentFrameTime=0,this._animationTimeScale=1,this._animationPaused=!0,this._animationFrameTimeDuration=0,this._useManualAnimationDuration=!1,this._needToInitializePhysicsModels=new Set,this._needToInitializePhysicsModelsBuffer=new Set,this._beforePhysicsBinded=null,this._afterPhysicsBinded=this.afterPhysics.bind(this),null!==t?(this._bindedDispose=()=>this.dispose(t),this._disposeObservableObject=t,null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.add(this._bindedDispose)):(this._bindedDispose=null,this._disposeObservableObject=null)}dispose(e){this.lock.wait(),this._physicsRuntime?.dispose();for(let e=0;e<this._models.length;++e)this._models[e].dispose();this._models.length=0,this.setCamera(null),this.setAudioPlayer(null),this.onAnimationDurationChangedObservable.clear(),this.onPlayAnimationObservable.clear(),this.onPauseAnimationObservable.clear(),this.onSeekAnimationObservable.clear(),this.onAnimationTickObservable.clear(),this._needToInitializePhysicsModels.clear(),this._needToInitializePhysicsModelsBuffer.clear(),this.unregister(e),this.wasmInternal.free(),null!==this._disposeObservableObject&&null!==this._bindedDispose&&this._disposeObservableObject.onDisposeObservable.removeCallback(this._bindedDispose)}static _TextDecoder=new TextDecoder;_flushWasmDiagnosticFromResultPtr(e,t){const n=Ys._TextDecoder,[i,r]=this.wasmInstance.createTypedArray(Uint32Array,e,4).array;if(r<=0)return;const o=this.wasmInstance.createTypedArray(Uint32Array,i,2*r).array;for(let e=0;e<r;++e){const i=o[2*e],r=o[2*e+1],a=new Uint8Array(r);a.set(this.wasmInstance.createTypedArray(Uint8Array,i,r).array),t(n.decode(a))}}_flushWasmDiagnosticLog(){const e=this.wasmInternal.acquireDiagnosticErrorResult();this._loggingEnabled&&this._flushWasmDiagnosticFromResultPtr(e,this.error),this.wasmInternal.releaseDiagnosticResult();const t=this.wasmInternal.acquireDiagnosticWarningResult();this._loggingEnabled&&this._flushWasmDiagnosticFromResultPtr(t,this.warn),this.wasmInternal.releaseDiagnosticResult();const n=this.wasmInternal.acquireDiagnosticInfoResult();this._loggingEnabled&&this._flushWasmDiagnosticFromResultPtr(n,this.log),this.wasmInternal.releaseDiagnosticResult()}static _NullPhysicsInitializeSet={add(e){}};_getPhysicsInitializeSet(){return null===this._externalPhysics?this._physicsRuntime?.initializer??Ys._NullPhysicsInitializeSet:this._needToInitializePhysicsModels}createMmdModel(e,t={}){if(!In.isMmdSkinnedMesh(e))throw new Error("Mesh validation failed.");return this.createMmdModelFromSkeleton(e,e.metadata.skeleton,t)}createMmdModelFromSkeleton(e,t,n={}){void 0===n.materialProxyConstructor&&(n.materialProxyConstructor=qs),void 0===n.buildPhysics&&(n.buildPhysics=!0),this.lock.wait();const i=this.wasmInternal,r=this._usingWasmBackBuffer;r&&(i.swapWorldMatrixBuffer(),this._usingWasmBackBuffer=!1);const o=this._mmdMetadataEncoder;o.setEncodePhysicsOptions(n.buildPhysics);const a=o.computeSize(e),s=i.allocateBuffer(a),l=this.wasmInstance.createTypedArray(Uint8Array,s,a),h=o.encode(e,t.bones,l.array),d=i.createMmdModel(s,a),c=new Xs(this,d,e,t,n.materialProxyConstructor,h,n.buildPhysics?this._externalPhysics:null);return this._models.push(c),this._getPhysicsInitializeSet().add(c),i.deallocateBuffer(s,a),r&&(i.swapWorldMatrixBuffer(),this._usingWasmBackBuffer=!0),this._flushWasmDiagnosticLog(),this._needToSyncEvaluate=!0,c.onCurrentAnimationChangedObservable.add(this._onAnimationChanged),c}destroyMmdModel(e){e.dispose();const t=this._models,n=t.indexOf(e);if(n<0)throw new Error("Model not found.");t.splice(n,1),this.lock.wait(),this.wasmInternal.destroyMmdModel(e.ptr)}initializeMmdModelPhysics(e){this._getPhysicsInitializeSet().add(e)}initializeAllMmdModelsPhysics(e){const t=this._models;if(e)for(let e=0;e<t.length;++e){const n=t[e];null!==n.currentAnimation&&this._getPhysicsInitializeSet().add(n)}else for(let e=0;e<t.length;++e)this._getPhysicsInitializeSet().add(t[e])}setCamera(e){null!==this._camera&&this._camera.onCurrentAnimationChangedObservable.removeCallback(this._onAnimationChanged),null!==e&&e.onCurrentAnimationChangedObservable.add(this._onAnimationChanged),this._camera=e,this._onAnimationChanged(e?.currentAnimation??null)}_setAudioPlayerLastValue=null;async setAudioPlayer(e){if(this._audioPlayer!==e)if(this._setAudioPlayerLastValue=e,null!==this._audioPlayer&&(this._audioPlayer.onDurationChangedObservable.removeCallback(this._onAudioDurationChanged),this._audioPlayer.onPlaybackRateChangedObservable.removeCallback(this._onAudioPlaybackRateChanged),this._audioPlayer.onPlayObservable.removeCallback(this._onAudioPlay),this._audioPlayer.onPauseObservable.removeCallback(this._onAudioPause),this._audioPlayer.onSeekObservable.removeCallback(this._onAudioSeek),this._audioPlayer.pause()),this._audioPlayer=null,null!==e){if(!this._animationPaused){const t=30*e.duration;if(this._currentFrameTime<t&&(e.currentTime=this._currentFrameTime/30,await e.play(),this._setAudioPlayerLastValue!==e))return void e.pause()}this._audioPlayer=e,this._onAudioDurationChanged(),e.onDurationChangedObservable.add(this._onAudioDurationChanged),e.onPlaybackRateChangedObservable.add(this._onAudioPlaybackRateChanged),e.onPlayObservable.add(this._onAudioPlay),e.onPauseObservable.add(this._onAudioPause),e.onSeekObservable.add(this._onAudioSeek),e._setPlaybackRateWithoutNotify(this._animationTimeScale)}else this._onAudioDurationChanged()}register(e){this._isRegistered||(this._isRegistered=!0,this._beforePhysicsBinded=()=>this.beforePhysics(e.getEngine().getDeltaTime()),e.onBeforeAnimationsObservable.add(this._beforePhysicsBinded),e.onBeforeRenderObservable.add(this._afterPhysicsBinded))}unregister(e){this._isRegistered&&(this._isRegistered=!1,e.onBeforeAnimationsObservable.removeCallback(this._beforePhysicsBinded),e.onBeforeRenderObservable.removeCallback(this._afterPhysicsBinded),this._beforePhysicsBinded=null)}beforePhysics(e){let t=null;if(!this._animationPaused){if(null===this._audioPlayer||this._audioPlayer.paused)this._currentFrameTime+=e/1e3*30*this._animationTimeScale;else{const t=this._audioPlayer.currentTime,n=t-this._currentFrameTime/30,i=Math.abs(n);if(i<.05)this._currentFrameTime+=e/1e3*30*this._animationTimeScale;else if(i<.5)this._currentFrameTime+=n<0?e/1e3*30*this._animationTimeScale*.9:e/1e3*30*this._animationTimeScale*1.1;else{if(this.autoPhysicsInitialization&&60<Math.abs(t-this._currentFrameTime)){const e=this._getPhysicsInitializeSet();for(let t=0;t<this._models.length;++t){const n=this._models[t];null!==n.currentAnimation&&e.add(n)}}this._currentFrameTime=30*t}}t=this._currentFrameTime,this._animationFrameTimeDuration<=t&&(this._animationPaused=!0,this._currentFrameTime=this._animationFrameTimeDuration,null===this._audioPlayer||this._audioPlayer.paused?this.onPauseAnimationObservable.notifyObservers():this._audioPlayer.pause())}const n=this._physicsClock.getDeltaTime();if(this._physicsRuntime?.setMmdModelsWorldMatrix(this._models),this._evaluationType===zs.Buffered){const e=this._models;{const n=this._lastRequestAnimationFrameTime??t;for(let t=0;t<e.length;++t){const i=e[t];void 0!==i.currentAnimation?.wasmAnimate&&e[t].beforePhysicsAndWasm(n)}null!==n&&null!==this._camera&&this._camera.animate(n)}if(void 0===this.wasmInstance.MmdRuntime.bufferedUpdate&&(this.wasmInternal.beforePhysics(this._lastRequestAnimationFrameTime??void 0,n),null===this._externalPhysics&&this.wasmInternal.afterPhysics()),this.lock.wait(),!1===this._usingWasmBackBuffer&&(this._usingWasmBackBuffer=!0,this.wasmInternal.swapWorldMatrixBuffer()),null===this._lastRequestAnimationFrameTime){if(null!==t){for(let n=0;n<e.length;++n){const i=e[n];void 0===i.currentAnimation?.wasmAnimate&&e[n].beforePhysicsAndWasm(t)}this.wasmInternal.beforePhysics(t??void 0,n),null===this._externalPhysics&&this.wasmInternal.afterPhysics()}else if(this._needToSyncEvaluate){this._needToSyncEvaluate=!1;const e=this._needToInitializePhysicsModelsBuffer;for(const t of this._needToInitializePhysicsModels)e.add(t);this.wasmInternal.beforePhysics(void 0,n),null===this._externalPhysics&&this.wasmInternal.afterPhysics()}}else if(this._needToSyncEvaluate){this._needToSyncEvaluate=!1;const t=this._needToInitializePhysicsModelsBuffer;for(const e of this._needToInitializePhysicsModels)t.add(e);for(let t=0;t<e.length;++t){const n=e[t];void 0===n.currentAnimation?.wasmAnimate&&e[t].beforePhysicsAndWasm(this._lastRequestAnimationFrameTime)}this.wasmInternal.beforePhysics(this._lastRequestAnimationFrameTime,n),null===this._externalPhysics&&this.wasmInternal.afterPhysics()}for(let t=0;t<e.length;++t)e[t].swapWorldTransformMatricesBuffer();this.wasmInternal.swapWorldMatrixBuffer();for(let t=0;t<e.length;++t)e[t].beforePhysics();for(let n=0;n<e.length;++n){const i=e[n];void 0===i.currentAnimation?.wasmAnimate&&e[n].beforePhysicsAndWasm(t)}if(null===this._externalPhysics&&this.wasmInstance.MmdRuntime.bufferedUpdate?.(this.wasmInternal,t??void 0,n),this._lastRequestAnimationFrameTime=t,null!==this._externalPhysics){const e=this._needToInitializePhysicsModelsBuffer;for(const t of e)t.initializePhysics();e.clear();const t=this._needToInitializePhysicsModels;for(const n of t)e.add(n);t.clear()}}else{if(!0===this._usingWasmBackBuffer){if(null!==this._externalPhysics){const e=this._needToInitializePhysicsModels;for(const t of this._needToInitializePhysicsModelsBuffer)e.add(t)}this.lock.wait(),this._usingWasmBackBuffer=!1,this._lastRequestAnimationFrameTime=null,this.wasmInternal.swapWorldMatrixBuffer()}const e=this._models;for(let n=0;n<e.length;++n)e[n].beforePhysicsAndWasm(t);this.wasmInternal.beforePhysics(t??void 0,n);for(let t=0;t<e.length;++t)e[t].beforePhysics();if(this._needToSyncEvaluate=!1,null!==this._externalPhysics){const e=this._needToInitializePhysicsModels;for(const t of e)t.initializePhysics();e.clear()}null!==t&&null!==this._camera&&this._camera.animate(t)}null!==t&&this.onAnimationTickObservable.notifyObservers()}afterPhysics(){const e=this._models;if(this._usingWasmBackBuffer){for(let t=0;t<e.length;++t){const n=e[t];n.afterPhysicsAndWasm(),n.afterPhysics()}if(null!==this._externalPhysics){this.wasmInternal.swapWorldMatrixBuffer(),this.wasmInternal.afterPhysics(),this.wasmInternal.swapWorldMatrixBuffer();const e=this._physicsClock.getDeltaTime();this.wasmInstance.MmdRuntime.bufferedBeforePhysics?.(this.wasmInternal,this._lastRequestAnimationFrameTime??void 0,e)}}else{for(let t=0;t<e.length;++t)e[t].afterPhysicsAndWasm();this.wasmInternal.afterPhysics();for(let t=0;t<e.length;++t)e[t].afterPhysics()}}_onAnimationChanged=e=>{if(this._useManualAnimationDuration)return;const t=e?.animation.endFrame??0;this._animationFrameTimeDuration<t?this._animationFrameTimeDuration=t:t<this._animationFrameTimeDuration&&(this._animationFrameTimeDuration=this._computeAnimationDuration()),this.onAnimationDurationChangedObservable.notifyObservers()};_computeAnimationDuration(){let e=0;const t=this._models;for(let n=0;n<t.length;++n){const i=t[n];null!==i.currentAnimation&&(e=Math.max(e,i.currentAnimation.animation.endFrame))}return null!==this._camera&&null!==this._camera.currentAnimation&&(e=Math.max(e,this._camera.currentAnimation.animation.endFrame)),null!==this._audioPlayer&&(e=Math.max(e,30*this._audioPlayer.duration)),e}_onAudioDurationChanged=()=>{if(!this._animationPaused&&null!==this._audioPlayer){const e=this._audioPlayer,t=this._currentFrameTime/30;t<e.duration&&(e._setCurrentTimeWithoutNotify(t),e.play().then((()=>{this._setAudioPlayerLastValue===e||e.pause()})))}if(this._useManualAnimationDuration)return;const e=null!==this._audioPlayer?30*this._audioPlayer.duration:0;this._animationFrameTimeDuration<e?this._animationFrameTimeDuration=e:this._animationFrameTimeDuration=this._computeAnimationDuration(),this.onAnimationDurationChangedObservable.notifyObservers()};_onAudioPlaybackRateChanged=()=>{this._animationTimeScale=this._audioPlayer.playbackRate};_onAudioPlay=()=>{this._playAnimationInternal()};_onAudioPause=()=>{this._audioPlayer.currentTime!==this._audioPlayer.duration&&(this._animationPaused=!0,this.onPauseAnimationObservable.notifyObservers())};_onAudioSeek=()=>{this._seekAnimationInternal(30*this._audioPlayer.currentTime,this._animationPaused)};_playAnimationInternal(){if(this._animationPaused){if(this._animationPaused=!1,this.autoPhysicsInitialization&&0===this._currentFrameTime){const e=this._models,t=this._getPhysicsInitializeSet();for(let n=0;n<e.length;++n)t.add(e[n])}this.onPlayAnimationObservable.notifyObservers()}}async playAnimation(){if(null!==this._audioPlayer&&this._currentFrameTime<30*this._audioPlayer.duration)try{const e=this._currentFrameTime/30;.05<Math.abs(this._audioPlayer.currentTime-e)&&this._audioPlayer._setCurrentTimeWithoutNotify(e),await this._audioPlayer.play()}catch(e){if(!(e instanceof DOMException&&"NotSupportedError"===e.name))throw e;this.error("Failed to play audio."),this._playAnimationInternal()}else this._playAnimationInternal()}pauseAnimation(){null===this._audioPlayer||this._audioPlayer.paused?(this._animationPaused=!0,this.onPauseAnimationObservable.notifyObservers()):(this._audioPlayer.pause(),this._animationPaused=!0)}_seekAnimationInternal(e,t){if(this.autoPhysicsInitialization&&60<Math.abs(e-this._currentFrameTime)){const e=this._getPhysicsInitializeSet();for(let t=0;t<this._models.length;++t){const n=this._models[t];null!==n.currentAnimation&&e.add(n)}}if(this._currentFrameTime=e,t){const t=this._models;if(this._evaluationType===zs.Buffered)this._lastRequestAnimationFrameTime=e,this._needToSyncEvaluate=!0;else{this.lock.wait();for(let n=0;n<t.length;++n){const i=t[n].currentAnimation;null!==i&&(void 0!==i.wasmAnimate?(i.wasmAnimate(e),i.animate(e)):i.animate(e))}}null!==this._camera&&null!==this._camera.currentAnimation&&this._camera.animate(e),this.onAnimationTickObservable.notifyObservers()}this.onSeekAnimationObservable.notifyObservers()}async seekAnimation(e,t=!1){if(e=Math.max(0,Math.min(e,this._animationFrameTimeDuration)),null!==this._audioPlayer)if(this._audioPlayer.paused)if(!this._animationPaused&&30*this._audioPlayer.currentTime<this._animationFrameTimeDuration&&e<30*this._audioPlayer.duration)try{this._audioPlayer._setCurrentTimeWithoutNotify(e/30),await this._audioPlayer.play()}catch(n){if(!(n instanceof DOMException&&"NotSupportedError"===n.name))throw n;this.error("Failed to play audio."),this._seekAnimationInternal(e,t)}else this._seekAnimationInternal(e,t),this._audioPlayer?._setCurrentTimeWithoutNotify(e/30);else this._audioPlayer.currentTime=e/30;else this._seekAnimationInternal(e,t)}get isAnimationPlaying(){return!this._animationPaused}get models(){return this._models}get camera(){return this._camera}get audioPlayer(){return this._audioPlayer}get timeScale(){return this._animationTimeScale}set timeScale(e){this._animationTimeScale=e,null!==this._audioPlayer&&this._audioPlayer._setPlaybackRateWithoutNotify(e)}get currentFrameTime(){return this._currentFrameTime}get currentTime(){return this._currentFrameTime/30}get animationFrameTimeDuration(){return this._animationFrameTimeDuration}get animationDuration(){return this._animationFrameTimeDuration/30}setManualAnimationDuration(e){(null!==e||this._useManualAnimationDuration)&&(null===e?(this._useManualAnimationDuration=!1,this._animationFrameTimeDuration=this._computeAnimationDuration()):(this._useManualAnimationDuration=!0,this._animationFrameTimeDuration=e),this.onAnimationDurationChangedObservable.notifyObservers())}get evaluationType(){return this._evaluationType}set evaluationType(e){if(this._evaluationType===e)return;zs.Buffered,this._evaluationType=e;const t=this._models;for(let n=0;n<t.length;++n)t[n].onEvaluationTypeChanged(e)}get physics(){return this._physicsRuntime}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){Rn.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){Rn.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){Rn.Logger.Error(e)}_errorDisabled(){}}class Qs{_frontBuffer;_backBuffer;constructor(e,t){this._frontBuffer=e,this._backBuffer=t??e}setBackBuffer(e){this._backBuffer=e}swap(){const e=this._backBuffer;this._backBuffer=this._frontBuffer,this._frontBuffer=e}get frontBuffer(){return this._frontBuffer.array}get backBuffer(){return this._backBuffer.array}}class Hs{_data;_frontBufferPtr;_frontBufferSpan;_backBufferSpan;constructor(e,t,n,i){this._data=t;const r=this._frontBufferPtr=t.frontBuffer.byteOffset;this._frontBufferSpan=e.createTypedArray(t.frontBuffer.constructor,r+n,i);const o=t.backBuffer.byteOffset;this._backBufferSpan=e.createTypedArray(t.backBuffer.constructor,o+n,i)}updateBackBufferReference(e){const t=this._frontBufferSpan.array,n=t.byteOffset-this._frontBufferPtr,i=t.length,r=this._data.backBuffer.byteOffset;this._backBufferSpan=e.createTypedArray(this._data.backBuffer.constructor,r+n,i)}get array(){if(this._frontBufferPtr!==this._data.frontBuffer.byteOffset){this._frontBufferPtr=this._data.frontBuffer.byteOffset;const e=this._backBufferSpan;this._backBufferSpan=this._frontBufferSpan,this._frontBufferSpan=e}return this._frontBufferSpan.array}}class $s{linkedBone;name;parentBone;childBones;transformOrder;flag;transformAfterPhysics;_worldMatrix;get worldMatrix(){return this._worldMatrix.array}ikSolverIndex;constructor(e,t,n,i,r,o){this.linkedBone=e,this.name=t.name,this.parentBone=null,this.childBones=[],this.transformOrder=t.transformOrder,this.flag=t.flag,this.transformAfterPhysics=!!(t.flag&bt.B.Bone.Flag.TransformAfterPhysics),this._worldMatrix=new Hs(o.wasmInstance,n,16*i*4,16),this.ikSolverIndex=r}updateBackBufferReference(e){this._worldMatrix.updateBackBufferReference(e)}getWorldMatrixToRef(e){return rt.Matrix.FromArrayToRef(this._worldMatrix.array,0,e)}getWorldTranslationToRef(e){return rt.Vector3.FromArrayToRef(this._worldMatrix.array,12,e)}setWorldTranslationFromRef(e){const t=this._worldMatrix.array;t[12]=e.x,t[13]=e.y,t[14]=e.z}}class Xs{ptr;mesh;skeleton;_worldTransformMatrices;get worldTransformMatrices(){return this._worldTransformMatrices.frontBuffer}_boneAnimationStates;get boneAnimationStates(){return this._runtime.lock.wait(),this._boneAnimationStates.array}_ikSolverStates;get ikSolverStates(){return this._runtime.lock.wait(),this._ikSolverStates.array}runtimeBones;morph;_physicsModel;_runtime;_sortedRuntimeBones;onCurrentAnimationChangedObservable;_animations;_currentAnimation;_needStateReset;constructor(e,t,n,i,r,o,a){const s=e.wasmInstance,l=e.wasmInternal;this._runtime=e;const h=n.metadata,d=n;d.metadata={isRuntimeMmdModel:!0,header:h.header,meshes:h.meshes,materials:h.materials,skeleton:h.skeleton},this.ptr=t,this.mesh=d,this.skeleton=i;const c=l.getBoneWorldMatrixArena(t),u=l.getAnimationArena(t),m=l.getAnimationIkSolverStateArena(t),p=l.getAnimationMorphArena(t),_=s.createTypedArray(Float32Array,c,16*h.bones.length);let g=_;if(e.evaluationType===zs.Buffered){const e=l.createBoneWorldMatrixBackBuffer(this.ptr);g=s.createTypedArray(Float32Array,e,16*h.bones.length)}const f=this._worldTransformMatrices=new Qs(_,g);this._boneAnimationStates=s.createTypedArray(Float32Array,u,12*h.bones.length);let b=0;for(let e=0;e<h.bones.length;++e)h.bones[e].ik&&(b+=1);this._ikSolverStates=s.createTypedArray(Uint8Array,m,b),i.prepare(),this._disableSkeletonWorldMatrixUpdate(i);const y=this.runtimeBones=this._buildRuntimeSkeleton(i.bones,h.bones,f,e);(this._sortedRuntimeBones=[...y]).sort(((e,t)=>e.transformOrder-t.transformOrder));const w=h.morphs;let A=0;for(let e=0;e<w.length;++e)switch(w[e].type){case bt.B.Morph.Type.BoneMorph:case bt.B.Morph.Type.GroupMorph:A+=1}const M=s.createTypedArray(Float32Array,p,A),T=[];{const e=h.meshes;for(let t=0;t<e.length;++t){const n=e[t].morphTargetManager;null!==n&&T.push(n)}}this.morph=new Ws(M,o,h.materials,h.meshes,r,h.morphs,T),null!==a?(l.setExternalPhysics(t,!0),this._physicsModel=a.buildPhysics(n,y,h.rigidBodies,h.joints,e)):this._physicsModel=null,this.onCurrentAnimationChangedObservable=new pt.Observable,this._animations=[],this._currentAnimation=null,this._needStateReset=!1}dispose(){this._enableSkeletonWorldMatrixUpdate(),this._physicsModel?.dispose(),this.onCurrentAnimationChangedObservable.clear();const e=this._animations;for(let t=0;t<e.length;++t)e[t].dispose?.();this._animations.length=0,this.mesh.metadata=null}get sortedRuntimeBones(){return this._sortedRuntimeBones}addAnimation(e,t,n=!0){let i;if(void 0!==e.createWasmRuntimeModelAnimation)this._runtime.lock.wait(),i=e.createWasmRuntimeModelAnimation(this,(()=>{this._removeAnimationByReference(i)}),t,this._runtime);else{if(void 0===e.createRuntimeModelAnimation)throw new Error('animation is not MmdWasmAnimation or MmdAnimation or MmdModelAnimationGroup or MmdCompositeAnimation. are you missing import "babylon-mmd/esm/Runtime/Optimized/Animation/mmdWasmRuntimeModelAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimationGroup" or "babylon-mmd/esm/Runtime/Animation/mmdCompositeRuntimeModelAnimation"?');i=e.createRuntimeModelAnimation(this,t,this._runtime),void 0!==e.ptr&&this._runtime.warn('MmdWasmAnimation has better performance in the wasm animation runtime. consider importing "babylon-mmd/esm/Runtime/Optimized/Animation/mmdWasmRuntimeModelAnimation" instead of "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimation"')}const r=this._animations.findIndex((t=>t.animation.name===e.name));if(-1!==r){const e=this._animations[r];this._animations[r]=i,this._currentAnimation===e&&(this._currentAnimation=i,this._resetPose(),this._needStateReset=!0,void 0!==i.wasmAnimate&&(this._runtime.lock.wait(),this._runtime.wasmInternal.setRuntimeAnimation(this.ptr,i.ptr)),i.induceMaterialRecompile(n,this._runtime),this.onCurrentAnimationChangedObservable.notifyObservers(i))}else this._animations.push(i)}_removeAnimationByReference(e){const t=this._animations.indexOf(e);-1!==t&&this._removeAnimation(t,!0)}removeAnimation(e){this._removeAnimation(e,!1)}_removeAnimation(e,t){const n=this._animations[e];void 0!==n&&(this._currentAnimation===n&&(this._resetPose(),void 0!==this._currentAnimation.wasmAnimate&&(this._runtime.lock.wait(),this._runtime.wasmInternal.setRuntimeAnimation(this.ptr,0)),this._currentAnimation=null,this.onCurrentAnimationChangedObservable.notifyObservers(null)),this._animations.splice(e,1),t||n.dispose?.())}setAnimation(e,t=!0){if(null===e)return void(null!==this._currentAnimation&&(this._resetPose(),void 0!==this._currentAnimation.wasmAnimate&&(this._runtime.lock.wait(),this._runtime.wasmInternal.setRuntimeAnimation(this.ptr,0)),this._currentAnimation=null,this.onCurrentAnimationChangedObservable.notifyObservers(null)));const n=this._animations.findIndex((t=>t.animation.name===e));if(-1===n)throw new Error(`Animation '${e}' is not found.`);null!==this._currentAnimation&&(this._resetPose(),this._needStateReset=!0);const i=this._currentAnimation=this._animations[n];void 0!==i.wasmAnimate&&(this._runtime.lock.wait(),this._runtime.wasmInternal.setRuntimeAnimation(this.ptr,i.ptr)),i.induceMaterialRecompile(t,this._runtime),this.onCurrentAnimationChangedObservable.notifyObservers(i)}get runtimeAnimations(){return this._animations}get currentAnimation(){return this._currentAnimation}initializePhysics(){this._physicsModel?.initialize()}beforePhysicsAndWasm(e){if(null!==e&&(this._needStateReset&&(this._needStateReset=!1,this.ikSolverStates.fill(1),this.morph.resetMorphWeights()),null!==this._currentAnimation&&this._currentAnimation.animate(e)),this.morph.update(),void 0===this._currentAnimation?.wasmAnimate){const e=this.skeleton.bones,t=this.boneAnimationStates;for(let n=0;n<e.length;++n){const i=e[n],r=12*n;{const{x:e,y:n,z:o}=i.position;t[r+0]=e,t[r+1]=n,t[r+2]=o}{const{x:e,y:n,z:o,w:a}=i.rotationQuaternion;t[r+4]=e,t[r+5]=n,t[r+6]=o,t[r+7]=a}{const{x:e,y:n,z:o}=i.scaling;t[r+8]=e,t[r+9]=n,t[r+10]=o}}}}beforePhysics(){this._physicsModel?.syncBodies()}afterPhysicsAndWasm(){const e=this._physicsModel;null!==e&&e.syncBones()}afterPhysics(){this.mesh.metadata.skeleton._markAsDirty()}_buildRuntimeSkeleton(e,t,n,i){const r=[];let o=0;for(let a=0;a<t.length;++a){const s=t[a];let l=-1;void 0!==s.ik&&(l=o,o+=1),r.push(new $s(e[a],s,n,a,l,i))}for(let e=0;e<t.length;++e){const n=t[e],i=r[e],o=n.parentBoneIndex;if(0<=o&&o<r.length){const e=r[o];i.parentBone=e,e.childBones.push(i)}}return r}_originalComputeTransformMatrices=null;_disableSkeletonWorldMatrixUpdate(e){if(null!==this._originalComputeTransformMatrices)return;this._originalComputeTransformMatrices=e._computeTransformMatrices;const t=this._worldTransformMatrices;e._computeTransformMatrices=function(e,n){this.onBeforeComputeObservable.notifyObservers(this);const i=t.frontBuffer;for(let t=0;t<this.bones.length;t++){const n=this.bones[t];if(n._childUpdateId+=1,-1!==n._index){const r=null===n._index?t:n._index;n.getAbsoluteInverseBindMatrix().multiplyToArray(rt.Matrix.FromArrayToRef(i,16*t,n.getFinalMatrix()),e,16*r)}}this._identity.copyToArray(e,16*this.bones.length)}}_enableSkeletonWorldMatrixUpdate(){null!==this._originalComputeTransformMatrices&&(this.skeleton._computeTransformMatrices=this._originalComputeTransformMatrices,this._originalComputeTransformMatrices=null)}_resetPose(){const e=new rt.Vector3;if(void 0===this._currentAnimation?.wasmAnimate){const t=this._sortedRuntimeBones,n=rt.Quaternion.Identity();for(let i=0;i<t.length;++i){const r=t[i].linkedBone;r.getRestMatrix().getTranslationToRef(e),r.position=e,r.setRotationQuaternion(n,Ut.Space.LOCAL)}}else{this._runtime.lock.wait();const t=this.skeleton.bones,n=this.boneAnimationStates;for(let i=0;i<t.length;++i){const r=t[i],o=12*i,{x:a,y:s,z:l}=r.getRestMatrix().getTranslationToRef(e);n[o+0]=a,n[o+1]=s,n[o+2]=l,n[o+4]=0,n[o+5]=0,n[o+6]=0,n[o+7]=1,n[o+8]=1,n[o+9]=1,n[o+10]=1}}this.mesh.metadata.skeleton._markAsDirty()}onEvaluationTypeChanged(e){if(e===zs.Buffered){const e=this._worldTransformMatrices;if(e.frontBuffer===e.backBuffer){const t=this._runtime.wasmInstance,n=this._runtime.wasmInternal.createBoneWorldMatrixBackBuffer(this.ptr),i=t.createTypedArray(Float32Array,n,e.frontBuffer.length);e.setBackBuffer(i);const r=this._sortedRuntimeBones;for(let e=0;e<r.length;++e)r[e].updateBackBufferReference(t)}}}swapWorldTransformMatricesBuffer(){this._worldTransformMatrices.swap()}}var Js=We(5905),Zs=We(2273);class el extends Zs.AmmoJSPlugin{_mmdtmpAmmoVector;_mmdtmpAmmoQuat;_mmdtmpAmmoTransformA;_mmdtmpAmmoTransformB;static _BjsQuaternion=new rt.Quaternion;constructor(e=!0,t,n=null){super(e,t,n),this.name="MmdAmmoJSPlugin",this._mmdtmpAmmoVector=new this.bjsAMMO.btVector3,this._mmdtmpAmmoQuat=new this.bjsAMMO.btQuaternion,this._mmdtmpAmmoTransformA=new this.bjsAMMO.btTransform,this._mmdtmpAmmoTransformB=new this.bjsAMMO.btTransform}dispose(){super.dispose(),this.bjsAMMO.destroy(this._mmdtmpAmmoVector),this.bjsAMMO.destroy(this._mmdtmpAmmoQuat),this.bjsAMMO.destroy(this._mmdtmpAmmoTransformA),this.bjsAMMO.destroy(this._mmdtmpAmmoTransformB)}_stepSimulation(e=1/60,t=10,n=1/60){this.world.stepSimulation(e,t,n)}_normalizeAngle(e){const t=Math.PI,n=2*t;return(e%=n)<-t?e+=n:e>t&&(e-=n),e}generateJoint(e){const t=e.mainImpostor.physicsBody,n=e.connectedImpostor.physicsBody;if(t&&n&&!e.joint.physicsJoint)if(20===e.joint.type){const i=e.joint.jointData;i.mainFrame||(i.mainFrame=rt.Matrix.Identity()),i.connectedFrame||(i.connectedFrame=rt.Matrix.Identity()),i.useLinearReferenceFrameA||(i.useLinearReferenceFrameA=!0),i.linearLowerLimit||(i.linearLowerLimit=new rt.Vector3(0,0,0)),i.linearUpperLimit||(i.linearUpperLimit=new rt.Vector3(0,0,0)),i.angularLowerLimit||(i.angularLowerLimit=new rt.Vector3(0,0,0)),i.angularUpperLimit||(i.angularUpperLimit=new rt.Vector3(0,0,0)),i.linearStiffness||(i.linearStiffness=new rt.Vector3(0,0,0)),i.angularStiffness||(i.angularStiffness=new rt.Vector3(0,0,0));const r=this._mmdtmpAmmoVector,o=this._mmdtmpAmmoQuat;{const e=i.mainFrame;r.setValue(e.m[12],e.m[13],e.m[14]);const t=rt.Quaternion.FromRotationMatrixToRef(e,el._BjsQuaternion);o.setValue(t.x,t.y,t.z,t.w)}const a=this._mmdtmpAmmoTransformA;a.setOrigin(r),a.setRotation(o);{const e=i.connectedFrame;r.setValue(e.m[12],e.m[13],e.m[14]);const t=rt.Quaternion.FromRotationMatrixToRef(e,el._BjsQuaternion);o.setValue(t.x,t.y,t.z,t.w)}const s=this._mmdtmpAmmoTransformB;s.setOrigin(r),s.setRotation(o);const l=new this.bjsAMMO.btGeneric6DofSpringConstraint(t,n,a,s,i.useLinearReferenceFrameA);0!==i.linearStiffness.x?(l.setStiffness(0,i.linearStiffness.x),l.enableSpring(0,!0)):l.enableSpring(0,!1),0!==i.linearStiffness.y?(l.setStiffness(1,i.linearStiffness.y),l.enableSpring(1,!0)):l.enableSpring(1,!1),0!==i.linearStiffness.z?(l.setStiffness(2,i.linearStiffness.z),l.enableSpring(2,!0)):l.enableSpring(2,!1),l.setStiffness(3,i.angularStiffness.x),l.enableSpring(3,!0),l.setStiffness(4,i.angularStiffness.y),l.enableSpring(4,!0),l.setStiffness(5,i.angularStiffness.z),l.enableSpring(5,!0);const h=this._mmdtmpAmmoVector;h.setValue(i.linearLowerLimit.x,i.linearLowerLimit.y,i.linearLowerLimit.z),l.setLinearLowerLimit(h),h.setValue(i.linearUpperLimit.x,i.linearUpperLimit.y,i.linearUpperLimit.z),l.setLinearUpperLimit(h),h.setValue(this._normalizeAngle(i.angularLowerLimit.x),this._normalizeAngle(i.angularLowerLimit.y),this._normalizeAngle(i.angularLowerLimit.z)),l.setAngularLowerLimit(h),h.setValue(this._normalizeAngle(i.angularUpperLimit.x),this._normalizeAngle(i.angularUpperLimit.y),this._normalizeAngle(i.angularUpperLimit.z)),l.setAngularUpperLimit(h),this.world.addConstraint(l,!e.joint.jointData.collision),e.joint.physicsJoint=l}else super.generateJoint(e)}}class tl extends Js.PhysicsJoint{constructor(e){super(20,e)}}We(5031),We(9106);var nl=We(8619),il=We(4439),rl=We(4398);class ol extends il.AbstractMesh{linkedBone;physicsMode;bodyOffsetMatrix;bodyOffsetInverseMatrix;_customBoundingInfo;constructor(e,t,n,i,r){super(e,t),this.linkedBone=n,this.physicsMode=i,this.bodyOffsetMatrix=rt.Matrix.Identity(),this.bodyOffsetInverseMatrix=rt.Matrix.Identity(),this._customBoundingInfo=r}static _WorldMatrix=new rt.Matrix;computeBodyOffsetMatrix(e){rt.Matrix.ComposeToRef(this.scaling,this.rotationQuaternion,this.position,ol._WorldMatrix).multiplyToRef(e,this.bodyOffsetMatrix),this.bodyOffsetMatrix.invertToRef(this.bodyOffsetInverseMatrix)}getBoundingInfo(){return this._customBoundingInfo??super.getBoundingInfo()}get _positions(){return null}copyVerticesData(e,t){}refreshBoundingInfo(e,t){return this}}class al extends rl.PhysicsImpostor{linkedBone;constructor(e,t,n,i,r){super(e,t,n,r),this.linkedBone=i}}class sl{_mmdPhysics;_nodes;_impostors;_rootMesh;_ammoInstance;_tmpBtVector3;_tmpBtQuaternion;_tmpBtTransform;constructor(e,t,n,i,r){this._mmdPhysics=e,this._nodes=t,this._impostors=n,this._rootMesh=i,this._ammoInstance=r,this._tmpBtVector3=new r.btVector3,this._tmpBtQuaternion=new r.btQuaternion,this._tmpBtTransform=new r.btTransform}dispose(){const e=this._impostors;for(let t=0;t<e.length;++t){const n=e[t];null!==n&&(n.dispose(),n.object.physicsImpostor=null)}e.length=0;const t=this._nodes;for(let e=0;e<t.length;++e)t[e]?.dispose(!1,!0);t.length=0,this._ammoInstance.destroy(this._tmpBtVector3),this._ammoInstance.destroy(this._tmpBtQuaternion),this._ammoInstance.destroy(this._tmpBtTransform)}static _NodeWorldMatrix=new rt.Matrix;static _ZeroVector=rt.Vector3.Zero();static _Position=new rt.Vector3;static _Rotation=new rt.Quaternion;initialize(){const e=this._rootMesh.computeWorldMatrix(),t=sl._Position,n=sl._Rotation,i=this._tmpBtVector3,r=this._tmpBtQuaternion,o=this._tmpBtTransform,a=this._mmdPhysics,s=this._nodes;for(let l=0;l<s.length;++l){const h=s[l];if(null===h)continue;if(null===h.linkedBone)continue;const d=h.linkedBone.getWorldMatrixToRef(sl._NodeWorldMatrix);if(h.bodyOffsetMatrix.multiplyToRef(d,d),h.physicsMode===bt.B.RigidBody.PhysicsMode.FollowBone)d.decompose(h.scaling,h.rotationQuaternion,h.position);else{d.multiplyToRef(e,d),d.decompose(void 0,n,t);const s=h.physicsImpostor;a._makeKinematicOnce(s),i.setValue(t.x,t.y,t.z),r.setValue(n.x,n.y,n.z,n.w),o.setOrigin(i),o.setRotation(r),s.physicsBody.getMotionState().setWorldTransform(o)}}}syncBodies(){const e=this._nodes;for(let t=0;t<e.length;++t){const n=e[t];if(null!==n&&null!==n.linkedBone)switch(n.physicsMode){case bt.B.RigidBody.PhysicsMode.FollowBone:{const e=n.linkedBone.getWorldMatrixToRef(sl._NodeWorldMatrix);n.bodyOffsetMatrix.multiplyToRef(e,e),e.decompose(n.scaling,n.rotationQuaternion,n.position)}break;case bt.B.RigidBody.PhysicsMode.Physics:case bt.B.RigidBody.PhysicsMode.PhysicsWithBone:break;default:throw new Error(`Unknown physics mode: ${n.physicsMode}`)}}}static _BoneWorldPosition=new rt.Vector3;syncBones(){const e=this._nodes;for(let t=0;t<e.length;++t){const n=e[t];if(null!==n&&null!==n.linkedBone)switch(n.physicsMode){case bt.B.RigidBody.PhysicsMode.FollowBone:break;case bt.B.RigidBody.PhysicsMode.Physics:n.bodyOffsetInverseMatrix.multiplyToArray(rt.Matrix.ComposeToRef(n.scaling,n.rotationQuaternion,n.position,sl._NodeWorldMatrix),n.linkedBone.worldMatrix,0);break;case bt.B.RigidBody.PhysicsMode.PhysicsWithBone:n.linkedBone.getWorldTranslationToRef(sl._BoneWorldPosition),n.bodyOffsetInverseMatrix.multiplyToArray(rt.Matrix.ComposeToRef(n.scaling,n.rotationQuaternion,sl._ZeroVector,sl._NodeWorldMatrix),n.linkedBone.worldMatrix,0),n.linkedBone.setWorldTranslationFromRef(sl._BoneWorldPosition);break;default:throw new Error(`Unknown physics mode: ${n.physicsMode}`)}}}}class ll{_scene;_kinematicOnces=[];constructor(e){this._scene=e}buildPhysics(e,t,n,i,r){const o=this._scene,a=o.getPhysicsEngine()?.getPhysicsPlugin();if(!a)throw new Error("Physics engine is not enabled");if("MmdAmmoJSPlugin"!==a.name)throw new Error("Physics engine is not MMDAmmoJSPlugin");let s;e.computeWorldMatrix(!0);const l=e.getWorldMatrix(),h=new rt.Quaternion;{const e=new rt.Vector3;l.decompose(e,h),Math.abs(e.x-e.y)<1e-4&&Math.abs(e.y-e.z)<1e-4?Math.abs(e.x-1)<1e-4?s=1:(s=e.x,r.warn("Root node scaling is not 1, simulation may differ from the original")):(s=Math.max(e.x,e.y,e.z),r.warn("Root node scaling is not uniform, physics may not work correctly"))}const d=new Array(n.length),c=new Array(n.length),u=new Map;for(let e=0;e<t.length;++e){const n=t[e];u.set(n.name,n)}const m=e=>e.boneIndex<0||t.length<=e.boneIndex?u.get(e.name):t[e.boneIndex];for(let t=0;t<n.length;++t){const i=n[t],u=m(i);let p;void 0===u&&r.warn(`Bone index out of range create unmapped rigid body: ${i.name}`);const _=new rt.Vector3,g=new rt.Vector3;let f=!1;switch(i.shapeType){case bt.B.RigidBody.ShapeType.Sphere:{p=rl.PhysicsImpostor.SphereImpostor;const e=i.shapeSize[0]*s;_.copyFromFloats(-e,-e,-e),g.copyFromFloats(e,e,e),0===e&&(f=!0);break}case bt.B.RigidBody.ShapeType.Box:{p=rl.PhysicsImpostor.BoxImpostor;const e=i.shapeSize;_.copyFromFloats(-e[0]*s,-e[1]*s,-e[2]*s),g.copyFromFloats(e[0]*s,e[1]*s,e[2]*s),0!==e[0]&&0!==e[1]&&0!==e[2]||(f=!0);break}case bt.B.RigidBody.ShapeType.Capsule:{p=rl.PhysicsImpostor.CapsuleImpostor;const e=i.shapeSize,t=e[0]*s,n=e[1]/2*s+t;_.copyFromFloats(-t,-n,-t),g.copyFromFloats(t,n,t),0!==e[0]&&0!==e[1]||(f=!0);break}default:r.warn(`Unknown rigid body shape type: ${i.shapeType}`),d[t]=null,c[t]=null;continue}const b=new ol(i.name,o,u??null,i.physicsMode,new nl.BoundingInfo(_,g)),y=i.shapePosition;b.position.copyFromFloats(y[0],y[1],y[2]);const w=i.shapeRotation;b.rotationQuaternion=rt.Quaternion.FromEulerAngles(w[0],w[1],w[2]),void 0!==u&&b.computeBodyOffsetMatrix(u.linkedBone.getAbsoluteInverseBindMatrix()),rt.Vector3.TransformCoordinatesToRef(b.position,l,b.position),h.multiplyToRef(b.rotationQuaternion,b.rotationQuaternion);const A={mass:i.physicsMode===bt.B.RigidBody.PhysicsMode.FollowBone?0:i.mass*s,friction:i.friction,restitution:i.repulsion,ignoreParent:!0,disableBidirectionalTransformation:i.physicsMode!==bt.B.RigidBody.PhysicsMode.FollowBone,group:1<<i.collisionGroup,mask:i.collisionMask},M=b.physicsImpostor=void 0!==u?new al(b,p,A,u,o):new rl.PhysicsImpostor(b,p,A,o);M.setDeltaPosition(new rt.Vector3(0,0,0)),b.setParent(e);const T=M.physicsBody;(0===i.collisionMask||f)&&T.setCollisionFlags(4|T.getCollisionFlags()),T.setDamping(i.linearDamping,i.angularDamping),T.setSleepingThresholds(0,0);const x=a.bjsAMMO.getPointer(T);a.bjsAMMO.HEAP32[x/4+113]=4294967295,d[t]=b,c[t]=M}const p=rt.Vector3.One(),_=new rt.Quaternion,g=new rt.Vector3,f=new rt.Matrix,b=new rt.Quaternion,y=new rt.Vector3,w=new rt.Matrix,A=new rt.Matrix,M=new rt.Matrix,T=new rt.Matrix;for(let e=0;e<i.length;++e){const t=i[e];if(t.rigidbodyIndexA<0||n.length<=t.rigidbodyIndexA){r.warn(`Rigid body index out of range failed to create joint: ${t.name}`);continue}if(t.rigidbodyIndexB<0||n.length<=t.rigidbodyIndexB){r.warn(`Rigid body index out of range failed to create joint: ${t.name}`);continue}const o=c[t.rigidbodyIndexA],a=c[t.rigidbodyIndexB];if(null===o||null===a){r.warn(`Rigid body not found failed to create joint: ${t.name}`);continue}rt.Matrix.ComposeToRef(p,rt.Quaternion.FromEulerAnglesToRef(t.rotation[0],t.rotation[1],t.rotation[2],_),g.copyFromFloats(t.position[0]*s,t.position[1]*s,t.position[2]*s),f);const l=n[t.rigidbodyIndexA],h=n[t.rigidbodyIndexB];{const e=l.shapeRotation,t=l.shapePosition;rt.Matrix.ComposeToRef(p,rt.Quaternion.FromEulerAnglesToRef(e[0],e[1],e[2],b),y.copyFromFloats(t[0]*s,t[1]*s,t[2]*s),w).invert()}{const e=h.shapeRotation,t=h.shapePosition;rt.Matrix.ComposeToRef(p,rt.Quaternion.FromEulerAnglesToRef(e[0],e[1],e[2],b),y.copyFromFloats(t[0]*s,t[1]*s,t[2]*s),A).invert()}f.multiplyToRef(w,M),f.multiplyToRef(A,T);const u=new tl({mainFrame:M,connectedFrame:T,useLinearReferenceFrameA:!0,linearLowerLimit:new rt.Vector3(t.positionMin[0],t.positionMin[1],t.positionMin[2]),linearUpperLimit:new rt.Vector3(t.positionMax[0],t.positionMax[1],t.positionMax[2]),angularLowerLimit:new rt.Vector3(t.rotationMin[0],t.rotationMin[1],t.rotationMin[2]),angularUpperLimit:new rt.Vector3(t.rotationMax[0],t.rotationMax[1],t.rotationMax[2]),linearStiffness:new rt.Vector3(t.springPosition[0],t.springPosition[1],t.springPosition[2]),angularStiffness:new rt.Vector3(t.springRotation[0],t.springRotation[1],t.springRotation[2]),collision:!0});o.addJoint(a,u);const x=d[t.rigidbodyIndexA],v=d[t.rigidbodyIndexB];if(x.physicsMode!==bt.B.RigidBody.PhysicsMode.FollowBone&&v.physicsMode===bt.B.RigidBody.PhysicsMode.PhysicsWithBone){const e=m(h);void 0!==e&&e.parentBone===m(l)&&(v.physicsMode=bt.B.RigidBody.PhysicsMode.Physics)}else if(v.physicsMode!==bt.B.RigidBody.PhysicsMode.FollowBone&&x.physicsMode===bt.B.RigidBody.PhysicsMode.PhysicsWithBone){const e=m(l);void 0!==e&&e.parentBone===m(h)&&(x.physicsMode=bt.B.RigidBody.PhysicsMode.Physics)}}return new sl(this,d,c,e,a.bjsAMMO)}static _ZeroVector=rt.Vector3.Zero();_onAfterPhysics=()=>{const e=this._kinematicOnces;for(let t=0;t<e.length;++t){const n=e[t];n.setLinearVelocity(ll._ZeroVector),n.setAngularVelocity(ll._ZeroVector);const i=n.physicsBody;i.setCollisionFlags(-3&i.getCollisionFlags())}e.length=0};_makeKinematicOnce(e){e._options.disableBidirectionalTransformation&&(0===this._kinematicOnces.length&&this._scene.onAfterPhysicsObservable.addOnce(this._onAfterPhysics),this._kinematicOnces.push(e),e.physicsBody.setCollisionFlags(2|e.physicsBody.getCollisionFlags()))}}We(6247);var hl,dl=We(4044),cl=We(6970),ul=We(3466),ml=We(3301),pl=We(5755);class _l extends dl.TransformNode{linkedBone;physicsMode;bodyOffsetMatrix;bodyOffsetInverseMatrix;constructor(e,t,n,i,r){super(e,t,r),this.linkedBone=n,this.physicsMode=i,this.bodyOffsetMatrix=rt.Matrix.Identity(),this.bodyOffsetInverseMatrix=rt.Matrix.Identity()}static _WorldMatrix=new rt.Matrix;computeBodyOffsetMatrix(e){rt.Matrix.ComposeToRef(this.scaling,this.rotationQuaternion,this.position,_l._WorldMatrix).multiplyToRef(e,this.bodyOffsetMatrix),this.bodyOffsetMatrix.invertToRef(this.bodyOffsetInverseMatrix)}}class gl extends ul.PhysicsBody{linkedBone;constructor(e,t,n,i,r){super(e,t,n,r),this.linkedBone=i}}class fl{_mmdPhysics;_nodes;_bodies;_constraints;constructor(e,t,n,i){this._mmdPhysics=e,this._nodes=t,this._bodies=n,this._constraints=i}dispose(){const e=this._constraints;for(let t=0;t<e.length;++t)e[t]?.dispose();e.length=0;const t=this._bodies;for(let e=0;e<t.length;++e){const n=t[e];null!==n&&(n.shape?.dispose(),n.dispose())}t.length=0;const n=this._nodes;for(let e=0;e<n.length;++e)n[e]?.dispose();n.length=0}static _NodeWorldMatrix=new rt.Matrix;static _ZeroVector=rt.Vector3.Zero();initialize(){const e=this._mmdPhysics,t=this._nodes;for(let n=0;n<t.length;++n){const i=t[n];if(null===i)continue;if(null===i.linkedBone)continue;const r=i.linkedBone.getWorldMatrixToRef(fl._NodeWorldMatrix);i.bodyOffsetMatrix.multiplyToRef(r,r),r.decompose(i.scaling,i.rotationQuaternion,i.position);const o=i.physicsBody;o.setAngularVelocity(fl._ZeroVector),o.setLinearVelocity(fl._ZeroVector),e._enablePreStepOnce(o)}}static _NodeWorldPosition=new rt.Vector3;static _NodeWorldRotation=new rt.Quaternion;syncBodies(){const e=this._nodes;for(let t=0;t<e.length;++t){const n=e[t];if(null!==n&&null!==n.linkedBone)switch(n.physicsMode){case bt.B.RigidBody.PhysicsMode.FollowBone:{const e=n.linkedBone.getWorldMatrixToRef(fl._NodeWorldMatrix);n.bodyOffsetMatrix.multiplyToRef(e,e),e.decompose(n.scaling,n.rotationQuaternion,n.position),n.computeWorldMatrix(!0).decompose(void 0,fl._NodeWorldRotation,fl._NodeWorldPosition),n.physicsBody.setTargetTransform(fl._NodeWorldPosition,fl._NodeWorldRotation)}break;case bt.B.RigidBody.PhysicsMode.Physics:case bt.B.RigidBody.PhysicsMode.PhysicsWithBone:break;default:throw new Error(`Unknown physics mode: ${n.physicsMode}`)}}}static _BoneWorldPosition=new rt.Vector3;syncBones(){const e=this._nodes;for(let t=0;t<e.length;++t){const n=e[t];if(null!==n&&null!==n.linkedBone)switch(n.physicsMode){case bt.B.RigidBody.PhysicsMode.FollowBone:break;case bt.B.RigidBody.PhysicsMode.Physics:n.bodyOffsetInverseMatrix.multiplyToArray(rt.Matrix.ComposeToRef(n.scaling,n.rotationQuaternion,n.position,fl._NodeWorldMatrix),n.linkedBone.worldMatrix,0);break;case bt.B.RigidBody.PhysicsMode.PhysicsWithBone:n.linkedBone.getWorldTranslationToRef(fl._BoneWorldPosition),n.bodyOffsetInverseMatrix.multiplyToArray(rt.Matrix.ComposeToRef(n.scaling,n.rotationQuaternion,fl._ZeroVector,fl._NodeWorldMatrix),n.linkedBone.worldMatrix,0),n.linkedBone.setWorldTranslationFromRef(fl._BoneWorldPosition);break;default:throw new Error(`Unknown physics mode: ${n.physicsMode}`)}}}}class bl{angularLimitClampThreshold;_scene;_enablePreStepOnces=[];constructor(e){this.angularLimitClampThreshold=5*Math.PI/180,this._scene=e}_convertParameter(e){const t=1/60;return(1-(1-e)**t)/t}_clampAngularLimit(e){return Math.abs(e)<this.angularLimitClampThreshold?0:e}buildPhysics(e,t,n,i,r){const o=this._scene,a=o.getPhysicsEngine()?.getPhysicsPlugin();if(!a)throw new Error("Physics engine is not enabled");if("HavokPlugin"!==a.name)throw new Error("Physics plugin is not HavokPlugin");let s;{e.computeWorldMatrix(!0);const t=e.getWorldMatrix(),n=new rt.Vector3;t.decompose(n),Math.abs(n.x-n.y)<1e-4&&Math.abs(n.y-n.z)<1e-4?Math.abs(n.x-1)<1e-4?s=1:(s=n.x,r.warn("Root node scaling is not 1, simulation may differ from the original")):(s=Math.max(n.x,n.y,n.z),r.warn("Root node scaling is not uniform, physics may not work correctly"))}const l=new Array(n.length),h=new Array(n.length),d=new Array(i.length),c=new Map;for(let e=0;e<t.length;++e){const n=t[e];c.set(n.name,n)}const u=e=>e.boneIndex<0||t.length<=e.boneIndex?c.get(e.name):t[e.boneIndex];for(let t=0;t<n.length;++t){const i=n[t],d=u(i);let c;void 0===d&&r.warn(`Bone index out of range create unmapped rigid body: ${i.name}`);let m=!1;switch(i.shapeType){case bt.B.RigidBody.ShapeType.Sphere:c=new pl.PhysicsShapeSphere(new rt.Vector3,i.shapeSize[0]*s,o),0===i.shapeSize[0]&&(m=!0);break;case bt.B.RigidBody.ShapeType.Box:c=new pl.PhysicsShapeBox(new rt.Vector3,new rt.Quaternion,new rt.Vector3(2*i.shapeSize[0]*s,2*i.shapeSize[1]*s,2*i.shapeSize[2]*s),o),0!==i.shapeSize[0]&&0!==i.shapeSize[1]&&0!==i.shapeSize[2]||(m=!0);break;case bt.B.RigidBody.ShapeType.Capsule:c=new pl.PhysicsShapeCapsule(new rt.Vector3(0,i.shapeSize[1]/2*s,0),new rt.Vector3(0,-i.shapeSize[1]/2*s,0),i.shapeSize[0]*s,o),0!==i.shapeSize[0]&&0!==i.shapeSize[1]||(m=!0);break;default:r.warn(`Unknown rigid body shape type: ${i.shapeType}`),l[t]=null,h[t]=null;continue}c.material={friction:i.friction,restitution:i.repulsion},c.filterCollideMask=m?0:i.collisionMask,c.filterMembershipMask=1<<i.collisionGroup;const p=new _l(i.name,o,d??null,i.physicsMode),_=i.shapePosition;p.position.copyFromFloats(_[0],_[1],_[2]);const g=i.shapeRotation;p.rotationQuaternion=rt.Quaternion.FromEulerAngles(g[0],g[1],g[2]),void 0!==d&&p.computeBodyOffsetMatrix(d.linkedBone.getAbsoluteInverseBindMatrix()),p.setParent(e);const f=i.physicsMode===bt.B.RigidBody.PhysicsMode.FollowBone?cl.PhysicsMotionType.ANIMATED:cl.PhysicsMotionType.DYNAMIC,b=void 0!==d?new gl(p,f,!1,d,o):new ul.PhysicsBody(p,f,!1,o);a.setActivationControl(b,cl.PhysicsActivationControl.ALWAYS_ACTIVE),b.shape=c,b.setMassProperties({mass:i.mass}),b.setLinearDamping(this._convertParameter(i.linearDamping)),b.setAngularDamping(this._convertParameter(i.angularDamping)),b.computeMassProperties(),l[t]=p,h[t]=b}const m=rt.Vector3.One(),p=new rt.Quaternion,_=new rt.Vector3,g=new rt.Matrix,f=new rt.Quaternion,b=new rt.Vector3,y=new rt.Matrix,w=new rt.Matrix,A=new rt.Matrix,M=new rt.Matrix;for(let e=0;e<i.length;++e){const t=i[e];if(t.rigidbodyIndexA<0||n.length<=t.rigidbodyIndexA){r.warn(`Rigid body index out of range failed to create joint: ${t.name}`),d[e]=null;continue}if(t.rigidbodyIndexB<0||n.length<=t.rigidbodyIndexB){r.warn(`Rigid body index out of range failed to create joint: ${t.name}`),d[e]=null;continue}const a=h[t.rigidbodyIndexA],c=h[t.rigidbodyIndexB];if(null===a||null===c){r.warn(`Rigid body not found failed to create joint: ${t.name}`),d[e]=null;continue}rt.Matrix.ComposeToRef(m,rt.Quaternion.FromEulerAnglesToRef(t.rotation[0],t.rotation[1],t.rotation[2],p),_.copyFromFloats(t.position[0]*s,t.position[1]*s,t.position[2]*s),g);const T=n[t.rigidbodyIndexA],x=n[t.rigidbodyIndexB];{const e=T.shapeRotation,t=T.shapePosition;rt.Matrix.ComposeToRef(m,rt.Quaternion.FromEulerAnglesToRef(e[0],e[1],e[2],f),b.copyFromFloats(t[0]*s,t[1]*s,t[2]*s),y).invert()}{const e=x.shapeRotation,t=x.shapePosition;rt.Matrix.ComposeToRef(m,rt.Quaternion.FromEulerAnglesToRef(e[0],e[1],e[2],f),b.copyFromFloats(t[0]*s,t[1]*s,t[2]*s),w).invert()}g.multiplyToRef(y,A),g.multiplyToRef(w,M);const v=this._convertParameter(1),I=[{axis:cl.PhysicsConstraintAxis.LINEAR_X,minLimit:t.positionMin[0],maxLimit:t.positionMax[0],stiffness:this._convertParameter(t.springPosition[0]),damping:v},{axis:cl.PhysicsConstraintAxis.LINEAR_Y,minLimit:t.positionMin[1],maxLimit:t.positionMax[1],stiffness:this._convertParameter(t.springPosition[1]),damping:v},{axis:cl.PhysicsConstraintAxis.LINEAR_Z,minLimit:t.positionMin[2],maxLimit:t.positionMax[2],stiffness:this._convertParameter(t.springPosition[2]),damping:v},{axis:cl.PhysicsConstraintAxis.ANGULAR_X,minLimit:this._clampAngularLimit(t.rotationMin[0]),maxLimit:this._clampAngularLimit(t.rotationMax[0]),stiffness:this._convertParameter(t.springRotation[0]),damping:v},{axis:cl.PhysicsConstraintAxis.ANGULAR_Y,minLimit:this._clampAngularLimit(t.rotationMin[1]),maxLimit:this._clampAngularLimit(t.rotationMax[1]),stiffness:this._convertParameter(t.springRotation[1]),damping:v},{axis:cl.PhysicsConstraintAxis.ANGULAR_Z,minLimit:this._clampAngularLimit(t.rotationMin[2]),maxLimit:this._clampAngularLimit(t.rotationMax[2]),stiffness:this._convertParameter(t.springRotation[2]),damping:v}];for(let e=0;e<3;++e){const t=I[e];0===t.stiffness&&(t.stiffness=void 0,t.damping=void 0)}const B=new ml.Physics6DoFConstraint({pivotA:A.getTranslation(),pivotB:M.getTranslation(),axisA:new rt.Vector3(A.m[0],A.m[1],A.m[2]).negateInPlace(),axisB:new rt.Vector3(M.m[0],M.m[1],M.m[2]).negateInPlace(),perpAxisA:new rt.Vector3(A.m[4],A.m[5],A.m[6]),perpAxisB:new rt.Vector3(M.m[4],M.m[5],M.m[6]),collision:!0},I,o);a.addConstraint(c,B),d[e]=B;const P=l[t.rigidbodyIndexA],S=l[t.rigidbodyIndexB];if(P.physicsMode!==bt.B.RigidBody.PhysicsMode.FollowBone&&S.physicsMode===bt.B.RigidBody.PhysicsMode.PhysicsWithBone){const e=u(x);void 0!==e&&e.parentBone===u(T)&&(S.physicsMode=bt.B.RigidBody.PhysicsMode.Physics)}else if(S.physicsMode!==bt.B.RigidBody.PhysicsMode.FollowBone&&P.physicsMode===bt.B.RigidBody.PhysicsMode.PhysicsWithBone){const e=u(T);void 0!==e&&e.parentBone===u(x)&&(P.physicsMode=bt.B.RigidBody.PhysicsMode.Physics)}}return new fl(this,l,h,d)}_onAfterPhysics=()=>{const e=this._enablePreStepOnces;for(let t=0;t<e.length;++t)e[t].disablePreStep=!0;e.length=0};_enablePreStepOnce(e){e.disablePreStep&&(0===this._enablePreStepOnces.length&&this._scene.onAfterPhysicsObservable.addOnce(this._onAfterPhysics),this._enablePreStepOnces.push(e),e.disablePreStep=!1)}}class yl{index;name;get position(){return this._position}set position(e){this._position.copyFrom(e)}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion.copyFrom(e)}get scaling(){return this._scaling}set scaling(e){this._scaling.copyFrom(e)}_position;_rotationQuaternion;_scaling;parent;children;bone;_boneWorldRestRotationMatrix;_boneFinalMatrix;_boneFinalMatrixInverse;_boneParent;_restMatrix;_absoluteInverseBindMatrix;_positionApplyScale;_scalingMatrix;constructor(e,t,n,i,r){this.index=e,this.name=t,this._position=rt.Vector3.Zero(),this._rotationQuaternion=rt.Quaternion.Identity(),this._scaling=rt.Vector3.One(),this.parent=null,this.children=[],this.bone=n,this._boneWorldRestRotationMatrix=null!==n?n.getFinalMatrix().getRotationMatrix():null,this._boneFinalMatrix=null!==n?rt.Matrix.Identity():null,this._boneFinalMatrixInverse=null!==n?rt.Matrix.Identity():null,this._boneParent=null,this._restMatrix=rt.Matrix.Identity(),this._absoluteInverseBindMatrix=rt.Matrix.Identity(),this._positionApplyScale=i,this._scalingMatrix=r}getRestMatrix(){return this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}setRotationQuaternion(e){this._rotationQuaternion.copyFrom(e)}updateBoneParent(){let e=this.parent;if(null!==e)for(;null===e.bone&&(e=e.parent,null!==e););this._boneParent=e}computeBoneFinalMatrix(e,t){const n=this._boneFinalMatrix;"センター"===this.name?t.getWorldMatrixToRef(n):e[this.index].getWorldMatrixToRef(n),this._scalingMatrix.multiplyToRef(n,n),n.multiplyToRef(this._scalingMatrix,n);const i=this._positionApplyScale;{const e=n.m;n.setTranslationFromFloats(e[12]*i.x,e[13]*i.y,e[14]*i.z)}this._boneWorldRestRotationMatrix.multiplyToRef(n,n),this._boneFinalMatrixInverse.copyFrom(n).invert()}static _BoneLocalMatrix=new rt.Matrix;apply(){const e=this._boneParent,t=yl._BoneLocalMatrix.copyFrom(this._boneFinalMatrix);null!==e&&t.multiplyToRef(e._boneFinalMatrixInverse,t),this.bone._matrix=t}}class wl{bones;_skeleton;_runtimeBones;_upperBodyBone;constructor(e,t){this.bones=e,this._skeleton=t,this._runtimeBones=null,this._upperBodyBone=null}lateInitialize(e){this._runtimeBones=e;let t=null;for(let n=0;n<e.length;++n){const i=e[n];if("上半身"===i.name){t=i;break}}this._upperBodyBone=t}prepare(){}get _computeTransformMatrices(){return!0}set _computeTransformMatrices(e){if(!0===e){this._skeleton.onBeforeComputeObservable.removeCallback(this._onBeforeCompute);const e=this._skeleton.bones;let t=0;for(let n=0;n<e.length;++n)null!==e[n]._linkedTransformNode&&(t+=1);this._skeleton._numBonesWithLinkedTransformNode=t}else this._skeleton.onBeforeComputeObservable.add(this._onBeforeCompute),this._skeleton._numBonesWithLinkedTransformNode=0}_onBeforeCompute=()=>{const e=this.bones,t=this._runtimeBones,n=this._upperBodyBone;for(let i=0;i<e.length;++i)null!==e[i].bone&&e[i].computeBoneFinalMatrix(t,n);for(let t=0;t<e.length;++t)null!==e[t].bone&&e[t].apply()}}class Al{static _StandardSkeletonMetaData=[["全ての親",-1,0,31,null,null],["センター",0,0,30,null,null],["グルーブ",1,0,30,null,null],["腰",2,0,26,null,null],["右足IK親",0,0,31,null,null],["右足ＩＫ",4,1,62,null,{target:67,iteration:40,rotationConstraint:2,links:[{target:66,limitation:{minimumAngle:[-3.1415927410125732,0,0],maximumAngle:[-.008726646192371845,0,0]}},{target:65,limitation:void 0}]}],["右つま先ＩＫ",5,2,62,null,{target:72,iteration:3,rotationConstraint:4,links:[{target:67,limitation:void 0}]}],["左足IK親",0,0,31,null,null],["左足ＩＫ",7,1,62,null,{target:71,iteration:40,rotationConstraint:2,links:[{target:70,limitation:{minimumAngle:[-3.1415927410125732,0,0],maximumAngle:[-.008726646192371845,0,0]}},{target:69,limitation:void 0}]}],["左つま先ＩＫ",8,2,62,null,{target:73,iteration:3,rotationConstraint:4,links:[{target:71,limitation:void 0}]}],["上半身",3,0,27,null,null],["上半身2",10,0,27,null,null],["下半身",3,0,26,null,null],["首",11,0,27,null,null],["頭",13,0,26,null,null],["右肩P",11,0,26,null,null],["右肩",15,0,2075,null,null],["右肩C",16,0,274,{parentIndex:15,ratio:-1},null],["右腕",17,0,2075,null,null],["右腕捩",18,0,1050,null,null],["右ひじ",19,0,2075,null,null],["右手捩",20,0,1050,null,null],["右手首",21,0,2075,null,null],["右親指０",22,0,2079,null,null],["右親指１",23,0,2075,null,null],["右親指２",24,0,2075,null,null],["右小指１",22,0,2075,null,null],["右小指２",26,0,2075,null,null],["右小指３",27,0,2075,null,null],["右薬指１",22,0,2075,null,null],["右薬指２",29,0,2075,null,null],["右薬指３",30,0,2075,null,null],["右中指１",22,0,2075,null,null],["右中指２",32,0,2075,null,null],["右中指３",33,0,2075,null,null],["右人指１",22,0,2075,null,null],["右人指２",35,0,2075,null,null],["右人指３",36,0,2075,null,null],["左肩P",11,0,26,null,null],["左肩",38,0,2075,null,null],["左肩C",39,0,274,{parentIndex:38,ratio:-1},null],["左腕",40,0,2075,null,null],["左腕捩",41,0,1050,null,null],["左ひじ",42,0,2075,null,null],["左手捩",43,0,1050,null,null],["左手首",44,0,2075,null,null],["左親指０",45,0,2079,null,null],["左親指１",46,0,2075,null,null],["左親指２",47,0,2075,null,null],["左小指１",45,0,2075,null,null],["左小指２",49,0,2075,null,null],["左小指３",50,0,2075,null,null],["左薬指１",45,0,2075,null,null],["左薬指２",52,0,2075,null,null],["左薬指３",53,0,2075,null,null],["左中指１",45,0,2075,null,null],["左中指２",55,0,2075,null,null],["左中指３",56,0,2075,null,null],["左人指１",45,0,2075,null,null],["左人指２",58,0,2075,null,null],["左人指３",59,0,2075,null,null],["右目",14,2,2330,{parentIndex:63,ratio:1},null],["左目",14,2,2330,{parentIndex:63,ratio:1},null],["両目",14,0,2074,null,null],["腰キャンセル右",12,0,274,{parentIndex:3,ratio:-1},null],["右足",64,0,27,null,null],["右ひざ",65,0,27,null,null],["右足首",66,0,27,null,null],["腰キャンセル左",12,0,274,{parentIndex:3,ratio:-1},null],["左足",68,0,27,null,null],["左ひざ",69,0,27,null,null],["左足首",70,0,27,null,null],["右つま先",67,2,18,null,null],["左つま先",71,2,18,null,null],["右足D",64,1,283,{parentIndex:65,ratio:1},null],["右ひざD",74,1,283,{parentIndex:66,ratio:1},null],["右足首D",75,2,282,{parentIndex:67,ratio:1},null],["左足D",68,1,283,{parentIndex:69,ratio:1},null],["左ひざD",77,1,283,{parentIndex:70,ratio:1},null],["左足首D",78,2,282,{parentIndex:71,ratio:1},null],["右足先EX",76,2,26,null,null],["左足先EX",79,2,26,null,null]];_createMetadata(e,t,n,i){const r={modelName:e,englishModelName:e,comment:"",englishComment:""},o=[],a=Al._StandardSkeletonMetaData;for(let e=0;e<a.length;++e){const t=a[e],n=t[5],i={name:t[0],englishName:"",parentBoneIndex:t[1],transformOrder:t[2],flag:t[3],appendTransform:null!==t[4]?{...t[4]}:void 0,axisLimit:void 0,ik:null!==n?{target:n.target,iteration:n.iteration,rotationConstraint:n.rotationConstraint,links:n.links.map((e=>({target:e.target,limitation:void 0!==e.limitation?{...e.limitation}:void 0})))}:void 0};o.push(i)}const s=[];for(let e=0;e<t.length;++e){const n=t[e];null!==n.morphTargetManager&&s.push(n.morphTargetManager)}const l=new Map;for(let e=0;e<s.length;++e){const t=s[e],n=t.numTargets;for(let e=0;e<n;++e){const n=t.getTarget(e),i=n.name;let r=l.get(i);void 0===r&&(r=[],l.set(i,r)),r.push(n)}}const h=[];for(const[e,t]of l){const i=n[e]??e,r={name:i,englishName:i,category:bt.B.Morph.Category.Eye,type:bt.B.Morph.Type.VertexMorph,morphTargets:t};h.push(r)}return{isMmdModel:!0,header:r,bones:o,morphs:h,rigidBodies:[],joints:[],meshes:t,materials:[],skeleton:i}}_removeScaleFromOffsetMatrix(e){const t=new rt.Vector3;e.decompose(t),t.x=Math.abs(t.x),t.y=Math.abs(t.y),t.z=Math.abs(t.z);const n=e.m;return e.setRowFromFloats(0,n[0]/t.x,n[1]/t.x,n[2]/t.x,n[3]),e.setRowFromFloats(1,n[4]/t.y,n[5]/t.y,n[6]/t.y,n[7]),e.setRowFromFloats(2,n[8]/t.z,n[9]/t.z,n[10]/t.z,n[11]),t}_copyBonePosition(e,t,n){const i=n.get(e),r=n.get(t);return void 0===i||void 0===r?null:(r._position.copyFrom(i._position),r)}_getAverageBonePosition(e,t){const n=rt.Vector3.Zero();for(let i=0;i<e.length;++i){const r=t.get(e[i]);if(void 0===r)return null;n.addInPlace(r._position)}return n.scaleInPlace(1/e.length)}_buildBoneProxyTree(e,t,n,i,r){const o=i.clone(),a=this._removeScaleFromOffsetMatrix(o),s=new rt.Vector3(1/a.x,1/a.y,1/a.z),l=e.bones,h=new Set,d=new Map;for(let e=0;e<l.length;++e){const n=l[e],i=t[n.name];void 0!==i&&d.set(i,n)}e.prepare(!0);const c=[],u=new Map;for(let e=0;e<n.length;++e){const t=n[e],i=d.get(t.name)??null,r=new yl(e,t.name,i,s,o);null!==i&&(i.getFinalMatrix().getTranslationToRef(r._position),h.add(r.name)),c.push(r),u.set(t.name,r)}for(let e=0;e<n.length;++e){const t=n[e],i=c[e],r=t.parentBoneIndex;if(-1!==r){const e=c[r];i.parent=e,e.children.push(i)}}h.has("全ての親")||(u.get("全ての親")._position.y=.1*s.y,h.add("全ての親"));{const e=h.has("センター"),t=h.has("グルーブ");if(e||t)e?t||null!==this._copyBonePosition("センター","グルーブ",u)&&h.add("グルーブ"):null!==this._copyBonePosition("グルーブ","センター",u)&&h.add("センター");else{const e=this._getAverageBonePosition(["左足","左ひざ","右足","右ひざ"],u);null!==e&&(u.get("センター")._position.copyFrom(e),u.get("グルーブ")._position.copyFrom(e),h.add("センター"),h.add("グルーブ"))}}{const e=h.has("上半身"),t=h.has("下半身"),n=h.has("腰");if(e||t||n)e?t||null!==this._copyBonePosition(e?"上半身":"腰","下半身",u)&&h.add("下半身"):null!==this._copyBonePosition(t?"下半身":"腰","上半身",u)&&h.add("上半身");else{const e=this._getAverageBonePosition(["左足","左足","右足","右足","首"],u);null!==e&&(u.get("上半身")._position.copyFrom(e),u.get("下半身")._position.copyFrom(e),u.get("腰")._position.copyFrom(e),h.add("上半身"),h.add("下半身"),h.add("腰"))}n||null!==this._copyBonePosition(t?"下半身":"上半身","腰",u)&&h.add("腰")}if(!h.has("両目")){const e=this._getAverageBonePosition(["右目","左目"],u);if(null!==e){const t=u.get("両目");t._position.copyFrom(e);const n=u.get("頭")._position.y-t._position.y;t._position.y-=2*n,h.add("両目")}}if(h.has("右肩P")||null!==this._copyBonePosition("右肩","右肩P",u)&&h.add("右肩P"),h.has("右肩C")||null!==this._copyBonePosition("右腕","右肩C",u)&&h.add("右肩C"),h.has("左肩P")||null!==this._copyBonePosition("左肩","左肩P",u)&&h.add("左肩P"),h.has("左肩C")||null!==this._copyBonePosition("左腕","左肩C",u)&&h.add("左肩C"),!h.has("右腕捩")){const e=this._getAverageBonePosition(["右腕","右ひじ"],u);null!==e&&(u.get("右腕捩")._position.copyFrom(e),h.add("右腕捩"))}if(!h.has("右手捩")){const e=this._getAverageBonePosition(["右ひじ","右手首"],u);null!==e&&(u.get("右手捩")._position.copyFrom(e),h.add("右手捩"))}if(!h.has("左腕捩")){const e=this._getAverageBonePosition(["左腕","左ひじ"],u);null!==e&&(u.get("左腕捩")._position.copyFrom(e),h.add("左腕捩"))}if(!h.has("左手捩")){const e=this._getAverageBonePosition(["左ひじ","左手首"],u);null!==e&&(u.get("左手捩")._position.copyFrom(e),h.add("左手捩"))}if(h.has("腰キャンセル右")||null!==this._copyBonePosition("右足","腰キャンセル右",u)&&h.add("腰キャンセル右"),h.has("腰キャンセル左")||null!==this._copyBonePosition("左足","腰キャンセル左",u)&&h.add("腰キャンセル左"),h.has("右足ＩＫ")||null!==this._copyBonePosition("右足首","右足ＩＫ",u)&&h.add("右足ＩＫ"),!h.has("右足IK親")){const e=this._copyBonePosition("右足首","右足IK親",u);null!==e&&(e._position.y=.1*s.y,h.add("右足IK親"))}if(h.has("右つま先ＩＫ")||null!==this._copyBonePosition("右つま先","右つま先ＩＫ",u)&&h.add("右つま先ＩＫ"),h.has("左足ＩＫ")||null!==this._copyBonePosition("左足首","左足ＩＫ",u)&&h.add("左足ＩＫ"),!h.has("左足IK親")){const e=this._copyBonePosition("左足首","左足IK親",u);null!==e&&(e._position.y=.1*s.y,h.add("左足IK親"))}h.has("左つま先ＩＫ")||null!==this._copyBonePosition("左つま先","左つま先ＩＫ",u)&&h.add("左つま先ＩＫ"),h.has("右足D")||null!==this._copyBonePosition("右足","右足D",u)&&h.add("右足D"),h.has("右ひざD")||null!==this._copyBonePosition("右ひざ","右ひざD",u)&&h.add("右ひざD"),h.has("右足首D")||null!==this._copyBonePosition("右足首","右足首D",u)&&h.add("右足首D"),h.has("右足先EX")||null!==this._copyBonePosition("右つま先","右足先EX",u)&&h.add("右足先EX"),h.has("左足D")||null!==this._copyBonePosition("左足","左足D",u)&&h.add("左足D"),h.has("左ひざD")||null!==this._copyBonePosition("左ひざ","左ひざD",u)&&h.add("左ひざD"),h.has("左足首D")||null!==this._copyBonePosition("左足首","左足首D",u)&&h.add("左足首D"),h.has("左足先EX")||null!==this._copyBonePosition("左つま先","左足先EX",u)&&h.add("左足先EX");for(let e=0;e<c.length;++e){const t=c[e];t._position.multiplyInPlace(a),rt.Vector3.TransformCoordinatesToRef(t._position,o,t._position)}let m=c.length-h.size;for(;0<m;)for(let e=0;e<c.length;++e){const t=c[e];if(h.has(t.name))continue;const n=t.parent;null!==n&&h.has(n.name)&&(t._position.copyFrom(n._position),h.add(t.name),m-=1,r.warn(`Bone position of ${t.name} is not initialized. Use parent bone position instead. Animation may not work correctly.`))}const p=["右腕捩","右手捩","左腕捩","左手捩"],_=["右ひじ","右手首","左ひじ","左手首"];for(let e=0;e<p.length;++e){const t=p[e],i=u.get(t),r=u.get(_[e]);if(void 0!==i&&void 0!==r){const e=r._position.subtract(i._position).normalize();for(let i=0;i<n.length;++i)if(n[i].name===t){n[i]={...n[i],axisLimit:[e.x,e.y,e.z]};break}}}const g=new Map;for(let e=0;e<c.length;++e)g.set(c[e],c[e]._position.clone());for(let e=0;e<c.length;++e){const t=c[e];rt.Matrix.TranslationToRef(-t._position.x,-t._position.y,-t._position.z,t.getAbsoluteInverseBindMatrix());const n=t.parent;if(null!==n){const e=g.get(n);t._position.subtractInPlace(e)}t.getRestMatrix().setTranslation(t._position),t.updateBoneParent()}return c}createMmdModelFromHumanoid(e,t,n,i={}){const{boneMap:r={},morphMap:o={},transformOffset:a=rt.Matrix.Identity()}=i;let s=null;for(let e=0;e<n.length;++e){const t=n[e];if(null!==t.skeleton){s=t.skeleton;break}}if(null===s)throw new Error("Skeleton not found.");const l=this._createMetadata(t.name,n.slice(),o,s);if(t.metadata=l,!In.isMmdSkinnedMesh(t))throw new Error("Mesh validation failed.");let h;h=void 0!==a.getWorldMatrix?a.computeWorldMatrix(!0).clone().setTranslationFromFloats(0,0,0):a.clone().setTranslationFromFloats(0,0,0);const d=this._buildBoneProxyTree(s,r,l.bones,h,e),c=new wl(d,s),u=e.createMmdModelFromSkeleton(t,c,{materialProxyConstructor:null,buildPhysics:!1});return c.lateInitialize(u.runtimeBones),u}}!function(e){e[e.Seconds=0]="Seconds",e[e.Frames=1]="Frames"}(hl||(hl={}));class Ml{autoHidePlayerControl;hidePlayerControlTimeout;displayTimeFormat;_mmdRuntime;_audioPlayer;_newCanvasContainer;_playerContainer;_hidePlayerControlTimeoutId;_playButton;_timeSlider;_soundButton;_volumeSlider;_currentFrameNumberSpan;_endFrameNumberSpan;_speedSlider;_fullscreenButton;_bindedDispose;_scene;constructor(e,t,n){const i=e.getEngine().getInputElement();if(null===i)throw new Error("Failed to get root element.");this.autoHidePlayerControl=!0,this.hidePlayerControlTimeout=3e3,this.displayTimeFormat=hl.Seconds,this._mmdRuntime=t,this._audioPlayer=n??null;const r=this._newCanvasContainer=this._createCanvasContainer(i.parentElement);this._playerContainer=null,this._hidePlayerControlTimeoutId=void 0,this._playButton=null,this._timeSlider=null,this._soundButton=null,this._volumeSlider=null,this._currentFrameNumberSpan=null,this._endFrameNumberSpan=null,this._speedSlider=null,this._fullscreenButton=null,this._createPlayerControl(r,t,n),t.onPlayAnimationObservable.add(this._onAnimationPlay),t.onPauseAnimationObservable.add(this._onAnimationPause),t.onAnimationDurationChangedObservable.add(this._onAnimationDurationChanged),t.onAnimationTickObservable.add(this._onAnimationTick),n?.onMuteStateChangedObservable.add(this._onMuteStateChanged),this._bindedDispose=this.dispose.bind(this),this._scene=e,e.onDisposeObservable.add(this._bindedDispose)}_createCanvasContainer(e){const t=e.ownerDocument.createElement("div");for(t.style.display=e.style.display;e.childElementCount>0;){const n=e.childNodes[0];e.removeChild(n),t.appendChild(n)}return e.appendChild(t),t.style.width="100%",t.style.height="100%",t.style.overflow="hidden",t}_restoreCanvasContainer(e){const t=this._newCanvasContainer;for(;t.childElementCount>0;){const n=t.childNodes[0];t.removeChild(n),e.appendChild(n)}e.removeChild(t)}_createPlayerControl(e,t,n){const i=e.ownerDocument,r=this._playerContainer=i.createElement("div");r.style.position="relative",r.style.bottom="120px",r.style.left="0",r.style.width="100%",r.style.height="120px",r.style.transform="translateY(50%)",r.style.transition="transform 0.5s",e.appendChild(r),r.onmouseenter=this._onPlayerControlMouseEnter,r.onmouseleave=this._onPlayerControlMouseLeave;{const o=i.createElement("div");o.style.position="absolute",o.style.bottom="0",o.style.left="0",o.style.width="100%",o.style.height="50%",o.style.boxSizing="border-box",o.style.background="linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.6))",o.style.display="flex",o.style.flexDirection="column",r.appendChild(o);{const r=i.createElement("div");r.style.width="100%",r.style.boxSizing="border-box",r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center",o.appendChild(r);{const e=this._timeSlider=i.createElement("input");e.style.width="100%",e.style.height="4px",e.style.border="none",e.style.opacity="0.5",e.type="range",e.min="0",e.max=t.animationFrameTimeDuration.toString(),e.oninput=n=>{n.preventDefault(),t.seekAnimation(Number(e.value),!0)};{let n=!1;e.onmousedown=()=>{t.isAnimationPlaying&&(t.pauseAnimation(),n=!0)},e.onmouseup=()=>{n&&(t.playAnimation(),n=!1)}}r.appendChild(e)}const a=i.createElement("div");a.style.width="100%",a.style.flexGrow="1",a.style.padding="0 5px",a.style.boxSizing="border-box",a.style.display="flex",a.style.flexDirection="row",a.style.alignItems="space-between",o.appendChild(a);{const r=i.createElement("div");r.style.flex="1",r.style.display="flex",r.style.flexDirection="row",r.style.alignItems="center",a.appendChild(r);{const e=this._playButton=i.createElement("button");if(e.style.width="40px",e.style.border="none",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.color="white",e.style.fontSize="18px",e.innerText=t.isAnimationPlaying?"❚❚":"▶",e.onclick=()=>{t.isAnimationPlaying?t.pauseAnimation():t.playAnimation()},r.appendChild(e),void 0!==n){const e=this._soundButton=i.createElement("button");e.style.width="35px",e.style.border="none",e.style.backgroundColor="rgba(0, 0, 0, 0)",e.style.color="white",e.style.fontSize="20px",e.innerText=n.muted?"🔇":"🔊",e.onclick=()=>{n.muted?n.unmute():n.mute()},r.appendChild(e);const t=this._volumeSlider=i.createElement("input");t.style.width="80px",t.style.height="4px",t.style.border="none",t.style.opacity="0.5",t.type="range",t.min="0",t.max="1",t.step="0.01",t.value=n.volume.toString(),t.oninput=()=>{n.volume=Number(t.value)},r.appendChild(t)}const o=this._currentFrameNumberSpan=i.createElement("span");o.style.width="40px",o.style.textAlign="right",o.style.color="white",o.innerText=this.displayTimeFormat===hl.Seconds?this._getFormattedTime(t.currentTime):Math.floor(t.currentFrameTime).toString(),r.appendChild(o);const a=this._endFrameNumberSpan=i.createElement("span");a.style.width="50px",a.style.textAlign="left",a.style.color="white",a.innerHTML="&nbsp;/&nbsp;"+(this.displayTimeFormat===hl.Seconds?this._getFormattedTime(t.animationDuration):Math.floor(t.animationFrameTimeDuration).toString()),r.appendChild(a)}const o=i.createElement("div");o.style.flex="1",o.style.display="flex",o.style.flexDirection="row",o.style.alignItems="center",o.style.justifyContent="flex-end",a.appendChild(o);{const n=i.createElement("label");n.style.width="40px",n.style.textAlign="center",n.style.color="white",n.innerText="1.00x",o.appendChild(n);const r=this._speedSlider=i.createElement("input");r.style.width="80px",r.style.height="4px",r.style.border="none",r.style.opacity="0.5",r.type="range",r.min="0.07",r.max="1",r.step="0.01",r.value=t.timeScale.toString(),r.oninput=()=>{t.timeScale=Number(r.value),n.innerText=t.timeScale.toFixed(2)+"x"},o.appendChild(r);const a=this._fullscreenButton=i.createElement("button");a.style.width="40px",a.style.border="none",a.style.color="white",a.style.backgroundColor="rgba(0, 0, 0, 0)",a.style.fontSize="20px",a.innerText="🗖",a.onclick=()=>{i.fullscreenElement?i.exitFullscreen():e.requestFullscreen()},o.appendChild(a)}}}}}_onPlayerControlMouseEnter=()=>{this.autoHidePlayerControl&&(window.clearTimeout(this._hidePlayerControlTimeoutId),this._hidePlayerControlTimeoutId=void 0,this.showPlayerControl())};_onPlayerControlMouseLeave=()=>{this.autoHidePlayerControl&&(this._hidePlayerControlTimeoutId=window.setTimeout(this.hidePlayerControl.bind(this),this.hidePlayerControlTimeout))};_onAnimationPlay=()=>{this._playButton.innerText="❚❚"};_onAnimationPause=()=>{this._playButton.innerText="▶"};_onAnimationDurationChanged=()=>{const e=this._mmdRuntime;this._timeSlider.max=e.animationFrameTimeDuration.toString(),this._endFrameNumberSpan.innerHTML="&nbsp;/&nbsp;"+(this.displayTimeFormat===hl.Seconds?this._getFormattedTime(e.animationDuration):Math.floor(e.animationFrameTimeDuration).toString())};_onAnimationTick=()=>{const e=this._mmdRuntime;if(this._timeSlider.value=e.currentFrameTime.toString(),this.displayTimeFormat===hl.Seconds){const t=this._getFormattedTime(e.currentTime);this._currentFrameNumberSpan.innerText!==t&&(this._currentFrameNumberSpan.innerText=t)}else this._currentFrameNumberSpan.innerText=Math.floor(e.currentFrameTime).toString()};_onMuteStateChanged=()=>{null!==this._soundButton&&(this._soundButton.innerText=this._audioPlayer.muted?"🔇":"🔊")};_formattedTimeCacheKey=NaN;_formatterTimeCacheValue="";_getFormattedTime(e){const t=Math.floor(e);if(t===this._formattedTimeCacheKey)return this._formatterTimeCacheValue;if(!isFinite(e))return this._formattedTimeCacheKey=t,this._formatterTimeCacheValue="-:--","-:--";const n=Math.floor(e/60),i=Math.floor(e%60),r=n.toString()+":"+(i<10?"0":"")+i.toString();return this._formattedTimeCacheKey=t,this._formatterTimeCacheValue=r,r}hidePlayerControl(){this._playerContainer.style.transform="translateY(50%)",this._hidePlayerControlTimeoutId=void 0}showPlayerControl(){this._playerContainer.style.transform="translateY(0)"}dispose(){null!==this._newCanvasContainer&&(this._restoreCanvasContainer(this._newCanvasContainer.parentElement),this._newCanvasContainer=null,this._playButton.onclick=null,this._timeSlider.oninput=null,this._timeSlider.onmousedown=null,this._timeSlider.onmouseup=null,null!==this._audioPlayer&&(this._soundButton.onclick=null,this._volumeSlider.oninput=null),this._speedSlider.oninput=null,this._fullscreenButton.onclick=null,this._playerContainer.onmouseenter=null,this._playerContainer.onmouseleave=null,this._playerContainer.remove(),this._mmdRuntime.onPlayAnimationObservable.removeCallback(this._onAnimationPlay),this._mmdRuntime.onPauseAnimationObservable.removeCallback(this._onAnimationPause),this._mmdRuntime.onAnimationDurationChangedObservable.removeCallback(this._onAnimationDurationChanged),this._mmdRuntime.onAnimationTickObservable.removeCallback(this._onAnimationTick),this._audioPlayer?.onMuteStateChangedObservable.removeCallback(this._onMuteStateChanged),this._scene.onDisposeObservable.removeCallback(this._bindedDispose))}}class Tl{static OverrideComputeTransformMatrices(e){e._computeTransformMatrices=function(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let n=0;n<this.bones.length;n++){const i=this.bones[n];if(i._childUpdateId+=1,!i.getParent()){const r=[i];for(;r.length>0;){const i=r.pop(),o=i.getParent();if(o?i.getLocalMatrix().multiplyToRef(o.getFinalMatrix(),i.getFinalMatrix()):t?i.getLocalMatrix().multiplyToRef(t,i.getFinalMatrix()):i.getFinalMatrix().copyFrom(i.getLocalMatrix()),-1!==i._index){const t=null===i._index?n:i._index;i.getAbsoluteInverseBindMatrix().multiplyToArray(i.getFinalMatrix(),e,16*t)}const a=i.getChildren();for(const e of a)r.push(e)}}}this._identity.copyToArray(e,16*this.bones.length)}}}class xl{isLocal;affectRotation;affectPosition;ratio;targetBone;appendPosition=rt.Vector3.Zero();appendRotation=rt.Quaternion.Identity();constructor(e,t,n){this.isLocal=!!(e&bt.B.Bone.Flag.LocalAppendTransform),this.affectRotation=!!(e&bt.B.Bone.Flag.HasAppendRotate),this.affectPosition=!!(e&bt.B.Bone.Flag.HasAppendMove),this.ratio=t.ratio,this.targetBone=n}static _IdentityQuaternion=rt.Quaternion.Identity();static _TargetBoneWorldMatrix=rt.Matrix.Identity();update(e,t){const n=this.targetBone;if(this.affectRotation){const t=this.appendRotation;if(this.isLocal){const e=n.getWorldMatrixToRef(xl._TargetBoneWorldMatrix);rt.Quaternion.FromRotationMatrixToRef(e,t)}else null!==n.appendTransformSolver&&n.appendTransformSolver.affectRotation?t.copyFrom(n.appendTransformSolver.appendRotation):n.getAnimatedRotationToRef(t);null===n.ikChainInfo||this.isLocal||n.ikChainInfo.ikRotation.multiplyToRef(t,t),1!==this.ratio&&rt.Quaternion.SlerpToRef(xl._IdentityQuaternion,t,this.ratio,t),e.multiplyToRef(t,t)}if(this.affectPosition){const e=this.appendPosition;if(this.isLocal){const t=n.getWorldMatrixToRef(xl._TargetBoneWorldMatrix);t.multiplyToRef(n.linkedBone.getAbsoluteInverseBindMatrix(),t),t.getTranslationToRef(e)}else null!==n.appendTransformSolver&&n.appendTransformSolver.affectPosition?e.copyFrom(n.appendTransformSolver.appendPosition):n.getAnimationPositionOffsetToRef(e);1!==this.ratio&&e.scaleInPlace(this.ratio),e.addInPlace(t)}}}class vl{localRotation;localPosition;ikRotation;constructor(){this.localRotation=rt.Quaternion.Identity(),this.localPosition=rt.Vector3.Zero(),this.ikRotation=rt.Quaternion.Identity()}}class Il{bone;minimumAngle;maximumAngle;rotationOrder;solveAxis;constructor(e,t){if(this.bone=e,void 0!==t){{const e=t.minimumAngle,n=t.maximumAngle,i=Math.min(e[0],n[0]),r=Math.min(e[1],n[1]),o=Math.min(e[2],n[2]),a=Math.max(e[0],n[0]),s=Math.max(e[1],n[1]),l=Math.max(e[2],n[2]);this.minimumAngle=new rt.Vector3(i,r,o),this.maximumAngle=new rt.Vector3(a,s,l)}const e=this.minimumAngle,n=this.maximumAngle,i=.5*Math.PI;-i<e.x&&n.x<i?this.rotationOrder=0:-i<e.y&&n.y<i?this.rotationOrder=1:this.rotationOrder=2,0===e.x&&0===n.x&&0===e.y&&0===n.y&&0===e.z&&0===n.z?this.solveAxis=1:0===e.y&&0===n.y&&0===e.z&&0===n.z?this.solveAxis=2:0===e.x&&0===n.x&&0===e.z&&0===n.z?this.solveAxis=3:0===e.x&&0===n.x&&0===e.y&&0===n.y?this.solveAxis=4:this.solveAxis=0}else this.minimumAngle=null,this.maximumAngle=null,this.rotationOrder=2,this.solveAxis=0}}class Bl{index;get iteration(){return this._iteration}set iteration(e){this._iteration=Math.min(e,256)}limitAngle;ikBone;targetBone;_iteration;_ikChains;_canSkipWhenPhysicsEnabled;constructor(e,t,n){this.index=e,this._iteration=1,this.limitAngle=Math.PI,this.ikBone=t,this.targetBone=n,this._ikChains=[],this._canSkipWhenPhysicsEnabled=!0}addIkChain(e,t,n){e.ikChainInfo=new vl,t||(this._canSkipWhenPhysicsEnabled=!1);const i=new Il(e,n);this._ikChains.push(i)}get canSkipWhenPhysicsEnabled(){return this._canSkipWhenPhysicsEnabled}static _IkPosition=new rt.Vector3;static _TargetPosition=new rt.Vector3;solve(e){if(0===this._ikChains.length)return;const t=this.ikBone,n=this.targetBone,i=this._ikChains;for(let e=0;e<i.length;++e)i[e].bone.ikChainInfo.ikRotation.set(0,0,0,1);const r=t.getWorldTranslationToRef(Bl._IkPosition);n.updateWorldMatrix(e,!0);const o=n.getWorldTranslationToRef(Bl._TargetPosition);if(rt.Vector3.DistanceSquared(r,o)<1e-8)return;for(let t=i.length-1;t>=0;--t)i[t].bone.updateWorldMatrix(e,!1);if(n.updateWorldMatrix(!1,!1),n.getWorldTranslationToRef(o),rt.Vector3.DistanceSquared(r,o)<1e-8)return;const a=this.iteration,s=a>>1;for(let e=0;e<a;++e){for(let t=0;t<i.length;++t){const n=i[t];1!==n.solveAxis&&this._solveChain(n,t,r,o,e<s)}if(rt.Vector3.DistanceSquared(r,o)<1e-8)break}}static _ChainPosition=new rt.Vector3;static _ChainTargetVector=new rt.Vector3;static _ChainIkVector=new rt.Vector3;static _ChainRotationAxis=new rt.Vector3;static _ChainParentRotationMatrix=new rt.Matrix;static _Axis=new rt.Vector3;static _Rotation=new rt.Quaternion;static _RotationMatrix=new rt.Matrix;static _Right=rt.Vector3.Right();static _Up=rt.Vector3.Up();static _Forward=rt.Vector3.Forward();static _Rotation2=new rt.Quaternion;static _Rotation3=new rt.Quaternion;_solveChain(e,t,n,i,r){const o=this.targetBone,a=e.bone,s=a.getWorldTranslationToRef(Bl._ChainPosition),l=s.subtractToRef(i,Bl._ChainTargetVector).normalize(),h=s.subtractToRef(n,Bl._ChainIkVector).normalize(),d=rt.Vector3.CrossToRef(l,h,Bl._ChainRotationAxis);if(d.lengthSquared()<1e-8)return;const c=null!==a.parentBone?a.parentBone.getWorldMatrixToRef(Bl._ChainParentRotationMatrix):rt.Matrix.IdentityToRef(Bl._ChainParentRotationMatrix);if(c.setTranslationFromFloats(0,0,0),null!==e.minimumAngle&&r)switch(e.solveAxis){case 0:c.transposeToRef(c),rt.Vector3.TransformNormalToRef(d,c,d),d.normalize();break;case 2:{const e=c.m,t=rt.Vector3.Dot(d,Bl._Axis.set(e[0],e[1],e[2]));d.x=0<=t?1:-1,d.y=0,d.z=0;break}case 3:{const e=c.m,t=rt.Vector3.Dot(d,Bl._Axis.set(e[4],e[5],e[6]));d.x=0,d.y=0<=t?1:-1,d.z=0;break}case 4:{const e=c.m,t=rt.Vector3.Dot(d,Bl._Axis.set(e[8],e[9],e[10]));d.x=0,d.y=0,d.z=0<=t?1:-1;break}}else c.transposeToRef(c),rt.Vector3.TransformNormalToRef(d,c,d),d.normalize();let u=rt.Vector3.Dot(l,h);u=Math.max(-1,Math.min(1,u));const m=Math.min(this.limitAngle*(t+1),Math.acos(u)),p=rt.Quaternion.RotationAxisToRef(d,m,Bl._Rotation);if(p.multiplyToRef(a.ikChainInfo.ikRotation,a.ikChainInfo.ikRotation),null!==e.minimumAngle){a.ikChainInfo.ikRotation.multiplyToRef(a.ikChainInfo.localRotation,p);const t=rt.Matrix.FromQuaternionToRef(p,Bl._RotationMatrix).m,n=88*Math.PI/180;let i,o,s;switch(e.rotationOrder){case 0:{i=Math.asin(-t[9]),Math.abs(i)>n&&(i=i<0?-n:n);let l=Math.cos(i);0!==l&&(l=1/l),o=Math.atan2(t[8]*l,t[10]*l),s=Math.atan2(t[1]*l,t[5]*l);{const t=e.minimumAngle,n=e.maximumAngle;i=this._limitAngle(i,t.x,n.x,r),o=this._limitAngle(o,t.y,n.y,r),s=this._limitAngle(s,t.z,n.z,r)}rt.Quaternion.RotationAxisToRef(Bl._Up,o,a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(rt.Quaternion.RotationAxisToRef(Bl._Right,i,Bl._Rotation2),a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(rt.Quaternion.RotationAxisToRef(Bl._Forward,s,Bl._Rotation2),a.ikChainInfo.ikRotation);break}case 1:{o=Math.asin(-t[2]),Math.abs(o)>n&&(o=o<0?-n:n);let l=Math.cos(o);0!==l&&(l=1/l),i=Math.atan2(t[6]*l,t[10]*l),s=Math.atan2(t[1]*l,t[0]*l);{const t=e.minimumAngle,n=e.maximumAngle;i=this._limitAngle(i,t.x,n.x,r),o=this._limitAngle(o,t.y,n.y,r),s=this._limitAngle(s,t.z,n.z,r)}rt.Quaternion.RotationAxisToRef(Bl._Forward,s,a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(rt.Quaternion.RotationAxisToRef(Bl._Up,o,Bl._Rotation2),a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(rt.Quaternion.RotationAxisToRef(Bl._Right,i,Bl._Rotation2),a.ikChainInfo.ikRotation);break}case 2:{s=Math.asin(-t[4]),Math.abs(s)>n&&(s=s<0?-n:n);let l=Math.cos(s);0!==l&&(l=1/l),i=Math.atan2(t[6]*l,t[5]*l),o=Math.atan2(t[8]*l,t[0]*l);{const t=e.minimumAngle,n=e.maximumAngle;i=this._limitAngle(i,t.x,n.x,r),o=this._limitAngle(o,t.y,n.y,r),s=this._limitAngle(s,t.z,n.z,r)}rt.Quaternion.RotationAxisToRef(Bl._Right,i,a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(rt.Quaternion.RotationAxisToRef(Bl._Forward,s,Bl._Rotation2),a.ikChainInfo.ikRotation),a.ikChainInfo.ikRotation.multiplyToRef(rt.Quaternion.RotationAxisToRef(Bl._Up,o,Bl._Rotation2),a.ikChainInfo.ikRotation);break}}const l=rt.Quaternion.InverseToRef(a.ikChainInfo.localRotation,Bl._Rotation3);a.ikChainInfo.ikRotation.multiplyToRef(l,a.ikChainInfo.ikRotation)}const _=this._ikChains;for(let e=t;e>=0;--e)_[e].bone.updateIkChainWorldMatrix();o.updateWorldMatrix(!1,!1),o.getWorldTranslationToRef(i)}_limitAngle(e,t,n,i){if(e<t){const r=2*t-e;return r<=n&&i?r:t}if(e>n){const r=2*n-e;return r>=t&&i?r:n}return e}}class Pl extends Vs{setMorphWeight(e,t){const n=this._morphIndexMap.get(e);if(void 0===n)return;const i=this._morphWeights;for(let e=0;e<n.length;++e)i[n[e]]=t;0!==t&&this._activeMorphs.add(e)}setMorphWeightFromIndex(e,t){this._morphWeights[e]=t,0!==t&&this._activeMorphs.add(this._morphs[e].name)}_resetBoneMorph(e){const t=this._runtimeBones,n=e.elements;for(let e=0;e<n.length;++e){const i=t[n[e]];void 0!==i&&(i.morphPositionOffset.set(0,0,0),i.morphRotationOffset.set(0,0,0,1),i.disableMorph())}}_tempQuaternion=new rt.Quaternion;_applyBoneMorph(e,t){const n=this._runtimeBones,i=e.elements,r=e.elements2,o=e.elements3;for(let e=0;e<i.length;++e){const a=n[i[e]];void 0!==a&&(a.morphPositionOffset.addInPlaceFromFloats(r[3*e+0]*t,r[3*e+1]*t,r[3*e+2]*t),rt.Quaternion.SlerpToRef(a.morphRotationOffset,this._tempQuaternion.copyFromFloats(o[4*e+0],o[4*e+1],o[4*e+2],o[4*e+3]),t,a.morphRotationOffset),0!==t&&a.enableMorph())}}}function Sl(e,t){t.set(e.x,e.y,e.z);const n=t.length();if(n>=1e-8){const i=2*Math.atan2(n,e.w);return t.scaleInPlace(1/n),i}return t.set(1,0,0),0}class Rl{linkedBone;name;parentBone;childBones;transformOrder;flag;transformAfterPhysics;appendTransformSolver;axisLimit;ikSolver;morphPositionOffset;morphRotationOffset;ikChainInfo;worldMatrix;getAnimatedRotationToRef;getAnimationPositionOffsetToRef;constructor(e,t,n,i){this.linkedBone=e,this.name=t.name,this.parentBone=null,this.childBones=[],this.transformOrder=t.transformOrder,this.flag=t.flag,this.transformAfterPhysics=!!(t.flag&bt.B.Bone.Flag.TransformAfterPhysics),this.appendTransformSolver=null,void 0!==t.axisLimit?this.axisLimit=rt.Vector3.FromArray(t.axisLimit).normalize():this.axisLimit=null,this.ikSolver=null,this.morphPositionOffset=rt.Vector3.Zero(),this.morphRotationOffset=rt.Quaternion.Identity(),this.ikChainInfo=null,this.worldMatrix=new Float32Array(n.buffer,n.byteOffset+16*i*4,16),this.getAnimatedRotationToRef=this._getAnimatedRotationToRef,this.getAnimationPositionOffsetToRef=this._getAnimationPositionOffsetToRef}static _TempAxis=new rt.Vector3;_getAnimatedRotationToRef(e){if(null!==this.axisLimit){const t=this.axisLimit;if(0===t.x&&0===t.y&&0===t.z)e.set(0,0,0,1);else{const n=Rl._TempAxis;let i=Sl(this.linkedBone.rotationQuaternion,n);rt.Vector3.Dot(n,t)<0&&(i=-i),rt.Quaternion.RotationAxisToRef(t,i,e)}}else e.copyFrom(this.linkedBone.rotationQuaternion);return e}_getAnimatedRotationWithMorphToRef(e){if(null!==this.axisLimit){const t=this.axisLimit;if(0===t.x&&0===t.y&&0===t.z)e.set(0,0,0,1);else{const n=Rl._TempAxis;let i=Sl(this.linkedBone.rotationQuaternion,n);rt.Vector3.Dot(n,t)<0&&(i=-i),rt.Quaternion.RotationAxisToRef(t,i,e)}}else e.copyFrom(this.linkedBone.rotationQuaternion);return this.morphRotationOffset.multiplyToRef(e,e)}static _TempVector3=new rt.Vector3;_getAnimationPositionOffsetToRef(e){return e.copyFrom(this.linkedBone.position),this.linkedBone.getRestMatrix().getTranslationToRef(Rl._TempVector3),e.subtractInPlace(Rl._TempVector3)}_getAnimationPositionOffsetWithMorphToRef(e){return e.copyFrom(this.linkedBone.position),e.addInPlace(this.morphPositionOffset),this.linkedBone.getRestMatrix().getTranslationToRef(Rl._TempVector3),e.subtractInPlace(Rl._TempVector3)}enableMorph(){this.getAnimatedRotationToRef=this._getAnimatedRotationWithMorphToRef,this.getAnimationPositionOffsetToRef=this._getAnimationPositionOffsetWithMorphToRef}disableMorph(){this.getAnimatedRotationToRef=this._getAnimatedRotationToRef,this.getAnimationPositionOffsetToRef=this._getAnimationPositionOffsetToRef}resetTransformState(){const e=this.worldMatrix;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,null!==this.ikChainInfo&&(this.ikChainInfo.localRotation.set(0,0,0,1),this.ikChainInfo.localPosition.set(0,0,0),this.ikChainInfo.ikRotation.set(0,0,0,1)),null!==this.appendTransformSolver&&(this.appendTransformSolver.appendRotation.set(0,0,0,1),this.appendTransformSolver.appendPosition.set(0,0,0))}static _TempRotation=rt.Quaternion.Identity();static _TempPosition=rt.Vector3.Zero();static _TempPosition2=rt.Vector3.Zero();static _TempMatrix=rt.Matrix.Identity();static _TempMatrix2=rt.Matrix.Identity();updateWorldMatrix(e,t){const n=this.getAnimatedRotationToRef(Rl._TempRotation),i=this.getAnimationPositionOffsetToRef(Rl._TempPosition);null!==this.appendTransformSolver&&(this.appendTransformSolver.update(n,i),this.appendTransformSolver.affectRotation&&n.copyFrom(this.appendTransformSolver.appendRotation),this.appendTransformSolver.affectPosition&&i.copyFrom(this.appendTransformSolver.appendPosition)),null!==this.ikChainInfo&&(this.ikChainInfo.localRotation.copyFrom(n),this.ikChainInfo.localPosition.copyFrom(i),this.ikChainInfo.ikRotation.multiplyToRef(n,n));const r=Rl._TempMatrix,o=this.linkedBone.getRestMatrix().getTranslationToRef(Rl._TempPosition2).addInPlace(i),a=this.linkedBone.scaling;if(1!==a.x||1!==a.y||1!==a.z?rt.Matrix.ComposeToRef(a,n,o,r):(rt.Matrix.FromQuaternionToRef(n,r),r.setTranslation(o)),null!==this.parentBone){const e=this.parentBone.getWorldMatrixToRef(Rl._TempMatrix2);r.multiplyToRef(e,r)}r.copyToArray(this.worldMatrix),t&&null!==this.ikSolver&&(e&&this.ikSolver.canSkipWhenPhysicsEnabled||this.ikSolver.solve(e))}updateIkChainWorldMatrix(){const e=this.ikChainInfo,t=e.ikRotation.multiplyToRef(e.localRotation,Rl._TempRotation),n=Rl._TempMatrix,i=this.linkedBone.scaling;if(1!==i.x||1!==i.y||1!==i.z){rt.Matrix.ScalingToRef(i.x,i.y,i.z,n);const e=rt.Matrix.FromQuaternionToRef(t,Rl._TempMatrix2);n.multiplyToRef(e,n)}else rt.Matrix.FromQuaternionToRef(t,n);const r=this.linkedBone.getRestMatrix().getTranslationToRef(Rl._TempPosition);if(r.addInPlace(e.localPosition),n.setTranslation(r),null!==this.parentBone){const e=this.parentBone.getWorldMatrixToRef(Rl._TempMatrix2);n.multiplyToRef(e,n)}n.copyToArray(this.worldMatrix);const o=this.childBones;for(let e=0;e<o.length;++e)o[e]._updateWorldMatrixRecursive()}static _WorldMatrixUpdateStack=[];_updateWorldMatrixRecursive(){const e=Rl._WorldMatrixUpdateStack;for(e.length=0,e.push(this);e.length>0;){const t=e.pop();t.updateWorldMatrix(!1,!1);for(let n=0,i=t.childBones.length;n<i;++n)e.push(t.childBones[n])}}getWorldMatrixToRef(e){return rt.Matrix.FromArrayToRef(this.worldMatrix,0,e)}getWorldTranslationToRef(e){return rt.Vector3.FromArrayToRef(this.worldMatrix,12,e)}setWorldTranslationFromRef(e){e.toArray(this.worldMatrix,12)}get ikSolverIndex(){return null!==this.ikSolver?this.ikSolver.index:-1}}class El{mesh;skeleton;worldTransformMatrices;ikSolverStates;runtimeBones;morph;_physicsModel;_logger;_sortedRuntimeBones;onCurrentAnimationChangedObservable;_animations;_currentAnimation;_needStateReset;constructor(e,t,n,i,r){this._logger=r;const o=e.metadata,a=e;a.metadata={isRuntimeMmdModel:!0,header:o.header,meshes:o.meshes,materials:o.materials,skeleton:o.skeleton},this.mesh=a,this.skeleton=t;const s=this.worldTransformMatrices=new Float32Array(16*t.bones.length);{let e=0;const t=o.bones;for(let n=0;n<t.length;++n)void 0!==t[n].ik&&(e+=1);this.ikSolverStates=new Uint8Array(e).fill(1)}t.prepare(),this._disableSkeletonWorldMatrixUpdate(t);const l=this.runtimeBones=this._buildRuntimeSkeleton(t.bones,o.bones,o.rigidBodies,s);(this._sortedRuntimeBones=[...l]).sort(((e,t)=>e.transformOrder-t.transformOrder));const h=[];{const e=o.meshes;for(let t=0;t<e.length;++t){const n=e[t].morphTargetManager;null!==n&&h.push(n)}}this.morph=new Pl(l,o.materials,o.meshes,n,o.morphs,h),this._physicsModel=null!==i?i.buildPhysics(e,l,o.rigidBodies,o.joints,r):null,this.onCurrentAnimationChangedObservable=new pt.Observable,this._animations=[],this._currentAnimation=null,this._needStateReset=!1}dispose(){this._enableSkeletonWorldMatrixUpdate(),this._physicsModel?.dispose(),this.onCurrentAnimationChangedObservable.clear();const e=this._animations;for(let t=0;t<e.length;++t)e[t].dispose?.();this._animations.length=0,this.mesh.metadata=null}get sortedRuntimeBones(){return this._sortedRuntimeBones}addAnimation(e,t,n=!0){let i;if(void 0===e.createRuntimeModelAnimation)throw new Error('animation is not MmdAnimation or MmdModelAnimationGroup or MmdCompositeAnimation. are you missing import "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimation" or "babylon-mmd/esm/Runtime/Animation/mmdRuntimeModelAnimationGroup" or "babylon-mmd/esm/Runtime/Animation/mmdCompositeRuntimeModelAnimation"?');i=e.createRuntimeModelAnimation(this,t,this._logger);const r=this._animations.findIndex((t=>t.animation.name===e.name));if(-1!==r){const e=this._animations[r];this._animations[r]=i,this._currentAnimation===e&&(this._currentAnimation=i,this._resetPose(),this._needStateReset=!0,i.induceMaterialRecompile(n,this._logger),this.onCurrentAnimationChangedObservable.notifyObservers(i))}else this._animations.push(i)}removeAnimation(e){const t=this._animations[e];void 0!==t&&(this._currentAnimation===t&&(this._currentAnimation=null,this._resetPose(),this.onCurrentAnimationChangedObservable.notifyObservers(null)),this._animations.splice(e,1),t.dispose?.())}setAnimation(e,t=!0){if(null===e)return void(null!==this._currentAnimation&&(this._currentAnimation=null,this._resetPose(),this.onCurrentAnimationChangedObservable.notifyObservers(null)));const n=this._animations.findIndex((t=>t.animation.name===e));if(-1===n)throw new Error(`Animation '${e}' is not found.`);null!==this._currentAnimation&&(this._resetPose(),this._needStateReset=!0);const i=this._currentAnimation=this._animations[n];i.induceMaterialRecompile(t,this._logger),this.onCurrentAnimationChangedObservable.notifyObservers(i)}get runtimeAnimations(){return this._animations}get currentAnimation(){return this._currentAnimation}initializePhysics(){this._physicsModel?.initialize()}beforePhysics(e){null!==e&&(this._needStateReset&&(this._needStateReset=!1,this.morph.resetMorphWeights(),this.ikSolverStates.fill(1)),null!==this._currentAnimation&&this._currentAnimation.animate(e)),this.morph.update();for(let e=0;e<this._sortedRuntimeBones.length;++e)this._sortedRuntimeBones[e].resetTransformState();this._update(!1),this._physicsModel?.syncBodies()}afterPhysics(){const e=this._physicsModel;null!==e&&e.syncBones(),this._update(!0),this.mesh.metadata.skeleton._markAsDirty()}_update(e){const t=null!==this._physicsModel,n=this._sortedRuntimeBones;for(let i=0;i<n.length;++i){const r=n[i];r.transformAfterPhysics===e&&r.updateWorldMatrix(t,0!==this.ikSolverStates[r.ikSolverIndex])}}_buildRuntimeSkeleton(e,t,n,i){const r=[];for(let n=0;n<t.length;++n){const o=t[n];r.push(new Rl(e[n],o,i,n))}const o=new Set;{const e=new Map;for(let t=0;t<r.length;++t){const n=r[t];e.set(n.name,n)}for(let t=0;t<n.length;++t){const i=n[t];if(i.physicsMode===bt.B.RigidBody.PhysicsMode.FollowBone)continue;let a=r[i.boneIndex];void 0===a&&(a=e.get(n[t].name)),void 0!==a&&o.add(a)}}let a=0;for(let e=0;e<t.length;++e){const n=t[e],i=r[e],s=n.parentBoneIndex;if(0<=s&&s<r.length){const e=r[s];i.parentBone=e,e.childBones.push(i)}if(void 0!==n.appendTransform){const e=n.appendTransform.parentIndex;0<=e&&e<r.length?i.appendTransformSolver=new xl(n.flag,n.appendTransform,r[e]):this._logger.error(`Invalid append transform target bone index: ${e}`)}if(void 0!==n.ik){const e=n.ik,t=e.target;if(0<=t&&t<r.length){const n=i.ikSolver=new Bl(a,i,r[t]);a+=1,n.iteration=e.iteration,n.limitAngle=e.rotationConstraint;for(let t=0;t<e.links.length;++t){const i=e.links[t],a=i.target;if(0<=a&&a<r.length){const e=r[a];n.addIkChain(e,o.has(e),i.limitation)}else this._logger.error(`Invalid IK link bone index: ${a}`)}}else this._logger.error(`Invalid IK target bone index: ${t}`)}}return r}_originalComputeTransformMatrices=null;_disableSkeletonWorldMatrixUpdate(e){if(null!==this._originalComputeTransformMatrices)return;this._originalComputeTransformMatrices=e._computeTransformMatrices;const t=this.worldTransformMatrices;e._computeTransformMatrices=function(e,n){this.onBeforeComputeObservable.notifyObservers(this);for(let n=0;n<this.bones.length;n++){const i=this.bones[n];if(i._childUpdateId+=1,-1!==i._index){const r=null===i._index?n:i._index;i.getAbsoluteInverseBindMatrix().multiplyToArray(rt.Matrix.FromArrayToRef(t,16*n,i.getFinalMatrix()),e,16*r)}}this._identity.copyToArray(e,16*this.bones.length)}}_enableSkeletonWorldMatrixUpdate(){null!==this._originalComputeTransformMatrices&&(this.skeleton._computeTransformMatrices=this._originalComputeTransformMatrices,this._originalComputeTransformMatrices=null)}_resetPose(){const e=this._sortedRuntimeBones,t=new rt.Vector3,n=rt.Quaternion.Identity();for(let i=0;i<e.length;++i){const r=e[i].linkedBone;r.getRestMatrix().getTranslationToRef(t),r.position=t,r.setRotationQuaternion(n,Ut.Space.LOCAL)}this.mesh.metadata.skeleton._markAsDirty()}}class Cl{_physics;_models;_camera;_audioPlayer;autoPhysicsInitialization;_loggingEnabled;log;warn;error;_isRegistered;onAnimationDurationChangedObservable;onPlayAnimationObservable;onPauseAnimationObservable;onSeekAnimationObservable;onAnimationTickObservable;_currentFrameTime;_animationTimeScale;_animationPaused;_animationFrameTimeDuration;_useManualAnimationDuration;_needToInitializePhysicsModels;_beforePhysicsBinded;_afterPhysicsBinded;_bindedDispose;_disposeObservableObject;constructor(e=null,t=null){this._physics=t,this._models=[],this._camera=null,this._audioPlayer=null,this.autoPhysicsInitialization=!0,this._loggingEnabled=!1,this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled,this._isRegistered=!1,this.onAnimationDurationChangedObservable=new pt.Observable,this.onPlayAnimationObservable=new pt.Observable,this.onPauseAnimationObservable=new pt.Observable,this.onSeekAnimationObservable=new pt.Observable,this.onAnimationTickObservable=new pt.Observable,this._currentFrameTime=0,this._animationTimeScale=1,this._animationPaused=!0,this._animationFrameTimeDuration=0,this._useManualAnimationDuration=!1,this._needToInitializePhysicsModels=new Set,this._beforePhysicsBinded=null,this._afterPhysicsBinded=this.afterPhysics.bind(this),null!==e?(this._bindedDispose=()=>this.dispose(e),this._disposeObservableObject=e,null!==this._disposeObservableObject&&this._disposeObservableObject.onDisposeObservable.add(this._bindedDispose)):(this._bindedDispose=null,this._disposeObservableObject=null)}dispose(e){for(let e=0;e<this._models.length;++e)this._models[e].dispose();this._models.length=0,this.setCamera(null),this.setAudioPlayer(null),this.onAnimationDurationChangedObservable.clear(),this.onPlayAnimationObservable.clear(),this.onPauseAnimationObservable.clear(),this.onSeekAnimationObservable.clear(),this.onAnimationTickObservable.clear(),this._needToInitializePhysicsModels.clear(),this.unregister(e),null!==this._disposeObservableObject&&null!==this._bindedDispose&&this._disposeObservableObject.onDisposeObservable.removeCallback(this._bindedDispose)}createMmdModel(e,t={}){if(!In.isMmdSkinnedMesh(e))throw new Error("Mesh validation failed.");return this.createMmdModelFromSkeleton(e,e.metadata.skeleton,t)}createMmdModelFromSkeleton(e,t,n={}){void 0===n.materialProxyConstructor&&(n.materialProxyConstructor=qs),void 0===n.buildPhysics&&(n.buildPhysics=!0);const i=new El(e,t,n.materialProxyConstructor,n.buildPhysics?this._physics:null,this);return this._models.push(i),this._needToInitializePhysicsModels.add(i),i.onCurrentAnimationChangedObservable.add(this._onAnimationChanged),i}destroyMmdModel(e){e.dispose();const t=this._models,n=t.indexOf(e);if(n<0)throw new Error("Model not found.");t.splice(n,1)}initializeMmdModelPhysics(e){this._needToInitializePhysicsModels.add(e)}initializeAllMmdModelsPhysics(e){const t=this._models;if(e)for(let e=0;e<t.length;++e){const n=t[e];null!==n.currentAnimation&&this._needToInitializePhysicsModels.add(n)}else for(let e=0;e<t.length;++e)this._needToInitializePhysicsModels.add(t[e])}setCamera(e){null!==this._camera&&this._camera.onCurrentAnimationChangedObservable.removeCallback(this._onAnimationChanged),null!==e&&e.onCurrentAnimationChangedObservable.add(this._onAnimationChanged),this._camera=e,this._onAnimationChanged(e?.currentAnimation??null)}_setAudioPlayerLastValue=null;async setAudioPlayer(e){if(this._audioPlayer!==e)if(this._setAudioPlayerLastValue=e,null!==this._audioPlayer&&(this._audioPlayer.onDurationChangedObservable.removeCallback(this._onAudioDurationChanged),this._audioPlayer.onPlaybackRateChangedObservable.removeCallback(this._onAudioPlaybackRateChanged),this._audioPlayer.onPlayObservable.removeCallback(this._onAudioPlay),this._audioPlayer.onPauseObservable.removeCallback(this._onAudioPause),this._audioPlayer.onSeekObservable.removeCallback(this._onAudioSeek),this._audioPlayer.pause()),this._audioPlayer=null,null!==e){if(!this._animationPaused){const t=30*e.duration;if(this._currentFrameTime<t&&(e.currentTime=this._currentFrameTime/30,await e.play(),this._setAudioPlayerLastValue!==e))return void e.pause()}this._audioPlayer=e,this._onAudioDurationChanged(),e.onDurationChangedObservable.add(this._onAudioDurationChanged),e.onPlaybackRateChangedObservable.add(this._onAudioPlaybackRateChanged),e.onPlayObservable.add(this._onAudioPlay),e.onPauseObservable.add(this._onAudioPause),e.onSeekObservable.add(this._onAudioSeek),e._setPlaybackRateWithoutNotify(this._animationTimeScale)}else this._onAudioDurationChanged()}register(e){this._isRegistered||(this._isRegistered=!0,this._beforePhysicsBinded=()=>this.beforePhysics(e.getEngine().getDeltaTime()),e.onBeforeAnimationsObservable.add(this._beforePhysicsBinded),e.onBeforeRenderObservable.add(this._afterPhysicsBinded))}unregister(e){this._isRegistered&&(this._isRegistered=!1,e.onBeforeAnimationsObservable.removeCallback(this._beforePhysicsBinded),e.onBeforeRenderObservable.removeCallback(this._afterPhysicsBinded),this._beforePhysicsBinded=null)}beforePhysics(e){if(this._animationPaused){const e=this._models;for(let t=0;t<e.length;++t)e[t].beforePhysics(null)}else{if(null===this._audioPlayer||this._audioPlayer.paused)this._currentFrameTime+=e/1e3*30*this._animationTimeScale;else{const t=this._audioPlayer.currentTime,n=t-this._currentFrameTime/30,i=Math.abs(n);if(i<.05)this._currentFrameTime+=e/1e3*30*this._animationTimeScale;else if(i<.5)this._currentFrameTime+=n<0?e/1e3*30*this._animationTimeScale*.9:e/1e3*30*this._animationTimeScale*1.1;else{if(this.autoPhysicsInitialization&&60<Math.abs(t-this._currentFrameTime)){const e=this._needToInitializePhysicsModels;for(let t=0;t<this._models.length;++t){const n=this._models[t];null!==n.currentAnimation&&e.add(n)}}this._currentFrameTime=30*t}}const t=this._currentFrameTime;this._animationFrameTimeDuration<=t&&(this._animationPaused=!0,this._currentFrameTime=this._animationFrameTimeDuration,null===this._audioPlayer||this._audioPlayer.paused?this.onPauseAnimationObservable.notifyObservers():this._audioPlayer.pause());const n=this._models;for(let e=0;e<n.length;++e)n[e].beforePhysics(t);null!==this._camera&&this._camera.animate(t),this.onAnimationTickObservable.notifyObservers()}const t=this._needToInitializePhysicsModels;for(const e of t)e.initializePhysics();t.clear()}afterPhysics(){const e=this._models;for(let t=0;t<e.length;++t)e[t].afterPhysics()}_onAnimationChanged=e=>{if(this._useManualAnimationDuration)return;const t=e?.animation.endFrame??0;this._animationFrameTimeDuration<t?this._animationFrameTimeDuration=t:t<this._animationFrameTimeDuration&&(this._animationFrameTimeDuration=this._computeAnimationDuration()),this.onAnimationDurationChangedObservable.notifyObservers()};_computeAnimationDuration(){let e=0;const t=this._models;for(let n=0;n<t.length;++n){const i=t[n];null!==i.currentAnimation&&(e=Math.max(e,i.currentAnimation.animation.endFrame))}return null!==this._camera&&null!==this._camera.currentAnimation&&(e=Math.max(e,this._camera.currentAnimation.animation.endFrame)),null!==this._audioPlayer&&(e=Math.max(e,30*this._audioPlayer.duration)),e}_onAudioDurationChanged=()=>{if(!this._animationPaused&&null!==this._audioPlayer){const e=this._audioPlayer,t=this._currentFrameTime/30;t<e.duration&&(e._setCurrentTimeWithoutNotify(t),e.play().then((()=>{this._setAudioPlayerLastValue===e||e.pause()})))}if(this._useManualAnimationDuration)return;const e=null!==this._audioPlayer?30*this._audioPlayer.duration:0;this._animationFrameTimeDuration<e?this._animationFrameTimeDuration=e:this._animationFrameTimeDuration=this._computeAnimationDuration(),this.onAnimationDurationChangedObservable.notifyObservers()};_onAudioPlaybackRateChanged=()=>{this._animationTimeScale=this._audioPlayer.playbackRate};_onAudioPlay=()=>{this._playAnimationInternal()};_onAudioPause=()=>{this._audioPlayer.currentTime!==this._audioPlayer.duration&&(this._animationPaused=!0,this.onPauseAnimationObservable.notifyObservers())};_onAudioSeek=()=>{this._seekAnimationInternal(30*this._audioPlayer.currentTime,this._animationPaused)};_playAnimationInternal(){if(this._animationPaused){if(this._animationPaused=!1,this.autoPhysicsInitialization&&0===this._currentFrameTime){const e=this._models,t=this._needToInitializePhysicsModels;for(let n=0;n<e.length;++n)t.add(e[n])}this.onPlayAnimationObservable.notifyObservers()}}async playAnimation(){if(null!==this._audioPlayer&&this._currentFrameTime<30*this._audioPlayer.duration)try{const e=this._currentFrameTime/30;.05<Math.abs(this._audioPlayer.currentTime-e)&&this._audioPlayer._setCurrentTimeWithoutNotify(e),await this._audioPlayer.play()}catch(e){if(!(e instanceof DOMException&&"NotSupportedError"===e.name))throw e;this.error("Failed to play audio."),this._playAnimationInternal()}else this._playAnimationInternal()}pauseAnimation(){null===this._audioPlayer||this._audioPlayer.paused?(this._animationPaused=!0,this.onPauseAnimationObservable.notifyObservers()):(this._audioPlayer.pause(),this._animationPaused=!0)}_seekAnimationInternal(e,t){if(this.autoPhysicsInitialization&&60<Math.abs(e-this._currentFrameTime)){const e=this._needToInitializePhysicsModels;for(let t=0;t<this._models.length;++t){const n=this._models[t];null!==n.currentAnimation&&e.add(n)}}if(this._currentFrameTime=e,t){const t=this._models;for(let n=0;n<t.length;++n){const i=t[n];null!==i.currentAnimation&&i.currentAnimation.animate(e)}null!==this._camera&&null!==this._camera.currentAnimation&&this._camera.animate(e),this.onAnimationTickObservable.notifyObservers()}this.onSeekAnimationObservable.notifyObservers()}async seekAnimation(e,t=!1){if(e=Math.max(0,Math.min(e,this._animationFrameTimeDuration)),null!==this._audioPlayer)if(this._audioPlayer.paused)if(!this._animationPaused&&30*this._audioPlayer.currentTime<this._animationFrameTimeDuration&&e<30*this._audioPlayer.duration)try{this._audioPlayer._setCurrentTimeWithoutNotify(e/30),await this._audioPlayer.play()}catch(n){if(!(n instanceof DOMException&&"NotSupportedError"===n.name))throw n;this.error("Failed to play audio."),this._seekAnimationInternal(e,t)}else this._seekAnimationInternal(e,t),this._audioPlayer?._setCurrentTimeWithoutNotify(e/30);else this._audioPlayer.currentTime=e/30;else this._seekAnimationInternal(e,t)}get isAnimationPlaying(){return!this._animationPaused}get models(){return this._models}get camera(){return this._camera}get audioPlayer(){return this._audioPlayer}get timeScale(){return this._animationTimeScale}set timeScale(e){this._animationTimeScale=e,null!==this._audioPlayer&&this._audioPlayer._setPlaybackRateWithoutNotify(e)}get currentFrameTime(){return this._currentFrameTime}get currentTime(){return this._currentFrameTime/30}get animationFrameTimeDuration(){return this._animationFrameTimeDuration}get animationDuration(){return this._animationFrameTimeDuration/30}setManualAnimationDuration(e){(null!==e||this._useManualAnimationDuration)&&(null===e?(this._useManualAnimationDuration=!1,this._animationFrameTimeDuration=this._computeAnimationDuration()):(this._useManualAnimationDuration=!0,this._animationFrameTimeDuration=e),this.onAnimationDurationChangedObservable.notifyObservers())}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled=e,e?(this.log=this._logEnabled,this.warn=this._warnEnabled,this.error=this._errorEnabled):(this.log=this._logDisabled,this.warn=this._warnDisabled,this.error=this._errorDisabled)}_logEnabled(e){Rn.Logger.Log(e)}_logDisabled(){}_warnEnabled(e){Rn.Logger.Warn(e)}_warnDisabled(){}_errorEnabled(e){Rn.Logger.Error(e)}_errorDisabled(){}}return An(),xn(),ze})()));
//# sourceMappingURL=babylon.mmd.min.js.map